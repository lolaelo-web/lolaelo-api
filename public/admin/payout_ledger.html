<!doctype html>
<html lang="en">
<head>
  <!-- Favicon (match Admin Hub and AP) -->
  <link rel="icon" href="https://www.lolaelo.com/images/logo3.png?v=4" type="image/png">
  <link rel="shortcut icon" href="https://www.lolaelo.com/images/logo3.png?v=4" type="image/png">
  <link rel="apple-touch-icon" href="https://www.lolaelo.com/images/logo3.png?v=4">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Payout Ledger | Lolaelo Admin</title>

  <link rel="stylesheet" href="/css/extranet.css">

  <style>
    :root{
      --bg:#f6f8fc;
      --card:#ffffff;
      --fg:#0f172a;
      --muted:#5b6b84;
      --accent:#ff6a3d;
      --line:rgba(15,23,42,.12);
      --shadow:0 10px 30px rgba(15,23,42,.08);
    }
    *{ box-sizing:border-box }
    body{
      margin:0;
      background:var(--bg);
      color:var(--fg);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    button, input, select, textarea{ font-family: inherit; }

    .wrap{ max-width:1200px; margin:0 auto; padding:18px 14px 30px; }

    /* Header matches AP patterns */
    /* ANCHOR: HUB_HEADER_OVERRIDE */
    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:8px;
      padding:0;
    }
    .brandRow{
      display:flex;
      align-items:center;
      gap:12px;
      margin:0;
      padding:0;
    }
    .brandRow img{ height:64px; width:auto; display:block; }

    .pill{
      display:inline-block;
      font-size:11px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.18);
      color:#0f172a;
      font-weight:800;
      vertical-align:middle;
      background:#fff;
      white-space:nowrap;
    }
    .sub{ color:var(--muted); font-size:13px; margin:2px 0 0; }
    .btnRow{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    .btn.ghost{
      background:#0b3a4a;
      border:1px solid rgba(11,58,74,.35);
      color:#ffffff !important;
      box-shadow:0 6px 18px rgba(15,23,42,.12);
      transition: transform .08s ease, background .15s ease, box-shadow .15s ease, border-color .15s ease;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:9px 12px;
      border-radius:999px;
      font-weight:800;
      font-size:13px;
      cursor:pointer;
    }
    .btn.ghost:hover{
      background: linear-gradient(90deg, #0b3a4a 0%, #0f5b63 100%);
      border-color: rgba(11,58,74,.55);
      transform: translateY(-1px);
    }
    .btn.ghost:active{ transform: translateY(0px); }
    .btn.ghost:focus{
      outline:none;
      box-shadow:0 0 0 4px rgba(11,58,74,.20), 0 6px 18px rgba(15,23,42,.12);
    }
    /* ANCHOR: HUB_HEADER_OVERRIDE END */

    .hero{
      border:1px solid var(--line);
      background:var(--card);
      border-radius:14px;
      padding:14px;
      box-shadow:var(--shadow);
    }
    .hero h1{ margin:0; font-size:18px; }
    .hero p{ margin:6px 0 0; color:var(--muted); font-size:13px; line-height:1.35; }

    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin:12px 0;
      align-items:flex-end;
    }
    label{
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size:12px;
      color:var(--muted);
    }
    .controls select, .controls input{
      background:#fff;
      border:1px solid var(--line);
      color:var(--fg);
      padding:9px 10px;
      border-radius:12px;
      font-size:13px;
      outline:none;
      min-width:260px;
    }
    .controls input.search{ min-width:320px; }
    .controls input:focus, .controls select:focus{
      border-color:rgba(255,106,61,.55);
      box-shadow:0 0 0 3px rgba(255,106,61,.15);
    }

    .statusRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin:10px 0 0;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--line);
      background:#fff;
      padding:8px 10px;
      border-radius:999px;
      font-size:12.5px;
      cursor:pointer;
      user-select:none;
      box-shadow:0 6px 18px rgba(15,23,42,.06);
      color:var(--fg);
      font-weight:700;
    }
    .chip input{ accent-color: var(--accent); }

    .chipToggle{
      appearance:none;
      border:1px solid rgba(255,106,61,.55);
      background:#fff;
      color:#0f172a;
      padding:10px 14px;
      border-radius:999px;
      font-size:12.5px;
      font-weight:800;
      cursor:pointer;
      box-shadow:0 6px 18px rgba(15,23,42,.06);
      transition: background .12s ease, border-color .12s ease, transform .08s ease, filter .12s ease;
    }
    .chipToggle:hover{
      border-color: rgba(255,106,61,.85);
      filter: brightness(1.01);
    }
    .chipToggle:active{
      transform: translateY(1px);
    }
    .chipToggle.on{
      background: #ff6a3d;
      border-color: #ff6a3d;
      color:#fff;
    }

    .banner{
      margin:12px 0 0;
      border:1px solid rgba(15,23,42,.12);
      background:rgba(15,118,110,.06);
      border-radius:14px;
      padding:10px 12px;
      color:#475569;
      display:none;
    }
    .banner.show{ display:block; }

    .table{
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
      background:var(--card);
      box-shadow:var(--shadow);
      margin-top:12px;
    }
    table{ width:100%; border-collapse:collapse; }
    th, td{
      border-bottom:1px solid rgba(15,23,42,.08);
      padding:10px 10px;
      font-size:13px;
      text-align:left;
      vertical-align:middle;
    }
    th{
      color:var(--muted);
      font-weight:700;
      background:#fbfcff;
    }
    tr:last-child td{ border-bottom:none; }

    .muted{ color:var(--muted); }
    .right{ text-align:right; }
    .mono{ font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .nowrap{ white-space:nowrap; }

    .pillStatus{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--line);
      background:#fff;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:800;
      box-shadow:0 6px 18px rgba(15,23,42,.06);
    }
    .pillStatus .dot{ width:8px; height:8px; border-radius:50%; }
    /* Waiting for review: only dot is bright yellow */
    .pillStatus.ready{
      background:#fff;
      border-color:rgba(15,23,42,.12);
      color:#0f172a;
    }

    .pillStatus.ready .dot{
      background:#facc15; /* bright yellow dot */
    }

    .pillStatus.draft .dot{ background:var(--accent); }
    .pillStatus.paid  .dot{ background:#10b981; }

    .footerRow{
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:10px;
      color:var(--muted);
      font-size:12.5px;
      min-height:16px;
    }

    .btn{
      border:1px solid var(--line);
      background:#fff;
      color:var(--fg);
      padding:9px 12px;
      border-radius:999px;
      font-weight:800;
      font-size:13px;
      cursor:pointer;
      box-shadow:0 6px 18px rgba(15,23,42,.06);
      transition: transform .08s ease, box-shadow .08s ease, border-color .12s ease;
    }
    .btn:hover{
      transform: translateY(-1px);
      border-color: rgba(255,106,61,.65);
      box-shadow:0 10px 26px rgba(15,23,42,.10);
    }
    .btn:active{ transform: translateY(0px); }
    .btn.primary{
      background: rgba(255,106,61,.10);
      border-color: rgba(255,106,61,.35);
    }
    .toggleHint{
      font-size:12px;
      color:#64748b;
      font-weight:650;
    }

  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div>
        <div class="brandRow">
          <img src="/images/logo.png" alt="Lolaelo" />
          <span class="pill">Payout Ledger</span>
        </div>
        <div class="sub">Read-only history and audit view. Filter by partner or by pay period Friday. Export current view as CSV.</div>
      </div>

      <div class="btnRow">
        <a class="btn ghost" href="/admin/index.html">Admin hub</a>
        <a class="btn ghost" href="/partners_app.html">Extranet</a>
        <button id="btnLogout" class="btn ghost" type="button">Sign out</button>
      </div>
    </div>

    <div class="hero">
      <h1>Payout Ledger</h1>
      <p>AP is operational. Ledger is historical and audit only. No state changes from this page.</p>

      <div class="controls">
        <label>
          Partner
          <select id="partnerSel"></select>
        </label>

        <label>
          Pay period (posting Friday)
          <select id="periodSel"></select>
        </label>

        <label>
          Search (confirmation, payout id, partner name)
          <input id="searchBox" class="search" type="text" placeholder="Type to filter table rows" />
        </label>

        <button class="btn" id="refreshBtn" type="button">Refresh</button>
        <button class="btn primary" id="csvBtn" type="button">Download CSV</button>
      </div>

      <div class="statusRow" id="statusRow">
        <button class="chipToggle on" id="stReady" type="button" data-val="READY">Waiting for review</button>
        <button class="chipToggle on" id="stDraft" type="button" data-val="DRAFT">Reviewed and waiting for payment</button>
        <button class="chipToggle on" id="stPaid" type="button" data-val="PAID">Paid</button>
        <span class="toggleHint">(click buttons to toggle on & off)</span>
      </div>

      <div class="banner" id="noPostedBanner">No payments posted for this week.</div>
    </div>

    <div class="table" style="margin-top:12px;">
      <table>
        <thead>
          <tr>
            <th class="nowrap">Pay window</th>
            <th>Partner</th>
            <th class="nowrap">Status</th>
            <th class="right nowrap">Gross</th>
            <th class="right nowrap">Fees</th>
            <th class="right nowrap">Net</th>
            <th>Confirmation / Reference</th>
            <th class="nowrap">Paid at / Updated at</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="8" class="muted">Loading...</td></tr>
        </tbody>
      </table>
    </div>

  <script>
    // Auth gate matches admin/login.html behavior
    const ADMIN_TOKEN_KEY = "lolaelo_admin_session";
    // TEMP: surface runtime errors (remove after fix)
    window.addEventListener("error", (ev) => {
      try {
        alert("JS ERROR: " + (ev && ev.message ? ev.message : "unknown"));
      } catch (_) {}
    });
    window.addEventListener("unhandledrejection", (ev) => {
      try {
        alert("PROMISE ERROR: " + (ev && ev.reason ? (ev.reason.message || String(ev.reason)) : "unknown"));
      } catch (_) {}
    });

    const LOGIN = "/admin/login.html";

    function getToken(){
      try { return localStorage.getItem(ADMIN_TOKEN_KEY) || ""; } catch(_) { return ""; }
    }

    async function fetchJSON(url, opts){
      opts = opts || {};
      opts.headers = opts.headers || {};
      const tok = getToken();
      if (tok) opts.headers["Authorization"] = "Bearer " + tok;
      const res = await fetch(url, opts);
      if (!res.ok) {
        const txt = await res.text().catch(()=>"");
        throw new Error("HTTP " + res.status + " " + (txt || ""));
      }
      return res.json();
    }

    async function requireAdmin(){
      const tok = getToken();
      if (!tok) {
        location.replace(LOGIN);
        return false;
      }
      try {
        await fetchJSON("/api/admin/ping");
        return true;
      } catch (e) {
        try { localStorage.removeItem(ADMIN_TOKEN_KEY); } catch(_) {}
        location.replace(LOGIN);
        return false;
      }
    }

    function esc(s){
      return String(s == null ? "" : s)
        .replace(/&/g,"&amp;").replace(/</g,"&lt;")
        .replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");
    }

    function fmtDateOnly(ts){
      if (!ts) return "";
      try {
        const d = new Date(ts);
        if (isNaN(d.getTime())) return "";
        return d.toLocaleDateString(undefined, { year:"numeric", month:"short", day:"2-digit", timeZone:"America/New_York" });
      } catch { return ""; }
    }

    function buildStatusesParam(){
      const a = [];
      if (document.getElementById("stReady").classList.contains("on")) a.push("READY");
      if (document.getElementById("stDraft").classList.contains("on")) a.push("DRAFT");
      if (document.getElementById("stPaid").classList.contains("on")) a.push("PAID");
      return a.join(",");
    }

    function buildPayWindowLabel(weekStart, weekEnd){
      if (!weekStart || !weekEnd) return "";
      const ws = fmtDateOnly(weekStart);
      const we = fmtDateOnly(weekEnd);
      return (ws && we) ? (ws + " to " + we) : "";
    }

    function statusPill(status){
      const s = String(status || "").toUpperCase();
      let cls = "pillStatus ";
      let label = s;
      if (s === "READY"){ cls += "ready"; label = "Waiting for review"; }
      else if (s === "DRAFT"){ cls += "draft"; label = "Reviewed and waiting"; }
      else if (s === "PAID"){ cls += "paid"; label = "Paid"; }
      return `<span class="${cls}"><span class="dot"></span>${esc(label)}</span>`;
    }

    let ledgerRows = [];
    let currentMeta = { payFriday:"", weekStart:"", weekEnd:"", hasPostedPayout:false };

    let __ledgerReqSeq = 0;
    let __ledgerLoading = false;

    async function loadPartners(){
      const sel = document.getElementById("partnerSel");
      sel.innerHTML = "";

      const optAll = document.createElement("option");
      optAll.value = "0";
      optAll.textContent = "All partners";
      sel.appendChild(optAll);

      const data = await fetchJSON("/api/admin/ap/ledger/partners");
      const rows = (data && data.rows) ? data.rows : [];

      for (const r of rows){
        const o = document.createElement("option");
        o.value = String(r.partnerId || r.partnerID || r.id || "");
        o.textContent = String(r.propertyName || r.name || ("Partner #" + o.value));
        sel.appendChild(o);
      }
    }

    async function loadPeriods(){
      const sel = document.getElementById("periodSel");
      sel.innerHTML = "";

      // YTD option (Jan 1, 2026 -> today)
      const ytdOpt = document.createElement("option");
      ytdOpt.value = "YTD";
      ytdOpt.textContent = "Year to date (Jan 1 â€“ Today)";
      sel.appendChild(ytdOpt);

      const data = await fetchJSON("/api/admin/ap/ledger/periods?weeks=260");
      const periods = (data && data.periods) ? data.periods : [];
      const def = (data && data.defaultPayFriday) ? data.defaultPayFriday : "";

      for (const p of periods){
        const payFriday = String(p.payFriday || "");
        // Only Jan 2026 onward
        if (!payFriday || payFriday < "2026-01-01") continue;

        const o = document.createElement("option");
        o.value = payFriday;
        o.textContent = String(p.label || payFriday);
        sel.appendChild(o);
      }

      // Default to YTD always
      sel.value = "YTD";
    }

    async function loadLedger(){
      // In-flight guard: allow only one active request, and only the latest response may update UI
      if (__ledgerLoading) return;
      __ledgerLoading = true;
      const mySeq = ++__ledgerReqSeq;

      try {
        const partnerId = Number(document.getElementById("partnerSel").value || 0) || 0;
        const periodVal = String(document.getElementById("periodSel").value || "").trim();
        const statuses = buildStatusesParam() || "READY,DRAFT,PAID";

        const tbody = document.getElementById("tbody");
        if (tbody) tbody.innerHTML = `<tr><td colspan="8" class="muted">Loading...</td></tr>`;

        let url;
        if (periodVal === "YTD") {
          url = `/api/admin/ap/ledger?startDate=2026-01-01&endDate=${new Date().toISOString().slice(0,10)}&partnerId=${encodeURIComponent(String(partnerId))}&statuses=${encodeURIComponent(statuses)}`;
        } else {
          url = `/api/admin/ap/ledger?payFriday=${encodeURIComponent(periodVal)}&partnerId=${encodeURIComponent(String(partnerId))}&statuses=${encodeURIComponent(statuses)}`;
        }

        const data = await fetchJSON(url);

        // If a newer request started, drop this response silently
        if (mySeq !== __ledgerReqSeq) return;

        ledgerRows = (data && data.rows) ? data.rows : [];
        currentMeta = {
          payFriday: data.payFriday || (periodVal === "YTD" ? "" : periodVal),
          weekStart: data.weekStart || "",
          weekEnd: data.weekEnd || "",
          hasPostedPayout: !!data.hasPostedPayout
        };

        renderTable();
        renderSummary();
        renderNoPostedBanner();
      } catch (e) {
        // Only show errors for the latest request
        if (mySeq === __ledgerReqSeq) showErr(e);
      } finally {
        // Only the latest request clears the loading flag
        if (mySeq === __ledgerReqSeq) __ledgerLoading = false;
      }
    }

    function renderNoPostedBanner(){
      const el = document.getElementById("noPostedBanner");
      if (!currentMeta.hasPostedPayout) el.classList.add("show");
      else el.classList.remove("show");
    }

    function renderTable(){
      const q = String(document.getElementById("searchBox").value || "").trim().toLowerCase();
      const tbody = document.getElementById("tbody");

      function rowText(r){
        return [
          r.propertyName, r.status, r.confirmationNumber, r.payoutId,
          r.weekStart, r.weekEnd, r.payFriday
        ].join(" ").toLowerCase();
      }

      const rows0 = Array.isArray(ledgerRows) ? ledgerRows.slice() : [];
      const rows = q ? rows0.filter(r => rowText(r).includes(q)) : rows0;

      // Sort: status first, then partner, then pay window
      const order = { READY: 1, DRAFT: 2, PAID: 3 };
      rows.sort((a, b) => {
        const sa = order[String(a.status || "").toUpperCase()] || 99;
        const sb = order[String(b.status || "").toUpperCase()] || 99;
        if (sa !== sb) return sa - sb;

        const an = String(a.propertyName || "").toLowerCase();
        const bn = String(b.propertyName || "").toLowerCase();
        if (an < bn) return -1;
        if (an > bn) return 1;

        const aw = String(a.weekStart || "");
        const bw = String(b.weekStart || "");
        if (aw < bw) return -1;
        if (aw > bw) return 1;

        return 0;
      });

      if (!rows.length){
        tbody.innerHTML = `<tr><td colspan="8" class="muted">No rows.</td></tr>`;
        return;
      }

      function buildRow(r){
        const payWindow = buildPayWindowLabel(r.weekStart || currentMeta.weekStart, r.weekEnd || currentMeta.weekEnd);
        const partner = r.propertyName || ("Partner #" + (r.partnerId || ""));
        const status = r.status || "";
        const gross = (r.grossTotal != null ? String(r.grossTotal) : "");
        const fees  = (r.feesTotal  != null ? String(r.feesTotal)  : "");
        const net   = (r.netTotal   != null ? String(r.netTotal)   : "");
        const conf  = r.confirmationNumber || "";
        const paidAt = fmtDateOnly(r.paidAt);
        const updatedAt = fmtDateOnly(r.updatedAt);
        const paidOrUpdated = paidAt ? paidAt : (updatedAt ? updatedAt : "");

        return `
          <tr>
            <td class="nowrap">${esc(payWindow || "-")}</td>
            <td>${esc(partner)}</td>
            <td class="nowrap">${statusPill(status)}</td>
            <td class="right nowrap mono">${esc(gross || "")}</td>
            <td class="right nowrap mono">${esc(fees || "")}</td>
            <td class="right nowrap mono">${esc(net || "")}</td>
            <td><div class="mono">${esc(conf || "-")}</div></td>
            <td class="nowrap">${esc(paidOrUpdated || "-")}</td>
          </tr>
        `;
      }

      tbody.innerHTML = rows.map(buildRow).join("");
    }

    function renderSummary(){
      const left = document.getElementById("summaryLeft");
      const right = document.getElementById("summaryRight");

      // If footer elements were removed/reworked, just no-op safely
      if (!left || !right) return;

      const count = Array.isArray(ledgerRows) ? ledgerRows.length : 0;
      const payFridayLabel = ((document.getElementById("periodSel") || {}).selectedOptions || [])[0]?.textContent || currentMeta.payFriday || "";
      const partnerLabel = ((document.getElementById("partnerSel") || {}).selectedOptions || [])[0]?.textContent || "All partners";

      left.textContent = `${count} row(s). Period: ${payFridayLabel}. Partner: ${partnerLabel}.`;

      let gross = 0, fees = 0, net = 0;
      let any = false;

      for (const r of (Array.isArray(ledgerRows) ? ledgerRows : [])){
        const g = Number(r.grossTotal);
        const f = Number(r.feesTotal);
        const n = Number(r.netTotal);
        if (Number.isFinite(g) || Number.isFinite(f) || Number.isFinite(n)){
          if (Number.isFinite(g)) gross += g;
          if (Number.isFinite(f)) fees += f;
          if (Number.isFinite(n)) net += n;
          any = true;
        }
      }

      right.textContent = any ? `Totals (where available): gross ${gross.toFixed(2)} | fees ${fees.toFixed(2)} | net ${net.toFixed(2)}` : "";
    }

    function applyClientSearch(){
      const q = String(document.getElementById("searchBox").value || "").trim().toLowerCase();
      const rows = Array.from(document.querySelectorAll('tbody#tbody tr[data-row="1"]'));
      if (!q){ rows.forEach(tr => tr.style.display = ""); return; }
      rows.forEach(tr => {
        const txt = tr.textContent || "";
        tr.style.display = (txt.toLowerCase().includes(q)) ? "" : "none";
      });
    }

    function downloadCSV(){
      const headers = [
        "pay_window",
        "partner",
        "status",
        "booking_count",
        "gross",
        "fees",
        "net",
        "confirmation",
        "payout_id",
        "paid_or_updated"
      ];
      const lines = [headers.join(",")];

      for (const r of ledgerRows){
        const payWindow = buildPayWindowLabel(r.weekStart || currentMeta.weekStart, r.weekEnd || currentMeta.weekEnd);
        const partner = r.propertyName || ("Partner #" + (r.partnerId || ""));
        const status = String(r.status || "").toUpperCase();
        const bookingCount = (r.bookingCount != null ? String(r.bookingCount) : "");
        const gross = (r.grossTotal != null ? String(r.grossTotal) : "");
        const fees  = (r.feesTotal  != null ? String(r.feesTotal)  : "");
        const net   = (r.netTotal   != null ? String(r.netTotal)   : "");
        const conf  = r.confirmationNumber ? String(r.confirmationNumber) : "";
        const payoutId = r.payoutId ? String(r.payoutId) : "";
        const paidOrUpdated = fmtDateOnly(r.paidAt) || fmtDateOnly(r.updatedAt) || "";

        const row = [payWindow, partner, status, bookingCount, gross, fees, net, conf, payoutId, paidOrUpdated]
          .map(v => {
            const s = String(v == null ? "" : v);
            if (/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
            return s;
          })
          .join(",");

        lines.push(row);
      }

      const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);

      const partnerLabel = (document.getElementById("partnerSel").selectedOptions[0] || {}).textContent || "all_partners";
      const payFridayVal = (document.getElementById("periodSel").value || "period");
      const fn = `payout_ledger_${payFridayVal}_${partnerLabel}`.replace(/[^a-z0-9]+/gi, "_").replace(/^_+|_+$/g,"").toLowerCase() + ".csv";

      const a = document.createElement("a");
      a.href = url;
      a.download = fn;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 1000);
    }

    async function boot(){
      const ok = await requireAdmin();
      if (!ok) return;

      document.getElementById("btnLogout").addEventListener("click", () => {
        try { localStorage.removeItem(ADMIN_TOKEN_KEY); } catch(_) {}
        location.replace(LOGIN);
      });

      document.getElementById("refreshBtn").addEventListener("click", () => loadLedger().catch(showErr));
      document.getElementById("csvBtn").addEventListener("click", () => downloadCSV());

      document.getElementById("partnerSel").addEventListener("change", () => {
        const pid = Number(document.getElementById("partnerSel").value || 0);
        if (pid !== 0) {
          document.getElementById("periodSel").value = "YTD";
        }
        loadLedger().catch(showErr);
      });
      document.getElementById("periodSel").addEventListener("change", () => loadLedger().catch(showErr));

      for (const id of ["stReady","stDraft","stPaid"]){
        const el = document.getElementById(id);
        el.addEventListener("click", () => {
          el.classList.toggle("on");
          loadLedger().catch(showErr);
        });
      }

      document.getElementById("searchBox").addEventListener("input", () => {
        renderTable();
        renderSummary();
      });

      await loadPartners();
      await loadPeriods();
      await loadLedger();
    }

    function showErr(e){
      console.error(e);
      const tbody = document.getElementById("tbody");
      tbody.innerHTML = `<tr><td colspan="8" class="muted">Error loading ledger. Check console.</td></tr>`;
      document.getElementById("summaryLeft").textContent = "Error.";
      document.getElementById("summaryRight").textContent = "";
      document.getElementById("noPostedBanner").classList.remove("show");
    }

    boot().catch(showErr);
  </script>
</body>
</html>
