<!doctype html>
<html lang="en">
<head>
  <!-- Favicon -->
  <link rel="icon" href="https://www.lolaelo.com/images/logo3.png?v=4" type="image/png">
  <link rel="shortcut icon" href="https://www.lolaelo.com/images/logo3.png?v=4" type="image/png">
  <link rel="apple-touch-icon" href="https://www.lolaelo.com/images/logo3.png?v=4">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AP Payouts | Lolaelo Admin</title>

  <link rel="stylesheet" href="/css/extranet.css">

  <!-- Flatpickr (CDN) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    :root{
      --bg:#f6f8fc;
      --card:#ffffff;
      --fg:#0f172a;
      --muted:#5b6b84;
      --accent:#ff6a3d;
      --line:rgba(15,23,42,.12);
      --shadow:0 10px 30px rgba(15,23,42,.08);
    }
    *{ box-sizing:border-box }
    body{
      margin:0;
      background:var(--bg);
      color:var(--fg);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    button, input, select, textarea {
      font-family: inherit;
    }
    .wrap{ max-width:1200px; margin:0 auto; padding:18px 14px 30px; }

    .section-label{
      text-align:center;
      font-weight:500;
      font-size:13px;
      letter-spacing:.3px;
      color:#475569;
      background:rgba(15,118,110,.06); /* subtle teal wash */
      border:1px solid rgba(15,118,110,.18);
      border-radius:999px;
      padding:6px 14px;
      margin:14px auto 12px;
      width:fit-content;
    }

    .hero{
      border:1px solid var(--line);
      background:var(--card);
      border-radius:14px;
      padding:14px;
      box-shadow:var(--shadow);
    }
    .hero h1{ margin:0; font-size:18px; }
    .hero p{ margin:6px 0 0; color:var(--muted); font-size:13px; line-height:1.35; }

    .controls{
      display:flex; flex-wrap:wrap; gap:10px;
      margin:12px 0;
      align-items:flex-end;
    }
    label{ display:flex; flex-direction:column; gap:6px; font-size:12px; color:var(--muted); }
    .controls select, .controls input{
      background:#fff;
      border:1px solid var(--line);
      color:var(--fg);
      padding:9px 10px;
      border-radius:12px;
      font-size:13px;
      outline:none;
      min-width:220px;
    }
    /* header margin field narrower */
    .controls input.small{ min-width:90px; width:90px; }
    .controls input:focus, .controls select:focus{
      border-color:rgba(255,106,61,.55);
      box-shadow:0 0 0 3px rgba(255,106,61,.15);
    }

    .metaRow{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center;
      margin:6px 0 0;
      color:var(--muted);
      font-size:12px;
    }

    .pill b{ color:var(--fg); font-weight:700; }

    .table{
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
      background:var(--card);
      box-shadow:var(--shadow);
    }
    table{ width:100%; border-collapse:collapse; }
    th,td{
      border-bottom:1px solid rgba(15,23,42,.08);
      padding:10px 10px;
      font-size:13px;
      text-align:left;
      vertical-align:top;
    }
    th{ color:var(--muted); font-weight:700; background:#fbfcff; }
    tr:last-child td{ border-bottom:none; }
    .muted{ color:var(--muted); }
    .right{ text-align:right; }
    .mono{ font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .link{
      color:var(--accent);
      text-decoration:none;
      font-weight:700;
    }
    .link:hover{ text-decoration:underline; }

    .modal-header{
      text-align:center;
    }

    /* Flatpickr tweaks */
    .flatpickr-calendar{
      border-radius:14px !important;
      border:1px solid var(--line) !important;
      box-shadow:var(--shadow) !important;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial !important;
    }
    .flatpickr-day.selected, .flatpickr-day.startRange, .flatpickr-day.endRange,
    .flatpickr-day.selected.inRange, .flatpickr-day.startRange.inRange, .flatpickr-day.endRange.inRange{
      background:var(--accent) !important;
      border-color:var(--accent) !important;
    }
    .flatpickr-day.today{ border-color:rgba(255,106,61,.45) !important; }

    /* Modal */
    .modalOverlay{
      display:none;
      position:fixed; inset:0;
      background:rgba(2,6,23,.55);
      z-index:9999;
      padding:18px;
      overflow:auto;
    }
    .modal{
      max-width:1050px;
      margin:0 auto;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow:0 30px 90px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .modalHeader{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding:12px 14px;
      border-bottom:1px solid rgba(15,23,42,.08);
      background:#fbfcff;
    }
    .modalHeader .h{ display:flex; flex-direction:column; gap:2px; }
    .modalHeader .h .t{ font-weight:800; font-size:14px; }
    .modalHeader .h .s{ color:var(--muted); font-size:12px; }
    .modalBody{ padding:12px 14px; }
    .modalActions{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .kpiRow{ display:flex; flex-wrap:wrap; gap:10px; margin:0 0 10px; }
    .kpi{
      border:1px solid var(--line);
      background:#fff;
      border-radius:14px;
      padding:10px 12px;
      box-shadow:0 6px 18px rgba(15,23,42,.06);
      min-width:160px;
    }
    .kpi .k{ color:var(--muted); font-size:12px; }
    .kpi .v{ margin-top:4px; font-size:14px; font-weight:800; }
    .toast{
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
      min-height:16px;
    }
    .toast.bad{ color:#b42318; }
    .toast.ok{ color:#0f7a3a; }

    /* modal margin field narrower */
    .chipInput{
      width:60px;
      padding:7px 8px;
      border-radius:10px;
      border:1px solid var(--line);
      background:#fff;
      outline:none;
      font-size:13px;
      text-align:right;
    }
    .chipInput:focus{
      border-color:rgba(255,106,61,.55);
      box-shadow:0 0 0 3px rgba(255,106,61,.15);
    }
    .check{
      width:18px; height:18px;
      accent-color: var(--accent);
    }
    /* ANCHOR: HUB_HEADER_OVERRIDE */
    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:8px;
      padding:0;
    }

    .brandRow{
      display:flex;
      align-items:center;
      gap:12px;
      margin:0;
      padding:0;
    }

    .brandRow img{ height:64px; width:auto; display:block; }

    .pill{
      display:inline-block;
      font-size:11px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.18);
      color:#0f172a;
      font-weight:800;
      vertical-align:middle;
      background:#fff;
      white-space:nowrap;
    }

    .sub{ color:var(--muted); font-size:13px; margin:2px 0 0; }

    .btnRow{ display:flex; gap:10px; align-items:center; }

    .btn.ghost{
      background:#0b3a4a;
      border:1px solid rgba(11,58,74,.35);
      color:#ffffff !important;
      box-shadow:0 6px 18px rgba(15,23,42,.12);
      transition: transform .08s ease, background .15s ease, box-shadow .15s ease, border-color .15s ease;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:9px 12px;
      border-radius:999px;
      font-weight:800;
      font-size:13px;
    }

    .btn.ghost:hover{
      background: linear-gradient(90deg, #0b3a4a 0%, #0f5b63 100%);
      border-color: rgba(11,58,74,.55);
      transform: translateY(-1px);
    }

    .btn.ghost:active{ transform: translateY(0px); }

    .btn.ghost:focus{
      outline:none;
      box-shadow:0 0 0 4px rgba(11,58,74,.20), 0 6px 18px rgba(15,23,42,.12);
    }
    /* ANCHOR: HUB_HEADER_OVERRIDE END */

  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div>
        <div class="brandRow">
          <img src="/images/logo.png" alt="Lolaelo" />
          <span class="pill"> Accounts Payable </span>
        </div>
      </div>

      <div class="btnRow">
        <a class="btn ghost" href="/admin/index.html">Admin hub</a>
        <a class="btn ghost" href="/partners_app.html">Extranet</a>
        <button id="btnLogout" class="btn ghost" type="button">Sign out</button>
      </div>
    </div>

    <div class="hero">
      <h1>Accounts Payable – Partner payouts</h1>
      <p>
        Eligibility is completion-driven: status COMPLETED, completedAt in the pay window (ET), and not yet linked in PayoutBooking.
        Draft payouts link bookings; paid payouts record wire details.
      </p>
      <div class="metaRow">
        <span class="pill"><b>Status:</b> <span id="authStatus">Checking…</span></span>
        <span class="pill"><b>Pay window:</b> <span id="windowText">—</span></span>
      </div>
    </div>

    <div class="controls">
      <label>
        Pay period (pick any date in the week)
        <input id="weekPick" placeholder="Select a date…" />
      </label>

      <label>
        Partner (optional)
        <select id="partnerFilter">
          <option value="">All partners</option>
        </select>
      </label>

      <label>
        Default margin %
        <input id="defaultMargin" class="small" inputmode="decimal" placeholder="i.e. 10%" />
      </label>

      <button id="btnLoad" class="btn" type="button">Load</button>
      <button id="btnThisWeek" class="btn ghost" type="button">Last completed week</button>
      <button id="btnCurrentWeek" class="btn ghost" type="button">This week list</button>
    </div>

    <!-- Eligible rollup -->
    <div class="section-label">
      Review for Payment
    </div>
    <div class="table">
      <table>
        <thead>
          <tr>
            <th style="width:360px; text-align:center;">Partner</th>
            <th style="width:180px; text-align:center;">Pay window</th>
            <th style="width:170px; text-align:center;">Eligible bookings</th>
            <th class="right" style="width:170px; text-align:center;">Gross</th>
            <th style="width:220px; text-align:center;">Actions</th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr><td colspan="5" class="muted">No data loaded.</td></tr>
        </tbody>
      </table>
    </div>

    <div style="height:12px;"></div>

    <!-- Payouts list -->
    <div class="section-label">
      Reviewed & Waiting for Payment
    </div>
    <div class="table">
      <table>
        <thead>
          <tr>
            <th style="width:120px; text-align:center;">Payout ID</th>
            <th style="width:320px; text-align:center;">Partner</th>
            <th style="width:120px; text-align:center;">Status</th>
            <th style="width:140px; text-align:center;">Bookings</th>
            <th class="right" style="width:160px; text-align:center;">Gross Total</th>
            <th class="right" style="width:160px; text-align:center;">Total Commission</th>
            <th class="right" style="width:160px; text-align:center;">Net Amt Paid to Partner </th>
            <th style="width:260px; text-align:center;">Actions</th>
          </tr>
        </thead>
        <tbody id="payoutRows">
          <tr><td colspan="8" class="muted">No payouts available for the selected pay window.</td></tr>
        </tbody>
      </table>
    </div>

    <div id="pageToast" class="toast"></div>
  </div>

  <!-- Modal: create payout -->
  <div id="modalOverlay" class="modalOverlay" role="dialog" aria-modal="true" aria-label="Create payout">
    <div class="modal">
      <div class="modalHeader">
        <div class="h">
          <div class="t" id="modalTitle">Create payout</div>
          <div class="s" id="modalSub">—</div>
        </div>
        <div class="modalActions">
          <button class="btn ghost" type="button" id="btnCloseModal">Close</button>
        </div>
      </div>
      <div class="modalBody">
        <div class="kpiRow">
          <div class="kpi"><div class="k">Selected bookings</div><div class="v" id="kpiSelCount">0</div></div>
          <div class="kpi"><div class="k">Gross total</div><div class="v" id="kpiGross">USD 0.00</div></div>
          <div class="kpi"><div class="k">Total fees</div><div class="v" id="kpiFees">USD 0.00</div></div>
          <div class="kpi"><div class="k">Net amount paid</div><div class="v" id="kpiNet">USD 0.00</div></div>
          <div class="kpi"><div class="k">Week start</div><div class="v mono" id="kpiWeekStart">—</div></div>
          <div class="kpi"><div class="k">Week end</div><div class="v mono" id="kpiWeekEnd">—</div></div>
        </div>

        <div class="table" style="box-shadow:none;">
          <table>
            <thead>
              <tr>
                <th style="width:80px;">Include</th>
                <th style="width:150px;">Booking ref</th>
                <th style="width:120px;">Status</th>
                <th style="width:210px;">Stay dates</th>
                <th style="width:190px;">Completed at</th>
                <th class="right" style="width:140px;">Gross</th>
                <th class="right" style="width:110px;">Margin %</th>
                <th class="right" style="width:140px;">Fee</th>
                <th class="right" style="width:160px;">Net amount paid</th>
              </tr>
            </thead>
            <tbody id="modalRows">
              <tr><td colspan="9" class="muted">Loading…</td></tr>
            </tbody>
          </table>
        </div>

        <div style="display:flex; justify-content:space-between; gap:12px; margin-top:12px; flex-wrap:wrap; align-items:center;">
          <div class="muted" style="font-size:12px;">
            Draft creation links selected bookings to a payout. Mark paid is available in the payouts list below.
          </div>
          <button id="btnCreateDraft" class="btn" type="button">Create payout (Draft)</button>
        </div>

        <div id="modalToast" class="toast"></div>
      </div>
    </div>
  </div>

  <!-- Modal: payout details -->
  <div id="payoutOverlay" class="modalOverlay" role="dialog" aria-modal="true" aria-label="Payout details">
    <div class="modal">
      <div class="modalHeader">
        <div class="h">
          <div class="t" id="payoutTitle">Payout</div>
          <div class="s" id="payoutSub">—</div>
        </div>
        <div class="modalActions">
          <button class="btn ghost" type="button" id="btnClosePayout">Close</button>
        </div>
      </div>
      <div class="modalBody">
        <div class="kpiRow">
          <div class="kpi"><div class="k">Gross total</div><div class="v" id="payoutGross">USD 0.00</div></div>
          <div class="kpi"><div class="k">Total fees</div><div class="v" id="payoutFees">USD 0.00</div></div>
          <div class="kpi"><div class="k">Net amount paid</div><div class="v" id="payoutNet">USD 0.00</div></div>
          <div class="kpi"><div class="k">Status</div><div class="v" id="payoutStatus">—</div></div>
        </div>

        <div class="table" style="box-shadow:none;">
          <table>
            <thead>
              <tr>
                <th style="width:150px;">Booking ref</th>
                <th style="width:210px;">Stay dates</th>
                <th class="right" style="width:140px;">Gross</th>
                <th class="right" style="width:110px;">Margin %</th>
                <th class="right" style="width:140px;">Fee</th>
                <th class="right" style="width:160px;">Net amount paid</th>
              </tr>
            </thead>
            <tbody id="payoutBookingRows">
              <tr><td colspan="6" class="muted">Loading…</td></tr>
            </tbody>
          </table>
        </div>

        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:12px; flex-wrap:wrap;">
          <button class="btn" type="button" id="btnOpenMarkPaid">Mark paid</button>
        </div>

        <div id="payoutToast" class="toast"></div>
      </div>
    </div>
  </div>

  <!-- Modal: mark paid -->
  <div id="paidOverlay" class="modalOverlay" role="dialog" aria-modal="true" aria-label="Mark payout paid">
    <div class="modal" style="max-width:720px;">
      <div class="modalHeader">
        <div class="h">
          <div class="t">Mark payout paid</div>
          <div class="s" id="paidSub">—</div>
        </div>
        <div class="modalActions">
          <button class="btn ghost" type="button" id="btnClosePaid">Close</button>
        </div>
      </div>
      <div class="modalBody">
        <div class="controls" style="margin:0;">
          <label>Net amount paid
            <input id="paidAmountNet" class="small" inputmode="decimal" />
          </label>
          <label>Method
            <input id="paidMethod" class="small" placeholder="Wire" />
          </label>
          <label>Confirmation / reference
            <input id="paidConf" style="min-width:240px;" placeholder="Bank reference" />
          </label>
          <label>Paid at (default Fri 21:00 ET)
            <input id="paidAt" style="min-width:240px;" placeholder="YYYY-MM-DDTHH:mm" />
          </label>
        </div>

        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:12px;">
          <button id="btnSubmitPaid" class="btn" type="button">Mark paid</button>
        </div>

        <div id="paidToast" class="toast"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <script>
    (function(){
      const ADMIN_TOKEN_KEY = "lolaelo_admin_session";
      const LOGIN = "/admin/login.html";
      const API_BASE = location.origin;
      const $ = (id) => document.getElementById(id);

      let lastRollupRows = [];
      let currentPartnerId = null;
      let currentCurrency = "USD";
      let currentWeekStart = "";
      let currentWeekEnd = "";
      let currentBookings = [];
      let defaultMarginPct = 0;

      let currentPayoutId = null;
      let currentPayout = null;
      let currentPayoutBookings = [];

      function getAdminToken(){
        try { return localStorage.getItem(ADMIN_TOKEN_KEY) || ""; } catch { return ""; }
      }
      function authHeaders(){
        const t = String(getAdminToken() || "").trim();
        return { "Authorization": "Bearer " + t };
      }

      function money(n, currency){
        const num = Number(n || 0);
        const c = String(currency || "USD");
        if (!Number.isFinite(num)) return c + " 0.00";
        return c + " " + num.toFixed(2);
      }

      function setAuthStatus(txt){ const el = $("authStatus"); if (el) el.textContent = txt; }
      function setPageToast(msg, kind){
        const el = $("pageToast"); if (!el) return;
        el.textContent = msg || "";
        el.className = "toast" + (kind ? (" " + kind) : "");
      }
      function setModalToast(msg, kind){
        const el = $("modalToast"); if (!el) return;
        el.textContent = msg || "";
        el.className = "toast" + (kind ? (" " + kind) : "");
      }

      function escapeHtml(s){
        return String(s == null ? "" : s)
          .replace(/&/g,"&amp;")
          .replace(/</g,"&lt;")
          .replace(/>/g,"&gt;")
          .replace(/"/g,"&quot;")
          .replace(/'/g,"&#039;");
      }

      function mondayOf(d){
        const x = new Date(d.getFullYear(), d.getMonth(), d.getDate());
        const day = x.getDay();
        const diff = (day === 0) ? -6 : (1 - day);
        x.setDate(x.getDate() + diff);
        x.setHours(0,0,0,0);
        return x;
      }
      function ymd(d){
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,"0");
        const da = String(d.getDate()).padStart(2,"0");
        return `${y}-${m}-${da}`;
      }
      function addDays(date, days){
        const d = new Date(date.getTime());
        d.setDate(d.getDate() + days);
        return d;
      }
      function lastCompletedWeekStart(){
        const now = new Date();
        const thisMon = mondayOf(now);
        return addDays(thisMon, -7);
      }

      function normalizeWeekStartYmd(input){
        const s = String(input || "").trim();
        const m = s.match(/^(\d{4}-\d{2}-\d{2})/);
        if (m) return m[1];

        const d = new Date(s);
        if (!isNaN(d.getTime())) return ymd(d);

        return "";
      }

      // Accepts either "YYYY-MM-DD" OR an ISO string like "2026-01-19T00:00:00.000Z"
      function defaultPaidAtEtIso(weekStartLike){
        const wsYmd = normalizeWeekStartYmd(weekStartLike) || currentWeekStart;
        const ws = new Date(wsYmd + "T00:00:00");
        if (isNaN(ws.getTime())) return "";
        const d = addDays(ws, 11); // Fri 21:00 relative to weekStart (Mon)
        return `${ymd(d)}T21:00`;
      }

      async function ensureAdmin(){
        const t = String(getAdminToken() || "").trim();
        if (!t) { location.replace(LOGIN); return false; }
        const r = await fetch("/api/admin/ping", { headers: authHeaders() }).catch(() => null);
        if (!r || !r.ok) {
          try { localStorage.removeItem(ADMIN_TOKEN_KEY); } catch {}
          location.replace(LOGIN);
          return false;
        }
        return true;
      }

      function setWindowText(weekStartYmd){
        const ws = new Date(weekStartYmd + "T00:00:00");
        const we = addDays(ws, 6);
        currentWeekStart = ymd(ws);
        currentWeekEnd = ymd(we);
        const el = $("windowText");
        if (el) el.textContent = `${currentWeekStart} to ${currentWeekEnd}`;
      }

      function setMarginText(){
        const el = $("marginText");
        if (el) el.textContent = `${Number(defaultMarginPct || 0).toFixed(2).replace(/\.00$/,"")}%`;
      }

      async function fetchJSON(path, opts){
        const r = await fetch(API_BASE + path, { ...(opts||{}), headers: { ...(opts?.headers||{}), ...authHeaders() } });
        if (r.status === 401) {
          try { localStorage.removeItem(ADMIN_TOKEN_KEY); } catch {}
          location.replace(LOGIN);
          return null;
        }
        const data = await r.json().catch(() => null);
        if (!r.ok) {
          const msg = (data && (data.error || data.message)) ? String(data.error || data.message) : `HTTP ${r.status}`;
          throw new Error(msg);
        }
        return data;
      }

      function renderPartnerFilter(rows){
        const sel = $("partnerFilter");
        const current = String(sel.value || "");
        const opts = [`<option value="">All partners</option>`]
          .concat(rows.map(r => `<option value="${String(r.partnerId)}">${escapeHtml(r.propertyName || ("Partner #" + r.partnerId))}</option>`));
        sel.innerHTML = opts.join("");
        if (current) sel.value = current;
      }

      function setRowsLoading(){ $("rows").innerHTML = `<tr><td colspan="5" class="muted">Loading…</td></tr>`; }
      function setRowsEmpty(){ $("rows").innerHTML = `<tr><td colspan="5" class="muted">No eligible bookings for this pay period.</td></tr>`; }

      function renderRollups(rows, weekStartYmd){
        lastRollupRows = rows || [];
        const selPartner = String($("partnerFilter").value || "");
        const view = selPartner ? rows.filter(r => String(r.partnerId) === selPartner) : rows;

        if (!view.length) { setRowsEmpty(); return; }

        $("rows").innerHTML = view.map(r => {
          const name = escapeHtml(r.propertyName || ("Partner #" + r.partnerId));
          const ws = escapeHtml(r.weekStart || weekStartYmd);
          const we = escapeHtml(r.weekEnd || "");
          const count = Number(r.bookingCount || 0);
          const gross = r.amountGross;

          return `
            <tr>
              <td>
                <div style="font-weight:800;">${name}</div>
                <div class="muted" style="font-size:12px; margin-top:2px;">Partner ID: <span class="mono">${escapeHtml(r.partnerId)}</span></div>
              </td>
              <td class="mono">${ws}${we ? (" to " + we) : ""}</td>
              <td>${count}</td>
              <td class="right">${money(gross, "USD")}</td>
              <td>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                  <button class="btn ghost" type="button" onclick="window.openCreatePayout('${escapeHtml(r.partnerId)}','${escapeHtml(name)}')">Create payout</button>
                </div>
              </td>
            </tr>
          `;
        }).join("");
      }

      function openModal(id){
        const o = $(id);
        if (o) o.style.display = "block";
        document.body.style.overflow = "hidden";
      }
      function closeModal(id){
        const o = $(id);
        if (o) o.style.display = "none";
        document.body.style.overflow = "";
      }

      function fmtDate(d){
        if (!d) return "—";
        const s = String(d);
        const ymdMatch = /^\d{4}-\d{2}-\d{2}/.test(s) ? s.slice(0,10) : "";
        return ymdMatch || s;
      }

      function parsePct(v){
        const n = Number(String(v||"").replace("%","").trim());
        if (!Number.isFinite(n)) return 0;
        if (n < 0) return 0;
        if (n > 100) return 100;
        return n;
      }

      function recalcModalTotals(){
        let selCount = 0, grossSum = 0, feeSum = 0, netSum = 0;
        for (const b of currentBookings) {
          if (!b._include) continue;
          selCount++;
          const gross = Number(b.amountGross != null ? b.amountGross : b.amountPaid) || 0;
          const pct = Number(b._marginPct || 0) || 0;
          const fee = Math.round(gross * (pct/100) * 100) / 100;
          const net = Math.round((gross - fee) * 100) / 100;
          grossSum += gross; feeSum += fee; netSum += net;
        }
        $("kpiSelCount").textContent = String(selCount);
        $("kpiGross").textContent = money(grossSum, currentCurrency);
        $("kpiFees").textContent = money(feeSum, currentCurrency);
        $("kpiNet").textContent = money(netSum, currentCurrency);
      }

      function renderModalRows(){
        if (!currentBookings.length) {
          $("modalRows").innerHTML = `<tr><td colspan="9" class="muted">No bookings found.</td></tr>`;
          recalcModalTotals();
          return;
        }

        $("modalRows").innerHTML = currentBookings.map((r, idx) => {
          const ref = escapeHtml(r.bookingRef || "");
          const st = escapeHtml(r.status || "");
          const stay = `${escapeHtml(fmtDate(r.checkInDate))} to ${escapeHtml(fmtDate(r.checkOutDate))}`;
          const comp = escapeHtml(String(r.completedAt || "—"));

          const gross = Number(r.amountGross != null ? r.amountGross : r.amountPaid) || 0;
          const pct = Number(r._marginPct || 0) || 0;
          const fee = Math.round(gross * (pct/100) * 100) / 100;
          const net = Math.round((gross - fee) * 100) / 100;

          const checked = r._include ? "checked" : "";
          return `
            <tr>
              <td><input class="check" type="checkbox" data-idx="${idx}" data-k="include" ${checked} /></td>
              <td class="mono"><span class="link">${ref}</span></td>
              <td>${st}</td>
              <td class="mono">${stay}</td>
              <td class="mono">${comp}</td>
              <td class="right mono">${escapeHtml(money(gross, currentCurrency))}</td>
              <td class="right">
                <input class="chipInput" data-idx="${idx}" data-k="pct" value="${pct.toFixed(2).replace(/\.00$/,"")}" />
              </td>
              <td class="right mono">${escapeHtml(money(fee, currentCurrency))}</td>
              <td class="right mono">${escapeHtml(money(net, currentCurrency))}</td>
            </tr>
          `;
        }).join("");

        $("modalRows").querySelectorAll("input[data-k='include']").forEach(el => {
          el.addEventListener("change", (e) => {
            const idx = Number(e.target.getAttribute("data-idx"));
            currentBookings[idx]._include = !!e.target.checked;
            recalcModalTotals();
          });
        });

        $("modalRows").querySelectorAll("input[data-k='pct']").forEach(el => {
          el.addEventListener("input", (e) => {
            const idx = Number(e.target.getAttribute("data-idx"));
            const val = parsePct(e.target.value);
            currentBookings[idx]._marginPct = val;
            renderModalRows();
          });
        });

        recalcModalTotals();
      }

      async function loadRollup(){
        setRowsLoading();
        const data = await fetchJSON(`/api/admin/ap/ready?weekStart=${encodeURIComponent(currentWeekStart)}`);
        const rows = (data && data.ok && Array.isArray(data.rows)) ? data.rows : [];
        renderPartnerFilter(rows);
        renderRollups(rows, currentWeekStart);
      }

      function setPayoutRowsLoading(){
        $("payoutRows").innerHTML = `<tr><td colspan="8" class="muted">Loading…</td></tr>`;
      }
      function setPayoutRowsEmpty(){
        $("payoutRows").innerHTML = `<tr><td colspan="8" class="muted">No payouts for this pay period.</td></tr>`;
      }

      async function loadPayouts(){
        setPayoutRowsLoading();
        const selPartner = String($("partnerFilter").value || "");
        const pid = selPartner ? Number(selPartner) : 0;

        const data = await fetchJSON(`/api/admin/ap/payouts?weekStart=${encodeURIComponent(currentWeekStart)}&partnerId=${encodeURIComponent(pid)}`);
        const rows = (data && data.ok && Array.isArray(data.rows)) ? data.rows : [];

        if (!rows.length) { setPayoutRowsEmpty(); return; }

        $("payoutRows").innerHTML = rows.map(r => {
          const id = Number(r.id);
          const name = escapeHtml(r.propertyName || ("Partner #" + r.partnerId));
          const st = escapeHtml(String(r.status || ""));
          const bc = Number(r.bookingCount || 0);

          const gross = r.grossTotal;
          const fees = r.feesTotal;
          const net = r.netTotal;
          const cur = String(r.currency || "USD").toUpperCase();

          const canMarkPaid = String(r.status || "") === "DRAFT";

          return `
            <tr>
              <td class="mono">${id}</td>
              <td>
                <div style="font-weight:800;">${name}</div>
                <div class="muted" style="font-size:12px; margin-top:2px;">Partner ID: <span class="mono">${escapeHtml(r.partnerId)}</span></div>
              </td>
              <td>${st}</td>
              <td>${bc}</td>
              <td class="right mono">${escapeHtml(money(gross, cur))}</td>
              <td class="right mono">${escapeHtml(money(fees, cur))}</td>
              <td class="right mono">${escapeHtml(money(net, cur))}</td>
              <td style="text-align:center;">
                <div style="display:inline-flex; gap:8px; flex-wrap:wrap;">
                  <button class="btn ghost" type="button" onclick="window.openPayout(${id})">View</button>
                  ${canMarkPaid ? `<button class="btn" type="button" onclick="window.openMarkPaid(${id})">Mark paid</button>` : ``}
                </div>
              </td>
            </tr>
          `;
        }).join("");
      }

      async function loadBookingsForPartner(partnerId){
        const data = await fetchJSON(`/api/admin/ap/ready/bookings?partnerId=${encodeURIComponent(partnerId)}&weekStart=${encodeURIComponent(currentWeekStart)}`);
        const rows = (data && data.ok && Array.isArray(data.rows)) ? data.rows : [];

        currentBookings = rows.map(r => ({
          ...r,
          _include: true,
          _marginPct: Number(defaultMarginPct || 0) || 0
        }));

        currentCurrency = String(rows[0]?.currency || "USD").toUpperCase();

        $("kpiWeekStart").textContent = currentWeekStart;
        $("kpiWeekEnd").textContent = currentWeekEnd;

        renderModalRows();
      }

      async function createDraft(){
        setModalToast("Creating draft payout…", "");
        const selected = currentBookings.filter(b => b._include);

        if (!selected.length) {
          setModalToast("Select at least one booking.", "bad");
          return;
        }

        const payload = {
          partnerId: Number(currentPartnerId),
          weekStart: currentWeekStart,
          currency: currentCurrency,
          createdBy: "admin",
          items: selected.map(b => ({
            bookingId: Number(b.id),
            marginPct: Number(b._marginPct || 0) || 0
          }))
        };

        try {
          const data = await fetchJSON(`/api/admin/ap/payouts`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });

          if (data && data.ok && data.payout && data.payout.id) {
            setModalToast(`Draft payout created. Payout ID: ${data.payout.id}`, "ok");
            setPageToast(`Draft payout created for Partner ${currentPartnerId} (Payout ID ${data.payout.id}).`, "ok");
            await loadRollup();
            await loadPayouts();
            setTimeout(() => closeModal("modalOverlay"), 600);
          } else {
            setModalToast("Failed creating payout.", "bad");
          }
        } catch (e) {
          setModalToast(`Failed: ${String(e.message || e)}`, "bad");
        }
      }

      window.openCreatePayout = async function(partnerId){
        currentPartnerId = Number(partnerId);

        $("modalTitle").textContent = `Create payout – Partner ${currentPartnerId}`;
        $("modalSub").textContent = `Pay period: ${currentWeekStart} to ${currentWeekEnd} · Default margin ${Number(defaultMarginPct||0).toFixed(2).replace(/\.00$/,"")}%`;
        setModalToast("", "");

        openModal("modalOverlay");
        $("modalRows").innerHTML = `<tr><td colspan="9" class="muted">Loading…</td></tr>`;

        try {
          await loadBookingsForPartner(currentPartnerId);
        } catch (e) {
          $("modalRows").innerHTML = `<tr><td colspan="9" class="muted">Failed: ${escapeHtml(String(e.message || e))}</td></tr>`;
        }
      };

      window.openPayout = async function(payoutId){
        currentPayoutId = Number(payoutId);
        openModal("payoutOverlay");
        $("payoutBookingRows").innerHTML = `<tr><td colspan="6" class="muted">Loading…</td></tr>`;
        $("payoutToast").textContent = "";

        try {
          const data = await fetchJSON(`/api/admin/ap/payouts/${encodeURIComponent(currentPayoutId)}/bookings`);
          currentPayout = data.payout;
          currentPayoutBookings = data.bookings || [];

          $("payoutTitle").textContent = `Payout ${currentPayoutId} · Partner ${currentPayout.partnerId}`;
          $("payoutSub").textContent = `Pay period: ${currentPayout.weekStart} to ${currentPayout.weekEnd} · Created by ${currentPayout.createdBy || "admin"}`;

          const gross = currentPayoutBookings.reduce((s,b)=>s+(Number(b.grossAmount||0)||0),0);
          const fees = currentPayoutBookings.reduce((s,b)=>s+(Number(b.feeAmount||0)||0),0);
          const net  = currentPayoutBookings.reduce((s,b)=>s+(Number(b.netAmount||0)||0),0);
          const cur = String(currentPayout.currency || "USD").toUpperCase();

          $("payoutGross").textContent = money(gross, cur);
          $("payoutFees").textContent = money(fees, cur);
          $("payoutNet").textContent = money(net, cur);
          $("payoutStatus").textContent = String(currentPayout.status || "");

          $("payoutBookingRows").innerHTML = currentPayoutBookings.map(b => {
            const ref = escapeHtml(b.bookingRef || "");
            const stay = `${escapeHtml(fmtDate(b.checkInDate))} to ${escapeHtml(fmtDate(b.checkOutDate))}`;
            const grossAmt = money(b.grossAmount, cur);
            const pct = (b.marginPct != null ? Number(b.marginPct) : 0);
            const feeAmt = money(b.feeAmount, cur);
            const netAmt = money(b.netAmount, cur);

            return `
              <tr>
                <td class="mono">${ref}</td>
                <td class="mono">${stay}</td>
                <td class="right mono">${escapeHtml(grossAmt)}</td>
                <td class="right mono">${escapeHtml((Number.isFinite(pct)?pct:0).toFixed(2).replace(/\.00$/,"") + "%")}</td>
                <td class="right mono">${escapeHtml(feeAmt)}</td>
                <td class="right mono">${escapeHtml(netAmt)}</td>
              </tr>
            `;
          }).join("");

        } catch (e) {
          $("payoutBookingRows").innerHTML = `<tr><td colspan="6" class="muted">Failed: ${escapeHtml(String(e.message || e))}</td></tr>`;
        }
      };

      window.openMarkPaid = async function(payoutId){
        currentPayoutId = Number(payoutId);
        openModal("paidOverlay");
        $("paidToast").textContent = "";
        $("paidToast").className = "toast";

        try {
          const data = await fetchJSON(`/api/admin/ap/payouts/${encodeURIComponent(currentPayoutId)}/bookings`);
          const p = data.payout;
          const bookings = data.bookings || [];
          const net = bookings.reduce((s,b)=>s+(Number(b.netAmount||0)||0),0);
          const cur = String(p.currency || "USD").toUpperCase();

          $("paidSub").textContent = `Payout ${currentPayoutId} · Partner ${p.partnerId} · Pay period ${p.weekStart} to ${p.weekEnd}`;
          $("paidAmountNet").value = String(Math.round(net * 100) / 100);
          $("paidMethod").value = "Wire";
          $("paidConf").value = "";
          $("paidAt").value = defaultPaidAtEtIso(String(p.weekStart || currentWeekStart));
          currentCurrency = cur;
        } catch {
          $("paidSub").textContent = `Payout ${currentPayoutId}`;
          $("paidAmountNet").value = "";
          $("paidMethod").value = "Wire";
          $("paidConf").value = "";
          $("paidAt").value = defaultPaidAtEtIso(currentWeekStart);
        }
      };

      async function submitPaid(){
        const amountNet = Number($("paidAmountNet").value || 0);
        const method = String($("paidMethod").value || "").trim();
        const confirmationNumber = String($("paidConf").value || "").trim();
        const paidAt = String($("paidAt").value || "").trim();

        if (!Number.isFinite(amountNet) || amountNet <= 0) { $("paidToast").textContent = "Net amount paid required."; $("paidToast").className="toast bad"; return; }
        if (!method) { $("paidToast").textContent = "Method required."; $("paidToast").className="toast bad"; return; }
        if (!confirmationNumber) { $("paidToast").textContent = "Confirmation/reference required."; $("paidToast").className="toast bad"; return; }

        $("paidToast").textContent = "Marking paid…";
        $("paidToast").className = "toast";

        try {
          await fetchJSON(`/api/admin/ap/payouts/${encodeURIComponent(currentPayoutId)}/mark-paid`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ amountNet, method, confirmationNumber, paidAt })
          });

          if (!paidAt) { $("paidToast").textContent = "Paid at required."; $("paidToast").className="toast bad"; return; }
          const paidAtDate = new Date(paidAt);
          if (isNaN(paidAtDate.getTime())) { $("paidToast").textContent = "Paid at is invalid. Use YYYY-MM-DDTHH:mm"; $("paidToast").className="toast bad"; return; }

          $("paidToast").textContent = "Marked PAID.";
          $("paidToast").className = "toast ok";

          await loadRollup();
          await loadPayouts();

          setTimeout(() => {
            closeModal("paidOverlay");
            closeModal("payoutOverlay");
          }, 450);

        } catch (e) {
          $("paidToast").textContent = `Failed: ${String(e.message || e)}`;
          $("paidToast").className = "toast bad";
        }
      }

      // Wire UI
      $("btnCloseModal").onclick = () => closeModal("modalOverlay");
      $("modalOverlay").addEventListener("click", (e) => { if (e.target && e.target.id === "modalOverlay") closeModal("modalOverlay"); });
      $("btnCreateDraft").onclick = createDraft;

      $("btnClosePayout").onclick = () => closeModal("payoutOverlay");
      $("payoutOverlay").addEventListener("click", (e) => { if (e.target && e.target.id === "payoutOverlay") closeModal("payoutOverlay"); });

      $("btnClosePaid").onclick = () => closeModal("paidOverlay");
      $("paidOverlay").addEventListener("click", (e) => { if (e.target && e.target.id === "paidOverlay") closeModal("paidOverlay"); });

      $("btnOpenMarkPaid").onclick = () => { if (currentPayoutId) window.openMarkPaid(currentPayoutId); };
      $("btnSubmitPaid").onclick = submitPaid;

      $("btnLogout").onclick = () => {
        try { localStorage.removeItem(ADMIN_TOKEN_KEY); } catch {}
        location.replace(LOGIN);
      };

      $("partnerFilter").addEventListener("change", async () => {
        renderRollups(lastRollupRows || [], currentWeekStart);
        await loadPayouts();
      });

      $("defaultMargin").addEventListener("input", () => {
        defaultMarginPct = parsePct($("defaultMargin").value);
        setMarginText();
      });

      $("btnLoad").onclick = async () => {
        setPageToast("", "");
        await loadRollup().catch((e) => {
          $("rows").innerHTML = `<tr><td colspan="5" class="muted">Failed: ${escapeHtml(String(e.message || e))}</td></tr>`;
        });
        await loadPayouts().catch(() => {});
      };

      $("btnThisWeek").onclick = () => {
        const ws = lastCompletedWeekStart();
        const wsYmd = ymd(ws);
        $("weekPick")._flatpickr.setDate(ws, true);
        setWindowText(wsYmd);
        $("btnLoad").click();
      };

      $("btnCurrentWeek").onclick = () => {
        const now = new Date();
        const ws = mondayOf(now); // current week Monday
        const wsYmd = ymd(ws);
        $("weekPick")._flatpickr.setDate(ws, true);
        setWindowText(wsYmd);
        $("btnLoad").click();
      };

      // Init
      (async function boot(){
        const ok = await ensureAdmin();
        if (!ok) return;

        setAuthStatus("Ready");

        flatpickr("#weekPick", {
          dateFormat: "Y-m-d",
          allowInput: true,
          defaultDate: lastCompletedWeekStart(),
          onChange: function(selectedDates){
            const d = selectedDates && selectedDates[0] ? selectedDates[0] : lastCompletedWeekStart();
            const ws = mondayOf(d);
            setWindowText(ymd(ws));
          }
        });

        setWindowText(ymd(lastCompletedWeekStart()));
        defaultMarginPct = parsePct($("defaultMargin").value);
        setMarginText();

        $("btnLoad").click();
      })();
    })();
  </script>
</body>
</html>
