<!doctype html>
<html lang="en">
<head>
  <!-- Favicon -->
  <link rel="icon" href="https://www.lolaelo.com/images/logo3.png?v=4" type="image/png">
  <link rel="shortcut icon" href="https://www.lolaelo.com/images/logo3.png?v=4" type="image/png">
  <link rel="apple-touch-icon" href="https://www.lolaelo.com/images/logo3.png?v=4">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Exceptions | Lolaelo Admin</title>

  <link rel="stylesheet" href="/css/extranet.css">

  <style>
    :root{
      --bg:#f6f8fc;
      --card:#ffffff;
      --fg:#0f172a;
      --muted:#5b6b84;
      --accent:#ff6a3d;
      --line:rgba(15,23,42,.12);
      --shadow:0 10px 30px rgba(15,23,42,.08);
      --teal:#0b3a4a;
    }
    *{ box-sizing:border-box }
    body{
      margin:0;
      background:var(--bg);
      color:var(--fg);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      min-height:100vh;
    }
    button, input, select, textarea{ font-family:inherit; }
    .wrap{ max-width:1200px; margin:0 auto; padding:18px 14px 30px; }

    /* Header aligned with other admin pages */
    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:8px;
      padding:0;
    }
    .brandRow{
      display:flex;
      align-items:center;
      gap:12px;
      margin:0;
      padding:0;
    }
    .brandRow img{ height:64px; width:auto; display:block; }
    .pill{
      display:inline-block;
      font-size:11px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.18);
      color:#0f172a;
      font-weight:800;
      vertical-align:middle;
      background:#fff;
      white-space:nowrap;
    }
    .sub{ color:var(--muted); font-size:13px; margin:2px 0 0; }
    .btnRow{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    .btn.ghost{
      background:var(--teal);
      border:1px solid rgba(11,58,74,.35);
      color:#ffffff !important;
      box-shadow:0 6px 18px rgba(15,23,42,.12);
      transition: transform .08s ease, background .15s ease, box-shadow .15s ease, border-color .15s ease;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:9px 12px;
      border-radius:999px;
      font-weight:800;
      font-size:13px;
      cursor:pointer;
    }
    .btn.ghost:hover{
      background: linear-gradient(90deg, #0b3a4a 0%, #0f5b63 100%);
      border-color: rgba(11,58,74,.55);
      transform: translateY(-1px);
    }
    .btn.ghost:active{ transform: translateY(0px); }
    .btn.ghost:focus{
      outline:none;
      box-shadow:0 0 0 4px rgba(11,58,74,.20), 0 6px 18px rgba(15,23,42,.12);
    }

    .hero{
      border:1px solid var(--line);
      background:var(--card);
      border-radius:14px;
      padding:14px;
      box-shadow:var(--shadow);
    }
    .hero h1{ margin:0; font-size:18px; }
    .hero p{ margin:6px 0 0; color:var(--muted); font-size:13px; line-height:1.35; }

    .metaRow{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center;
      margin:10px 0 0;
      color:var(--muted);
      font-size:12px;
    }

    .controls{
      display:flex; flex-wrap:wrap; gap:10px;
      margin:12px 0 0;
      align-items:flex-end;
    }
    label{ display:flex; flex-direction:column; gap:6px; font-size:12px; color:var(--muted); }
    .controls input, .controls select{
      background:#fff;
      border:1px solid var(--line);
      color:var(--fg);
      padding:9px 10px;
      border-radius:12px;
      font-size:13px;
      outline:none;
      min-width:220px;
    }
    .controls input.search{ min-width:320px; }
    .controls input:focus, .controls select:focus{
      border-color:rgba(255,106,61,.55);
      box-shadow:0 0 0 3px rgba(255,106,61,.15);
    }

    .toast{
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
      min-height:16px;
    }
    .toast.bad{ color:#b42318; }
    .toast.ok{ color:#0f7a3a; }

    .table{
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
      background:var(--card);
      box-shadow:var(--shadow);
      margin-top:12px;
    }
    table{ width:100%; border-collapse:collapse; }
    th,td{
      border-bottom:1px solid rgba(15,23,42,.08);
      padding:10px 10px;
      font-size:13px;
      text-align:left;
      vertical-align:top;
    }
    th{ color:var(--muted); font-weight:700; background:#fbfcff; font-size:12px; letter-spacing:.2px; }
    tr:last-child td{ border-bottom:none; }

    .right{ text-align:right; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .muted{ color:var(--muted); }

    .link{
      color: var(--accent);
      text-decoration:none;
      font-weight:800;
    }
    .link:hover{ text-decoration:underline; }

    .tag{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.14);
      font-size:11px;
      color:var(--muted);
      background:#fff;
      font-weight:800;
      white-space:nowrap;
    }
    .tag.warn{
      border-color: rgba(250,204,21,.55);
      background: rgba(250,204,21,.10);
      color:#0f172a;
    }
    .tag.danger{
      border-color: rgba(180,35,24,.35);
      background: rgba(180,35,24,.06);
      color:#7a1b12;
    }

    .empty{
      margin-top:12px;
      padding:12px;
      color:var(--muted);
      font-size:13px;
      border:1px solid var(--line);
      border-radius:12px;
      background:#fff;
      display:none;
    }
    /* Row priority cues */
    tr.pri-danger td { border-left: 4px solid #b42318; }
    tr.pri-warn   td { border-left: 4px solid #f59e0b; }
    tr.pri-neutral td { border-left: 4px solid transparent; }

  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div>
        <div class="brandRow">
          <img src="/images/logo.png" alt="Lolaelo" />
        </div>
        <div class="sub">Operational inbox. Refund holds within the selected horizon.</div>
      </div>

      <div class="btnRow">
        <a class="btn ghost" href="/admin/index.html">Admin hub</a>
        <a class="btn ghost" href="/partners_app.html">Extranet</a>
        <button id="btnLogout" class="btn ghost" type="button">Sign out</button>
      </div>
    </div>

    <div class="hero">
      <h1>Exceptions</h1>
      <p>Refund holds within the selected horizon window.</p>

      <div class="metaRow">
        <span class="pill"><b>Status:</b> <span id="authStatus">Checking...</span></span>
        <span class="pill"><b>Count:</b> <span id="kpiCount">0</span></span>
        <span class="pill"><b>Updated:</b> <span id="kpiUpdated" class="mono">-</span></span>
      </div>

      <div class="controls">
        <label>
          Horizon days
          <select id="daysSel">
            <option value="7">7</option>
            <option value="14">14</option>
            <option value="30" selected>30</option>
            <option value="60">60</option>
          </select>
        </label>

        <label>
          Search
          <input id="searchBox" class="search" type="text" placeholder="Booking ref, property, traveler, provider payment id" />
        </label>

        <label>
          Check-in date
          <select id="checkinSel">
            <option value="all" selected>All</option>
            <option value="has">Has check-in date</option>
            <option value="none">No check-in date</option>
          </select>
        </label>

        <button id="btnRefresh" class="btn" type="button">Refresh</button>
        <button id="btnClear" class="btn ghost" type="button">Clear</button>
      </div>

      <div id="pageToast" class="toast"></div>
    </div>

    <div id="emptyState" class="empty">No exceptions for the current horizon.</div>

    <div class="table">
      <table>
        <thead>
          <tr>
            <th style="width:140px;">Booking ref</th>
            <th style="width:260px;">Property</th>
            <th style="width:280px;">Traveler</th>
            <th style="width:200px;">Stay</th>
            <th style="width:220px;">Why</th>
            <th style="width:160px;">Status</th>
            <th class="right" style="width:120px;">Paid</th>
            <th style="width:220px;">Provider payment id</th>
            <th style="width:160px;">Created</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="9" class="muted">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    (function(){
      const ADMIN_TOKEN_KEY = "lolaelo_admin_session";
      const LOGIN = "/admin/login.html";
      const API_BASE = location.origin;

      const $ = (id) => document.getElementById(id);

      let lastRows = [];
      let __loading = false;

      function getToken(){
        try { return localStorage.getItem(ADMIN_TOKEN_KEY) || ""; } catch(_) { return ""; }
      }

      function authHeaders(){
        const t = String(getToken() || "").trim();
        return { "Authorization": "Bearer " + t };
      }

      async function ensureAdmin(){
        const t = String(getToken() || "").trim();
        if (!t) { location.replace(LOGIN); return false; }

        const r = await fetch("/api/admin/ping", { headers: authHeaders() }).catch(() => null);
        if (!r || !r.ok) {
          try { localStorage.removeItem(ADMIN_TOKEN_KEY); } catch(_) {}
          location.replace(LOGIN);
          return false;
        }
        return true;
      }

      async function fetchJSON(path, opts){
        const r = await fetch(API_BASE + path, { ...(opts||{}), headers: { ...(opts?.headers||{}), ...authHeaders() } });
        if (r.status === 401) {
          try { localStorage.removeItem(ADMIN_TOKEN_KEY); } catch(_) {}
          location.replace(LOGIN);
          return null;
        }
        const data = await r.json().catch(() => null);
        if (!r.ok) {
          const msg = (data && (data.error || data.message)) ? String(data.error || data.message) : ("HTTP " + r.status);
          throw new Error(msg);
        }
        return data;
      }

      function setAuthStatus(txt){
        const el = $("authStatus");
        if (el) el.textContent = txt || "";
      }

      function setToast(msg, kind){
        const el = $("pageToast");
        if (!el) return;
        el.textContent = msg || "";
        el.className = "toast" + (kind ? (" " + kind) : "");
      }

      function esc(s){
        return String(s == null ? "" : s)
          .replace(/&/g,"&amp;")
          .replace(/</g,"&lt;")
          .replace(/>/g,"&gt;")
          .replace(/"/g,"&quot;")
          .replace(/'/g,"&#039;");
      }

      function fmtDateOnly(v){
        if (!v) return "";
        try {
          const d = new Date(v);
          if (isNaN(d.getTime())) return "";
          return d.toLocaleDateString("en-US", { month:"short", day:"2-digit", year:"numeric" });
        } catch(_) { return ""; }
      }

      function fmtStay(r){
        const a = fmtDateOnly(r.checkInDate);
        const b = fmtDateOnly(r.checkOutDate);
        if (!a && !b) return "-";
        if (a && b) return a + " to " + b;
        return (a || b);
      }

      function fmtTraveler(r){
        const name = [r.travelerFirstName, r.travelerLastName].filter(Boolean).join(" ").trim();
        const email = String(r.travelerEmail || "").trim();
        if (name && email) return name + " (" + email + ")";
        return name || email || "-";
      }

      function fmtMoney(n, cur){
        const v = Number(n || 0);
        const c = String(cur || "USD").toUpperCase();
        if (!Number.isFinite(v)) return c + " 0.00";
        try { return new Intl.NumberFormat(undefined, { style:"currency", currency:c }).format(v); }
        catch { return c + " " + v.toFixed(2); }
      }

      function statusTag(status, r){
        const s = String(status || "");
        const checkIn = r && r.checkInDate ? new Date(r.checkInDate) : null;
        const daysSel = Number($("daysSel")?.value || 30) || 30;

        let cls = "tag";
        if (s === "REFUND_IN_PROGRESS") cls += " danger";

        // Quick urgency hint: check-in within 3 days
        try{
          if (checkIn && !isNaN(checkIn.getTime())){
            const now = new Date();
            const diffDays = Math.round((checkIn.getTime() - now.getTime()) / (1000*60*60*24));
            if (diffDays <= 3) cls = "tag danger";
            else if (diffDays <= Math.min(7, daysSel)) cls = "tag warn";
          }
        }catch(_){}

        return '<span class="' + cls + '">' + esc(s || "-") + "</span>";
      }

      function rowText(r){
        return [
          r.bookingRef,
          r.propertyName,
          r.travelerFirstName,
          r.travelerLastName,
          r.travelerEmail,
          r.providerPaymentId,
          r.status
        ].join(" ").toLowerCase();
      }

      function render(){
        const tbody = $("tbody");
        const empty = $("emptyState");
        const q = String($("searchBox")?.value || "").trim().toLowerCase();
        const ck = String($("checkinSel")?.value || "all").trim();

        const rows0 = Array.isArray(lastRows) ? lastRows.slice() : [];
        let rows = q ? rows0.filter(r => rowText(r).includes(q)) : rows0;

          if (ck === "has") {
            rows = rows.filter(r => !!r.checkInDate);
          } else if (ck === "none") {
            rows = rows.filter(r => !r.checkInDate);
          }

        if (!rows.length){
          if (tbody) tbody.innerHTML = '<tr><td colspan="9" class="muted">No rows.</td></tr>';
          if (empty) empty.style.display = (rows0.length ? "none" : "block");
          return;
        }

        if (empty) empty.style.display = "none";

        tbody.innerHTML = rows.map(r => {
          const ref = esc(r.bookingRef || "");
          const prop = esc(r.propertyName || ("Partner #" + (r.partnerId || "")));
          const traveler = esc(fmtTraveler(r));
          const stay = esc(fmtStay(r));
          const paid = esc(fmtMoney(r.amountPaid, r.currency || "USD"));
          const pp = esc(String(r.providerPaymentId || "-"));
          const created = esc(fmtDateOnly(r.createdAt) || "-");
          const st = statusTag(r.status, r);

          const pri = (() => {
            if (!r.checkInDate) return "pri-danger";
            try{
              const now = new Date();
              const ci = new Date(r.checkInDate);
              if (isNaN(ci.getTime())) return "pri-danger";
              const diff = Math.ceil((ci.getTime() - now.getTime()) / (1000*60*60*24));
              if (diff <= 3) return "pri-danger";
              if (diff <= 7) return "pri-warn";
              return "pri-neutral";
            }catch(_){
              return "pri-neutral";
            }
          })();

          return `
            <tr class="${pri}">
              <td class="mono">
                ${
                  (ref && ref !== "-")
                    ? `<a class="link" href="/admin/bookings.html?q=${encodeURIComponent(ref)}">${ref}</a>`
                    : `-`
                }
              </td>
              <td>${prop || "-"}</td>
              <td>${traveler}</td>
              <td class="mono">${stay}</td>
              <td>${esc(String(r.why || "-"))}</td>
              <td>${st}</td>
              <td class="right mono">${paid}</td>
              <td class="mono">${pp}</td>
              <td class="mono">${created}</td>
            </tr>
          `;
        }).join("");
      }

      async function load(){
        if (__loading) return;
        __loading = true;

        try{
          setToast("", "");

          const days = Number($("daysSel")?.value || 30) || 30;

          const elH = $("kpiHorizon");
          if (elH) elH.textContent = String(days);

          const tbody = $("tbody");
          if (tbody) tbody.innerHTML = '<tr><td colspan="9" class="muted">Loading...</td></tr>';

          const data = await fetchJSON("/api/admin/exceptions?days=" + encodeURIComponent(String(days)));

          if (!data || !data.ok){
            lastRows = [];
            const elC = $("kpiCount");
            if (elC) elC.textContent = "0";
            render();
            setToast("Failed loading exceptions.", "bad");
            return;
          }

          lastRows = Array.isArray(data.rows) ? data.rows : [];

          const elC = $("kpiCount");
          if (elC) elC.textContent = String(Number(data.count || lastRows.length || 0));

          render();
          setToast("Ready.", "ok");

          // Updated timestamp
          try{
            const elU = $("kpiUpdated");
            if (elU){
              const now = new Date();
              elU.textContent = now.toLocaleString(undefined, {
                year: "numeric",
                month: "short",
                day: "2-digit",
                hour: "2-digit",
                minute: "2-digit"
              });
            }
          }catch(_){}

          // Persist filters in URL (refresh-safe)
          try{
            const u = new URL(window.location.href);
            u.searchParams.set("days", String(days));
            u.searchParams.set("q", String($("searchBox")?.value || ""));
            u.searchParams.set("ck", String($("checkinSel")?.value || "all"));
            window.history.replaceState({}, "", u.toString());
          }catch(_){}
        } catch(e){
          console.error("[admin/exceptions] load failed", e);
          lastRows = [];
          const elC = $("kpiCount");
          if (elC) elC.textContent = "0";
          render();
          setToast("Failed: " + String(e && e.message ? e.message : e), "bad");
        } finally {
          __loading = false;
        }
      }

      function wire(){
        const btnLogout = $("btnLogout");
        if (btnLogout){
          btnLogout.onclick = () => {
            try { localStorage.removeItem(ADMIN_TOKEN_KEY); } catch(_) {}
            location.replace(LOGIN);
          };
        }

        const btnRefresh = $("btnRefresh");
        if (btnRefresh) btnRefresh.onclick = load;

        const daysSel = $("daysSel");
        if (daysSel) daysSel.onchange = load;

        const searchBox = $("searchBox");
        if (searchBox){
          searchBox.addEventListener("input", () => {
            // keep URL in sync
            try{
              const u = new URL(window.location.href);
              u.searchParams.set("q", String($("searchBox")?.value || ""));
              u.searchParams.set("ck", String($("checkinSel")?.value || "all"));
              window.history.replaceState({}, "", u.toString());
            }catch(_){}
            render();
          });
        }

        const checkinSel = $("checkinSel");
        if (checkinSel){
          checkinSel.onchange = () => {
            try{
              const u = new URL(window.location.href);
              u.searchParams.set("q", String($("searchBox")?.value || ""));
              u.searchParams.set("ck", String($("checkinSel")?.value || "all"));
              window.history.replaceState({}, "", u.toString());
            }catch(_){}
            render();
          };
        }

        const btnClear = $("btnClear");
        if (btnClear){
          btnClear.onclick = () => {
            // reset UI
            if ($("daysSel")) $("daysSel").value = "30";
            if ($("searchBox")) $("searchBox").value = "";
            if ($("checkinSel")) $("checkinSel").value = "all";

            // reset URL (keep cb if present)
            try{
              const u = new URL(window.location.href);
              const cb = u.searchParams.get("cb");
              u.search = "";
              if (cb) u.searchParams.set("cb", cb);
              window.history.replaceState({}, "", u.toString());
            }catch(_){}

            load();
          };
        }
      }

      (async function boot(){
        const ok = await ensureAdmin();
        if (!ok) return;

        setAuthStatus("Ready");
        wire();

        // Hydrate filters from URL (if present)
        try{
          const u = new URL(window.location.href);
          const days = u.searchParams.get("days");
          const q = u.searchParams.get("q");
          const ck = u.searchParams.get("ck");

          if (days && $("daysSel")) $("daysSel").value = String(days);
          if (q != null && $("searchBox")) $("searchBox").value = String(q);
          if (ck && $("checkinSel")) $("checkinSel").value = String(ck);
        }catch(_){}

        load();

      })();
    })();
  </script>
</body>
</html>
