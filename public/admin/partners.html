<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Partners | Admin Hub | Lolaelo</title>
  <link rel="stylesheet" href="/css/extranet.css">
  <style>
    :root{
      --bg:#f6f8fc;
      --card:#ffffff;
      --fg:#0f172a;
      --muted:#5b6b84;
      --accent:#ff6a3d;
      --line:rgba(15,23,42,.12);
    }
    *{ box-sizing:border-box }
    body{ margin:0; background:var(--bg); color:var(--fg); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial; }
    .wrap{ max-width:980px; margin:0 auto; padding:22px 14px 34px; }
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      margin-bottom:12px;
    }
    .pill{
      display:inline-block; font-size:11px; padding:4px 8px; border-radius:999px;
      border:1px solid var(--line); color:var(--muted);
      vertical-align:middle;
    }
    .card{
      border:1px solid var(--line);
      background:var(--card);
      border-radius:14px;
      padding:14px;
      box-shadow:0 10px 30px rgba(15,23,42,.08);
    }
    .status{ font-size:12px; color:var(--muted); min-height:16px; }
    .status.bad{ color:#b42318; }
    .status.ok{ color:#0f7a3a; }

    .row{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; }
    @media (max-width: 760px){ .row{ grid-template-columns:1fr } }

    label{ display:block; font-size:12px; color:var(--muted); margin:10px 0 6px; }
    input{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#ffffff;
      color:var(--fg);
      outline:none;
    }
    input:focus{
      border-color:rgba(255,106,61,.55);
      box-shadow:0 0 0 3px rgba(255,106,61,.15);
    }

    /* Force email input to stay light even when invalid/autofill */
    .admin-email-input,
    .admin-email-input:focus,
    .admin-email-input:active,
    .admin-email-input:invalid {
      background-color:#ffffff !important;
      color:#0b1220 !important;
    }
    .admin-email-input:-webkit-autofill,
    .admin-email-input:-webkit-autofill:hover,
    .admin-email-input:-webkit-autofill:focus,
    .admin-email-input:-webkit-autofill:active{
      -webkit-box-shadow:0 0 0 1000px #ffffff inset !important;
      -webkit-text-fill-color:#0b1220 !important;
      transition: background-color 9999s ease-in-out 0s;
    }

    .btnRow{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:10px; }
    .btnRow a{ text-decoration:none; }
    /* Keep partner name input light (avoid dark/autofill styling) */
    .admin-text-input,
    .admin-text-input:focus,
    .admin-text-input:active {
    background-color:#ffffff !important;
    color:#0b1220 !important;
    }
    .admin-text-input:-webkit-autofill,
    .admin-text-input:-webkit-autofill:hover,
    .admin-text-input:-webkit-autofill:focus,
    .admin-text-input:-webkit-autofill:active{
    -webkit-box-shadow:0 0 0 1000px #ffffff inset !important;
    -webkit-text-fill-color:#0b1220 !important;
    transition: background-color 9999s ease-in-out 0s;
    }
    /* ANCHOR: ADMIN_TOP_BUTTONS */
    .btn.ghost{
      background:#0b3a4a;
      border:1px solid rgba(11,58,74,.35);
      color:#ffffff !important;
      box-shadow:0 6px 18px rgba(15,23,42,.12);
    }
    .btn.ghost:hover{
      background: linear-gradient(90deg, #0b3a4a 0%, #0f5b63 100%);
      border-color: rgba(11,58,74,.55);
      transform: translateY(-1px);
    }
    .btn.ghost:active{
      transform: translateY(0px);
    }
    .btn.ghost:focus{
      outline: none;
      box-shadow:0 0 0 4px rgba(11,58,74,.20), 0 6px 18px rgba(15,23,42,.12);
    }
    /* ANCHOR: ADMIN_TOP_BUTTONS END */

        /* ANCHOR: PARTNER_SELECTOR_CARD_CSS */
    .partnerBar{
      display:flex;
      gap:10px;
      align-items:end;
      flex-wrap:wrap;
      margin-top:8px;
    }
    .partnerBar .field{ min-width: 240px; flex: 1 1 260px; }
    select{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#ffffff;
      color:var(--fg);
      outline:none;
    }
    select:focus{
      border-color:rgba(255,106,61,.55);
      box-shadow:0 0 0 3px rgba(255,106,61,.15);
    }
    .snap{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
      margin-top:12px;
    }
    @media (max-width: 980px){ .snap{ grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 560px){ .snap{ grid-template-columns: 1fr; } }

    .snapItem{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      background:#fff;
      box-shadow:0 6px 18px rgba(15,23,42,.06);
      min-height:64px;
    }
    .snapItem .k{ font-size:11px; color:var(--muted); }
    .snapItem .v{ margin-top:6px; font-size:14px; font-weight:800; color:var(--fg); overflow-wrap:anywhere; }
    /* ANCHOR: PARTNER_SELECTOR_CARD_CSS END */

  </style>
</head>
<body>
  <div class="wrap">
  <div class="top">
    <div>
      <div style="display:flex; align-items:center; gap:12px;">
        <img src="/images/logo.png" alt="Lolaelo" style="height:48px; width:auto; display:block;">
       </div>
      </div>
      <div class="btnRow">
        <a class="btn ghost" href="/admin/index.html">Back</a>
        <button id="btnLogout" class="btn ghost" type="button">Sign out</button>
      </div>
    </div>

    <!-- ANCHOR: PARTNER_SELECTOR_CARD -->
    <div class="card">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
        <div style="font-weight:700;">Partner</div>
        <div class="pill">lookup + snapshot</div>
      </div>

      <!-- IMPORTANT: keep id="status" so existing setStatus() continues to work -->
      <div class="status" id="status"></div>

      <div class="partnerBar">
        <div class="field">
          <label for="partnerSelect">Select partner</label>
          <select id="partnerSelect">
            <option value="">Loading…</option>
          </select>
        </div>

        <div class="field" style="flex: 2 1 420px;">
          <label for="partnerSearch">Quick search</label>
          <input id="partnerSearch" class="admin-text-input" type="text" placeholder="Type to filter by name or email" />
        </div>

        <div style="min-width:160px;">
          <button id="btnRefreshPartners" class="btn" type="button">Refresh</button>
        </div>
      </div>

      <div class="snap">
        <div class="snapItem">
          <div class="k">Partner ID</div>
          <div class="v" id="snapPartnerId">-</div>
        </div>
        <div class="snapItem">
          <div class="k">Name</div>
          <div class="v" id="snapPartnerName">-</div>
        </div>
        <div class="snapItem">
          <div class="k">Email</div>
          <div class="v" id="snapPartnerEmail">-</div>
        </div>
        <div class="snapItem">
          <div class="k">Created</div>
          <div class="v" id="snapPartnerCreated">-</div>
        </div>
      </div>

      <div class="btnRow" style="margin-top:12px;">
        <button id="btnCopyPartnerEmail" class="btn ghost" type="button" disabled>Copy email</button>
        <button id="btnCopyPartnerId" class="btn ghost" type="button" disabled>Copy ID</button>
        <div class="status" id="partnerLoadStatus"></div>
      </div>

      <details style="margin-top:10px;">
        <summary style="cursor:pointer; color:var(--muted); font-size:12px;">Raw partner record</summary>
        <pre id="partnerRaw" style="white-space:pre-wrap; margin:10px 0 0; padding:10px; border:1px solid var(--line); border-radius:12px; background:#fff; font-size:12px; overflow:auto;">-</pre>
      </details>
    </div>

    <div style="height:12px;"></div>
    <!-- ANCHOR: PARTNER_SELECTOR_CARD END -->

    <!-- ANCHOR: PARTNER_CONTACT_CARD -->
    <div class="card">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
        <div style="font-weight:700;">Contact & notes</div>
        <div class="pill">internal</div>
      </div>

      <div class="row" style="margin-top:8px;">
        <div>
          <label>Primary contact</label>
          <input id="pcName" class="admin-text-input" type="text" disabled placeholder="-" />
        </div>
        <div>
          <label>Email</label>
          <input id="pcEmail" class="admin-email-input" type="email" disabled placeholder="-" />
        </div>
        <div>
          <label>Phone / WhatsApp</label>
          <input id="pcPhone" class="admin-text-input" type="text" disabled placeholder="-" />
        </div>
      </div>

      <label for="pcNotes" style="margin-top:10px;">Internal notes</label>
      <textarea
        id="pcNotes"
        rows="3"
        placeholder="Internal context, flags, reminders…"
        style="width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line); outline:none;"
      ></textarea>

      <div class="btnRow">
        <button id="btnSaveNotes" class="btn" type="button" disabled>Save notes</button>
        <div class="status" id="pcStatus"></div>
      </div>
    </div>

    <div style="height:12px;"></div>
    <!-- ANCHOR: PARTNER_CONTACT_CARD END -->

    <!-- Create partner -->
    <div class="card">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
        <div style="font-weight:700;">Create partner</div>
        <div class="pill">extranet.Partner</div>
      </div>

      <div class="row" style="margin-top:8px;">
        <div>
          <label for="cpEmail">Partner email</label>
          <input id="cpEmail" class="admin-email-input" type="email" placeholder="daguhoy@hotel.com" autocomplete="email" />
        </div>
        <div>
          <label for="cpName">Partner name (optional)</label>
          <input id="cpName" class="admin-text-input" type="text" placeholder="Daguhoy Hotel" />
        </div>
        <div>
          <label for="cpPassword">Initial password</label>
          <input id="cpPassword" type="password" placeholder="Set password" autocomplete="new-password" />
        </div>
      </div>

      <div class="btnRow">
        <button id="btnCreatePartner" class="btn" type="button">Create partner</button>
        <div class="status" id="cpStatus"></div>
      </div>
    </div>

    <div style="height:12px;"></div>

    <!-- Password reset -->
    <div class="card">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
        <div style="font-weight:700;">Set or reset password</div>
        <div class="pill">bcrypt hash only</div>
      </div>

      <div class="row" style="margin-top:8px;">
        <div>
          <label for="prEmail">Partner email</label>
          <input id="prEmail" class="admin-email-input" type="email" placeholder="palatulan@gmail.com" autocomplete="email" />
        </div>
        <div>
          <label for="prPassword">New password</label>
          <input id="prPassword" type="password" placeholder="Hunter1014!" autocomplete="new-password" />
        </div>
      </div>

      <div class="btnRow">
        <button id="btnSetPw" class="btn" type="button">Set password</button>
        <div class="status" id="pwStatus"></div>
      </div>

      <div class="status" style="margin-top:6px;">
        Password cannot be retrieved later. Only reset.
      </div>
    </div>

  </div>

  <script>
    (function(){
      const TOKEN_KEY = "lolaelo_admin_session";
      const LOGIN = "/admin/login.html";

      const PING_URL = "/api/admin/ping";
      const CREATE_PARTNER_URL = "/api/admin/partners";
      const SET_PW_EMAIL_URL = "/api/admin/partners/password-by-email";
      const LIST_PARTNERS_URL = "/api/admin/partners";

      const PARTNER_DETAILS_URL = (id) => `/api/admin/partners/${encodeURIComponent(id)}`;
      const PARTNER_NOTES_URL   = (id) => `/api/admin/partners/${encodeURIComponent(id)}/notes`;

      const $ = (id) => document.getElementById(id);

      async function fetchJSON(url, opts){
        const r = await fetch(url, opts || {});
        const j = await r.json().catch(() => null);
        return { ok: r.ok, status: r.status, json: j };
      }

      const LAST_PARTNER_KEY = "lolaelo_admin_last_partner";

      function getToken(){
        try { return localStorage.getItem(TOKEN_KEY) || ""; } catch { return ""; }
      }
      function setStatus(msg, kind){
        const el = $("status");
        if (!el) return;
        el.textContent = msg || "";
        el.className = "status" + (kind ? (" " + kind) : "");
      }
      function setCpStatus(msg, kind){
        const el = $("cpStatus");
        if (!el) return;
        el.textContent = msg || "";
        el.className = "status" + (kind ? (" " + kind) : "");
      }
      function setPwStatus(msg, kind){
        const el = $("pwStatus");
        if (!el) return;
        el.textContent = msg || "";
        el.className = "status" + (kind ? (" " + kind) : "");
      }

      function setPartnerLoadStatus(msg, kind){
        const el = $("partnerLoadStatus");
        if (!el) return;
        el.textContent = msg || "";
        el.className = "status" + (kind ? (" " + kind) : "");
      }

      function setPcStatus(msg, kind){
        const el = $("pcStatus");
        if (!el) return;
        el.textContent = msg || "";
        el.className = "status" + (kind ? (" " + kind) : "");
      }

      function notesKey(p){
        return p && (p.id || p.email)
          ? "lolaelo_admin_partner_notes_" + (p.id || p.email)
          : null;
      }

      function fmtDate(iso){
        if (!iso) return "-";
        try{
          const d = new Date(iso);
          if (!isFinite(d.getTime())) return String(iso);
          return d.toLocaleDateString(undefined, { year:"numeric", month:"short", day:"numeric" });
        } catch { return String(iso); }
      }

      function normalizePartner(p){
        if (!p) return null;
        const id = (p.id != null) ? String(p.id) : "";
        const email = String(p.email || p.partnerEmail || "").trim();
        const name = String(p.name || p.partnerName || "").trim();
        const createdAt = p.createdAt || p.created_at || p.created || null;
        return { id, email, name, createdAt, raw: p };
      }

      let PARTNERS = [];
      let FILTERED = [];

      function renderPartnerOptions(list){
        const sel = $("partnerSelect");
        if (!sel) return;

        sel.innerHTML = "";
        const opt0 = document.createElement("option");
        opt0.value = "";
        opt0.textContent = list.length ? "Select a partner…" : "No partners found";
        sel.appendChild(opt0);

        for (const p of list){
          const o = document.createElement("option");
          o.value = p.id || p.email || "";
          o.textContent =
            (p.name ? p.name + " - " : "") +
            (p.email || "(no email)") +
            (p.id ? " [" + p.id + "]" : "");
          sel.appendChild(o);
        }
      }

      function applySnapshot(p){
        const set = (id, v) => {
          const el = document.getElementById(id);
          if (el) el.textContent = (v == null || v === "") ? "-" : String(v);
        };

        set("snapPartnerId", p ? p.id : "-");
        set("snapPartnerName", p ? (p.name || "-") : "-");
        set("snapPartnerEmail", p ? (p.email || "-") : "-");
        set("snapPartnerCreated", p ? fmtDate(p.createdAt) : "-");

        // Raw record view
        const raw = document.getElementById("partnerRaw");
        if (raw) {
          raw.textContent = p ? JSON.stringify(p.raw || p, null, 2) : "-";
        }

        // Disable copy buttons until selected
        const has = !!(p && (p.email || p.id));
        const btnEmail = $("btnCopyPartnerEmail");
        const btnId = $("btnCopyPartnerId");
        if (btnEmail) btnEmail.disabled = !has || !p.email;
        if (btnId) btnId.disabled = !has || !p.id;

        // Auto-fill reset password email
        const prEmail = $("prEmail");
        if (prEmail && p && p.email) prEmail.value = p.email;

        // Persist last selection
        try {
          if (p && (p.id || p.email)) {
            localStorage.setItem(LAST_PARTNER_KEY, String(p.id || p.email));
          } else {
            localStorage.removeItem(LAST_PARTNER_KEY);
          }
        } catch {}
        // Contact fields (best-effort from record)
        const setInput = (id, v) => {
          const el = $(id);
          if (el) el.value = (v == null || v === "") ? "" : String(v);
        };

        setInput("pcName", p ? (p.raw && (p.raw.contactName || p.raw.name)) : "");
        setInput("pcEmail", p ? (p.email || "") : "");
        setInput("pcPhone", p ? (p.raw && (p.raw.phone || p.raw.whatsapp || "")) : "");

        // Notes are DB authoritative now. Only control enable/disable here.
        const notesEl = $("pcNotes");
        const btnSave = $("btnSaveNotes");
        if (notesEl && btnSave) {
          if (p) {
            btnSave.disabled = false;
          } else {
            notesEl.value = "";
            btnSave.disabled = true;
          }
        }
      }

      function getSelectedPartner(){
        const sel = $("partnerSelect");
        const v = sel ? String(sel.value || "") : "";
        if (!v) return null;
        return FILTERED.find(x => x.id === v) ||
               FILTERED.find(x => x.email === v) || null;
      }

      async function loadPartners(token){
        const sel = $("partnerSelect");
        if (sel) sel.disabled = true;

        setPartnerLoadStatus("Loading partners…", "");
        try{
          const r = await fetch(LIST_PARTNERS_URL, {
            headers: { "Authorization": "Bearer " + token }
          });
          const j = await r.json().catch(() => null);

          const arr =
            (j && Array.isArray(j.partners) && j.partners) ||
            (j && Array.isArray(j.items) && j.items) ||
            (Array.isArray(j) ? j : []);

          PARTNERS = arr.map(normalizePartner).filter(Boolean);
          FILTERED = PARTNERS.slice();

          renderPartnerOptions(FILTERED);

          // Restore last selected partner if possible
          let restored = null;
          try {
            const last = String(localStorage.getItem(LAST_PARTNER_KEY) || "").trim();
            if (last) {
              restored = FILTERED.find(x => x.id === last) || FILTERED.find(x => x.email === last) || null;
              const sel = $("partnerSelect");
              if (sel && restored) sel.value = restored.id || restored.email || "";
            }
          } catch {}

          applySnapshot(restored);

          setPartnerLoadStatus(
            PARTNERS.length ? ("Loaded " + PARTNERS.length + ".") : "No partners returned.",
            PARTNERS.length ? "ok" : ""
          );
        } catch (e){
          console.error(e);
          PARTNERS = [];
          FILTERED = [];
          renderPartnerOptions([]);
          applySnapshot(null);
          setPartnerLoadStatus("Failed loading partners.", "bad");
        } finally {
          if (sel) sel.disabled = false;
        }
      }

      function applyFilter(q){
        const needle = String(q || "").trim().toLowerCase();
        FILTERED = !needle
          ? PARTNERS.slice()
          : PARTNERS.filter(p =>
              String(p.name || "").toLowerCase().includes(needle) ||
              String(p.email || "").toLowerCase().includes(needle) ||
              String(p.id || "").toLowerCase().includes(needle)
            );
        renderPartnerOptions(FILTERED);
        applySnapshot(null);
      }

      async function ping(token){
        const r = await fetch(PING_URL, { headers: { "Authorization": "Bearer " + token } });
        return r.ok;
      }

      async function createPartner(token, email, name){
        const r = await fetch(CREATE_PARTNER_URL, {
          method: "POST",
          headers: {
            "Authorization": "Bearer " + token,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ email, name })
        });
        const j = await r.json().catch(()=>({}));
        return { ok: r.ok && j && j.ok, status:r.status, body:j };
      }

      async function setPartnerPasswordByEmail(token, email, password){
        const r = await fetch(SET_PW_EMAIL_URL, {
          method: "POST",
          headers: {
            "Authorization": "Bearer " + token,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ email, password })
        });
        const j = await r.json().catch(()=>({}));
        return { ok: r.ok && j && j.ok, status:r.status, body:j };
      }

      async function boot(){
        const t = String(getToken() || "").trim();
        if (!t) { location.replace(LOGIN); return; }

        setStatus("Validating…", "");
        const ok = await ping(t).catch(() => false);
        if (!ok) {
          try { localStorage.removeItem(TOKEN_KEY); } catch {}
          setStatus("Session invalid. Redirecting…", "bad");
          location.replace(LOGIN);
          return;
        }
        setStatus("Ready.", "ok");
        loadPartners(t);
        applySnapshot(null);
      }

      $("btnLogout").onclick = () => {
        try { localStorage.removeItem(TOKEN_KEY); } catch {}
        location.replace(LOGIN);
      };

      $("btnCreatePartner").onclick = async () => {
        const t = String(getToken() || "").trim();
        const email = String($("cpEmail").value || "").trim().toLowerCase();
        const name = String($("cpName").value || "").trim();
        const password = String(($("cpPassword") && $("cpPassword").value) ? $("cpPassword").value : "");

        if (!email || !email.includes("@")) return setCpStatus("Enter a valid email.", "bad");
        if (!password) return setCpStatus("Enter an initial password.", "bad");

        $("btnCreatePartner").disabled = true;
        setCpStatus("Creating…", "");

        try {
          const out = await createPartner(t, email, name || null);
          if (out.ok) {
            // Immediately set password (one-flow onboarding)
            const pwOut = await setPartnerPasswordByEmail(t, email, password);
            if (pwOut.ok) {
              setCpStatus("Partner created + password set.", "ok");
              $("prEmail").value = email;
              $("prPassword").value = password;
              setPwStatus("Password set.", "ok");
            } else {
              setCpStatus("Partner created, but password set failed.", "bad");
              $("prEmail").value = email;
            }
          } else {
            setCpStatus((out.body && (out.body.error || out.body.message)) ? (out.body.error || out.body.message) : ("Failed (" + out.status + ")"), "bad");
          }
        } catch (e) {
          console.error(e);
          setCpStatus("Failed.", "bad");
        } finally {
          $("btnCreatePartner").disabled = false;
        }
      };

      $("btnSetPw").onclick = async () => {
        const t = String(getToken() || "").trim();
        const email = String($("prEmail").value || "").trim().toLowerCase();
        const password = String($("prPassword").value || "");

        if (!email || !email.includes("@")) return setPwStatus("Enter a valid email.", "bad");
        if (!password) return setPwStatus("Enter a password.", "bad");

        $("btnSetPw").disabled = true;
        setPwStatus("Saving…", "");

        try {
          const out = await setPartnerPasswordByEmail(t, email, password);
          if (out.ok) {
            setPwStatus("Password set.", "ok");
          } else {
            setPwStatus((out.body && (out.body.error || out.body.message)) ? (out.body.error || out.body.message) : ("Failed (" + out.status + ")"), "bad");
          }
        } catch (e) {
          console.error(e);
          setPwStatus("Failed.", "bad");
        } finally {
          $("btnSetPw").disabled = false;
        }
      };
     
      const partnerSearch = $("partnerSearch");
      if (partnerSearch) {
        partnerSearch.addEventListener("input", (e) =>
          applyFilter(e.target.value)
        );
      }

      async function loadPartnerDetails(selected){
        const p = selected || null;

        // Keep snapshot UI in sync immediately
        applySnapshot(p);

        // Clear contact fields if none selected
        if (!p) {
          const pcName = $("pcName"); if (pcName) pcName.value = "";
          const pcEmail = $("pcEmail"); if (pcEmail) pcEmail.value = "";
          const pcPhone = $("pcPhone"); if (pcPhone) pcPhone.value = "";
          const pcNotes = $("pcNotes"); if (pcNotes) pcNotes.value = "";
          return;
        }

        const t = String(getToken() || "").trim();
        if (!t) return setPcStatus("Missing admin session.", "bad");

        setPcStatus("Loading…", "");
        try {
          const out = await fetchJSON(PARTNER_DETAILS_URL(p.id || p.email), {
            headers: { "Authorization": "Bearer " + t }
          });

          if (!(out.ok && out.json && out.json.ok && out.json.partner)) {
            const msg = (out.json && (out.json.error || out.json.message)) ? (out.json.error || out.json.message) : ("Failed (" + out.status + ")");
            setPcStatus(msg, "bad");
            return;
          }

          const partner = out.json.partner;

          const pcName = $("pcName"); if (pcName) pcName.value = String(partner.contactName || partner.name || "");
          const pcEmail = $("pcEmail"); if (pcEmail) pcEmail.value = String(partner.contactEmail || partner.email || "");
          const pcPhone = $("pcPhone"); if (pcPhone) pcPhone.value = String(partner.phone || "");
          const pcNotes = $("pcNotes"); if (pcNotes) pcNotes.value = String(partner.adminNotes || "");

          // Keep reset password email aligned
          const prEmail = $("prEmail");
          if (prEmail) prEmail.value = String(partner.email || "");

          // Update raw record panel with authoritative DB view too
          const raw = document.getElementById("partnerRaw");
          if (raw) raw.textContent = JSON.stringify(out.json, null, 2);

          setPcStatus("", "");
        } catch (e) {
          console.error(e);
          setPcStatus("Failed loading details.", "bad");
        }
      }

      const partnerSelect = $("partnerSelect");
      if (partnerSelect) {
        partnerSelect.addEventListener("change", () => loadPartnerDetails(getSelectedPartner()));
      }

      const btnRefreshPartners = $("btnRefreshPartners");
      if (btnRefreshPartners) {
        btnRefreshPartners.onclick = () => {
          const t = String(getToken() || "").trim();
          if (!t) return setPartnerLoadStatus("Missing admin session.", "bad");
          loadPartners(t);
        };
      }

      const btnCopyPartnerEmail = $("btnCopyPartnerEmail");
      if (btnCopyPartnerEmail) {
        btnCopyPartnerEmail.onclick = async () => {
          const p = getSelectedPartner();
          if (!p || !p.email)
            return setPartnerLoadStatus("Select a partner first.", "bad");
          try {
            await navigator.clipboard.writeText(p.email);
            setPartnerLoadStatus("Email copied.", "ok");
          } catch {
            setPartnerLoadStatus("Copy failed.", "bad");
          }
        };
      }

      const btnCopyPartnerId = $("btnCopyPartnerId");
      if (btnCopyPartnerId) {
        btnCopyPartnerId.onclick = async () => {
          const p = getSelectedPartner();
          if (!p || !p.id)
            return setPartnerLoadStatus("Select a partner first.", "bad");
          try {
            await navigator.clipboard.writeText(p.id);
            setPartnerLoadStatus("ID copied.", "ok");
          } catch {
            setPartnerLoadStatus("Copy failed.", "bad");
          }
        };
      }

      const btnSaveNotes = $("btnSaveNotes");
      if (btnSaveNotes) {
        btnSaveNotes.onclick = async () => {
          const p = getSelectedPartner();
          if (!p) return setPcStatus("Select a partner first.", "bad");

          const t = String(getToken() || "").trim();
          if (!t) return setPcStatus("Missing admin session.", "bad");

          const notes = String(($("pcNotes") || {}).value || "");

          btnSaveNotes.disabled = true;
          setPcStatus("Saving…", "");

          try {
            const out = await fetchJSON(PARTNER_NOTES_URL(p.id || p.email), {
              method: "PUT",
              headers: {
                "Authorization": "Bearer " + t,
                "Content-Type": "application/json"
              },
              body: JSON.stringify({ notes })
            });

            if (out.ok && out.json && out.json.ok) {
              setPcStatus("Notes saved.", "ok");
            } else {
              const msg = (out.json && (out.json.error || out.json.message)) ? (out.json.error || out.json.message) : ("Failed (" + out.status + ")");
              setPcStatus(msg, "bad");
            }
          } catch (e) {
            console.error(e);
            setPcStatus("Failed.", "bad");
          } finally {
            btnSaveNotes.disabled = false;
          }
        };
      }
      boot();
    })();
  </script>
</body>
</html>
