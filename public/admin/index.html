<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Hub | Lolaelo</title>
  <link rel="stylesheet" href="/css/extranet.css">
  <style>
    :root{
      --bg:#f6f8fc;
      --card:#ffffff;
      --fg:#0f172a;
      --muted:#5b6b84;
      --accent:#ff6a3d;
      --line:rgba(15,23,42,.12);
    }
    *{ box-sizing:border-box }
    body{ margin:0; background:var(--bg); color:var(--fg); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial; }
    .wrap{ max-width:980px; margin:0 auto; padding:22px 14px 34px; }
    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:8px;
      padding:0;
    }
    .brandRow{ margin:0; padding:0; }
    .sub{ margin:2px 0 0; }

    h1{ margin:0; font-size:18px; }
    .sub{ margin:4px 0 0; color:var(--muted); font-size:13px; }
    .card{
      border:1px solid var(--line);
      background:var(--card);
      border-radius:14px;
      padding:14px;
      box-shadow:0 10px 30px rgba(15,23,42,.08);
    }
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
      gap:12px;
      margin-top:12px;
    }

    /* ANCHOR: TILE_HOVER_ACCENT */
.tile{
  display:block;
  padding:14px;
  border:1px solid var(--line);
  border-radius:14px;
  background:#fff;
  text-decoration:none;
  color:var(--fg);
  box-shadow:0 6px 18px rgba(15,23,42,.06);
  transition: transform .08s ease, box-shadow .08s ease, border-color .12s ease;
}

.tile:hover{
  transform:translateY(-1px);
  border-color: rgba(255,106,61,.65);          /* bright orange border only */
  box-shadow:0 10px 26px rgba(15,23,42,.10);   /* keep your original lift */
}

.tile .t{ font-weight:700; font-size:14px; }
.tile .d{ margin-top:6px; color:var(--muted); font-size:12px; line-height:1.35; }
/* ANCHOR: TILE_HOVER_ACCENT END */


    .pill{
      display:inline-block;
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      color:var(--muted);
      margin-left:8px;
      vertical-align:middle;
    }
    .status{ font-size:12px; color:var(--muted); margin-top:10px; min-height:16px; }
    .status.bad{ color:#b42318; }
    .status.ok{ color:#0f7a3a; }
    
    /* ANCHOR: KPI_CSS */
    .kpis{ display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; }
    @media (max-width: 980px){ .kpis{ grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 560px){ .kpis{ grid-template-columns: 1fr; } }
    .kpi{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      background:#fff;
      box-shadow:0 6px 18px rgba(15,23,42,.06);
    }
    .kpi .label{ font-size:11px; color:var(--muted); letter-spacing:.2px; }
    .kpi .value{ margin-top:6px; font-size:18px; font-weight:800; }
    .kpi .sub{ margin-top:6px; font-size:11px; color:var(--muted); }
    /* ANCHOR: KPI_CSS END */

    .btnRow{ display:flex; gap:10px; align-items:center; }
    .btnRow a{ text-decoration:none; }
    /* ANCHOR: ADMIN_TOP_BUTTONS */
    .btn.ghost{
      background:#0b3a4a;
      border:1px solid rgba(11,58,74,.35);
      color:#ffffff !important;
      box-shadow:0 6px 18px rgba(15,23,42,.12);
    }
    .btn.ghost:hover{
      background: linear-gradient(90deg, #0b3a4a 0%, #0f5b63 100%);
      border-color: rgba(11,58,74,.55);
      transform: translateY(-1px);
    }
    .btn.ghost:active{
      transform: translateY(0px);
    }
    .btn.ghost:focus{
      outline: none;
      box-shadow:0 0 0 4px rgba(11,58,74,.20), 0 6px 18px rgba(15,23,42,.12);
    }
    /* ANCHOR: ADMIN_TOP_BUTTONS END */

  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <div style="display:flex; align-items:center; gap:12px;">
          <img src="/images/logo.png" alt="Lolaelo" style="height:64px; width:auto; display:block;">
          <span class="pill" style="border-color:rgba(15,23,42,.18); color:#0f172a; font-weight:800;">Admin Hub</span>
        </div>
        <div class="sub">Operations console for bookings, payouts, partners, and system health.</div>
      </div>
      <div class="btnRow">
        <a class="btn ghost" href="/partners_login.html">Extranet</a>
        <button id="btnLogout" class="btn ghost" type="button">Sign out</button>
      </div>
    </div>

    <!-- ANCHOR: BOOKINGS_KPI_CARD -->
    <div class="card">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
        <div style="font-weight:700;">Bookings $</div>
        <div class="pill" id="kpiWindow">ET</div>
      </div>

      <div class="kpis" style="margin-top:12px;">
        <div class="kpi">
          <div class="label">Today</div>
          <div class="value" id="kpiDay">-</div>
          <div class="sub" id="kpiDaySub"></div>
        </div>

        <div class="kpi">
          <div class="label">This week</div>
          <div class="value" id="kpiWeek">-</div>
          <div class="sub" id="kpiWeekSub"></div>
        </div>

        <div class="kpi">
          <div class="label">This month</div>
          <div class="value" id="kpiMonth">-</div>
          <div class="sub" id="kpiMonthSub"></div>
        </div>

        <div class="kpi">
          <div class="label">YTD</div>
          <div class="value" id="kpiYtd">-</div>
          <div class="sub" id="kpiYtdSub"></div>
        </div>
      </div>
    </div>
    <!-- ANCHOR: BOOKINGS_KPI_CARD END -->


    <!-- ANCHOR: HUB_TOOLS_CARD -->
    <div class="card">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
        <div style="font-weight:700;">Tools</div>
        <div id="status" class="status"></div>
      </div>

      <div class="grid">
        <a class="tile" href="/admin/ap.html">
          <div class="t">
            Accounts Payable
            <span id="apBadge" class="pill" style="display:none; margin-left:8px; border-color:rgba(180,35,24,.25); color:#b42318; font-weight:800;">0</span>
          </div>
          <div class="d">Batch payouts (DRAFT then mark PAID). Partner payments feed reads Payout and PayoutBooking.</div>
        </a>

        <a class="tile" href="/admin/bookings.html">
          <div class="t">Bookings</div>
          <div class="d">Search bookings, status timeline, resend confirmations, refunds, manual overrides.</div>
        </a>

        <a class="tile" href="/admin/data.html">
          <div class="t">Analytics</div>
          <div class="d">Visitors, sources, and engaged time (first party).</div>
        </a>

        <a class="tile" href="#" onclick="alert('Coming soon: partner admin'); return false;">
          <div class="t">Partners</div>
          <div class="d">Partner lookup, onboarding status, payout method, token reset, property profile health.</div>
        </a>

        <a class="tile" href="#" onclick="alert('Coming soon: exceptions inbox'); return false;">
          <div class="t">
            Exceptions
            <span id="excBadge" class="pill" style="display:none; margin-left:8px; border-color:rgba(180,35,24,.25); color:#b42318; font-weight:800;">0</span>
          </div>
          <div class="d">Bookings needing intervention (bad line items, refund-in-progress, upcoming check-ins at risk).</div>
        </a>

        <a class="tile" href="#" onclick="alert('Coming soon: payouts ledger'); return false;">
          <div class="t">Payout ledger</div>
          <div class="d">Search payouts by partner/date/status. Export CSV. Audit confirmation numbers.</div>
        </a>

        <a class="tile" href="#" onclick="alert('Coming soon: system health'); return false;">
          <div class="t">System health</div>
          <div class="d">Stripe webhook health, email provider status, DB connectivity, S3 upload checks.</div>
        </a>

        <a class="tile" href="#" onclick="alert('Coming soon: operations tooling'); return false;">
          <div class="t">Operations</div>
          <div class="d">Future: internal workflows and triage tools.</div>
        </a>
      </div>
    </div>
    <!-- ANCHOR: HUB_TOOLS_CARD END -->

    <!-- ANCHOR: ADMIN_PARTNERS_PASSWORD_CARD -->
    <div class="card" style="margin-top:12px;">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
        <div style="font-weight:700;">Partners - Password reset</div>
        <div class="pill">Admin only</div>
      </div>

      <div style="margin-top:10px; display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
        <div>
          <div style="font-size:12px; color:var(--muted); margin-bottom:6px;">Partner email</div>
          <input id="prEmail" type="email" placeholder="palatulan@gmail.com" style="width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line);"/>
        </div>
        <div>
          <div style="font-size:12px; color:var(--muted); margin-bottom:6px;">New password</div>
          <input id="prPassword" type="password" placeholder="Hunter1014!" style="width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line);"/>
        </div>
      </div>

      <div style="margin-top:10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <button id="btnSetPw" class="btn" type="button">Set password</button>
        <div class="status" id="pwStatus" style="margin-top:0;"></div>
      </div>

      <div class="sub" style="margin-top:8px;">
        This resets the partner password (hash only). Password cannot be retrieved later, only reset again.
      </div>
    </div>
    <!-- ANCHOR: ADMIN_PARTNERS_PASSWORD_CARD END -->

  <script>
    (function(){
      const TOKEN_KEY = "lolaelo_admin_session";
      const LOGIN = "/admin/login.html";
      const PING_URL = "/api/admin/ping";
      const SET_PW_EMAIL_URL = "/api/admin/partners/password-by-email";
      const EXC_URL = "/api/admin/exceptions?days=30";
      const $ = (id) => document.getElementById(id);

      function getToken(){
        try { return localStorage.getItem(TOKEN_KEY) || ""; } catch { return ""; }
      }
      function setStatus(msg, kind){
        const el = $("status");
        if (!el) return;
        el.textContent = msg || "";
        el.className = "status" + (kind ? (" " + kind) : "");
      }

      async function ping(token){
        const r = await fetch(PING_URL, { headers: { "Authorization": "Bearer " + token } });
        return r.ok;
      }

      async function boot(){
        const t = String(getToken() || "").trim();
        if (!t) { location.replace(LOGIN); return; }

        setStatus("Validating…", "");
        const ok = await ping(t).catch(() => false);
        if (!ok) {
          try { localStorage.removeItem(TOKEN_KEY); } catch {}
          setStatus("Session invalid. Redirecting…", "bad");
          location.replace(LOGIN);
          return;
        }

        setStatus("Ready.", "ok");

        // Fetch booking KPIs
        try {
          const r = await fetch("/api/admin/kpis/bookings?tz=America%2FNew_York", {
            headers: { "Authorization": "Bearer " + t }
          });
          const j = await r.json().catch(() => null);
          if (r.ok && j && j.ok) {
            const cur = j.currency || "USD";

            const fmt = (n) => {
              const v = Number(n || 0);
              try { return new Intl.NumberFormat(undefined, { style:"currency", currency: cur }).format(v); }
              catch { return `${cur} ${v.toFixed(2)}`; }
            };

            const day = document.getElementById("kpiDay");
            const week = document.getElementById("kpiWeek");
            const month = document.getElementById("kpiMonth");
            const ytd = document.getElementById("kpiYtd");

            if (day) day.textContent = fmt(j.today);
            if (week) week.textContent = fmt(j.week);
            if (month) month.textContent = fmt(j.month);
            if (ytd) ytd.textContent = fmt(j.ytd);

            // optional sublabels (show start dates)
            const sub = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = v || ""; };
            const fmtET = (iso) => {
              try{
                const d = new Date(iso);
                return d.toLocaleDateString(undefined, { timeZone:"America/New_York", month:"short", day:"numeric", year:"numeric" });
              } catch { return String(iso || "").slice(0,10); }
            };
            sub("kpiDaySub", j.dayStart ? fmtET(j.dayStart) : "");
            if (j.weekStart){
              try{
                const ws = new Date(String(j.weekStart).slice(0,10) + "T00:00:00Z");
                const we = new Date(ws);
                we.setUTCDate(we.getUTCDate() + 6);

                const startTxt = ws.toLocaleDateString(undefined, { timeZone:"America/New_York", month:"short", day:"numeric" });
                const endTxt   = we.toLocaleDateString(undefined, { timeZone:"America/New_York", month:"short", day:"numeric", year:"numeric" });

                sub("kpiWeekSub", `${startTxt} - ${endTxt}`);
              } catch {
                sub("kpiWeekSub", "");
              }
            } else {
              sub("kpiWeekSub", "");
            }
            if (j.monthStart){
              try{
                const ms = new Date(j.monthStart);
                const txt = ms.toLocaleDateString(undefined, { timeZone:"America/New_York", month:"short", year:"numeric" });
                sub("kpiMonthSub", txt);
              } catch {
                sub("kpiMonthSub", "");
              }
            } else {
              sub("kpiMonthSub", "");
            }
            sub("kpiYtdSub", ""); // keep YTD clean

            const w = document.getElementById("kpiWindow");
            if (w) w.textContent = "ET";
          }
        } catch {}

        // Fetch exceptions count for badge
        try {
          const r = await fetch(EXC_URL, { headers: { "Authorization": "Bearer " + t } });
          const j = await r.json().catch(() => null);
          const count = (r.ok && j && typeof j.count === "number") ? j.count : 0;

          const badge = document.getElementById("excBadge");
          if (badge) {
            if (count > 0) {
              badge.textContent = String(count);
              badge.style.display = "inline-block";
              setStatus("Attention needed.", "bad");
            } else {
              badge.style.display = "none";
            }
          }
        } catch {}
      }

      function setPwStatus(msg, kind){
        const el = document.getElementById("pwStatus");
        if (!el) return;
        el.textContent = msg || "";
        el.className = "status" + (kind ? (" " + kind) : "");
      }

      async function setPartnerPasswordByEmail(token, email, password){
        const r = await fetch(SET_PW_EMAIL_URL, {
          method: "POST",
          headers: {
            "Authorization": "Bearer " + token,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ email, password })
        });
        const j = await r.json().catch(() => ({}));
        return { ok: r.ok && j && j.ok, status: r.status, body: j };
      }

      const btnSetPw = document.getElementById("btnSetPw");
      if (btnSetPw) {
        btnSetPw.onclick = async () => {
          const t = String(getToken() || "").trim();
          const email = String((document.getElementById("prEmail") || {}).value || "").trim().toLowerCase();
          const password = String((document.getElementById("prPassword") || {}).value || "");

          if (!t) return setPwStatus("Missing admin session.", "bad");
          if (!email || !email.includes("@")) return setPwStatus("Enter a valid email.", "bad");
          if (!password) return setPwStatus("Enter a password.", "bad");

          btnSetPw.disabled = true;
          setPwStatus("Saving…", "");
          try {
            const out = await setPartnerPasswordByEmail(t, email, password);
            if (out.ok) {
              setPwStatus("Password set.", "ok");
            } else {
              setPwStatus((out.body && (out.body.error || out.body.message)) ? (out.body.error || out.body.message) : ("Failed (" + out.status + ")"), "bad");
            }
          } catch (e) {
            console.error(e);
            setPwStatus("Failed.", "bad");
          } finally {
            btnSetPw.disabled = false;
          }
        };
      }

      $("btnLogout").onclick = () => {
        try { localStorage.removeItem(TOKEN_KEY); } catch {}
        location.replace(LOGIN);
      };

      boot();
    })();
  </script>

</body>
</html>
