<!doctype html>
<html lang="en">
<head>
  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/images/logo4.png?v=1">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/logo4.png?v=1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/logo4.png?v=1">
  <meta charset="utf-8" />
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <title>Documents</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
  :root{
    --bg:#0b1320; --card:#111a2b; --fg:#e8eefc; --muted:#9bb0d3; --line:rgba(255,255,255,.08);
    --brand-orange:#ff6a3d; --brand-blue:#2e7bff;
  }
  *{ box-sizing:border-box }
  body{
    margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif; color:var(--fg);
    background: radial-gradient(1000px 600px at 20% -10%, #1a2b4a 0%, #0b1320 60%, #0b1320 100%);
    min-height:100vh;
  }

  .page{ max-width:980px; margin:32px auto; padding:0 16px; }
  .card{ background:var(--card); border:1px solid var(--line); border-radius:16px; padding:18px; box-shadow:0 8px 40px rgba(0,0,0,.45); }
  .row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  .row.between{ justify-content:space-between; align-items:center; }
  .row.bottom{ justify-content:flex-start; }
  .spacer{ height:16px; }
  .muted{ color:var(--muted); font-size:12px; }

  /* Buttons (match hub + Photos) */
  .btn{
    cursor:pointer;
    border-radius:999px;
    padding:9px 14px;
    font-weight:700;
    border:1px solid var(--brand-orange);
    background:var(--brand-orange);
    color:#fff; /* primary = orange + white text */
    transition: transform .12s ease, box-shadow .12s ease, opacity .12s ease;
  }
  .btn:hover{ transform: translateY(-1px); }
  .btn:disabled{ opacity:.6; cursor:not-allowed; }

  .btn-danger{
    background:transparent;
    border-color:#b91c1c;
    color:#fff; /* red outline, white text */
  }
  .btn-secondary-outline{
    background:transparent;
    color:#d7e5ff;
    border-color:var(--brand-blue);
  }
  .btn-secondary-outline:hover{ box-shadow:0 0 0 3px rgba(46,123,255,.20) inset; }

  /* Inputs */
  .input,.select{
    border:1px solid var(--line); border-radius:10px;
    padding:8px 10px; /* slimmer height to look tidy next to buttons */
    background:#0e1830; color:var(--fg);
  }
  .input:focus,.select:focus{ outline:none; border-color:var(--brand-blue); box-shadow:0 0 0 3px rgba(46,123,255,.20); }

  /* Custom file picker (match Photos "Choose file" as a blue-outline button) */
  .file-input--visually-hidden{
    position:absolute !important;
    width:1px; height:1px;
    padding:0; margin:-1px;
    overflow:hidden; clip:rect(0 0 0 0);
    white-space:nowrap; border:0;
  }
  .file-name{ color:var(--muted); font-size:12px; }

  /* Table */
  .table{ width:100%; border-collapse:collapse; table-layout:fixed; }
  .table thead th{ border-bottom:2px solid var(--line); padding:10px 12px; text-align:left; }
  .table td{ padding:10px 12px; border-bottom:1px solid var(--line); vertical-align:top; word-break:break-word; overflow-wrap:anywhere; }
  .nowrap{ white-space:nowrap; }

  .table a, .table a:visited{ color:var(--brand-orange); text-decoration:none; }
  .table a:hover, .table a:focus{ color:#ff8a68; text-decoration:none; }

  .badge{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--line); }
  .badge.SUBMITTED{ background:#1f2937; }
  .badge.APPROVED{ background:#065f46; }
  .badge.REJECTED{ background:#7f1d1d; }

  textarea.notes{ width:100%; min-height:40px; resize:vertical; }
  .actions{ display:flex; gap:8px; flex-wrap:wrap; }

  /* Uploaded column: show Date and Time on separate lines */
  td.uploadedAt > div{ line-height:1.2; }

  /* Responsive */
  @media (max-width: 720px){
    .table thead{ display:none; }
    .table tr{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px;
      border-bottom:1px solid var(--line);
      padding:8px 0;
    }
    .table td{ border:none; padding:6px 6px; }
    .nowrap{ white-space:normal; }
    .td-notes, .td-actions{ grid-column: 1 / -1; }
  }
  </style>
</head>

<body>
  <div class="page">
    <div class="card">
      <div class="row between">
        <h1 style="margin:0;">Documents</h1>
        <span></span>
      </div>
      <div class="muted">
        Upload W-9, insurance, vendor agreements, etc.<br/>
        <strong>Note:</strong> You can upload multiple files per <em>Type</em>. New uploads create additional rows; nothing is overwritten.
      </div>

      <div class="spacer"></div>

      <!-- Upload row -->
      <div class="row">
        <!-- Hidden native input + styled label to match Photos -->
        <input id="file" type="file" accept=".pdf,image/*" class="file-input--visually-hidden" />
        <label for="file" id="pickBtn" class="btn btn-secondary-outline">Choose file</label>
        <span id="fileName" class="file-name">No file chosen</span>

        <select id="docType" class="select" aria-label="Document Type"></select>
        <button id="uploadBtn" class="btn">Upload</button>
        <span class="muted">Your current session is used for auth.</span>
      </div>

      <div class="spacer"></div>

      <!-- Table -->
      <table class="table" id="tbl">
        <thead>
          <tr>
            <th class="nowrap">Type</th>
            <th>File</th>
            <th class="nowrap">Status</th>
            <th class="nowrap">Uploaded</th>
            <th>Comments</th>
            <th class="nowrap">Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="spacer"></div>
      <div class="row bottom">
        <button id="backBtn" class="btn btn-secondary-outline">Back to menu</button>
      </div>
    </div>
  </div>

<script>
const BASE = 'https://lolaelo-api.onrender.com';

/* --- Token / headers --- */
function token(){ return localStorage.getItem('lolaelo_session') || ''; }
function headers(json = true){
  const t = token();
  const h = { 'Authorization': 'Bearer ' + t, 'x-partner-token': t };
  if (json) h['Content-Type'] = 'application/json';
  return h;
}

/* --- Helpers --- */
function prettyLabel(s){
  return (s||'')
    .replace(/_/g, ' ')
    .toLowerCase()
    .replace(/\b\w/g, c => c.toUpperCase());
}
function badge(status){
  const s = (status || '').toUpperCase();
  const span = document.createElement('span');
  span.className = 'badge ' + s;
  span.textContent = s || '-';
  return span;
}

/* --- Load Type dropdown (pretty labels, original values) --- */
async function loadDocTypes(){
  const sel = document.getElementById('docType');
  sel.innerHTML = '<option disabled>Loading…</option>';
  try {
    const r = await fetch(BASE + '/extranet/property/documents/types?cb=' + Date.now(), {
      headers: headers(false), cache: 'no-store'
    });
    if (!r.ok) throw new Error(String(r.status));
    const raw = await r.json();
    const items = Array.isArray(raw.value) ? raw.value : raw;

    sel.innerHTML = '';
    for (const v of items) {
      const opt = document.createElement('option');
      opt.value = v;                 // keep canonical value
      opt.textContent = prettyLabel(v); // show friendly label
      sel.appendChild(opt);
    }
    if (items.includes('BUSINESS_REG')) sel.value = 'BUSINESS_REG';
  } catch {
    const fallback = ['GOVT_ID','BUSINESS_REG','TAX_ID','BANK_PROOF','PROOF_OF_ADDRESS','INSURANCE_LIABILITY','PROPERTY_OWNERSHIP','LOCAL_LICENSE'];
    sel.innerHTML = '';
    for (const v of fallback) {
      const opt = document.createElement('option');
      opt.value = v;
      opt.textContent = prettyLabel(v);
      sel.appendChild(opt);
    }
    sel.value = 'BUSINESS_REG';
  }
}

/* --- List documents --- */
async function listDocs(){
  const tbody = document.querySelector('#tbl tbody');
  tbody.innerHTML = '<tr><td colspan="6" class="muted">Loading…</td></tr>';

  const r = await fetch(BASE + '/extranet/property/documents?cb=' + Date.now(), {
    headers: headers(false), cache:'no-store'
  });
  if (!r.ok){
    tbody.innerHTML = `<tr><td colspan="6">Failed to load (${r.status}). Check your session.</td></tr>`;
    return;
  }
  const raw = await r.json();
  const rows = Array.isArray(raw.value) ? raw.value : raw;

  tbody.innerHTML = '';
  if (!rows.length){
    tbody.innerHTML = '<tr><td colspan="6" class="muted">No documents yet.</td></tr>';
    return;
  }

  for (const row of rows){
    const tr = document.createElement('tr');

    const tdType = document.createElement('td');
    tdType.textContent = prettyLabel(row.type);
    tr.appendChild(tdType);

    const tdFile = document.createElement('td');
    const a = document.createElement('a');
    a.href = row.url; a.target = '_blank'; a.rel = 'noopener';
    a.textContent = row.fileName || row.key;
    tdFile.appendChild(a);
    tr.appendChild(tdFile);

    const tdStatus = document.createElement('td');
    tdStatus.appendChild(badge(row.status));
    tr.appendChild(tdStatus);

    // Uploaded date/time on two lines
    const tdUp = document.createElement('td');
    tdUp.className = 'uploadedAt';
    if (row.uploadedAt){
      const dt = new Date(row.uploadedAt);
      const d  = dt.toLocaleDateString();
      const t  = dt.toLocaleTimeString();
      tdUp.innerHTML = `<div>${d}</div><div>${t}</div>`;
    } else {
      tdUp.textContent = '-';
    }
    tr.appendChild(tdUp);

    // Notes
    const tdNotes = document.createElement('td');
    tdNotes.className = 'td-notes';
    const ta = document.createElement('textarea');
    ta.className = 'notes input';
    ta.value = row.notes || '';
    ta.placeholder = 'Add a comment…';
    tdNotes.appendChild(ta);
    tr.appendChild(tdNotes);

    // Actions
    const tdActions = document.createElement('td');
    tdActions.className = 'actions td-actions';

    const saveBtn = document.createElement('button');
    saveBtn.className = 'btn btn-secondary-outline';
    saveBtn.textContent = 'Save';
    saveBtn.onclick = async () => {
      saveBtn.disabled = true;
      try{
        const rr = await fetch(BASE + '/extranet/property/documents/' + row.id, {
          method:'PUT', headers: headers(), body: JSON.stringify({ notes: ta.value })
        });
        if(!rr.ok){ const err = await rr.text(); alert('Save failed: ' + rr.status + '\n' + err); }
      } finally { saveBtn.disabled = false; }
    };

    const delBtn = document.createElement('button');
    delBtn.className = 'btn btn-danger';
    delBtn.textContent = 'Delete';
    delBtn.onclick = async () => {
      if (!confirm('Delete this document?')) return;
      delBtn.disabled = true;
      try{
        const rr = await fetch(BASE + '/extranet/property/documents/' + row.id, {
          method:'DELETE', headers: headers(false)
        });
        if(!rr.ok && rr.status !== 204){ const err = await rr.text(); alert('Delete failed: ' + rr.status + '\n' + err); }
        else { await listDocs(); }
      } finally { delBtn.disabled = false; }
    };

    tdActions.appendChild(saveBtn);
    tdActions.appendChild(delBtn);
    tr.appendChild(tdActions);

    tbody.appendChild(tr);
  }
}

/* --- Upload flow --- */
async function upload(){
  const fileEl = document.getElementById('file');
  const f = fileEl.files[0];
  if(!f) return alert('Pick a file first.');
  const type = document.getElementById('docType').value;
  const contentType = f.type || 'application/octet-stream';

  // 1) presign
  const r1 = await fetch(BASE + '/extranet/property/documents/upload-url', {
    method:'POST', headers: headers(), body: JSON.stringify({ fileName: f.name, contentType, size: f.size })
  });
  if(!r1.ok){ const e = await r1.text(); return alert('upload-url failed: ' + r1.status + '\n' + e); }
  const up = await r1.json();

  // 2) upload to S3
  const r2 = await fetch(up.uploadUrl, { method:'PUT', headers: up.headers, body: f });
  if(!r2.ok) return alert('S3 PUT failed: ' + r2.status);

  // 3) create DB row
  const r3 = await fetch(BASE + '/extranet/property/documents', {
    method:'POST', headers: headers(),
    body: JSON.stringify({ type, key: up.key, url: up.url, fileName: f.name, contentType })
  });
  if(!r3.ok){ const err = await r3.text(); return alert('Create failed: ' + r3.status + '\n' + err); }

  await listDocs();
  alert('Uploaded.');
}

/* Init */
window.addEventListener('pageshow', () => { if (typeof listDocs === 'function') listDocs(); });
document.getElementById('uploadBtn').addEventListener('click', upload);
document.getElementById('backBtn').addEventListener('click', () => { window.location.href = '/partners_app.html'; });

/* File picker filename display (match Photos behavior) */
const fileInput = document.getElementById('file');
const fileName  = document.getElementById('fileName');
fileInput.addEventListener('change', () => {
  fileName.textContent = (fileInput.files && fileInput.files[0]) ? fileInput.files[0].name : 'No file chosen';
});

/* Load types + table */
loadDocTypes().then(listDocs);
</script>
</body>
</html>
