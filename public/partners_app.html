<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><circle cx="32" cy="32" r="28" fill="%23ff6a3d"/></svg>'>
  <title>Lolaelo Extranet - Partner Hub</title>

  <!-- Prevent caching so Back can't revive stale pages -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><rect width='16' height='16' fill='%234f8cff'/></svg>">

  <style>
  :root{ --bg:#0b1320; --card:#111a2b; --fg:#e8eefc; --muted:#9bb0d3; --accent:#ff6a3d; --line:rgba(255,255,255,.08); }
  *{ box-sizing:border-box }
  body{
    margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;
    background: radial-gradient(1000px 600px at 20% -10%, #1a2b4a 0%, #0b1320 60%, #0b1320 100%);
    color:var(--fg); min-height:100vh; display:flex; flex-direction:column;
  }
  .wrap{ flex:1; display:flex; align-items:center; justify-content:center; padding:24px }
  .shell{ width:100%; max-width:980px }
  .topbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:18px }
  .brand{ display:flex; align-items:center; gap:10px; }
  .brand .dot{ width:10px; height:10px; border-radius:999px; background:#2bbb6f; box-shadow:0 0 0 3px rgba(43,187,111,.25) }
  .brand .title{ font-size:16px; color:#cfe0ff }
  .actions{ display:flex; gap:8px }
  .btn{
    appearance:none; border:1px solid var(--accent); background:var(--accent); color:#fff;
    padding:9px 14px; border-radius:999px; font-weight:700; cursor:pointer;
  }
  .btn.secondary{ background:transparent; border-color:#2e7bff; color:#d7e5ff }
  .btn.ghost{ background:transparent; border-color:var(--line); color:#cfe0ff }
  .btn.small{ padding:6px 10px; border-radius:12px; font-size:12px }
  .card{
    background:var(--card); border:1px solid var(--line); border-radius:16px; padding:18px 18px;
    box-shadow:0 8px 40px rgba(0,0,0,.45);
  }
  .hero{ display:flex; align-items:center; justify-content:space-between; gap:14px; margin-bottom:16px }
  .hero h1{ margin:0; font-size:22px }
  .hero p{ margin:6px 0 0; color:var(--muted); font-size:14px }
  .grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:12px; margin-top:8px }
  .tile{
    display:block; padding:16px; border:1px solid var(--line); background:#0e1830; border-radius:14px;
    text-decoration:none; color:var(--fg); transition:.18s transform, .18s border-color, .18s background; min-height:120px;
  }
  .tile:hover{ transform:translateY(-2px); border-color:#2e7bff; background:#0f1b36 }
  .tile h3{ margin:0 0 6px; font-size:16px }
  .tile p{ margin:0; color:var(--muted); font-size:13px; line-height:1.35 }
  .badge{ display:inline-block; font-size:11px; padding:2px 8px; border-radius:999px; background:#193258; color:#bcd3ff; margin-left:6px; border:1px solid rgba(255,255,255,.08) }
  .status{ font-size:12px; color:#a9bbde; }
  .status .ok{ color:#67e28f; font-weight:600 }
  .status .todo{ color:#ff9a88; font-weight:600 }

  .section{ margin-top:16px }
  .section h2{ margin:0 0 10px; font-size:18px }
  label{ display:block; font-size:13px; color:#cfe0ff; margin:12px 0 6px }
  input, textarea, select{
    width:100%; padding:12px; border-radius:10px; border:1px solid var(--line);
    background:#0e1830; color:var(--fg); outline:none;
  }
  input::placeholder, textarea::placeholder{ color:var(--muted); opacity:1; }
  textarea::placeholder { font-style: normal; font-family: inherit; }
  input:focus, textarea:focus, select:focus{ border-color:#2e7bff; box-shadow:0 0 0 3px rgba(46,123,255,.20) }
  .row{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
  .row3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px }
  .backlink{ display:inline-block; margin-top:8px; font-size:13px; color:#ffb59f; text-decoration:underline; cursor:pointer }

  .top-toast{ position:fixed; top:12px; left:0; right:0; display:flex; justify-content:center; pointer-events:none; z-index:10 }
  .toast{
    pointer-events:auto; min-width:280px; max-width:520px; background:#0e1830; border:1px solid rgba(255,255,255,.07);
    padding:10px 12px; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,.45); font-size:14px; color:#e8eefc;
  }
  .hidden{ display:none }

  /* Photos grid */
  .photos{ display:grid; grid-template-columns:repeat(auto-fill,minmax(140px,1fr)); gap:10px; margin-top:10px }
  .photos .ph{ background:#0e1830; border:1px solid var(--line); border-radius:10px; padding:8px; }
  .photos img{ width:100%; height:100px; object-fit:cover; border-radius:6px; display:block; }
  .photos .meta{ font-size:11px; color:#a9bbde; margin-top:6px; word-break:break-all }
  .photos .photo-actions{ display:flex; gap:6px; flex-wrap:wrap; margin-top:8px; }

    .photos .photo-actions{ display:flex; gap:6px; flex-wrap:wrap; margin-top:8px; }

  /* Add-ons modal */
  .addons-modal-backdrop{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.6);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:2000;
  }
  .addons-modal-backdrop.is-open{
    display:flex;
  }
  .addons-modal{
    background:var(--card);
    border-radius:16px;
    border:1px solid var(--line);
    max-width:1080px;
    width:96%;
    max-height:90vh;
    overflow:auto;
    padding:18px 20px;
    box-shadow:0 18px 45px rgba(0,0,0,0.6);
  }
  .addons-modal header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    margin-bottom:12px;
  }
  .addons-modal h3{
    margin:0;
    font-size:16px;
  }
  .addons-modal .addons-body{
    font-size:13px;
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .addons-modal .addons-actions{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:8px;
    margin-top:14px;
  }
  .addons-modal .close-btn{
    background:none;
    border:none;
    color:var(--muted);
    cursor:pointer;
    font-size:20px;
    line-height:1;
    padding:0 4px;
  }

  /* Add-ons price field: hide browser spin buttons */
  .addons-modal input[type="number"]::-webkit-outer-spin-button,
  .addons-modal input[type="number"]::-webkit-inner-spin-button{
    -webkit-appearance:none;
    margin:0;
  }
  .addons-modal input[type="number"]{
      appearance: textfield;
      -moz-appearance: textfield;
      -webkit-appearance: none;
  }

  /* Company Profile – map section */
  .pp-map-section{
    margin-top:12px;
  }
  .pp-map-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
  }
  .pp-map-header small{
    font-size:11px;
  }
  .pp-map-search{
    margin-top:6px;
  }
  .pp-map-container{
    margin-top:6px;
    border-radius:10px;
    border:1px solid var(--line);
    background:#020617;
    height:260px;
    position:relative;
    overflow:hidden;
  }
  .pp-map-placeholder{
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    text-align:center;
    padding:10px;
    font-size:13px;
    color:var(--muted);
  }
  .pp-map-coords{
    display:flex;
    gap:8px;
    margin-top:8px;
    flex-wrap:wrap;
  }
  .pp-map-coords .field{
    flex:1 1 150px;
  }

  table{ width:100%; border-collapse:collapse; }

  /* Add-ons modal column sizing */
  .addons-modal table{
    table-layout:fixed;
  }
  .addons-modal table th:nth-child(1),
  .addons-modal table td:nth-child(1){
    width:26%;  /* Activity / Excursion */
  }
  .addons-modal table th:nth-child(2),
  .addons-modal table td:nth-child(2){
    width:14%;  /* UoM */
  }
  .addons-modal table th:nth-child(3),
  .addons-modal table td:nth-child(3){
    width:14%;  /* Price */
  }
  .addons-modal table th:nth-child(4),
  .addons-modal table td:nth-child(4){
    width:36%;  /* Notes */
  }
  .addons-modal table th:nth-child(5),
  .addons-modal table td:nth-child(5){
    width:10%;  /* Actions */
  }

  th, td{ padding:8px 10px; border-bottom:1px solid #203150; font-size:13px }
  th{ text-align:left; color:#bcd3ff }
  .muted{ color:var(--muted) }

  @media (max-width: 700px){ .row, .row3{ grid-template-columns:1fr } }
  </style>

  <!-- Early token capture BEFORE any other scripts -->
  <script>
    (function () {
      try {
        const h = new URLSearchParams(location.hash.slice(1));
        const q = new URLSearchParams(location.search.slice(1));
        const t = h.get('token') || q.get('token');
        if (t) {
          localStorage.setItem('partnerToken', t);
          localStorage.setItem('lolaelo_session', t);
          history.replaceState(null, '', location.pathname + location.search);
          console.log('[hub] token captured early');
        }
      } catch (e) { console.warn('[hub] early capture err', e); }
    })();
  </script>

  <!-- shared helpers (ok if 404) -->
  <script src="js/shared.js"></script>
</head>
<body>
  <div class="top-toast"><div id="toast" class="toast hidden"></div></div>

  <div class="wrap">
    <div class="shell">
      <div class="topbar">
        <div class="brand">
          <span class="dot" aria-hidden="true"></span>
          <div class="title" id="brandTitle">Lolaelo Extranet</div>
        </div>
        <div class="actions">
          <button id="btnLogout" class="btn ghost" title="Sign out">Sign out</button>
        </div>
      </div>

      <!-- HUB -->
      <div id="hub" class="card" role="main" aria-label="Partner Hub">
        <div class="hero">
          <div>
            <h1 id="welcomeH1">Welcome</h1>
            <p id="partnerEmail" class="muted">-</p>
          </div>
          <div class="status">
            Profile: <span id="profileStatus" class="todo">Checking…</span>
          </div>
        </div>

        <div class="grid">
          <a id="tileProfile" class="tile" href="#profile">
            <h3>Company Profile</h3>
            <p>Manage your company details, contact info and description.</p>
          </a>

          <a class="tile" href="https://lolaelo-api.onrender.com/partners_photos.html" id="tilePhotos">
            <h3>My Photos</h3>
            <p>Browse the photos you’ve uploaded.</p>
          </a>

          <a class="tile" href="#" id="tileRooms">
            <h3>Rooms & Availability</h3>
            <p>Edit room types, inventory & prices.</p>
          </a>

          <a class="tile" href="https://lolaelo-api.onrender.com/partners_manage_bookings.html" id="tileManageBookings">
            <h3>Manage Bookings</h3>
            <p>Review bookings, confirm or decline, see payment history.</p>
          </a>

          <a class="tile" href="/partners_documents.html">
            <h3>Documents</h3>
            <p>Upload W-9, insurance, or vendor agreements.</p>
          </a>

          <a class="tile" href="#" id="tilePmsConnections">
            <h3>PMS Connections</h3>
            <p>Connect Cloudbeds (mock), test, view logs.</p>
          </a>

          <a class="tile" href="#" id="tilePmsMappings">
            <h3>PMS Mappings</h3>
            <p>Map PMS rooms/rate plans to Extranet.</p>
          </a>

          <a class="tile" href="partners_payments.html">
            <h3>Payments</h3>
            <p>View payment history, totals, and receipts.</p>
          </a>
        </div>
      </div>

      <!-- COMPANY PROFILE -->
      <div id="profile" class="card section hidden" aria-label="Company Profile">
        <h2>Company Profile</h2>

        <!-- Row 1: Name + Contact Email (required) -->
        <div class="row">
          <div>
            <label for="pp_name">Hotel/Property Name *</label>
            <input id="pp_name" type="text" placeholder="Coco Cabana" required />
          </div>
          <div>
            <label for="pp_contactEmail">Contact E-mail *</label>
            <input id="pp_contactEmail"
                  type="email"
                  placeholder="daguhoy@hotel.com"
                  disabled
                  aria-readonly="true"
                  title="System-managed (not editable)" />
            <small class="muted">System-managed email. Contact support to change.</small>
          </div>
        </div>

        <!-- Row 2: Partner ID (read-only) stays where it is -->
        <div class="row">
          <div>
            <label for="pp_partnerId">Partner ID</label>
            <input id="pp_partnerId" type="text" value="" disabled aria-readonly="true"
                  title="System-generated (not editable)" maxlength="5"
                  style="text-align:center; max-width:120px" />
            <small class="muted">System-generated ID. Contact support to change.</small>
          </div>
          <div></div>
        </div>

        <!-- Row 3: Phone + Address (Address moved to the right of Phone) -->
        <div class="row">
          <div>
            <label for="pp_phone">Phone *</label>
            <input id="pp_phone" type="tel" placeholder="+1 (555) 555-1234" required />
          </div>
          <div>
            <label for="pp_address">Address *</label>
            <input id="pp_address" type="text" placeholder="123 Ocean Ave" required />
          </div>
        </div>

        <!-- Row 4: City (moved into Address’s old spot) + Country (moved into City’s old spot) -->
        <div class="row">
          <div>
            <label for="pp_city">City *</label>
            <select id="pp_city" required>
              <option value="" disabled selected>— Select city —</option>
              <option value="SIARGAO">Siargao</option>
              <option value="BORACAY">Boracay</option>
              <option value="ELNIDO">El Nido</option>
              <option value="CORON">Coron</option>
              <option value="CEBU">Cebu</option>
              <option value="MANILA">Manila</option>
            </select>
            <small class="muted">This controls where your property appears in the public catalog.</small>
          </div>
          <div>
            <label for="pp_country">Country *</label>
            <input id="pp_country" type="text" placeholder="United States" required />
          </div>
        </div>

        <div class="pp-map-section">
          <div class="pp-map-header">
            <label class="section-label" style="font-weight:600;">
              Location on map
              <span style="font-weight:400; opacity:0.8;">
                (Set your exact location so travelers can find you on the map.)
              </span>
            </label>
          </div>

          <!-- Search row: input + Search + Selected place -->
          <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap; max-width:100%; padding-right:12px;">

            <!-- Search input (75% width) -->
            <input id="pp_map_search"
                   class="pp-map-search"
                   type="text"
                   placeholder="Search address or place"
                   style="flex:1 1 300px; max-width:420px;">

            <!-- Search button -->
            <button
              type="button"
              id="pp_map_search_btn"
              onclick="window.__ppMapSearch && window.__ppMapSearch()"
              style="
                padding:9px 18px;
                border-radius:999px;
                background:#0f172a;
                border:1px solid #ff6a3d;
                color:white;
                font-size:13px;
                cursor:pointer;
                line-height:1.2;
                white-space:nowrap;
              ">
              Search
            </button>

            <!-- Selected place label inline -->
            <div style="font-size:12px; max-width:260px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
              <span class="muted">Selected place: </span>
              <span id="pp_map_label_view" style="color:#e5e7eb;">Not set</span>
              <input id="pp_map_label" type="hidden" />
            </div>
          </div>

          <div id="pp_map" class="pp-map-container" style="margin-top:10px;">
            <div class="pp-map-placeholder">
              Map will appear here once Google Maps is connected. You’ll be able to drag the pin or search for your exact spot.
            </div>
          </div>

          <div class="pp-map-coords">
            <div class="field">
              <label for="pp_lat">Latitude</label>
              <input id="pp_lat"
                     type="text"
                     placeholder="Auto-filled"
                     readonly>
            </div>
            <div class="field">
              <label for="pp_lng">Longitude</label>
              <input id="pp_lng"
                     type="text"
                     placeholder="Auto-filled"
                     readonly>
            </div>
          </div>
        </div>
 
        <!-- Description (required field) -->
        <label for="pp_desc">
          Description <span style="color:#ff6a3d">*</span>
          <span style="font-weight:400; opacity:0.8;">
            (Write a brief personal note explaining what makes your property unique.)
          </span>
        </label>

        <textarea id="pp_desc"
          required
          placeholder="Write a short personal message that tells travelers what makes your property unique."></textarea>

        <button id="btnAddons"
                type="button"
                onclick="openAddonsModal()"
                style="
                  margin-top:12px;
                  padding:9px 18px;
                  border-radius:999px;
                  background:#0f172a;
                  border:1px solid #ff6a3d;
                  color:white;
                  font-size:13px;
                  cursor:pointer;
                  line-height:1.2;
                  display:inline-flex;
                  align-items:center;
                  gap:6px;
                ">
          <span>Manage ADD-ONs</span>
          <span id="addonsCountLabel"
                style="font-size:11px; color:#cbd5f5;"></span>
        </button>

        <div style="display:flex; gap:8px; margin-top:14px; flex-wrap:wrap">
          <button id="btnSave" class="btn">Save changes</button>
          <button id="btnBack" class="btn secondary" type="button">Back to menu</button>
        </div>
        </div>

      <!-- PMS CONNECTIONS PANEL -->
      <div id="pmsConnectionsPanel" class="card section hidden" aria-label="PMS Connections">
        <h2>PMS Connections</h2>

        <div style="display:flex; gap:8px; align-items:center; margin-bottom:10px">
          <button id="btnUpsertCloudbeds" class="btn small" type="button">Add/Upsert Cloudbeds (mock)</button>
          <button id="btnRefreshConns" class="btn secondary small" type="button">Refresh</button>
          <span id="connMsg" class="muted"></span>
        </div>

        <div style="overflow:auto">
          <table aria-label="Connections table">
            <thead>
              <tr><th>ID</th><th>Provider</th><th>Mode</th><th>Status</th><th>Scope</th><th>Updated</th><th>Actions</th></tr>
            </thead>
            <tbody id="connTbody"><tr><td class="muted" colspan="7">Loading…</td></tr></tbody>
          </table>
        </div>

        <h3 style="margin-top:18px">Recent Logs</h3>
        <ul id="connLogs" class="muted" style="padding-left:18px"><li>Loading…</li></ul>

        <div style="display:flex; gap:8px; margin-top:14px">
          <button id="connBackBtn" class="btn secondary" type="button">Back to menu</button>
        </div>
      </div>

      <!-- PMS MAPPINGS PANEL -->
      <div id="pmsMappingsPanel" class="card section hidden" aria-label="PMS Mappings">
        <h2>PMS Mappings</h2>

        <div class="row3">
          <div>
            <label for="map_conn">Connection *</label>
            <select id="map_conn"></select>
          </div>
          <div>
            <label for="map_room">Remote Room ID *</label>
            <input id="map_room" type="text" placeholder="R1" />
          </div>
          <div>
            <label for="map_rate">Remote Rate Plan ID</label>
            <input id="map_rate" type="text" placeholder="STD" />
          </div>
        </div>

        <div class="row3">
          <div>
            <label for="map_currency">Currency</label>
            <input id="map_currency" type="text" placeholder="USD" />
          </div>
          <div>
            <label for="map_active">Active</label>
            <select id="map_active">
              <option value="true" selected>True</option>
              <option value="false">False</option>
            </select>
          </div>
          <div style="display:flex; align-items:flex-end">
            <button id="btnCreateMapping" class="btn small" type="button">Create mapping</button>
          </div>
        </div>

        <div style="display:flex; gap:8px; align-items:center; margin:10px 0">
          <button id="btnRefreshMaps" class="btn secondary small" type="button">Refresh</button>
          <span id="mapMsg" class="muted"></span>
        </div>

        <div style="overflow:auto">
          <table aria-label="Mappings table">
            <thead>
              <tr>
                <th>ID</th><th>Conn</th><th>Remote Room</th><th>Remote Rate</th><th>Currency</th><th>Active</th><th>Actions</th>
              </tr>
            </thead>
            <tbody id="mapTbody"><tr><td class="muted" colspan="7">Loading…</td></tr></tbody>
          </table>
        </div>

        <div style="display:flex; gap:8px; margin-top:14px">
          <button id="mapBackBtn" class="btn secondary" type="button">Back to menu</button>
        </div>
      </div>

    </div>
  </div>

  <script>
    // --- Config ---------------------------------------------------------------
    const API_BASE = (location.hostname.endsWith('lolaelo.com'))
      ? 'https://lolaelo-api.onrender.com'
      : location.origin;
    const LOGIN_PAGE = "partners_login.html";

    // Debug flag available both as window.DEBUG and local DEBUG
    window.DEBUG = true;
    var DEBUG = !!window.DEBUG;

    // City codes ↔ labels shared with public catalog
    const CITY_LABELS = {
      SIARGAO: 'Siargao',
      BORACAY: 'Boracay',
      ELNIDO:  'El Nido',
      CEBU:    'Cebu',
      MANILA:  'Manila'
    };
    const normalizeCityCode = (s) => String(s || '').trim().toUpperCase();

    // --- Token helpers --------------------------------------------------------
    function getToken() {
      try {
        if (window.TravelAuth && typeof TravelAuth.getToken === 'function') {
          const t = TravelAuth.getToken(); if (t) return t;
        }
      } catch {}
      return localStorage.getItem("partnerToken") || localStorage.getItem("lolaelo_session") || "";
    }
    function setToken(t) {
      try {
        localStorage.setItem('partnerToken', t);
        localStorage.setItem('lolaelo_session', t);
      } catch {}
    }

    // --- Toast/DOM helpers ----------------------------------------------------
    const $ = (id) => document.getElementById(id);
    const toastBox = $('toast');
    function toast(html, ok=false){
      toastBox.innerHTML = html;
      toastBox.style.borderColor = ok ? '#2bbb6f' : 'rgba(255,255,255,.07)';
      toastBox.style.color = ok ? '#bff7d2' : '#e8eefc';
      toastBox.classList.remove('hidden');
      clearTimeout(window.__t);
      window.__t = setTimeout(()=>toastBox.classList.add('hidden'), 4000);
    }
    function show(id){ $(id).classList.remove('hidden'); }
    function hide(id){ $(id).classList.add('hidden'); }

    // --- Authed fetch (no auto-redirect on 401) -------------------------------
    async function authed(path, options = {}){
      const t = getToken();
      const isGet = !options.method || options.method.toUpperCase() === 'GET';
      const bust  = isGet ? (path.includes('?') ? '&' : '?') + '__ts=' + Date.now() : '';
      const url   = `${API_BASE}${path}${bust}`;
      const r = await fetch(url, {
        cache: 'no-store',
        ...options,
        headers: {
          'Cache-Control': 'no-store',
          'Pragma': 'no-cache',
          ...(options.headers || {}),
          'Authorization': `Bearer ${t || ''}`
        }
      });
      return r;
    }
    async function getJSON(path){
      const r = await authed(path, { method:'GET' });
      if (!r.ok) {
        const txt = await r.text().catch(()=>`${r.status}`);
        throw new Error(`GET ${path} -> ${r.status} ${txt}`);
      }
      return r.json();
    }

    // --- Logout ---------------------------------------------------------------
    $('btnLogout').onclick = async () => {
      try {
        const t = getToken();
        await fetch(`${API_BASE}/extranet/logout`, { method: 'POST', headers: { Authorization: `Bearer ${t}` } });
      } catch {}
      try {
        localStorage.removeItem("partnerToken");
        localStorage.removeItem("lolaelo_session");
      } catch {}
      location.replace(LOGIN_PAGE);
    };

    // --- Navigation -----------------------------------------------------------
    const backToHub = () => { hide('profile'); hide('pmsConnectionsPanel'); hide('pmsMappingsPanel'); show('hub'); };
    $('tileProfile').addEventListener('click', (e) => { e.preventDefault(); hide('hub'); show('profile'); });
    $('btnBack').onclick = backToHub;

    document.getElementById('tileRooms').addEventListener('click', (e) => {
      e.preventDefault();
      const t = getToken();
      const base = `${location.origin}/partners_rooms.html`;
      const url  = t ? `${base}#token=${encodeURIComponent(t)}` : base;
      location.href = url;
    });

    $('tilePmsConnections').addEventListener('click', async (e) => {
      e.preventDefault(); hide('hub'); show('pmsConnectionsPanel'); await refreshConnections();
    });
    $('connBackBtn').onclick = backToHub;

    $('tilePmsMappings').addEventListener('click', async (e) => {
      e.preventDefault(); hide('hub'); show('pmsMappingsPanel'); await refreshMappings(true);
    });
    $('mapBackBtn').onclick = backToHub;

    // --- Profile load/save ----------------------------------------------------
    function nz(v){ const s = (v ?? "").toString().trim(); return s.length ? s : null; }
    // Add this ABOVE saveProfile (line 460)
    async function loadPropertyIntoForm(){
      const me = await getJSON('/extranet/session').catch(()=> ({}));
      $('partnerEmail').textContent = me.email || '';
      let company = me.name || 'Partner';

      const p = await getJSON('/extranet/property').catch(()=> null);

      if (p) {
        $('pp_name').value         = p.name ?? company ?? '';
        $('pp_contactEmail').value = p.contactEmail ?? me.email ?? '';
        $('pp_phone').value        = p.phone ?? '';
        $('pp_country').value      = p.country ?? '';
        $('pp_address').value      = p.addressLine ?? '';

        const loadedCode = normalizeCityCode(p.cityCode || p.city);
        $('pp_city').value         = CITY_LABELS[loadedCode] ? loadedCode : '';

        $('pp_desc').value         = p.description ?? '';

                // Hydrate map lat / lng if the backend has them
        const latInp = document.getElementById('pp_lat');
        const lngInp = document.getElementById('pp_lng');
        if (latInp && typeof p.latitude === 'number') {
          latInp.value = String(p.latitude);
        }
        if (lngInp && typeof p.longitude === 'number') {
          lngInp.value = String(p.longitude);
        }

        // Hydrate map label (human-readable place) + search box
        const labelInp    = document.getElementById('pp_map_label');
        const labelView   = document.getElementById('pp_map_label_view');
        const searchInput = document.getElementById('pp_map_search');
        const labelVal    = p.mapLabel || '';

        if (labelInp) {
          labelInp.value = labelVal;
        }
        if (labelView) {
          labelView.textContent = labelVal || 'Not set';
        }
        // A1: textbox always shows last saved place label
        if (searchInput) {
          searchInput.value = labelVal;
        }

        // If map is already initialized, sync marker + center to saved coords
        try {
          const ctx = window.profileMapCtx;
          if (
            ctx &&
            typeof p.latitude === 'number' &&
            typeof p.longitude === 'number' &&
            !Number.isNaN(p.latitude) &&
            !Number.isNaN(p.longitude)
          ) {
            const pos = { lat: p.latitude, lng: p.longitude };
            ctx.marker.setPosition(pos);
            ctx.map.setCenter(pos);
          }
        } catch (err) {
          console.error('[MAP] failed to sync marker from profile', err);
        }

        $('profileStatus').textContent = p.name ? 'Complete' : 'Missing info';
        $('profileStatus').className   = p.name ? 'ok' : 'todo';

        $('pp_partnerId').value = (p.id ?? p.partnerId ?? me.partnerId ?? '') + '';
        if (p.name) company = p.name;
      } else {

        $('profileStatus').textContent = 'Missing info';
        $('profileStatus').className   = 'todo';
        $('pp_name').value             = company ?? '';
        $('pp_partnerId').value        = (me.partnerId ?? '') + '';
      }

      $('brandTitle').textContent = company;
      $('welcomeH1').textContent  = `Welcome, ${company}`;
    }
  async function saveProfile() {
    const cityCode  = normalizeCityCode($('pp_city').value);
    const cityLabel = CITY_LABELS[cityCode] || '';

    // Read current coordinates from the map fields
    const latRaw = $('pp_lat') ? $('pp_lat').value : '';
    const lngRaw = $('pp_lng') ? $('pp_lng').value : '';
    const latVal = parseFloat(latRaw);
    const lngVal = parseFloat(lngRaw);
    const hasLat = Number.isFinite(latVal);
    const hasLng = Number.isFinite(lngVal);

    // Read the human-readable place label
    const mapLabelVal = $('pp_map_label') ? $('pp_map_label').value.trim() : '';

    // D9: unified required-field validation
    const requiredFields = [
      { id: 'pp_name',         label: 'Hotel / Property Name' },
      { id: 'pp_phone',        label: 'Phone' },
      { id: 'pp_address',      label: 'Address' },
      { id: 'pp_city',         label: 'City' },
      { id: 'pp_country',      label: 'Country' },
      { id: 'pp_desc',         label: 'Description' }
    ];

    let descVal = '';
    for (const field of requiredFields) {
      const el = $(field.id);
      if (!el) continue;
      const value = (el.value || '').trim();
      if (!value) {
        alert(`${field.label} is required.`);
        el.focus();
        return;
      }
      if (field.id === 'pp_desc') {
        descVal = value;
      }
    }

    // PATCH = send only provided fields
    const patchPayload = {
      name:         nz($('pp_name').value),
      phone:        nz($('pp_phone').value),
      addressLine:  nz($('pp_address').value),
      country:      nz($('pp_country').value),
      description:  descVal,
      cityCode:     cityCode || null,
      city:         cityLabel || null,
      latitude:     hasLat ? latVal : null,
      longitude:    hasLng ? lngVal : null,
      mapLabel:     mapLabelVal || null
    };
    Object.keys(patchPayload).forEach(k => (patchPayload[k] == null) && delete patchPayload[k]);

    // Extract partnerId directly from DOM (no session usage)
    const partnerIdText =
      (($('pp_partnerId') && $('pp_partnerId').textContent) ||
      ($('pp_partnerId') && $('pp_partnerId').value) ||
      '').trim();

    const partnerIdNum = partnerIdText ? Number(partnerIdText) : null;

    // PUT payload
    const putPayload = {
      partnerId:    partnerIdNum,
      name:         nz($('pp_name').value),
      phone:        nz($('pp_phone').value),
      addressLine:  nz($('pp_address').value),
      country:      nz($('pp_country').value),
      description:  descVal,
      cityCode:     cityCode || null,
      city:         cityLabel || null,
      latitude:     hasLat ? latVal : null,
      longitude:    hasLng ? lngVal : null,
      mapLabel:     mapLabelVal || null
    };

    const btn = $('btnSave'); btn.disabled = true;
    try {
      // 1) Try PATCH first
      let r = await authed('/extranet/property', {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(patchPayload)
      });

      // 2) If PATCH fails, try PUT with full payload
      if (!r.ok) {
        console.warn('[profile] PATCH failed (' + r.status + '), retrying PUT…');
        r = await authed('/extranet/property', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(putPayload)
        });
      }

      if (!r.ok) {
        const txt = await r.text().catch(() => '');
        // friendlier message when the Partner row doesn’t exist yet (FK failure)
        if (/partner.*not.*present|foreign key|Partner.*fkey/i.test(txt)) {
          throw new Error('Your partner account is not initialized on the server yet (missing Partner row).');
        }
        throw new Error(txt || ('Save failed: ' + r.status));
      }

      // 3) Refresh UI safely
      const saved = await getJSON('/extranet/property').catch(() => null);
      if (window.DEBUG) console.log('[hub] saved record echo:', saved);
      try { (window.loadPropertyIntoForm || loadPropertyIntoForm)(); } catch {}

      toast(
        saved && (saved.name || saved.city)
          ? `Saved “${saved?.name || '—'}” · ${saved?.city || '—'}`
          : 'Saved.',
        true
      );
    } catch (e) {
      console.error(e);
      toast(e.message || 'Network error.');
    } finally {
      btn.disabled = false;
    }
  }

    $('btnSave').onclick = (e) => {
      e.preventDefault();
      const name = ($('pp_name').value || '').trim();
      const phone = ($('pp_phone').value || '').trim();
      const addr  = ($('pp_address').value || '').trim();
      const city  = ($('pp_city').value || '').trim();
      const country = ($('pp_country').value || '').trim();

      if (!name)     { toast('Hotel name is required.'); return; }
      if (!phone)    { toast('Phone is required.'); return; }
      if (!addr)     { toast('Address is required.'); return; }
      if (!city)     { toast('City is required.'); return; }
      if (!country)  { toast('Country is required.'); return; }

      saveProfile();
    };

    // --- PMS Connections / Mappings ------------------------------------------
    const connTbody = $('connTbody');
    const connLogs  = $('connLogs');
    const connMsg   = $('connMsg');
    async function listConnections(){ return getJSON('/extranet/pms/connections').catch(()=>[]); }
    async function listLogs(limit=10){ return getJSON(`/extranet/pms/logs?limit=${limit}`).catch(()=>[]); }

    function renderConnections(rows){
      if (!Array.isArray(rows) || !rows.length) {
        connTbody.innerHTML = '<tr><td class="muted" colspan="7">No connections yet.</td></tr>';
        return;
      }
      connTbody.innerHTML = rows.map(c => `
        <tr>
          <td>${c.id}</td>
          <td>${c.provider}</td>
          <td>${c.mode}</td>
          <td>${c.status}</td>
          <td>${c.scope || '-'}</td>
          <td>${c.updatedAt ? new Date(c.updatedAt).toLocaleString() : '-'}</td>
          <td>
            <button class="btn small secondary" data-act="test" data-id="${c.id}">Test</button>
            <button class="btn small ghost" data-act="del" data-id="${c.id}">Delete</button>
          </td>
        </tr>`).join('');

      connTbody.querySelectorAll('button[data-id]').forEach(btn => {
        btn.onclick = async () => {
          const id  = Number(btn.dataset.id);
          const act = btn.dataset.act;
          try {
            if (act === 'test') {
              connMsg.textContent = 'Testing…';
              const r = await authed(`/extranet/pms/connections/${id}/test`, { method:'POST' });
              if (!r.ok) throw new Error(`Test failed: ${r.status}`);
              await refreshConnections(); toast('Connection test: SUCCESS', true); connMsg.textContent = '';
            } else if (act === 'del') {
              if (!confirm('Delete connection (also deletes mappings & logs)?')) return;
              const r = await authed(`/extranet/pms/connections/${id}`, { method:'DELETE' });
              if (!r.ok) throw new Error(`Delete failed: ${r.status}`);
              await refreshConnections(); toast('Connection deleted.', true);
            }
          } catch (e) {
            console.error(e);
            toast(e.message || 'Action failed');
            connMsg.textContent='';
          }
        };
      });
    }

    function renderLogs(rows){
      if (!Array.isArray(rows) || !rows.length) {
        connLogs.innerHTML = '<li class="muted">No logs.</li>';
        return;
      }
      connLogs.innerHTML = rows.map(l =>
        `<li><strong>${l.type}</strong> · <em>${l.status}</em> — ${l.message} <span class="muted">(${new Date(l.startedAt).toLocaleString()})</span></li>`
      ).join('');
    }

    async function refreshConnections(){
      connMsg.textContent = 'Loading…';
      const [c,l] = await Promise.all([listConnections(), listLogs(10)]);
      renderConnections(c);
      renderLogs(l);
      connMsg.textContent = '';
      if (!$('pmsMappingsPanel').classList.contains('hidden')) await populateConnectionSelect(c);
    }

    const mapTbody = $('mapTbody');
    const mapMsg   = $('mapMsg');
    const mapConn  = $('map_conn');
    const mapRoom  = $('map_room');
    const mapRate  = $('map_rate');
    const mapCurr  = $('map_currency');
    const mapAct   = $('map_active');

    async function listMappings(){ return getJSON('/extranet/pms/mappings').catch(()=>[]); }

    function renderMappings(rows){
      if (!Array.isArray(rows) || !rows.length) {
        mapTbody.innerHTML = '<tr><td class="muted" colspan="7">No mappings yet.</td></tr>';
        return;
      }
      mapTbody.innerHTML = rows.map(m => `
        <tr>
          <td>${m.id}</td><td>${m.pmsConnectionId}</td><td>${m.remoteRoomId}</td>
          <td>${m.remoteRatePlanId || '-'}</td><td>${m.currency || '-'}</td><td>${m.active ? 'true' : 'false'}</td>
          <td><button class="btn small ghost" data-act="del" data-id="${m.id}">Delete</button></td>
        </tr>`).join('');

      mapTbody.querySelectorAll('button[data-id]').forEach(btn => {
        btn.onclick = async () => {
          const id = Number(btn.dataset.id);
          const act = btn.dataset.act;
          if (act === 'del') {
            if (!confirm('Delete mapping?')) return;
            try {
              const r = await authed(`/extranet/pms/mappings/${id}`, { method:'DELETE' });
              if (!r.ok) throw new Error(`Delete failed: ${r.status}`);
              await refreshMappings(false);
              toast('Mapping deleted.', true);
            } catch (e) {
              console.error(e);
              toast(e.message || 'Delete failed');
            }
          }
        };
      });
    }

    async function populateConnectionSelect(connections){
      const conns = Array.isArray(connections) ? connections : await listConnections();
      const options = conns.map(c =>
        `<option value="${c.id}">#${c.id} · ${c.provider} (${c.mode}) · ${c.status}</option>`
      ).join('');
      mapConn.innerHTML = options || '<option value="">No connections</option>';
    }

    async function refreshMappings(refreshConnSelect){
      mapMsg.textContent = 'Loading…';
      if (refreshConnSelect) await populateConnectionSelect();
      const rows = await listMappings();
      renderMappings(rows);
      mapMsg.textContent = '';
    }

    $('btnCreateMapping').onclick = async () => {
      const cid = Number(mapConn.value);
      const room = (mapRoom.value || '').trim();
      const rate = (mapRate.value || '').trim() || null;
      const curr = (mapCurr.value || '').trim() || null;
      const active = mapAct.value === 'true';
      if (!cid || !room) { toast('Connection and Remote Room ID are required.'); return; }
      try {
        mapMsg.textContent = 'Creating…';
        const r = await authed('/extranet/pms/mappings', {
          method:'POST', headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ pmsConnectionId: cid, remoteRoomId: room, remoteRatePlanId: rate, currency: curr, active })
        });
        if (!r.ok) throw new Error(`Create failed: ${r.status}`);
        await refreshMappings(false);
        toast('Mapping created.', true);
      } catch (e) {
        console.error(e);
        toast(e.message || 'Create failed');
      } finally {
        mapMsg.textContent = '';
      }
    };

    $('btnRefreshMaps').onclick = () => refreshMappings(false);

    // --- Init with tolerant session probe (no instant logout) -----------------
    async function probeSessionWithRetry() {
      const t = getToken();
      if (!t) return { ok:false, status:0, body:null };
      const headers = { Authorization: `Bearer ${t}` };
      let r = await fetch(`${API_BASE}/extranet/session?__ts=${Date.now()}`, { headers, cache:'no-store' });
      if (r.status === 401) {
        await new Promise(res => setTimeout(res, 250));
        r = await fetch(`${API_BASE}/extranet/session?__ts=${Date.now()}`, { headers, cache:'no-store' });
      }
      const body = await r.text().catch(()=> '');
      if (DEBUG) console.log('[session probe]', r.status, body);
      try { return { ok: r.ok, status:r.status, body: JSON.parse(body) }; }
      catch { return { ok: r.ok, status:r.status, body }; }
    }

    async function init() {
      const probe = await probeSessionWithRetry();
      if (!probe.ok) {
        if (DEBUG) console.warn('[init] no session → sending to login');
        toast('Please sign in again.');
        setTimeout(() => location.replace(LOGIN_PAGE), 600);
        return;
      }
      try {
        await loadPropertyIntoForm();
        await loadAddonsFromBackend();
      } catch (e) {
        console.error(e);
        toast('Could not load your profile.', false);
      }
    }
    
    // Kick things off after DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

    // If the page was restored from BFCache, re-hydrate the form
    window.addEventListener('pageshow', (e) => {
      if (e.persisted) loadPropertyIntoForm();
    });
  </script>

  <!-- ANCHOR: ADDONS_MODAL -->
  <div id="addonsModalBackdrop" class="addons-modal-backdrop"
      aria-hidden="true"
      onclick="if (event.target === this) closeAddonsModal()">
    <div class="addons-modal" role="dialog" aria-modal="true" aria-labelledby="addonsModalTitle">
      <header>
        <h3 id="addonsModalTitle">Manage Add-ons</h3>
        <button type="button" class="close-btn" id="addonsModalClose"
                aria-label="Close add-ons"
                onclick="closeAddonsModal()">
          ×
        </button>
      </header>
      <div class="addons-body">
        <p style="margin:0; color:var(--muted);">
          Configure activities and extras for your property. Each add-on will appear as an optional extra during checkout.
        </p>

        <div style="margin-top:8px; margin-bottom:6px; font-size:12px;" class="muted">
          Start by adding rows for things like airport transfers, tours, or equipment rentals.
        </div>

        <div class="table-wrapper" style="border:1px solid var(--line); border-radius:10px; overflow:hidden;">
          <table>
          <table>
            <thead>
              <tr>
                <th style="text-align:center; padding:8px 10px; font-size:12px;">Activity/Excursion</th>
                <th style="text-align:center; padding:8px 10px; font-size:12px;">UoM</th>
                <th style="text-align:center; padding:8px 10px; font-size:12px;">Price (USD)</th>
                <th style="text-align:center; padding:8px 10px; font-size:12px;">Notes</th>
                <th style="text-align:center; padding:8px 10px; font-size:12px;">Actions</th>
              </tr>
            </thead>
            <tbody id="addonsTableBody">
              <!-- rows will be injected by JS -->
            </tbody>
          </table>
        </div>
      </div>

      <div class="addons-actions">
        <div>
          <button type="button"
                  id="addonsAddRowBtn"
                  onclick="addAddonRow()"
                  class="btn small"
                  style="
                    background:var(--card);
                    border-radius:999px;
                    border:1px solid #3b82f6;
                    color:#e5e7eb;
                    padding:6px 14px;
                    font-size:12px;
                  ">
            Add Row
          </button>
        </div>
        <div>
          <button type="button"
                  class="btn secondary"
                  id="addonsDiscardBtn"
                  onclick="discardAddonsModal()">
            Cancel
          </button>
          <button type="button"
                  class="btn"
                  id="addonsSaveBtn"
                  onclick="saveAddonsModal()">
            Save
          </button>
        </div>
      </div>

<script>
// Make the Photos tile open the API-hosted page, passing the token
(function () {
  var a = document.getElementById('tilePhotos');
  if (!a) return;

  a.addEventListener('click', function (e) {
    e.preventDefault();
    var t = localStorage.getItem('partnerToken') || localStorage.getItem('lolaelo_session') || '';
    var base = (location.hostname.endsWith('lolaelo.com'))
      ? 'https://lolaelo-api.onrender.com/partners_photos.html'
      : '/partners_photos.html';
    // cache-bust as query, token in hash (early-capture on target reads both)
    var url = base + '?cb=' + Date.now() + (t ? '#token=' + encodeURIComponent(t) : '');
    location.href = url;
  });
})();
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB3S03x_g_worh7dj4dk-lHYPFJ3RMknVc&libraries=places"></script>
<script>
  // Simple in-memory state for the current session
  let addonsSessionRows = [];
    async function loadAddonsFromBackend() {
      try {
        const rows = await getJSON('/extranet/property/addons');
        if (Array.isArray(rows)) {
          addonsSessionRows = rows.map((r) => ({
            activity: r.activity || '',
            uom: r.uom || '',
            price:
              typeof r.price === 'number'
                ? r.price
                : (r.price != null ? Number(r.price) : null),
            notes: r.notes || ''
          }));
        } else {
          addonsSessionRows = [];
        }
      } catch (e) {
        console.error('[addons] failed to load from backend', e);
        addonsSessionRows = [];
      }

      resetAddonsTableFromState();
      updateAddonsButtonLabel();
    }
  
  function updateAddonsButtonLabel() {
    const lbl = document.getElementById('addonsCountLabel');
    if (!lbl) return;

    const count = Array.isArray(addonsSessionRows)
      ? addonsSessionRows.length
      : 0;

    lbl.textContent = count > 0 ? `(${count} configured)` : '';
  }

  const ADDON_ACTIVITY_PRESETS = [
    'Island hopping tour',
    'Scuba diving',
    'Snorkeling tour',
    'Pub crawl',
    'Guided hike',
    'Airport transfer',
    'Motorbike / scooter rental',
    'Breakfast add-on',
    'Late checkout'
  ];

  const ADDON_UOM_PRESETS = [
    'Persons',
    'Qty',
    'Hour'
  ];

  function getAddonsTableBody() {
    return document.getElementById('addonsTableBody');
  }

  function createAddonRow(initial) {
    const tr = document.createElement('tr');

    // Activity
    const activityTd = document.createElement('td');
    const activitySel = document.createElement('select');
    activitySel.style.width = '100%';
    activitySel.style.fontSize = '12px';

    const actPlaceholder = document.createElement('option');
    actPlaceholder.value = '';
    actPlaceholder.textContent = 'Select activity';
    actPlaceholder.disabled = true;
    actPlaceholder.selected = true;
    activitySel.appendChild(actPlaceholder);

    ADDON_ACTIVITY_PRESETS.forEach((name) => {
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = name;
      activitySel.appendChild(opt);
    });

    if (initial && initial.activity) {
      activitySel.value = initial.activity;
      if (!activitySel.value) {
        activitySel.value = '';
      }
    }

    activityTd.appendChild(activitySel);

    // UoM
    const uomTd = document.createElement('td');
    const uomSel = document.createElement('select');
    uomSel.style.width = '100%';
    uomSel.style.fontSize = '12px';

    ADDON_UOM_PRESETS.forEach((name) => {
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = name;
      uomSel.appendChild(opt);
    });

    if (initial && initial.uom) {
      uomSel.value = initial.uom;
    }

    uomTd.appendChild(uomSel);

    // Price (USD)
    const priceTd = document.createElement('td');
    const priceWrap = document.createElement('div');
    priceWrap.style.display = 'flex';
    priceWrap.style.alignItems = 'center';
    priceWrap.style.gap = '4px';

    const usdSpan = document.createElement('span');
    usdSpan.textContent = '$';
    usdSpan.style.fontSize = '12px';

    const priceInput = document.createElement('input');
    priceInput.type = 'number';
    priceInput.min = '0';
    priceInput.step = '0.01';
    priceInput.placeholder = '0.00';
    priceInput.style.width = '40%';      // 40% of previous size
    priceInput.style.fontSize = '12px';
    priceInput.addEventListener('wheel', function (e) {
      e.preventDefault();                 // keep scroll from changing value
    });

    if (initial && typeof initial.price === 'number') {
      priceInput.value = initial.price.toFixed(2);
    }

    priceWrap.appendChild(usdSpan);
    priceWrap.appendChild(priceInput);
    priceTd.appendChild(priceWrap);

    // Notes (small textarea)
    const notesTd = document.createElement('td');
    const notesArea = document.createElement('textarea');
    notesArea.rows = 4;                        // ~2x height
    notesArea.style.width = '100%';           // fill its column, no overflow
    notesArea.style.minHeight = '96px';       // 2x min height
    notesArea.style.fontSize = '12px';
    notesArea.style.resize = 'vertical';
    notesArea.placeholder = 'Optional notes';
    if (initial && initial.notes) {
      notesArea.value = initial.notes;
    }
    notesTd.appendChild(notesArea);

    // Actions
    const actionsTd = document.createElement('td');
    actionsTd.style.textAlign = 'right';

    const delBtn = document.createElement('button');
    delBtn.type = 'button';
    delBtn.textContent = 'Remove';
    delBtn.className = 'btn secondary';
    delBtn.style.fontSize = '11px';
    delBtn.style.padding = '4px 8px';

    delBtn.addEventListener('click', function (e) {
      e.preventDefault();
      tr.remove();
    });

    actionsTd.appendChild(delBtn);

    tr.appendChild(activityTd);
    tr.appendChild(uomTd);
    tr.appendChild(priceTd);
    tr.appendChild(notesTd);
    tr.appendChild(actionsTd);

    return tr;
  }

  function resetAddonsTableFromState() {
    const tbody = getAddonsTableBody();
    if (!tbody) return;
    tbody.innerHTML = '';

    if (!Array.isArray(addonsSessionRows) || addonsSessionRows.length === 0) {
      // At least one empty row
      tbody.appendChild(createAddonRow(null));
      return;
    }

    addonsSessionRows.forEach((row) => {
      tbody.appendChild(createAddonRow(row));
    });
  }

  function addAddonRow() {
    const tbody = getAddonsTableBody();
    if (!tbody) return;
    tbody.appendChild(createAddonRow(null));
  }

  function openAddonsModal() {
    var bd = document.getElementById('addonsModalBackdrop');
    if (!bd) return;

    // Build rows from current session state
    resetAddonsTableFromState();

    bd.classList.add('is-open');
    bd.setAttribute('aria-hidden', 'false');
  }

  function closeAddonsModal() {
    var bd = document.getElementById('addonsModalBackdrop');
    if (!bd) return;
    bd.classList.remove('is-open');
    bd.setAttribute('aria-hidden', 'true');
  }

  function saveAddonsModal() {
    const tbody = getAddonsTableBody();
    if (!tbody) {
      closeAddonsModal();
      return;
    }

    const rows = Array.from(tbody.querySelectorAll('tr'));
    addonsSessionRows = rows.map((tr) => {
      const cells = tr.querySelectorAll('td');
      if (cells.length < 4) return null;

      const activitySel = cells[0].querySelector('select');
      const uomSel      = cells[1].querySelector('select');
      const priceInput  = cells[2].querySelector('input[type="number"]');
      const notesArea   = cells[3].querySelector('textarea');

      const activity = activitySel ? activitySel.value.trim() : '';
      const uom      = uomSel ? uomSel.value.trim() : '';
      const priceVal = priceInput && priceInput.value
        ? parseFloat(priceInput.value)
        : null;
      const notes    = notesArea ? notesArea.value.trim() : '';

      return {
        activity,
        uom,
        price: isNaN(priceVal) ? null : priceVal,
        notes
      };
    }).filter(Boolean);

    (async () => {
      try {
        const r = await authed('/extranet/property/addons', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ items: addonsSessionRows })
        });

        if (!r.ok) {
          const txt = await r.text().catch(() => '');
          console.error('[addons] save failed', r.status, txt);
          toast('Could not save add-ons. Please try again.', false);
        } else {
          toast('Add-ons saved.', true);
        }
      } catch (err) {
        console.error('[addons] save error', err);
        toast('Could not save add-ons. Please try again.', false);
      } finally {
        updateAddonsButtonLabel();
        closeAddonsModal();
      }
    })();
  }

function discardAddonsModal() {
  // Do NOT touch addonsSessionRows.
  // Just restore the table to the last saved snapshot and close.
  resetAddonsTableFromState();
  closeAddonsModal();
}

  // Initialize add-ons label on first load
  updateAddonsButtonLabel();

    // --- Company Profile Map wiring (Google Maps + Places) -------------------
  (function () {
    const mapEl       = document.getElementById('pp_map');
    const latInp      = document.getElementById('pp_lat');
    const lngInp      = document.getElementById('pp_lng');
    const searchInput = document.getElementById('pp_map_search');

    let map   = null;
    let marker = null;

    function updateInputs(pos) {
      if (!latInp || !lngInp || !pos) return;
      const lat = typeof pos.lat === 'function' ? pos.lat() : pos.lat;
      const lng = typeof pos.lng === 'function' ? pos.lng() : pos.lng;
      if (typeof lat === 'number' && !Number.isNaN(lat)) {
        latInp.value = lat.toFixed(6);
      }
      if (typeof lng === 'number' && !Number.isNaN(lng)) {
        lngInp.value = lng.toFixed(6);
      }
    }

    function clearMapLabel() {
      const labelInp  = document.getElementById('pp_map_label');
      const labelView = document.getElementById('pp_map_label_view');
      if (labelInp)  labelInp.value = '';
      if (labelView) labelView.textContent = 'Not set';
    }

    // Exposed map initializer (used by loadPropertyIntoForm + onload)
    function initProfileMap() {
      if (!mapEl || !window.google || !google.maps) {
        console.warn('[MAP] Google Maps not available or mapEl missing');
        return;
      }

      const defaultCenter = {
        lat: parseFloat(latInp && latInp.value) || 9.7894,
        lng: parseFloat(lngInp && lngInp.value) || 126.165
      };

      map = new google.maps.Map(mapEl, {
        center: defaultCenter,
        zoom: 13,
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: false
      });

      marker = new google.maps.Marker({
        position: defaultCenter,
        map,
        draggable: true
      });

      // Click on map updates marker + inputs
      map.addListener('click', (e) => {
        marker.setPosition(e.latLng);
        updateInputs(e.latLng);
        clearMapLabel();
      });

      // Dragging marker updates inputs as well
      marker.addListener('dragend', (e) => {
        updateInputs(e.latLng);
        clearMapLabel();
      });

      // Stash context so loadPropertyIntoForm can recenter on saved coords
      window.profileMapCtx = { map, marker };
    }

    // Search box: Enter-to-geocode behavior + shared handler for Search button
    if (searchInput) {
      console.log('[MAP] Wiring search input for Enter-to-geocode');
      const geocoder = new google.maps.Geocoder();

      function runGeocode() {
        const query = searchInput.value.trim();
        console.log('[MAP] Search trigger, query =', query);
        if (!query) {
          console.log('[MAP] Empty query, skipping geocode');
          return;
        }

                geocoder.geocode(
          {
            address: query,
            componentRestrictions: { country: 'PH' }
          },
          function (results, status) {
            console.log('[MAP] geocode result status =', status, 'results =', results);
            if (status !== 'OK' || !results || !results.length) {
              console.warn('Geocode failed:', status);
              return;
            }

            const loc = results[0].geometry.location;

            if (map && marker) {
              map.setCenter(loc);
              map.setZoom(15);
              marker.setPosition(loc);
            }
            updateInputs(loc);

            // Update map label (hidden field + UI)
            const labelInp  = document.getElementById('pp_map_label');
            const labelView = document.getElementById('pp_map_label_view');
            const label =
              (results[0].formatted_address || results[0].name || query || '').trim();

            if (labelInp) {
              labelInp.value = label;
            }
            if (labelView) {
              labelView.textContent = label || 'Not set';
            }

            // Keep the resolved label in the search box as well
            if (searchInput && label) {
              searchInput.value = label;
            }
          }
        );
      }

      // Enter key triggers geocode
      searchInput.addEventListener('keydown', function (e) {
        console.log('[MAP] search keydown:', e.key);
        if (e.key !== 'Enter') return;
        e.preventDefault();
        runGeocode();
      });

      // Expose handler for the "Search" button
      window.__ppMapSearch = runGeocode;
    }

    // Initialize map after page load
    window.addEventListener('load', function () {
      try {
        initProfileMap();
      } catch (e) {
        console.warn('Profile map init failed:', e);
      }
    });

    // Also expose init for any other callers, defensively
    window.initProfileMap = initProfileMap;
  })();
</script>
</body>
</html>