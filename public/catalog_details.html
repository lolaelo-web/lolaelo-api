<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lolaelo · Stay</title>
  <link rel="icon" href="/logo.png" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    /* === ANCHOR: DETAILS_LIGHT_SKIN ======================================= */
    :root{
      --bg:#fff; --fg:#111; --muted:#6b7280; --line:#eaeaea; --bubble:#ff6633;
      --paper:#ffffff; --radius:16px; --shadow:0 12px 40px rgba(0,0,0,.08);
      --maxw:1100px;
      /* ANCHOR: TYPO_BASE_VAR */ --body:15px;   /* <-- ADD THIS LINE */
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; }
    body{
      font: var(--body)/1.45 Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--fg);
      background:
        linear-gradient(to bottom, rgba(255,255,255,.10), rgba(255,255,255,.10)),
        url("https://images.pexels.com/photos/1005417/pexels-photo-1005417.jpeg?auto=compress&cs=tinysrgb&dpr=2&h=1600&w=2400")
        center/cover no-repeat fixed;
      display:flex; flex-direction:column; align-items:center;
    }   
    /* ANCHOR: DETAILS_TYPE_SCALE */
    html { font-size: 16px; }                   /* baseline */
    body { font-size: 15px; line-height: 1.5; } /* normal text size across customer UIs */

    h1 { font-size: clamp(30px, 4.8vw, 44px); line-height: 1.15; margin: 6px 0 10px; font-weight: 600; }
    h2 { font-size: clamp(18px, 2.4vw, 22px); line-height: 1.2; margin: 10px 0 8px; font-weight: 600; }

    p, li, .meta, .tag, .desc, .smalltext { font-size: 15px; }
    .small { font-size: 13px; color: var(--muted); }

    /* ANCHOR: TYPO_REGULAR_ELEMS */
    p, li, td, th, input, select, button, .meta, .note { font-size: var(--body); }
    /* ANCHOR: DETAILS_PAPER_CLIP */
    .paper{ width:100%; max-width:var(--maxw); margin:18px 20px; background:var(--paper);
      border-radius:var(--radius); box-shadow:var(--shadow); padding:16px 16px 22px;
      overflow: hidden; /* clip panel to rounded frame */
    }
    
    /* ANCHOR: DETAILS_TOPBAR_CSS */
    .topbar{
        display:grid;
        grid-template-columns: 1fr auto; /* back (left) | title (right) */
        align-items:center;
        gap:12px;
        margin:8px 0 14px;
    }
    .topbar .back{
        justify-self:start;
        font-size:14px;
        padding:6px 10px;
        border:1px solid var(--line);
        border-radius:10px;
        background:#fff;
        color:var(--fg);
        text-decoration:none;
    }
    .topbar .back:hover{ filter:brightness(.98); }
    .topbar .title{
        margin:0;
        font-size:22px;
        font-weight:600;
        justify-self:end;   /* pushes the name to the right edge */
    }

    /* ANCHOR: DETAILS_LAYOUT_COLS */
    .layout{ display:grid; grid-template-columns: 1.1fr 1fr; gap:16px; }
    @media (min-width:1200px){
      .layout{ grid-template-columns: 1fr 0.95fr; }
    }
    @media (max-width:900px){
      .layout{ grid-template-columns: 1fr; }
    }

    /* Right panel */
    /* ANCHOR: DETAILS_PANEL_BOX */
    .panel{
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:14px;
      min-width: 320px;      /* ensures buttons/price breathe */
      max-width: 420px;      /* prevents overgrowth on ultra-wide */
      margin-left:auto;      /* tucks to the right edge cleanly */
    }
    .muted{ color:var(--muted); font-size:12px; }
    /* ANCHOR: DETAILS_PRICE_SIZE */
    .price{ font-weight:700; font-size:26px; letter-spacing:.2px; }
    @media (min-width:1200px){
      .price{ font-size:28px; }
    }
    .book{ border:1px solid var(--bubble); background:var(--bubble); color:#fff; font-weight:700;
      border-radius:12px; padding:14px; width:100%; cursor:pointer; }

    /* Chips + table */
    .chips{ display:flex; gap:6px; flex-wrap:wrap; margin:10px 0; }
    .chip{ font-size:11px; padding:4px 8px; border:1px solid var(--line); border-radius:999px; background:#fafafa; color:#444; }

    table{ width:100%; border-collapse:separate; border-spacing:0; margin-top:10px; }
    thead th{ text-align:left; font-size:12px; color:var(--muted); padding:8px; border-bottom:1px solid var(--line); }
    tbody td{ padding:10px 8px; border-bottom:1px solid var(--line); font-variant-numeric:tabular-nums; }
    .tag{ padding:4px 8px; border-radius:999px; background:#ecfdf5; color:#047857; font-size:12px; border:1px solid #d1fae5; display:inline-block; }
    .tag.off{ background:#fef2f2; color:#b91c1c; border-color:#fee2e2; }

    /* ANCHOR: DETAILS_GALLERY_CSS */
    .hero{
      position: relative;
      border-radius: var(--radius);
      overflow: hidden;
      background:#fff;
      aspect-ratio: 16 / 9;
      width: 100%;
      min-height: 260px;
      box-shadow: var(--shadow);
    }

    .hero img{
      width:100%;
      height:100%;
      object-fit:contain;
      object-position:center;
      display:block;
      opacity: 1;
      transition: opacity .25s ease;
      background:#fff; /* keeps letterbox bars white, not black */
    }

    .hero img.is-fading{ opacity: 0; }

    .thumbs{
      display: grid;
      grid-auto-flow: column;
      grid-auto-columns: max-content;
      gap: 10px;
      margin: 12px 0 10px;
      padding: 4px 2px;
      overflow-x: auto;
      scrollbar-gutter: stable;
    }

    .thumbs button{
      appearance: none;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #fff;
      padding: 0;
      margin: 0;
      line-height: 0;
      cursor: pointer;
      box-shadow: 0 6px 16px rgba(0,0,0,.10);
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .thumbs img{ display: block; width: 110px; height: 72px; object-fit: contain; background:#fff; border-radius: 12px; }
    .thumbs button:hover{
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(0,0,0,.12);
    }
    .thumbs button:focus-visible{
      outline: 2px solid var(--bubble);
      outline-offset: 2px;
    }
    .thumbs button[aria-current="true"]{
      border-color: var(--bubble);
      box-shadow: 0 0 0 2px rgba(255,102,51,.25) inset;
    }
    /* ANCHOR: DETAILS_GALLERY_CSS */

  </style>
</head>
<body>
  <div class="paper">
    <header>
      <!-- ANCHOR: DETAILS_TOPBAR -->
      <div class="topbar">
        <a class="back" href="/catalog">← Back</a>
        <h1 class="title">
          <span id="prop-name">Loading…</span>
          <span id="src-badge" class="chip" style="display:none; margin-left:8px;">db</span>
        </h1>
      </div>
      <!-- /ANCHOR: DETAILS_TOPBAR -->
    </header>

    <div class="layout">
      <section>
        <div id="hero" class="hero" aria-live="polite">
          <img id="hero-img" src="" alt="">
        </div>
        <!-- ANCHOR: DETAILS_THUMBS -->
        <div id="thumbs" class="thumbs" aria-label="More photos"></div>

        <div class="chips" id="amenities"></div>

        <table aria-label="Availability and prices">
          <thead><tr>
            <th style="width:120px;">Date</th>
            <th style="width:60px;">Open</th>
            <th style="width:100px;">Price</th>
            <th style="width:80px;">MinStay</th>
            <th style="width:80px;">Status</th>
          </tr></thead>
          <tbody id="rows"></tbody>
        </table>
      </section>

      <aside class="panel">
        <div class="muted" id="stay-range"></div>
        <div class="muted">From</div>
        <div class="price" id="from"></div>
        <div class="muted" id="nights-note"></div>
        <button class="book" type="button" id="book">Book now (mock)</button>
        <div class="muted" id="copyLink" style="text-align:center; cursor:pointer;">Copy link</div>
      </aside>
    </div>
  </div>

  <script>
    // === ANCHOR: DETAILS_SCRIPT ============================================
    const qs = new URLSearchParams(location.search);
    const propertyId = qs.get('propertyId');
    const start = qs.get('start') || new Date().toISOString().slice(0,10);
    const end   = qs.get('end')   || start;
    const plan  = qs.get('ratePlanId') || qs.get('plan');

    // ANCHOR: DETAILS_PLAN_PARAM_DEF
    const planParam = (qs.get('ratePlanId') || qs.get('plan') || '').trim();
    const planQS = planParam ? `&ratePlanId=${encodeURIComponent(planParam)}` : '';

    /* ANCHOR: DETAILS_SET_BACK */
    const backLink = document.querySelector('a.back');
    if (backLink){
      const guests = qs.get('guests') || '2';
      const plan   = qs.get('ratePlanId') || qs.get('plan') || '';
      const planPart = plan ? `&ratePlanId=${encodeURIComponent(plan)}` : '';
      backLink.href =
        `/catalog?start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}&guests=${encodeURIComponent(guests)}${planPart}`;
    }

    const hero = document.getElementById('hero-img');
      hero.decoding = 'async';
    const thumbs = document.getElementById('thumbs');
    const rows = document.getElementById('rows');
    const fromEl = document.getElementById('from');
    const rangeEl = document.getElementById('stay-range');
    const nameEl = document.getElementById('prop-name');
    const amenities = document.getElementById('amenities');
    const nightsNote = document.getElementById('nights-note');

    let images = [];
    let heroIndex = 0;

    function setHero(i){
      if (!images.length) return;
      i = Math.max(0, Math.min(images.length - 1, i));
      heroIndex = i;
      const src = images[i];

      hero.classList.add('is-fading');
      const img = new Image();
      img.onload = () => {
        hero.src = src;
        hero.alt = `${nameEl.textContent || 'Property'} — hero image`;
        requestAnimationFrame(() => { hero.classList.remove('is-fading'); });
      };
      img.src = src;

      thumbs.querySelectorAll('button.thumb').forEach((btn, idx) => {
        btn.setAttribute('aria-current', idx === i ? 'true' : 'false');
      });
    }

    function thumbHTML(src, idx){
      const current = idx === 0 ? 'true' : 'false';
      const total = images.length || 0;
      const name = (nameEl && nameEl.textContent) ? nameEl.textContent : 'Property';
      return `<button class="thumb" type="button" data-idx="${idx}" aria-label="${name} photo ${idx+1} of ${total}" aria-current="${current}">
        <img src="${src}" alt="${name} — photo ${idx+1} of ${total}" loading="lazy" decoding="async">
      </button>`;
    }

    function money(v){ const n=Number(v); return Number.isFinite(n) ? `$${n.toFixed(2)}` : '—'; }

    async function load(){
      // ANCHOR: DETAILS_FETCH_WITH_PLAN
      const plan    = qs.get('ratePlanId') || qs.get('plan') || '';
      const planQS  = plan ? `&ratePlanId=${encodeURIComponent(plan)}` : '';
      const url     = `/catalog/details?propertyId=${encodeURIComponent(propertyId)}&start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}${planQS}`;
      const r       = await fetch(url, { cache: 'no-store' });
      const j       = await r.json();

      nameEl.textContent = j?.name || j?.meta?.property?.name || 'Stay';
      const srcBadgeEl = document.getElementById('src-badge');
      if (srcBadgeEl) srcBadgeEl.style.display = (j?._roomsSource === 'db') ? 'inline-block' : 'none';
      rangeEl.textContent = `${start} — ${end}`;
      // Compute fromPrice + availability from daily rows (works for DB-backed data)
      const daily0 = (j?.rooms?.[0]?.daily || []);
      const priced = daily0.filter(d => typeof d.price === 'number');
      const minPrice = priced.length ? Math.min(...priced.map(d => Number(d.price))) : null;
      fromEl.textContent = (minPrice != null) ? money(minPrice) : '—';
      // Nights available note (deduped, DB-safe)
      {
        // uses daily0 computed above
        const available = daily0.filter(d => !d.closed && Number(d.inventory ?? d.open ?? 0) > 0).length;
        const total = daily0.length;
        nightsNote.textContent = `${available}/${total} nights available`;
      }

      // Prefer details.images (DB-backed) with cover support; fallback to first room images
      const rawImages =
        Array.isArray(j?.images) ? j.images
        : (Array.isArray(j?.rooms?.[0]?.images) ? j.rooms[0].images : []);

      // Extract a cover url if present (object with { url, isCover: true })
      const coverUrl =
        (Array.isArray(j?.images)
          ? j.images.find(it => typeof it === 'object' && it?.isCover === true)?.url
          : null) ||
        null;

      // Normalize to an array of URL strings
      images = rawImages
        .map(it => (typeof it === 'string' ? it : it?.url))
        .filter(Boolean);

      // If we found a cover, move it to the front
      if (coverUrl) {
        const idx = images.indexOf(coverUrl);
        if (idx > 0) {
          images.splice(0, 0, ...images.splice(idx, 1));
        }
      }

      // Thumbs + hero
      thumbs.innerHTML = images.map((src, i)=>thumbHTML(src, i)).join("");
      setHero(0);

      thumbs.addEventListener('click', (e)=>{
        const b = e.target.closest('.thumb'); if(!b) return;
        setHero(Number(b.dataset.idx||'0'));
      });
      thumbs.addEventListener('mouseover', (e)=>{
        const b = e.target.closest('.thumb'); if(!b) return;
        setHero(Number(b.dataset.idx||'0'));
      });

      // table rows (DB-safe: inventory || open)
      // ANCHOR: DETAILS_ROWS_RENDER
      const daily = j?.rooms?.[0]?.daily || [];
      if (!daily.length) {
        rows.innerHTML = `<tr>
          <td colspan="5" class="small" style="color:var(--muted); padding:14px 8px;">
            No availability or pricing for the selected dates. Try widening the range in Catalog.
          </td>
        </tr>`;
      } else {
        rows.innerHTML = daily.map(d => {
          const openCount = Number(d.inventory ?? d.open ?? 0);
          const isClosed = Boolean(d.closed) || openCount <= 0;
          const tag = isClosed ? `<span class="tag off">Closed</span>` : `<span class="tag">Open</span>`;
          return `<tr>
            <td>${d.date}</td>
            <td>${openCount}</td>
            <td>${money(d.price)}</td>
            <td>${d.minStay ?? 1}</td>
            <td>${tag}</td>
          </tr>`;
        }).join("");
      }
    }

    document.getElementById('book').addEventListener('click', ()=>{
      alert('Booking flows are coming soon. For now, this is a design preview using mock data.');
    });
    document.getElementById('copyLink').addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(location.href); alert('Link copied'); }catch(_){}
    });

    load().catch(err=>{ console.error(err); alert('Failed to load details'); });
  </script>
  
</body>
</html>
