<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lolaelo ¬∑ Catalog</title>
  <link rel="icon" href="https://www.lolaelo.com/logo2.png" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    /* === ANCHOR: CATALOG_LIGHT_SKIN (theme tokens) ======================== */
    :root{
      --bg:#ffffff;
      --fg:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --brand:#064e3b;          /* deep teal, same as new pages */
      --bubble:#ff6a3d;         /* orange accent for Search/CTAs */
      --paper:#ffffff;
      --radius:20px;
      --shadow:0 12px 40px rgba(15,23,42,.10);
      --maxw:960px;             /* tighter, like the new homepage card */
    }

    /* === ANCHOR: CATALOG_BASE_LAYOUT ===================================== */
    *{
      box-sizing:border-box;
    }

    html,
    body{
      height:100%;
      margin:0;
    }

    /* Standardize base type across customer UIs */
    html{
      font-size:16px;
    }

    body{
      font:15px/1.5 Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--fg);
      /* very light teal-at-top ‚Üí white gradient, keeps it minimalist */
      background:
        linear-gradient(to bottom, rgba(6, 78, 59, 0.06), #ffffff 42%);
      display:flex;
      flex-direction:column;
      align-items:center;
    }

    .paper{
      width:100%;
      max-width:var(--maxw);
      margin:24px 20px;
      background:var(--paper);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:22px 22px 30px;
    }

    /* === ANCHOR: CATALOG_HEADER_CSS ====================================== */
    /* Grid header: logo on left, back link on right */
    header{
      display:grid;
      grid-template-columns:auto 1fr auto;
      align-items:center;
      gap:12px;
      margin-bottom:8px;
    }

    header h1{
      margin:6px 0 0;
      text-align:center;
      font-size:clamp(22px, 3.4vw, 26px);
      font-weight:600;
    }

    /* Standardized logo container (kept for layout compatibility) */
    .logo{
      display:flex;
      align-items:center;
      gap:10px;
      text-decoration:none;
      color:inherit;
    }

    .logo-img{
      height:28px !important;
      width:auto !important;
      display:block;
      object-fit:contain;
    }

    /* Optional text wordmark if used */
    .wordmark{
      font-weight:700;
      font-size:18px;
      letter-spacing:.2px;
    }

    /* Back link (top-right), matching destinations page behavior */
    .nav-link{
      color:var(--brand);
      padding:4px 0;
      font-weight:500;
      text-decoration:none; /* no underline by default */
      justify-self:end;
    }

    .nav-link-back{
      display:inline-flex;
      align-items:center;
      gap:6px;
      text-decoration:none; /* no underline on full link */
    }

    .nav-back-arrow{
      font-size:16px;
      line-height:1;
      transform:translateY(1px);
      text-decoration:none !important;
    }

    /* text span is the second span inside .nav-link-back */
    .nav-link-back span:last-child{
      text-decoration:none;
    }

    /* Hover: underline text only, arrow stays clean */
    .nav-link-back:hover span:last-child{
      text-decoration:underline;
    }

    .nav-link-back:hover .nav-back-arrow{
      transform:translate(-2px, 1px);
      transition:transform 0.15s ease-out;
    }

    /* === ANCHOR: CATALOG_MAP_MODAL_CSS ============================= */
    .subhead-row{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-top:8px;
    }

    .map-toggle-btn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 20px;              /* bigger pill */
      border-radius:999px;
      border:1px solid var(--line-soft);
      background:rgba(15,23,42,0.02);
      color:var(--muted);
      font-size:16px;                  /* ~3x visual vs before */
      cursor:pointer;
      margin-top:10px;                 /* drops pill into the gap (toward Filters row) */
    }

    .map-toggle-btn:hover{
      background:rgba(15,23,42,0.04);
    }

    .map-toggle-icon{
      width:24px;
      height:24px;
      border-radius:999px;
      display:block;
    }

    .catalog-map-backdrop{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(15,23,42,0.55);
      z-index:70;
    }

    .catalog-map-inner{
      background:#020617;
      border-radius:18px;
      box-shadow:0 18px 45px rgba(15,23,42,0.32);
      width:min(900px, calc(100vw - 32px));
      height:min(540px, calc(100vh - 80px));
      position:relative;
      overflow:hidden;
    }

    .catalog-map-close{
      position:absolute;
      top:10px;
      right:10px;
      width:32px;
      height:32px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.5);
      background:#ffffff;
      cursor:pointer;
      font-size:16px;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .catalog-map-frame{
      border:0;
      width:100%;
      height:100%;
    }

    @media (max-width:640px){
      .catalog-map-inner{
        width:calc(100vw - 24px);
        height:calc(100vh - 60px);
      }
    }

    /* === ANCHOR: CATALOG_FILTERS_SEARCH ================================== */
    /* Collapsible filters (amenities only) */
    details.filters{
      border:1px solid var(--line);
      border-radius:16px;
      padding:0;
      overflow:hidden;
      background:#ffffff;
      margin-top:10px;
      box-shadow:0 4px 14px rgba(15,23,42,0.06);
    }

    .filters summary{
      list-style:none;
      cursor:pointer;
      padding:0;
      font-weight:600;
      display:flex;
      align-items:center;
    }

    .filters[open] summary{
      border-bottom:1px solid var(--line);
    }

    .filters{
      width:100%;
    }

    .filters .summary-pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:auto;
      background:rgba(255,106,61,0.06);   /* light tint only behind the text */
      border:1px solid rgba(255,106,61,0.55);
      border-radius:999px;
      padding:6px 12px;
      font-weight:600;
      font-size:13px;
      letter-spacing:0.03em;
      color:#1f2933;
      box-shadow:0 2px 6px rgba(15,23,42,0.10);
    }

    .filters-body{
      padding:12px 14px 10px;
      display:flex;
      gap:10px 16px;
      flex-wrap:wrap;
      font-size:13px;
      color:var(--muted);
    }

    .filters-body label{
      display:inline-flex;
      align-items:center;
      gap:4px;
      font-size:13px;
      cursor:pointer;
    }

    .filters-body input[type="checkbox"]{
      accent-color:#064e3b; /* brand green */
    }

    /* === ANCHOR: CATALOG_SEARCH_BAR_CSS (mirror landing) ================ */

    /* Outer search card: match index.html search-card */
    .searchbar{
      border-radius:18px;
      padding:14px 16px;
      margin-bottom:12px;
      background:#ffffff;
      border:1px solid #e5e7eb;
      box-shadow:0 18px 45px rgba(15,23,42,0.08);
    }

    /* Grid layout: 4 fields + Search button, like search-row */
    .controls-row{
      display:grid;
      grid-template-columns:1.4fr 1.3fr 1fr 1fr auto;
      gap:8px;
      align-items:stretch;
    }

    /* Field shell: match search-input-shell */
    .field{
      display:flex;
      align-items:center;
      gap:8px;
      background:#f9fafb;
      border:1px solid #e5e7eb;
      border-radius:12px;
      padding:8px 12px;
      position:relative;
      transition:
        border-color .15s ease-out,
        box-shadow .15s ease-out,
        background .15s ease-out;
    }

    .field:hover{
      border-color:#d1d5db;
      background:#ffffff;
      box-shadow:0 2px 8px rgba(15,23,42,0.12);
    }

    .field span{
      font-size:14px;
    }

    .field input,
    .field select{
      width:100%;
      border:none;
      background:transparent;
      outline:none;
      font:inherit;
      font-size:14px;
      color:var(--fg);
    }

    /* Search button: match landing search-btn */
    .search-btn{
      border:none;
      background:#ff6a3d;
      color:#ffffff;
      font-weight:600;
      font-size:13px;
      border-radius:999px;
      padding:0 18px;
      min-height:32px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      white-space:nowrap;
      box-shadow:0 10px 22px rgba(248,113,73,0.45);
      transition:filter .15s ease-out, box-shadow .15s ease-out, transform .12s ease-out;
    }

    .search-btn:hover{
      filter:brightness(0.97);
      box-shadow:0 12px 26px rgba(248,113,73,0.55);
      transform:translateY(-1px);
    }

    /* === ANCHOR: CATALOG_CUSTOM_SELECT_CSS (match landing) ================== */

    /* Container behaves same as landing page */
    .custom-select {
      position: relative;
      width: 100%;
    }

    /* Toggle ‚Üí widened, landing-page style */
    .custom-select-toggle {
      width: 100%;
      padding: 0;
      margin: 0;
      border: none;
      background: transparent;
      text-align: left;
      font: inherit;
      color: #111827;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;

      /* widen to match landing page proportions */
      min-width: 160px;  /* was 260 ‚Üí about 60% of that width */
    }

    /* === ANCHOR: GUEST_FIELD_WIDTH_FIX =================== */
    .field-guests .custom-select-toggle {
      min-width: 120px !important;   /* half the current ~240px width */
    }

    /* Label text handling */
    .custom-select-label {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Dropdown menu ‚Üí match landing behavior and field width */
    .custom-select-menu {
      list-style: none;
      margin: 4px 0 0 0;
      padding: 4px 0;
      position: absolute;
      top: 100%;

      /* extend slightly past inner content so it visually matches the field */
      left: -21px;
      right: -12px;

      background: #ffffff;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 14px 30px rgba(15, 23, 42, 0.12);

      max-height: none;        /* no scroll bar */
      overflow-y: visible;

      display: none;
      z-index: 30;
    }

    .custom-select-menu.is-open {
      display: block;
    }

    /* Dropdown list items */
    .custom-select-menu li {
      padding: 8px 12px;
      font-size: 14px;
      font-weight: 400;
      cursor: pointer;
      color: #111827;
      text-align: left;
    }

    .custom-select-menu li:hover {
      background: #e0f2f1;
      color: #064e3b;
    }

    .custom-select-menu li[aria-selected="true"] {
      background: #e0f2f1;
      color: #064e3b;
    }

    /* Arrow icon */
    .field .custom-select-toggle::after {
      content: "‚ñæ";
      font-size: 12px;
      color: #6b7280;
      margin-left: 8px;
      flex-shrink: 0;
    }

    /* Widen the entire shell (destination + guests) */
    .field .search-input-shell {
      min-width: 240px;    /* 1.3√ó wider than current */
      padding-right: 10px;
    }

    .subhead{
      color:var(--muted);
      font-size:14px;
      letter-spacing:0.1px;
      margin:14px 2px 6px; /* add bottom spacing */
      font-weight:500;
    }

    /* === ANCHOR: CATALOG_GRID_CARDS ====================================== */
    .grid{
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:20px;
      margin-top:20px;
    }

    @media (max-width:980px){
      .grid{
        grid-template-columns:repeat(2, 1fr);
        gap:18px;                /* tighter and more balanced for tablets */
      }
    }

    @media (max-width: 640px){
      /* Stack header on mobile so logo and back link don‚Äôt fight for space */
      header{
        grid-template-columns: 1fr;
        row-gap: 8px;
      }

      .nav-link{
        justify-self: flex-start;
      }

      /* Mobile: stack search fields in a single column to avoid overflow */
      .controls-row{
        grid-template-columns: 1fr;
        gap: 8px;
      }

      .controls-row .field,
      .controls-row .search-btn{
        width: 100%;
      }

      .controls-row .search-btn{
        justify-self: stretch;
      }

      /* Let dropdown buttons shrink on small screens */
      .controls-row .custom-select-toggle{
        min-width: 0;
      }

      .grid{
        grid-template-columns: 1fr;
        gap: 16px;                /* clean and consistent spacing on mobile */
      }

      .paper{
        padding: 18px 18px 24px;  /* reduce padding slightly on mobile */
      }
    }

    .card{
      background:#ffffff;
      border:1px solid var(--line);
      border-radius:18px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      box-shadow:0 10px 28px rgba(15,23,42,0.10);
      transition:
        transform .18s ease-out,
        box-shadow .18s ease-out;
    }

    .card:hover{
      transform:translateY(-3px);
      box-shadow:0 16px 40px rgba(15,23,42,0.15);
    }

    .card .img{
      position:relative;
      width:100%;
      padding-top:62%;
      overflow:hidden;
      background:#f3f4f6;
    }

    .card img{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
      transition:
        transform .25s ease-out,
        filter .25s ease-out;
      filter:brightness(0.92);
    }

    .card:hover img{
      transform:scale(1.04);
      filter:brightness(1);
    }

    .card .body{
      padding:16px 16px 18px;
      display:flex;
      flex-direction:column;
      gap:6px; /* tighter vertical spacing */
    }

    .name{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-weight:600;
      font-size:14px;
      color:#111827;
    }

    .meta{
      color:#6b7280;
      font-size:12px;
    }

    .chips{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }

    /* Tighter spacing between name ‚Üí location ‚Üí chips */
    .meta{
      margin-top:2px;
    }

    .chips{
      margin-top:4px;
      margin-bottom:2px;
    }

    .chip{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      background:#f3f4f6;
      border:1px solid #e5e7eb;
      color:#374151;
    }

    .foot{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-top:4px;   /* slightly tighter */
      min-height:28px;  /* ensures consistent alignment across cards */
    }

    .price{
      font-weight:700;
      font-size:14px;
      color:#064e3b;  /* matches brand */
    }

    .stars{
      font-size:13px;
      color:#ffb84d;
    }

    /* === ANCHOR: CATALOG_BUTTONS_CTA ===================================== */
    .btn{
      border:1px solid #d1d5db;
      background:#ffffff;
      border-radius:999px;
      padding:8px 14px;
      font-weight:600;
      font-size:13px;
      cursor:pointer;
      transition:
        border-color .15s ease-out,
        background .15s ease-out;
    }

    .btn:hover{
      border-color:#9ca3af;
      background:#f9fafb;
    }

    /* Catalog: standardized "Details" outline button */
    .details-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:8px 14px;
      margin-top:10px;
      border:1px solid #ff6a3d;
      border-radius:6px;
      color:#ff6a3d;
      text-decoration:none;
      font-size:14px;
      font-weight:600;
      background:transparent;
      cursor:pointer;
      transition:
        background 0.15s ease,
        color 0.15s ease;
    }

    .details-btn:hover{
      background:rgba(255,106,61,0.08);
      color:#ff6a3d;
      text-decoration:none;
    }
  </style>
</head>
<body>
  <div class="paper">
    <!-- ANCHOR: CATALOG_HEADER_HTML -->
    <header>
      <a
        class="logo"
        href="https://www.lolaelo.com/index.html"
        aria-label="Lolaelo home"
      >
        <img
          src="https://www.lolaelo.com/logo.png?cb=logo-5x"
          alt="Lolaelo"
          class="logo-img"
          decoding="async"
          loading="eager"
        >
      </a>

      <a
        class="nav-link nav-link-back"
        href="https://www.lolaelo.com/index.html"
        aria-label="Back to main page"
      >
        <span class="nav-back-arrow">‚Üê</span>
        <span>Back to main</span>
      </a>
    </header>
    <!-- ANCHOR: SEARCHBAR -->
    <div class="searchbar">
      <div class="controls-row">
        <label class="field" aria-label="Destination">
          <span>üìç</span>
          <div class="custom-select" data-target="dest">
            <button
              type="button"
              class="custom-select-toggle"
              aria-haspopup="listbox"
              aria-expanded="false"
            >
              <span class="custom-select-label">All destinations</span>
            </button>

            <ul class="custom-select-menu" role="listbox">
              <li data-value="" aria-selected="true">All destinations</li>
              <li data-value="SIARGAO">Siargao</li>
              <li data-value="EL NIDO">El Nido</li>
              <li data-value="CORON">Coron</li>
              <li data-value="BORACAY">Boracay</li>
              <li data-value="MANILA">Manila</li>
              <li data-value="CEBU">Cebu</li>
            </ul>

            <!-- used by existing JS (selectedCityCode, hydration, qs, etc.) -->
            <input id="dest" type="hidden" value="">
          </div>
        </label>
        <label class="field" aria-label="Check-in">
          <span>üìÖ</span>
          <input id="start" type="date" />
        </label>

        <label class="field" aria-label="Check-out">
          <span>üìÖ</span>
          <input id="end" type="date" />
        </label>

        <label class="field field-guests" aria-label="Guests">
          <span>üë§</span>

          <div class="custom-select" data-target="cat-guests">
            <button
              type="button"
              class="custom-select-toggle"
              aria-haspopup="listbox"
              aria-expanded="false"
            >
              <span class="custom-select-label">2 guests</span>
            </button>

            <ul class="custom-select-menu" role="listbox">
              <li data-value="1">1 guest</li>
              <li data-value="2" aria-selected="true">2 guests</li>
              <li data-value="3">3 guests</li>
              <li data-value="4">4 guests</li>
              <li data-value="5">5+ guests</li>
            </ul>

            <!-- Hidden actual value used by JS -->
            <input id="cat-guests" type="hidden" value="2">
          </div>
        </label>

        <button id="search" class="search-btn" type="button">Search</button>
      </div>

      <div class="subhead-row">
        <div class="subhead" id="found">Ready.</div>
      </div>
    </div>

    <!-- ANCHOR: CATALOG_MAP_ROW -->
    <div class="map-row" style="
      display:flex;
      justify-content:center;
      padding:12px 0 10px 0;
    ">
      <button
        type="button"
        id="catalog-map-open"
        class="map-toggle-btn"
        aria-label="View results on map"
        style="
          background:white;
          transition:background 0.25s ease, box-shadow 0.25s ease;
          box-shadow:0 2px 4px rgba(0,0,0,0.04);
        "
        onmouseover="this.style.background='linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.12)';"
        onmouseout="this.style.background='white'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.04)';"
      >
        <img
          src="https://www.lolaelo.com/logo2.png?cb=fav-v1"
          alt="Map"
          class="map-toggle-icon"
          decoding="async"
          loading="lazy"
        />
        <span>Map</span>
      </button>
    </div>

    <!-- ANCHOR: FILTERS_DETAILS (amenities only) -->
    <details id="amenities" class="filters">
      <summary>
        <span class="summary-pill">Filters ></span>
      </summary>
      <div class="filters-body">
        <label><input type="checkbox" value="beachfront"> Beachfront</label>
        <label><input type="checkbox" value="pool"> Pool</label>
        <label><input type="checkbox" value="wifi"> Wi-Fi</label>
        <label><input type="checkbox" value="aircon"> Aircon</label>
        <label><input type="checkbox" value="restaurant"> Restaurant</label>
        <label><input type="checkbox" value="harbor-view"> Harbor view</label>
        <label><input type="checkbox" value="eco"> Eco</label>
        <label><input type="checkbox" value="bar"> Bar</label>
      </div>
    </details>

    <section id="grid" class="grid" aria-live="polite"></section>
  </div>

  <!-- ANCHOR: CATALOG_MAP_MODAL_HTML -->
  <div
    id="catalog-map-modal"
    class="catalog-map-backdrop"
    aria-hidden="true"
  >
    <div
      class="catalog-map-inner"
      role="dialog"
      aria-modal="true"
      aria-label="Map of search results"
    >
      <button
        type="button"
        id="catalog-map-close"
        class="catalog-map-close"
        aria-label="Close map"
      >
        √ó
      </button>

      <iframe
        id="catalog-map-frame"
        class="catalog-map-frame"
        loading="lazy"
        referrerpolicy="no-referrer-when-downgrade"
      ></iframe>
    </div>
  </div>

  <script>
    // === ANCHOR: CATALOG_SCRIPT ============================================
    const qs   = new URLSearchParams(location.search);
    const S    = (id)=>document.getElementById(id);

    // no more legacy #guests select; we now use #cat-guests (hidden)
    const startInp = S('start');
    const endInp   = S('end');
    const grid     = S('grid');
    const found    = S('found');

    // Bind destination input and hydrate from ?q=
    const destInp = S('dest');
    // ANCHOR: PLAN_PARAM_DEF
    const planRaw = (qs.get('ratePlanId') || qs.get('plan') || '').trim();
    const plan = planRaw === '' ? null : Number(planRaw);
    const planQS = Number.isFinite(plan) && plan > 0 ? `&ratePlanId=${plan}` : '';
    window.ratePlanId = Number.isFinite(plan) && plan > 0 ? plan : null;
    // ANCHOR: PLAN_PARAM_DEF END
    // ANCHOR: CITY_PARAM_DEF
    function selectedCityCode(){
      const v = (S('dest')?.value || '').trim().toUpperCase();
      return v; // '' means all destinations
    }
    // ANCHOR: CITY_PARAM_DEF END
    // ANCHOR: CITY_PARAM_HYDRATE
    const __cityParam = (qs.get('city') || '').trim().toUpperCase();
    if (S('dest')) S('dest').value = __cityParam;
    // ANCHOR: CITY_PARAM_HYDRATE END
    // If q is in URL, show it; otherwise ensure input has no value (placeholder only)
    const detailsEl = document.getElementById('amenities');

    const todayISO = ()=>new Date().toISOString().slice(0,10);
    const addDaysISO=(iso,n)=>{ const d=new Date(iso+"T00:00:00Z"); d.setUTCDate(d.getUTCDate()+n); return d.toISOString().slice(0,10); };

    const s0 = qs.get('start') || todayISO();
    const e0 = qs.get('end')   || addDaysISO(s0, 3);
    startInp.value = s0;
    endInp.value   = e0;

    // initialize hidden guests field used by the custom-select
    const guestsHiddenInit = document.getElementById('cat-guests');
    if (guestsHiddenInit) {
      guestsHiddenInit.value = qs.get('guests') || "2";
    }
    // INIT CITY SELECT FROM ?city= (fallback to SIARGAO)
    (function initCity(){
      const sel = document.getElementById('dest');
      if (!sel) return;
      const qCity = (qs.get('city') || '').trim().toUpperCase();
      sel.value = qCity || 'SIARGAO';
    })();

    function stars(n){ return '‚òÖ'.repeat(Number(n||0)); }

    function cardHTML(p, start, end){
      // ANCHOR: CARDIMAGE_COVER_PICKER (REPLACE)
      const imgs = Array.isArray(p.images) ? p.images : [];
      const firstUrl =
        typeof imgs[0] === 'string'
          ? imgs[0]
          : (imgs[0] && typeof imgs[0] === 'object' && imgs[0].url
              ? String(imgs[0].url)
              : '');
      const baseImg = firstUrl || "https://www.lolaelo.com/logo.png?cb=logo-5x";
      const img = baseImg + (baseImg.includes("?") ? "&" : "?") + "cb=" + Date.now();
      // ANCHOR: CARDIMAGE_COVER_PICKER (REPLACE)

      // Chips source: prefer p.chips, fall back to amenities
      const chipsSource =
        Array.isArray(p.chips) && p.chips.length
          ? p.chips
          : (p.amenities || []);

      const chipsHtml = chipsSource
        .slice(0, 3)
        .map(label => `<span class="chip">${label}</span>`)
        .join("");

      const price = p.fromPriceStr ? `From ${p.fromPriceStr}` : '';

      const hasRollup =
        Number.isFinite(p?.availableNights) &&
        Number.isFinite(p?.nightsTotal);

      const nights = (hasRollup && Number(p.availableNights) < Number(p.nightsTotal))
        ? `${p.availableNights} nights available`
        : '';

      const availBadge =
        hasRollup && Number(p.availableNights) <= 0
          ? '<span class="chip" title="No rooms available in selected window">sold out</span>'
          : '';

      const baseLink = `/catalog_details.html?propertyId=${encodeURIComponent(p.propertyId)}`;
      const link = window.ratePlanId
        ? `${baseLink}&ratePlanId=${encodeURIComponent(window.ratePlanId)}`
        : baseLink;

      const locationLabel =
        p.location ||
        [p.city, p.country].filter(Boolean).join(", ");

      return `
      <article class="card">
        <a class="img" href="${link}" aria-label="View ${p.name}">
          <img src="${img}" alt="${p.name}">
        </a>
        <div class="body">
          <div class="name">
            <div>${p.name}</div>
            <div class="stars" aria-label="${p.starRating} stars">${stars(p.starRating)}</div>
          </div>
          <div class="meta">${locationLabel}</div>
          <div class="chips">${chipsHtml}${availBadge}</div>
          <div class="foot">
            <div class="meta">${nights}</div>
            <div class="price">${price}</div>
          </div>
          <div class="foot">
            <a class="details-btn" href="${link}">Details</a>
          </div>
        </div>
      </article>
      `;
    }

    /* ANCHOR: CATALOG_RUN (REPLACED) */
    async function run(){
      const start = startInp.value || todayISO();
      const end   = endInp.value   || start;

      // use the hidden guests field driven by the custom-select
      const guestsHiddenEl = document.getElementById('cat-guests');
      const guests = Number((guestsHiddenEl && guestsHiddenEl.value) || 2) || 2;

      found.textContent = "Searching‚Ä¶";

      // helpers
      const selectedAmenities = () =>
        Array.from(document.querySelectorAll('#amenities input[type="checkbox"]:checked'))
          .map(cb => String(cb.value).toLowerCase());

      try{
        // ANCHOR: PLAN_IN_SEARCH_FETCH
        const city = selectedCityCode();
        // send BOTH params so backend can match either text or code
        const cityQS =
          city
            ? `&city=${encodeURIComponent(city)}&cityCode=${encodeURIComponent(city)}`
            : '';
        const r = await fetch(
          `/catalog/search?start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}&guests=${encodeURIComponent(guests)}${planQS}${cityQS}`
        );
        const j = await r.json();
        const all = Array.isArray(j.properties) ? j.properties : [];

        // ANCHOR: CITY_CLIENT_FILTER
        const citySel = selectedCityCode();
        const byCity = (list, code) => {
          if (!code) return list;
          const norm  = s => String(s || '').trim().toUpperCase();
          const strip = s => norm(s).replace(/[^A-Z0-9]/g, ''); // remove spaces/punct
          return list.filter(p => {
            const sel   = norm(code);       // e.g., "SIARGAO"
            const cCode = norm(p.cityCode); // exact code
            const cLab  = norm(p.city);     // label

            if (cCode === sel) return true;
            if (cLab === sel) return true;
            if (cLab.includes(sel)) return true;
            if (strip(cLab) === strip(sel)) return true;
            return false;
          });
        };
        let list = byCity(all, citySel);
        // ANCHOR: CITY_CLIENT_FILTER END

        // ANCHOR: CITY_CLIENT_FILTER_DIAG
        console.log('[catalog] totals:', {
          all: all.length,
          afterCity: list.length,
          citySel
        });
        console.table(
          list.map(p => ({
            id: p.propertyId,
            name: p.name,
            city: p.city,
            cityCode: p.cityCode,
            availableNights: p.availableNights,
            fromPriceStr: p.fromPriceStr
          }))
        );
        // ANCHOR: CITY_CLIENT_FILTER_DIAG END

        // ANCHOR: TARGET_PROP_DIAG (mike check 1)
        (() => {
          const TARGET = 'mike check 1';
          const norm = s => String(s||'').trim().toLowerCase();
          const inAll  = (all  || []).find(p => norm(p.name) === norm(TARGET));
          const inCity = (list || []).find(p => norm(p.name) === norm(TARGET));

          console.log('[catalog][target]', TARGET, {
            presentInAll: !!inAll,
            presentAfterCityFilter: !!inCity,
            selectedCity: citySel,
            all_city: inAll && { city: inAll.city, cityCode: inAll.cityCode },
            all_availableNights: inAll && inAll.availableNights,
            all_fromPriceStr: inAll && inAll.fromPriceStr
          });

          if (inAll && !inCity) {
            console.warn('[catalog][target] City mismatch likely. Compare:', {
              selectedCity: citySel,
              propCity: inAll.city,
              propCityCode: inAll.cityCode
            });
          }
        })();

        window.__catalogProps = list;

        // amenity filter layered on top
        const sel = selectedAmenities();
        if (sel.length) {
          list = list.filter(p => {
            const am = (p.amenities || []).map(a => String(a).toLowerCase());
            return sel.every(a => am.includes(a));
          });
        }

        found.textContent = `Found ${list.length} propert${list.length===1?"y":"ies"} ‚Äî ${list.filter(p=>p.availableNights>0).length} with availability.`;
        grid.innerHTML = list.map(p => cardHTML(p, start, end)).join("") || "<div>No results.</div>";
      }catch(err){
        console.error(err);
        found.textContent = "Search failed.";
        grid.innerHTML = "";
      } finally {
        if (typeof detailsEl !== 'undefined' && detailsEl) detailsEl.open = false;
      }
    }

    // Update URL with city/start/end/guests (+ optional plan), then run
    document.getElementById('search').addEventListener('click', () => {
      const city  = selectedCityCode();
      const start = startInp.value || todayISO();
      const end   = endInp.value   || start;

      // Read from hidden field used by custom-select for guests
      const guestsHiddenEl = document.getElementById('cat-guests');
      const guests = Number((guestsHiddenEl && guestsHiddenEl.value) || 2) || 2;

      const params = new URLSearchParams();
      params.set('start', start);
      params.set('end', end);
      params.set('guests', String(guests));
      if (city) params.set('city', city);
      if (window.ratePlanId) params.set('ratePlanId', String(window.ratePlanId));

      history.replaceState(null, '', location.pathname + '?' + params.toString());
      run();
    });

    // Destination dropdown now custom-select, so we trigger run() manually if needed
    S('dest')?.addEventListener('change', run);

    /* ANCHOR: AMENITY_AUTO_FILTER */
    function filterAndRenderByAmenities(){
      if (!window.__catalogProps) return;

      const start = startInp.value || new Date().toISOString().slice(0,10);
      const end   = endInp.value   || start;

      const sel = Array.from(document.querySelectorAll('#amenities input[type="checkbox"]:checked'))
        .map(cb => String(cb.value).toLowerCase());

      const all = window.__catalogProps;
      const list = sel.length
        ? all.filter(p => {
            const am = (p.amenities || []).map(a => String(a).toLowerCase());
            return sel.every(a => am.includes(a));
          })
        : all;

      found.textContent = `Found ${list.length} propert${list.length===1?'y':'ies'} ‚Äî ${list.filter(p=>p.availableNights>0).length} with availability.`;
      grid.innerHTML = list.map(p => cardHTML(p, start, end)).join("") || "<div>No results.</div>";
    }

    document.querySelectorAll('#amenities input[type="checkbox"]').forEach(cb => {
      cb.addEventListener('change', () => {
        if (!window.__catalogProps) { run(); } else { filterAndRenderByAmenities(); }
      });
    });

    run();
  </script>
  <!-- ANCHOR: CATALOG_FILTERS_TOGGLE -->
  <script>
  (() => {
    const btn = document.getElementById('filtersBtn');
    const panel = document.getElementById('filtersPanel');
    if (!btn || !panel) return;
    btn.setAttribute('aria-controls', 'filtersPanel');
    btn.setAttribute('aria-expanded', panel.open ? 'true' : 'false');
    btn.addEventListener('click', () => {
      panel.open = !panel.open;
      btn.setAttribute('aria-expanded', panel.open ? 'true' : 'false');
    });
  })();
  /* ANCHOR: FILTERS_TOGGLE_JS */
  (() => {
    const btn   = document.getElementById('filtersBtn');
    const panel = document.getElementById('amenities');
    if (!btn || !panel) return;
    btn.addEventListener('click', () => {
      const willOpen = !panel.open;
      panel.open = willOpen;
      if (willOpen) {
        panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    });
  })();

  /* === ANCHOR: CUSTOM_SELECT_INIT (match landing, hardened) ============= */

  function initCustomSelect(wrapper){
    const button = wrapper.querySelector(".custom-select-toggle");
    const labelEl = wrapper.querySelector(".custom-select-label");
    const menu = wrapper.querySelector(".custom-select-menu");
    const options = menu.querySelectorAll("li[data-value]");
    const hidden = document.getElementById(wrapper.dataset.target);

    if (!button || !labelEl || !menu || !hidden) return;

    function openMenu(){
      menu.classList.add("is-open");
      button.setAttribute("aria-expanded","true");
    }

    function closeMenu(){
      menu.classList.remove("is-open");
      button.setAttribute("aria-expanded","false");
    }

    function selectOption(li){
      const value = li.getAttribute("data-value") || "";
      const text  = (li.textContent || "").trim();

      hidden.value = value;
      labelEl.textContent = text;

      options.forEach(o => o.removeAttribute("aria-selected"));
      if (value !== "") {
        li.setAttribute("aria-selected","true");
      }

      closeMenu();
    }

    // Toggle open/close on button click
    button.addEventListener("click", function(evt){
      evt.preventDefault();
      evt.stopPropagation();

      if(menu.classList.contains("is-open")){
        closeMenu();
      } else {
        openMenu();
      }
    });

    // Select + close on option click
    options.forEach(li => {
      li.addEventListener("click", function(evt){
        evt.preventDefault();
        evt.stopPropagation();
        selectOption(li);
      });
    });

    // Close when clicking anywhere outside the wrapper
    document.addEventListener("click", function(evt){
      if(!wrapper.contains(evt.target)){
        closeMenu();
      }
    });

    // Initial sync from hidden value or aria-selected
    (function syncInitial(){
      const currentVal = (hidden.value || "").trim();
      if (!currentVal) {
        const preSel = menu.querySelector("li[aria-selected='true']");
        if (preSel) {
          labelEl.textContent = (preSel.textContent || "").trim();
        }
        return;
      }

      let matched = false;
      options.forEach(li => {
        const val = (li.getAttribute("data-value") || "").trim();
        if (val === currentVal) {
          labelEl.textContent = (li.textContent || "").trim();
          options.forEach(o => o.removeAttribute("aria-selected"));
          li.setAttribute("aria-selected","true");
          matched = true;
        }
      });

      if (!matched) {
        const preSel = menu.querySelector("li[aria-selected='true']");
        if (preSel) {
          labelEl.textContent = (preSel.textContent || "").trim();
        }
      }
    })();
  }

  // Initialize ALL custom-select instances on this page
  document.querySelectorAll(".custom-select").forEach(initCustomSelect);

  /* === ANCHOR: CUSTOM_SELECT_SYNC (match landing) ========================= */
  // On page load, sync dropdown label to query param (?city=...)
  (function syncDestination(){
    const url = new URL(location.href);
    const cityParam =
      url.searchParams.get("city") ||
      url.searchParams.get("q") ||
      url.searchParams.get("destination") ||
      "";

    if (!cityParam) return;

    const destHidden = document.getElementById("dest");
    if (!destHidden) return;

    const wrapper = destHidden.closest(".custom-select");
    if (!wrapper) return;

    const labelEl = wrapper.querySelector(".custom-select-label");
    const options = wrapper.querySelectorAll(".custom-select-menu li[data-value]");

    // Normalize for comparison
    const normalized = cityParam.trim().toUpperCase();

    options.forEach(li => {
      const val = (li.getAttribute("data-value") || "").trim().toUpperCase();
      if (val === normalized) {
        destHidden.value = li.getAttribute("data-value");
        labelEl.textContent = li.textContent.trim();

        // update aria-selected
        options.forEach(o => o.removeAttribute("aria-selected"));
        li.setAttribute("aria-selected", "true");
      }
    });
  })();

  /* === ANCHOR: CATALOG_MAP_MODAL_WIRING (shell only) ===================== */
  (function wireCatalogMapModal(){
    const openBtn  = document.getElementById("catalog-map-open");
    const backdrop = document.getElementById("catalog-map-modal");
    const closeBtn = document.getElementById("catalog-map-close");
    const frame    = document.getElementById("catalog-map-frame");
    if (!openBtn || !backdrop || !closeBtn || !frame) return;

    function openModal(){
      backdrop.style.display = "flex";
      backdrop.setAttribute("aria-hidden","false");

      if (!frame.src) {
        frame.src = "about:blank"; // placeholder; real map wiring comes next step
      }

      document.documentElement.style.overflow = "hidden";
      document.body.style.overflow = "hidden";
    }

    function closeModal(){
      backdrop.style.display = "none";
      backdrop.setAttribute("aria-hidden","true");

      document.documentElement.style.overflow = "";
      document.body.style.overflow = "";
    }

    openBtn.addEventListener("click", openModal);
    closeBtn.addEventListener("click", closeModal);

    backdrop.addEventListener("click", function(evt){
      if (evt.target === backdrop) {
        closeModal();
      }
    });

    document.addEventListener("keydown", function(evt){
      if (evt.key === "Escape" && backdrop.style.display === "flex") {
        closeModal();
      }
    });
  })();

  </script>
</body>
</html>