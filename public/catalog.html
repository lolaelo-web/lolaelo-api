<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lolaelo ¬∑ Catalog</title>
  <link rel="icon" href="https://www.lolaelo.com/logo2.png" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css"
  />

  <style>
    /* === ANCHOR: CATALOG_LIGHT_SKIN (theme tokens) ======================== */
    :root{
      --bg:#ffffff;
      --fg:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --brand:#064e3b;          /* deep teal, same as new pages */
      --bubble:#ff6a3d;         /* orange accent for Search/CTAs */
      --paper:#ffffff;
      --radius:20px;
      --shadow:0 12px 40px rgba(15,23,42,.10);
      --maxw:960px;             /* tighter, like the new homepage card */
    }

    /* === ANCHOR: CATALOG_BASE_LAYOUT ===================================== */
    *{
      box-sizing:border-box;
    }

    html,
    body{
      height:100%;
      margin:0;
    }

    /* Standardize base type across customer UIs */
    html{
      font-size:16px;
    }

    body{
      font:15px/1.5 Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--fg);
      /* very light teal-at-top ‚Üí white gradient, keeps it minimalist */
      background:
        linear-gradient(to bottom, rgba(6, 78, 59, 0.06), #ffffff 42%);
      display:flex;
      flex-direction:column;
      align-items:center;
    }

    .paper{
      width:100%;
      max-width:var(--maxw);
      margin:24px 20px;
      background:var(--paper);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:22px 22px 30px;
    }

    /* === ANCHOR: CATALOG_HEADER_CSS ====================================== */
    /* Grid header: logo on left, back link on right */
    header{
      display:grid;
      grid-template-columns:auto 1fr auto;
      align-items:center;
      gap:12px;
      margin-bottom:8px;
    }

    header h1{
      margin:6px 0 0;
      text-align:center;
      font-size:clamp(22px, 3.4vw, 26px);
      font-weight:600;
    }

    /* Standardized logo container (kept for layout compatibility) */
    .logo{
      display:flex;
      align-items:center;
      gap:10px;
      text-decoration:none;
      color:inherit;
    }

    .logo-img{
      height:28px !important;
      width:auto !important;
      display:block;
      object-fit:contain;
    }

    /* Optional text wordmark if used */
    .wordmark{
      font-weight:700;
      font-size:18px;
      letter-spacing:.2px;
    }

    /* Back link (top-right), matching destinations page behavior */
    .nav-link{
      color:var(--brand);
      padding:4px 0;
      font-weight:500;
      text-decoration:none; /* no underline by default */
      justify-self:end;
    }

    .nav-link-back{
      display:inline-flex;
      align-items:center;
      gap:6px;
      text-decoration:none; /* no underline on full link */
    }

    .nav-back-arrow{
      font-size:16px;
      line-height:1;
      transform:translateY(1px);
      text-decoration:none !important;
    }

    /* text span is the second span inside .nav-link-back */
    .nav-link-back span:last-child{
      text-decoration:none;
    }

    /* Hover: underline text only, arrow stays clean */
    .nav-link-back:hover span:last-child{
      text-decoration:underline;
    }

    .nav-link-back:hover .nav-back-arrow{
      transform:translate(-2px, 1px);
      transition:transform 0.15s ease-out;
    }

    /* === ANCHOR: CATALOG_MAP_MODAL_CSS ============================= */
    .subhead-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;

      /* DROP THE THREE BUTTONS DOWN */
      margin-top:20px;
    }

    .subhead-actions{
      display:flex;
      align-items:center;
      gap:8px;
    }

    .map-toggle-btn{
      display:inline-flex;
      align-items:center;
      gap:6px;

      min-height:36px;          /* unified height with sort-select */
      padding:6px 16px;         /* unified padding */

      border-radius:999px;
      border:1px solid rgba(255,106,61,0.75); /* subtle orange outline */
      background:#ffffff;
      color:var(--muted);
      font-size:13px;           /* match sort-select */
      line-height:1;            /* tighten vertical alignment */
      cursor:pointer;
      box-shadow:0 2px 4px rgba(15,23,42,0.06);
      transition:
        background 0.25s ease,
        box-shadow 0.25s ease,
        border-color 0.25s ease;
    }

    .map-toggle-btn:hover{
      background:linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%);
      box-shadow:0 4px 14px rgba(15,23,42,0.18);
      border-color:rgba(255,106,61,0.95);
    }

    .map-toggle-icon{
      width:24px;
      height:24px;
      border-radius:999px;
      display:block;
    }

    .catalog-map-backdrop{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(15,23,42,0.55);
      z-index:70;
    }

    .catalog-map-inner{
      background:#020617;
      border-radius:18px;
      box-shadow:0 18px 45px rgba(15,23,42,0.32);
      width:min(900px, calc(100vw - 32px));
      height:min(540px, calc(100vh - 80px));
      position:relative;
      overflow:hidden;
    }

    .catalog-map-close{
      position:absolute;
      top:10px;
      right:10px;
      width:32px;
      height:32px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.5);
      background:#ffffff;
      cursor:pointer;
      font-size:16px;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .catalog-map-frame{
      border:0;
      width:100%;
      height:100%;
    }

    @media (max-width:640px){
      .catalog-map-inner{
        width:calc(100vw - 24px);
        height:calc(100vh - 60px);
      }
    }

    /* === ANCHOR: CATALOG_FILTERS_SEARCH ================================== */
    /* Collapsible filters (amenities only) */
    details.filters{
      border:1px solid var(--line);
      border-radius:16px;
      padding:0;
      overflow:hidden;
      background:#ffffff;
      margin-top:10px;
      box-shadow:0 4px 14px rgba(15,23,42,0.06);
    }

    .filters summary{
      display:none;
    }

    .filters[open] summary{
      border-bottom:1px solid var(--line);
    }

    .filters{
      width:100%;
    }

    .filters .summary-pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:auto;
      background:rgba(255,106,61,0.06);   /* light tint only behind the text */
      border:1px solid rgba(255,106,61,0.55);
      border-radius:999px;
      padding:6px 12px;
      font-weight:600;
      font-size:13px;
      letter-spacing:0.03em;
      color:#1f2933;
      box-shadow:0 2px 6px rgba(15,23,42,0.10);
    }

    .filters-body{
      padding:12px 14px 10px;
      display:grid;
      grid-template-columns:repeat(5, minmax(0, 1fr)); /* 5 fixed columns */
      gap:8px 16px;
      font-size:13px;
      color:var(--muted);
    }

    .filter-col{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }

    .filter-col-title{
      font-weight:600;
      font-size:12px;
      color:#4b5563;
      padding-bottom:4px;
      margin-bottom:4px;
      border-bottom:1px solid rgba(148,163,184,0.35); /* faint line under label */
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .filters-body label{
      display:flex;
      align-items:center;
      justify-content:flex-start;
      flex-direction:row-reverse;  /* move checkbox to the right */
      gap:6px;
      font-size:13px;
      cursor:pointer;
    }

    .filters-body label input[type="checkbox"]{
      margin:0; /* keep checkbox vertically centered */
    }

    .filters-body input[type="checkbox"]{
      accent-color:#064e3b; /* brand green */
    }

    .sort-row{
      margin:8px 0 0;
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:8px;
      font-size:13px;
      color:var(--muted);
    }

    .sort-label{
      font-size:13px;
      color:var(--muted);
    }

    .sort-select{
      min-height:36px;
      padding:6px 16px;

      border-radius:999px;
      border:1px solid rgba(255,106,61,0.45);

      background:#ffffff;
      font-size:13px;
      line-height:1;
      color:var(--fg);

      cursor:pointer;
      outline:none;

      background-image:
        linear-gradient(#ffffff, #ffffff),
        linear-gradient(135deg, #ffd7c2 0%, #ffb08a 50%, #ff8b55 100%);
      background-origin:border-box;
      background-clip:padding-box, border-box;

      appearance:none;
      -webkit-appearance:none;
      -moz-appearance:none;

      text-align:center;   /* NEW */
      text-indent:0;       /* NEW */
    }

    .sort-select:focus{
      border-color:#ff6a3d;
      box-shadow:0 0 0 1px rgba(255,106,61,0.35);
    }

    /* === ANCHOR: CATALOG_SEARCH_BAR_CSS (mirror landing) ==========

    /* Outer search card: match index.html search-card */
    .searchbar{
      border-radius:18px;
      padding:14px 16px;
      margin-bottom:12px;
      background:#ffffff;
      border:1px solid #e5e7eb;
      box-shadow:0 18px 45px rgba(15,23,42,0.08);
    }

    /* Grid layout: 4 fields + Search button, like search-row */
    .controls-row{
      display:grid;
      grid-template-columns:1.4fr 1.3fr 1fr 1fr auto;
      gap:8px;
      align-items:stretch;
    }

    /* Field shell: match search-input-shell */
    .field{
      display:flex;
      align-items:center;
      gap:8px;
      background:#f9fafb;
      border:1px solid #e5e7eb;
      border-radius:12px;
      padding:8px 12px;
      position:relative;
      transition:
        border-color .15s ease-out,
        box-shadow .15s ease-out,
        background .15s ease-out;
    }

    .field:hover{
      border-color:#d1d5db;
      background:#ffffff;
      box-shadow:0 2px 8px rgba(15,23,42,0.12);
    }

    .field span{
      font-size:14px;
    }

    .field input,
    .field select{
      width:100%;
      border:none;
      background:transparent;
      outline:none;
      font:inherit;
      font-size:14px;
      color:var(--fg);
    }

    /* Combined date field (Check-in ‚Äì Check-out) */
    .field-dates-combined{
      position:relative;
    }

    .date-range-driver{
      position:absolute;
      inset:0;
      opacity:0;
      pointer-events:none;
    }

    .dates-display{
      border:none;
      background:transparent;
      padding:0;
      margin:0;
      flex:1;
      text-align:left;
      font:inherit;
      font-size:14px;
      color:var(--fg);
      cursor:pointer;
    }

    .dates-display-label{
      opacity:0.7;
    }

    .field-dates-combined.has-dates .dates-display-label{
      opacity:1;
      font-weight:500;
    }

    .field-dates-combined input[type="date"]{
      position:absolute;
      inset:0;
      opacity:0;
      pointer-events:none;
    }

    /* Search button: match landing search-btn */
    .search-btn{
      border:none;
      background:#ff6a3d;
      color:#ffffff;
      font-weight:600;
      font-size:13px;
      border-radius:999px;
      padding:0 18px;
      min-height:32px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      white-space:nowrap;
      box-shadow:0 10px 22px rgba(248,113,73,0.45);
      transition:filter .15s ease-out, box-shadow .15s ease-out, transform .12s ease-out;
    }

    .search-btn:hover{
      filter:brightness(0.97);
      box-shadow:0 12px 26px rgba(248,113,73,0.55);
      transform:translateY(-1px);
    }

    /* === ANCHOR: CATALOG_CUSTOM_SELECT_CSS (match landing) ================== */

    /* Container behaves same as landing page */
    .custom-select {
      position: relative;
      width: 100%;
    }

    /* Toggle ‚Üí widened, landing-page style */
    .custom-select-toggle {
      width: 100%;
      padding: 0;
      margin: 0;
      border: none;
      background: transparent;
      text-align: left;
      font: inherit;
      color: #111827;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;

      /* widen to match landing page proportions */
      min-width: 160px;  /* was 260 ‚Üí about 60% of that width */
    }

    /* === ANCHOR: GUEST_FIELD_WIDTH_FIX =================== */
    .field-guests .custom-select-toggle {
      min-width: 120px !important;   /* half the current ~240px width */
    }

    /* Label text handling */
    .custom-select-label {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Dropdown menu ‚Üí match landing behavior and field width */
    .custom-select-menu {
      list-style: none;
      margin: 4px 0 0 0;
      padding: 4px 0;
      position: absolute;
      top: 100%;

      /* extend slightly past inner content so it visually matches the field */
      left: -21px;
      right: -12px;

      background: #ffffff;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 14px 30px rgba(15, 23, 42, 0.12);

      max-height: none;        /* no scroll bar */
      overflow-y: visible;

      display: none;
      z-index: 30;
    }

    .custom-select-menu.is-open {
      display: block;
    }

    /* Dropdown list items */
    .custom-select-menu li {
      padding: 8px 12px;
      font-size: 14px;
      font-weight: 400;
      cursor: pointer;
      color: #111827;
      text-align: left;
    }

    .custom-select-menu li:hover {
      background: #e0f2f1;
      color: #064e3b;
    }

    .custom-select-menu li[aria-selected="true"] {
      background: #e0f2f1;
      color: #064e3b;
    }

    /* Arrow icon */
    .field .custom-select-toggle::after {
      content: "‚ñæ";
      font-size: 12px;
      color: #6b7280;
      margin-left: 8px;
      flex-shrink: 0;
    }

    /* Widen the entire shell (destination + guests) */
    .field .search-input-shell {
      min-width: 240px;    /* 1.3√ó wider than current */
      padding-right: 10px;
    }

    .subhead{
      color:var(--muted);
      font-size:14px;
      letter-spacing:0.1px;
      margin:14px 2px 6px; /* add bottom spacing */
      font-weight:500;
    }

    /* === ANCHOR: CATALOG_GRID_CARDS ====================================== */
    .grid{
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:20px;
      margin-top:20px;
    }

    @media (max-width:980px){
      .grid{
        grid-template-columns:repeat(2, 1fr);
        gap:18px;                /* tighter and more balanced for tablets */
      }
    }

    @media (max-width: 640px){
      /* Stack header on mobile so logo and back link don‚Äôt fight for space */
      header{
        grid-template-columns: 1fr;
        row-gap: 8px;
      }

      .nav-link{
        justify-self: flex-start;
      }

      /* Mobile: stack search fields in a single column to avoid overflow */
      .controls-row{
        grid-template-columns: 1fr;
        gap: 8px;
      }

      .controls-row .field,
      .controls-row .search-btn{
        width: 100%;
      }

      .controls-row .search-btn{
        justify-self: stretch;
      }

      /* Let dropdown buttons shrink on small screens */
      .controls-row .custom-select-toggle{
        min-width: 0;
      }

      .grid{
        grid-template-columns: 1fr;
        gap: 16px;                /* clean and consistent spacing on mobile */
      }

      .paper{
        padding: 18px 18px 24px;  /* reduce padding slightly on mobile */
      }
    }

    .card{
      background:#ffffff;
      border:1px solid var(--line);
      border-radius:18px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      box-shadow:0 10px 28px rgba(15,23,42,0.10);
      transition:
        transform .18s ease-out,
        box-shadow .18s ease-out;
    }

    .card:hover{
      transform:translateY(-3px);
      box-shadow:0 16px 40px rgba(15,23,42,0.15);
    }

    .card .img{
      position:relative;
      width:100%;
      padding-top:62%;
      overflow:hidden;
      background:#f3f4f6;
    }

    .card img{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
      transition:
        transform .25s ease-out,
        filter .25s ease-out;
      filter:brightness(0.92);
    }

    .card:hover img{
      transform:scale(1.04);
      filter:brightness(1);
    }

    .card .body{
      padding:16px 16px 18px;
      display:flex;
      flex-direction:column;
      gap:6px; /* tighter vertical spacing */
    }

    .name{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-weight:600;
      font-size:14px;
      color:#111827;
    }

    .meta{
      color:#6b7280;
      font-size:12px;
    }

    .chips{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }

    /* Tighter spacing between name ‚Üí location ‚Üí chips */
    .meta{
      margin-top:2px;
    }

    .chips{
      margin-top:4px;
      margin-bottom:2px;
    }

    .chip{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      background:#f3f4f6;
      border:1px solid #e5e7eb;
      color:#374151;
    }

    .foot{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-top:4px;   /* slightly tighter */
      min-height:28px;  /* ensures consistent alignment across cards */
    }

    .price{
      font-weight:700;
      font-size:14px;
      color:#064e3b;  /* matches brand */
    }

    .stars{
      font-size:13px;
      color:#ffb84d;
    }

    /* === ANCHOR: CATALOG_BUTTONS_CTA ===================================== */
    .btn{
      border:1px solid #d1d5db;
      background:#ffffff;
      border-radius:999px;
      padding:8px 14px;
      font-weight:600;
      font-size:13px;
      cursor:pointer;
      transition:
        border-color .15s ease-out,
        background .15s ease-out;
    }

    .btn:hover{
      border-color:#9ca3af;
      background:#f9fafb;
    }

    .catalog-map-close{
      z-index: 5000 !important;
    }

    /* Catalog: standardized "Details" outline button */
    .details-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:8px 14px;
      margin-top:10px;
      border:1px solid #ff6a3d;
      border-radius:6px;
      color:#ff6a3d;
      text-decoration:none;
      font-size:14px;
      font-weight:600;
      background:transparent;
      cursor:pointer;
      transition:
        background 0.15s ease,
        color 0.15s ease;
    }

    .details-btn:hover{
      background:rgba(255,106,61,0.08);
      color:#ff6a3d;
      text-decoration:none;
    }

    /* === ANCHOR: CATALOG_BUTTON_STANDARDIZATION (UPDATED GRADIENT OUTLINE) === */

    /* Shared navy text */
    .catalog-btn-navy {
      color: #0f1e4d !important; /* dark navy blue */
      font-weight: 500;
    }

    /* Gradient outline pill */
    .catalog-btn-outline {
      background: #ffffff !important;
      border-radius: 999px !important;
      padding: 6px 14px !important;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.15s ease, box-shadow 0.15s ease, border-color 0.15s;

      /* NEW: solid light-orange visible outline */
      border: 1px solid rgba(255, 106, 61, 0.45) !important;

      /* Gradient overlay for hover (kept from your previous setup) */
      background-image:
        linear-gradient(#ffffff, #ffffff),
        linear-gradient(135deg, #ffd7c2 0%, #ffb08a 50%, #ff8b55 100%);
      background-origin: border-box;
      background-clip: padding-box, border-box;
    }

    /* Hover state: brighter gradient + soft glow */
    .catalog-btn-outline:hover {
      background-image:
        linear-gradient(#ffffff, #ffffff),
        linear-gradient(135deg, #ffb997 0%, #ff9463 50%, #ff6a3d 100%);
      box-shadow: 0 2px 10px rgba(255, 106, 61, 0.25);
    }

  </style>
</head>
<body>
  <div class="paper">
    <!-- ANCHOR: CATALOG_HEADER_HTML -->
    <header>
      <a
        class="logo"
        href="https://www.lolaelo.com/index.html"
        aria-label="Lolaelo home"
      >
        <img
          src="https://www.lolaelo.com/logo.png?cb=logo-5x"
          alt="Lolaelo"
          class="logo-img"
          decoding="async"
          loading="eager"
        >
      </a>

      <a
        class="nav-link nav-link-back"
        href="https://www.lolaelo.com/index.html"
        aria-label="Back to main page"
      >
        <span class="nav-back-arrow">‚Üê</span>
        <span>Back to main</span>
      </a>
    </header>
    <!-- ANCHOR: SEARCHBAR -->
    <div class="searchbar">
      <div class="controls-row">
        <label class="field" aria-label="Destination">
          <span>üìç</span>
          <div class="custom-select" data-target="dest">
            <button
              type="button"
              class="custom-select-toggle"
              aria-haspopup="listbox"
              aria-expanded="false"
            >
              <span class="custom-select-label">All destinations</span>
            </button>

            <ul class="custom-select-menu" role="listbox">
              <li data-value="" aria-selected="true">All destinations</li>
              <li data-value="SIARGAO">Siargao</li>
              <li data-value="EL NIDO">El Nido</li>
              <li data-value="CORON">Coron</li>
              <li data-value="BORACAY">Boracay</li>
              <li data-value="MANILA">Manila</li>
              <li data-value="CEBU">Cebu</li>
            </ul>

            <!-- used by existing JS (selectedCityCode, hydration, qs, etc.) -->
            <input id="dest" type="hidden" value="">
          </div>
        </label>
        <label class="field field-dates-combined" aria-label="Dates">
          <span>üìÖ</span>
          <button
            type="button"
            id="dates-display"
            class="dates-display"
            aria-haspopup="dialog"
          >
            <span id="dates-display-label" class="dates-display-label">
              Check-in ‚Äì Check-out
            </span>
          </button>

          <!-- Hidden Flatpickr driver for range calendar -->
          <input
            id="cat-dates"
            type="text"
            class="date-range-driver"
            autocomplete="off"
          />

          <!-- Actual start/end values used by all existing JS -->
          <input id="start" type="date" />
          <input id="end" type="date" />
        </label>

        <label class="field field-guests" aria-label="Guests">
          <span>üë§</span>

          <div class="custom-select" data-target="cat-guests">
            <button
              type="button"
              class="custom-select-toggle"
              aria-haspopup="listbox"
              aria-expanded="false"
            >
              <span class="custom-select-label">2 guests</span>
            </button>

            <ul class="custom-select-menu" role="listbox">
              <li data-value="1">1 guest</li>
              <li data-value="2" aria-selected="true">2 guests</li>
              <li data-value="3">3 guests</li>
              <li data-value="4">4 guests</li>
              <li data-value="5">5+ guests</li>
            </ul>

            <!-- Hidden actual value used by JS -->
            <input id="cat-guests" type="hidden" value="2">
          </div>
        </label>

        <button id="search" class="search-btn" type="button">Search</button>
      </div>

      <div class="subhead-row">
        <div class="subhead" id="found">Ready.</div>

        <div class="subhead-actions">
          <!-- Filter pill (left of Map) -->
          <button
            type="button"
            id="filtersBtn"
            class="map-toggle-btn catalog-btn-outline catalog-btn-navy"
          >
            <span>Filters ‚öôÔ∏è</span>
          </button>

          <!-- Map pill (center) -->
          <button
            type="button"
            id="catalog-map-open"
            class="map-toggle-btn catalog-btn-outline catalog-btn-navy"
            aria-label="View results on map"
          >
            <img
              src="https://www.lolaelo.com/logo2.png?cb=fav-v1"
              alt="Map"
              class="map-toggle-icon"
              decoding="async"
              loading="lazy"
            />
            <span>Map</span>
          </button>

          <!-- Sort dropdown (right) -->
          <select id="sort-order" class="sort-select">
            <option value="">Sort by ‚ñ≤ ‚ñº</option>
            <option value="price-asc">Price (low to high)</option>
            <option value="price-desc">Price (high to low)</option>
          </select>
        </div>
      </div>
    </div>

    <!-- ANCHOR: FILTERS_DETAILS (amenities only) -->
    <details id="amenities" class="filters">
      <summary>
        <span class="summary-pill catalog-btn-outline catalog-btn-navy">Filters ‚öôÔ∏è</span>
      </summary>
      <div class="filters-body">

        <!-- Column 1 ‚Äî Value & essentials -->
        <div class="filter-col">
          <div class="filter-col-title">Value & essentials</div>
          <label><input type="checkbox" value="Breakfast included (no added cost)"> Breakfast included (no added cost)</label>
          <label><input type="checkbox" value="Kids stay free under 12"> Kids stay free under 12</label>
          <label><input type="checkbox" value="Free Wi-Fi"> Free Wi-Fi</label>
          <label><input type="checkbox" value="Free parking"> Free parking</label>
          <label><input type="checkbox" value="Daily housekeeping"> Daily housekeeping</label>
        </div>

        <!-- Column 2 ‚Äî Wellness & leisure -->
        <div class="filter-col">
          <div class="filter-col-title">Wellness & leisure</div>
          <label><input type="checkbox" value="Swimming pool"> Swimming pool</label>
          <label><input type="checkbox" value="Gym or fitness center"> Gym or fitness center</label>
          <label><input type="checkbox" value="Spa or sauna"> Spa or sauna</label>
          <label><input type="checkbox" value="Water sports equipment (kayak / paddleboard / snorkel)"> Water sports equipment (kayak / paddleboard / snorkel)</label>
          <label><input type="checkbox" value="Beachfront or direct beach access"> Beachfront or direct beach access</label>
        </div>

        <!-- Column 3 ‚Äî Policy & comfort -->
        <div class="filter-col">
          <div class="filter-col-title">Policy & comfort</div>
          <label><input type="checkbox" value="24-hour front desk"> 24-hour front desk</label>
          <label><input type="checkbox" value="Family / child-friendly property"> Family / child-friendly property</label>
          <label><input type="checkbox" value="Non-smoking property"> Non-smoking property</label>
          <label><input type="checkbox" value="Smoking area"> Smoking area</label>
          <label><input type="checkbox" value="Pets allowed"> Pets allowed</label>
        </div>

        <!-- Column 4 ‚Äî Services & facilities -->
        <div class="filter-col">
          <div class="filter-col-title">Services & facilities</div>
          <label><input type="checkbox" value="Facilities for disabled guests"> Facilities for disabled guests</label>
          <label><input type="checkbox" value="Business center or meeting rooms"> Business center or meeting rooms</label>
          <label><input type="checkbox" value="Shared kitchen or guest pantry"> Shared kitchen or guest pantry</label>
          <label><input type="checkbox" value="Laundry service or self-service laundry"> Laundry service or self-service laundry</label>
          <label><input type="checkbox" value="On-site restaurant"> On-site restaurant</label>
        </div>

        <!-- Column 5 ‚Äî Eco, safety & convenience -->
        <div class="filter-col">
          <div class="filter-col-title">Eco, safety & convenience</div>
          <label><input type="checkbox" value="Eco-cleaning option (reduced housekeeping)"> Eco-cleaning option (reduced housekeeping)</label>
          <label><input type="checkbox" value="Quiet hours enforced"> Quiet hours enforced</label>
          <label><input type="checkbox" value="Guaranteed crib or baby cot"> Guaranteed crib or baby cot</label>
          <label><input type="checkbox" value="Flexible self check-in (lockbox / smart lock)"> Flexible self check-in (lockbox / smart lock)</label>
          <label><input type="checkbox" value="Airport shuttle"> Airport shuttle</label>
        </div>

      </div>
    </details>

    <section id="grid" class="grid" aria-live="polite"></section>
  </div>

  <!-- ANCHOR: CATALOG_MAP_MODAL_HTML -->
  <div
    id="catalog-map-modal"
    class="catalog-map-backdrop"
    aria-hidden="true"
  >
    <div
      class="catalog-map-inner"
      role="dialog"
      aria-modal="true"
      aria-label="Map of search results"
    >
      <button
        type="button"
        id="catalog-map-close"
        class="catalog-map-close"
        aria-label="Close map"
      >
        √ó
      </button>

      <div
        id="catalog-map-canvas"
        class="catalog-map-frame"
        role="presentation"
      ></div>
    </div>
  </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>

  <script>
    // === ANCHOR: CATALOG_SCRIPT ============================================
    const qs   = new URLSearchParams(location.search);
    const S    = (id)=>document.getElementById(id);

    // no more legacy #guests select; we now use #cat-guests (hidden)
    const startInp = S('start');
    const endInp   = S('end');
    const grid     = S('grid');
    const found    = S('found');

    const datesDisplay      = S('dates-display');
    const datesDisplayLabel = S('dates-display-label');

    const catDatesInput = S('cat-dates');
    let catDatePicker = null;

    function formatDateLabel(iso){
      if (!iso) return "";
      const d = new Date(iso + "T00:00:00");
      if (Number.isNaN(d.getTime())) return iso;

      const mm = String(d.getMonth() + 1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      const yyyy = d.getFullYear();

      return `${mm}/${dd}/${yyyy}`;
    }

    function syncDatesDisplay(){
      if (!datesDisplay || !datesDisplayLabel || !startInp || !endInp) return;
      const s = startInp.value;
      const e = endInp.value;

      if (!s && !e){
        datesDisplayLabel.textContent = "Check-in ‚Äì Check-out";
        datesDisplay.parentElement?.classList.remove('has-dates');
        return;
      }

      const sLbl = formatDateLabel(s);
      const eLbl = formatDateLabel(e || s);

      datesDisplayLabel.textContent = sLbl + " ‚Äì " + eLbl;
      datesDisplay.parentElement?.classList.add('has-dates');
    }

    if (datesDisplay){
      datesDisplay.addEventListener('click', function(){
        if (catDatePicker) {
          catDatePicker.open();
        } else if (startInp && typeof startInp.showPicker === 'function'){
          startInp.showPicker();
        } else if (startInp){
          startInp.focus();
        }
      });
    }

    if (startInp) startInp.addEventListener('change', syncDatesDisplay);
    if (endInp)   endInp.addEventListener('change', syncDatesDisplay);

    // Bind destination input and hydrate from ?q=
    const destInp = S('dest');
    // ANCHOR: PLAN_PARAM_DEF
    const planRaw = (qs.get('ratePlanId') || qs.get('plan') || '').trim();
    const plan = planRaw === '' ? null : Number(planRaw);
    const planQS = Number.isFinite(plan) && plan > 0 ? `&ratePlanId=${plan}` : '';
    window.ratePlanId = Number.isFinite(plan) && plan > 0 ? plan : null;
    // ANCHOR: PLAN_PARAM_DEF END
    // ANCHOR: CITY_PARAM_DEF
    function selectedCityCode(){
      const v = (S('dest')?.value || '').trim().toUpperCase();
      return v; // '' means all destinations
    }
    // ANCHOR: CITY_PARAM_DEF END
    // ANCHOR: CITY_PARAM_HYDRATE
    const __cityParam = (qs.get('city') || '').trim().toUpperCase();
    if (S('dest')) S('dest').value = __cityParam;
    // ANCHOR: CITY_PARAM_HYDRATE END
    // If q is in URL, show it; otherwise ensure input has no value (placeholder only)
    const detailsEl = document.getElementById('amenities');

    const todayISO = ()=>new Date().toISOString().slice(0,10);
    const addDaysISO=(iso,n)=>{
      const d = new Date(iso + "T00:00:00");
      d.setDate(d.getDate() + n);
      return d.toISOString().slice(0,10);
    };

    // Helpers: parse and format YYYY-MM-DD without timezone surprises
    function parseYmd(iso) {
      if (!iso) return null;
      const parts = iso.split("-");
      if (parts.length !== 3) return null;
      const y = Number(parts[0]);
      const m = Number(parts[1]);
      const d = Number(parts[2]);
      if (!y || !m || !d) return null;
      return new Date(y, m - 1, d);
    }

    function formatYmd(d) {
      const y  = d.getFullYear();
      const m  = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      return y + "-" + m + "-" + dd;
    }

    const s0Param = qs.get("start");
    const e0Param = qs.get("end");

    const s0 = s0Param || todayISO();
    let   e0 = e0Param || addDaysISO(s0, 3);

    startInp.value = s0;
    endInp.value   = e0;
    syncDatesDisplay();

    if (catDatesInput && window.flatpickr) {
      catDatePicker = flatpickr(catDatesInput, {
        mode: "range",
        dateFormat: "Y-m-d",
        defaultDate: [s0, e0],
        onChange(selectedDates, dateStr) {
          if (!startInp || !endInp) return;

          let start = selectedDates[0] || null;
          let end   = selectedDates[1] || null;

          // Enforce end >= start + 1 day
          if (start && !end) {
            const next = new Date(start.getTime());
            next.setDate(next.getDate() + 1);
            end = next;
          }

          if (start && end) {
            startInp.value = formatYmd(start);
            endInp.value   = formatYmd(end);
            syncDatesDisplay();
          }
        }
      });
    }

    // When start date changes, ensure end is at least +1 day.
    if (startInp && endInp) {
      startInp.addEventListener("change", function () {
        const rawStart = startInp.value;
        if (!rawStart) return;

        const startDate = parseYmd(rawStart);
        if (!startDate) return;

        const rawEnd = endInp.value;
        let endDate = rawEnd ? parseYmd(rawEnd) : null;

        if (!endDate || endDate <= startDate) {
          endDate = new Date(startDate.getTime());
          endDate.setDate(startDate.getDate() + 1);
        }

        endInp.value = formatYmd(endDate);
      });
    }

    // initialize hidden guests field used by the custom-select
    const guestsHiddenInit = document.getElementById('cat-guests');
    if (guestsHiddenInit) {
      guestsHiddenInit.value = qs.get('guests') || "2";
    }
    // INIT CITY SELECT FROM ?city= (fallback to SIARGAO)
    (function initCity(){
      const sel = document.getElementById('dest');
      if (!sel) return;
      const qCity = (qs.get('city') || '').trim().toUpperCase();
      sel.value = qCity || 'SIARGAO';
    })();

    function stars(n){ return '‚òÖ'.repeat(Number(n||0)); }

    // Build catalog_details link carrying dates, guests, and optional ratePlanId
    function buildDetailsLink(p){
      const startInp  = document.getElementById("start");
      const endInp    = document.getElementById("end");
      const guestsInp = document.getElementById("cat-guests");

      const startVal  = (startInp  && startInp.value)  || "";
      const endVal    = (endInp    && endInp.value)    || "";
      const guestsVal = (guestsInp && guestsInp.value) || "";

      const params = new URLSearchParams();
      params.set("propertyId", String(p.propertyId));

      if (startVal)  params.set("start", startVal);
      if (endVal)    params.set("end",   endVal);
      if (guestsVal) params.set("guests", guestsVal);

      if (window.ratePlanId) {
        params.set("ratePlanId", String(window.ratePlanId));
      }

      return "/catalog_details.html?" + params.toString();
    }

    function cardHTML(p, start, end){
      // ANCHOR: CARDIMAGE_COVER_PICKER (REPLACE)
      const imgs = Array.isArray(p.images) ? p.images : [];
      const firstUrl =
        typeof imgs[0] === 'string'
          ? imgs[0]
          : (imgs[0] && typeof imgs[0] === 'object' && imgs[0].url
              ? String(imgs[0].url)
              : '');
      const baseImg = firstUrl || "https://www.lolaelo.com/logo.png?cb=logo-5x";
      const img = baseImg + (baseImg.includes("?") ? "&" : "?") + "cb=" + Date.now();
      // ANCHOR: CARDIMAGE_COVER_PICKER (REPLACE)

      // Chips source: prefer p.chips, fall back to amenities
      const chipsSource =
        Array.isArray(p.chips) && p.chips.length
          ? p.chips
          : (p.amenities || []);

      const chipsHtml = chipsSource
        .slice(0, 3)
        .map(label => `<span class="chip">${label}</span>`)
        .join("");

      const price = p.fromPriceStr ? `From ${p.fromPriceStr}` : '';

      const hasRollup =
        Number.isFinite(p?.availableNights) &&
        Number.isFinite(p?.nightsTotal);

      const nights = (hasRollup && Number(p.availableNights) < Number(p.nightsTotal))
        ? `${p.availableNights} nights available`
        : '';

      const availBadge =
        hasRollup && Number(p.availableNights) <= 0
          ? '<span class="chip" title="No rooms available in selected window">sold out</span>'
          : '';

      const link = buildDetailsLink(p);

      const locationLabel =
        p.location ||
        [p.city, p.country].filter(Boolean).join(", ");

      return `
      <article class="card">
        <a class="img" href="${link}" aria-label="View ${p.name}">
          <img src="${img}" alt="${p.name}">
        </a>
        <div class="body">
          <div class="name">
            <div>${p.name}</div>
            <div class="stars" aria-label="${p.starRating} stars">${stars(p.starRating)}</div>
          </div>
          <div class="meta">${locationLabel}</div>
          <div class="chips">${chipsHtml}${availBadge}</div>
          <div class="foot">
            <div class="meta">${nights}</div>
            <div class="price">${price}</div>
          </div>
          <div class="foot">
            <a
              class="details-btn catalog-btn-outline catalog-btn-navy"
              href="${link}"
            >
              Details
            </a>
          </div>

        </div>
      </article>
      `;
    }

    /* ANCHOR: CATALOG_RUN (REPLACED) */
    async function run(){
      const start = startInp.value || todayISO();
      const end   = endInp.value   || start;

      // use the hidden guests field driven by the custom-select
      const guestsHiddenEl = document.getElementById('cat-guests');
      const guests = Number((guestsHiddenEl && guestsHiddenEl.value) || 2) || 2;

      found.textContent = "Searching‚Ä¶";

      // helpers
      const selectedAmenities = () =>
        Array.from(document.querySelectorAll('#amenities input[type="checkbox"]:checked'))
          .map(cb => String(cb.value).toLowerCase());

      try{
        // ANCHOR: PLAN_IN_SEARCH_FETCH
        const city = selectedCityCode();
        // send BOTH params so backend can match either text or code
        const cityQS =
          city
            ? `&city=${encodeURIComponent(city)}&cityCode=${encodeURIComponent(city)}`
            : '';
        const r = await fetch(
          `/catalog/search?start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}&guests=${encodeURIComponent(guests)}${planQS}${cityQS}`
        );
        const j = await r.json();
        const all = Array.isArray(j.properties) ? j.properties : [];

        // ANCHOR: CITY_CLIENT_FILTER
        const citySel = selectedCityCode();
        const byCity = (list, code) => {
          if (!code) return list;
          const norm  = s => String(s || '').trim().toUpperCase();
          const strip = s => norm(s).replace(/[^A-Z0-9]/g, ''); // remove spaces/punct
          return list.filter(p => {
            const sel   = norm(code);       // e.g., "SIARGAO"
            const cCode = norm(p.cityCode); // exact code
            const cLab  = norm(p.city);     // label

            if (cCode === sel) return true;
            if (cLab === sel) return true;
            if (cLab.includes(sel)) return true;
            if (strip(cLab) === strip(sel)) return true;
            return false;
          });
        };
        let list = byCity(all, citySel);
        // ANCHOR: CITY_CLIENT_FILTER END

        // ANCHOR: CITY_CLIENT_FILTER_DIAG
        console.log('[catalog] totals:', {
          all: all.length,
          afterCity: list.length,
          citySel
        });
        console.table(
          list.map(p => ({
            id: p.propertyId,
            name: p.name,
            city: p.city,
            cityCode: p.cityCode,
            availableNights: p.availableNights,
            fromPriceStr: p.fromPriceStr
          }))
        );
        // ANCHOR: CITY_CLIENT_FILTER_DIAG END

        // ANCHOR: TARGET_PROP_DIAG (mike check 1)
        (() => {
          const TARGET = 'mike check 1';
          const norm = s => String(s||'').trim().toLowerCase();
          const inAll  = (all  || []).find(p => norm(p.name) === norm(TARGET));
          const inCity = (list || []).find(p => norm(p.name) === norm(TARGET));

          console.log('[catalog][target]', TARGET, {
            presentInAll: !!inAll,
            presentAfterCityFilter: !!inCity,
            selectedCity: citySel,
            all_city: inAll && { city: inAll.city, cityCode: inAll.cityCode },
            all_availableNights: inAll && inAll.availableNights,
            all_fromPriceStr: inAll && inAll.fromPriceStr
          });

          if (inAll && !inCity) {
            console.warn('[catalog][target] City mismatch likely. Compare:', {
              selectedCity: citySel,
              propCity: inAll.city,
              propCityCode: inAll.cityCode
            });
          }
        })();

        window.__catalogProps = list;

        // amenity filter layered on top
        const sel = selectedAmenities();
        if (sel.length) {
          list = list.filter(p => {
            const am = (p.amenities || []).map(a => String(a).toLowerCase());
            return sel.every(a => am.includes(a));
          });
        }

        // apply sort
        list = applySort(list);

        found.textContent =
          `Found ${list.length} propert${list.length === 1 ? "y" : "ies"} ‚Äî ` +
          `${list.filter(p => p.availableNights > 0).length} with availability.`;
        grid.innerHTML =
          list.map(p => cardHTML(p, start, end)).join("") ||
          "<div>No results.</div>";
      }catch(err){
        console.error(err);
        found.textContent = "Search failed.";
        grid.innerHTML = "";
      } finally {
        if (typeof detailsEl !== 'undefined' && detailsEl) detailsEl.open = false;
      }
    }

    // Update URL with city/start/end/guests (+ optional plan), then run
    document.getElementById('search').addEventListener('click', () => {
      const city  = selectedCityCode();
      const start = startInp.value || todayISO();
      const end   = endInp.value   || start;

      // Read from hidden field used by custom-select for guests
      const guestsHiddenEl = document.getElementById('cat-guests');
      const guests = Number((guestsHiddenEl && guestsHiddenEl.value) || 2) || 2;

      const params = new URLSearchParams();
      params.set('start', start);
      params.set('end', end);
      params.set('guests', String(guests));
      if (city) params.set('city', city);
      if (window.ratePlanId) params.set('ratePlanId', String(window.ratePlanId));

      history.replaceState(null, '', location.pathname + '?' + params.toString());
      run();
    });

    // Destination dropdown now custom-select, so we trigger run() manually if needed
    S('dest')?.addEventListener('change', run);

    function getPriceValue(p){
      if (!p) return Infinity;
      const direct = Number(p.fromPrice);
      if (Number.isFinite(direct) && direct > 0) return direct;

      const s = typeof p.fromPriceStr === "string" ? p.fromPriceStr : "";
      if (!s) return Infinity;
      const cleaned = s.replace(/[^0-9.]+/g, "");
      const n = Number(cleaned);
      return Number.isFinite(n) && n > 0 ? n : Infinity;
    }

    function applySort(list){
      if (!Array.isArray(list) || !list.length) return list;
      const sel = document.getElementById('sort-order');
      if (!sel) return list;
      const mode = sel.value;
      if (!mode) return list;

      const sorted = list.slice();
      if (mode === "price-asc") {
        sorted.sort((a, b) => getPriceValue(a) - getPriceValue(b));
      } else if (mode === "price-desc") {
        sorted.sort((a, b) => getPriceValue(b) - getPriceValue(a));
      }
      return sorted;
    }

    /* ANCHOR: AMENITY_AUTO_FILTER */
    function filterAndRenderByAmenities(){
      if (!window.__catalogProps) return;

      const start = startInp.value || new Date().toISOString().slice(0,10);
      const end   = endInp.value   || start;

      const sel = Array.from(
        document.querySelectorAll('#amenities input[type="checkbox"]:checked')
      ).map(cb => String(cb.value).toLowerCase());

      const all = window.__catalogProps;
      let list = sel.length
        ? all.filter(p => {
            const am = (p.amenities || []).map(a => String(a).toLowerCase());
            return sel.every(a => am.includes(a));
          })
        : all.slice();

      // apply sort on top of amenity filter
      list = applySort(list);

      found.textContent =
        `Found ${list.length} propert${list.length === 1 ? "y" : "ies"} ‚Äî ` +
        `${list.filter(p => p.availableNights > 0).length} with availability.`;
      grid.innerHTML =
        list.map(p => cardHTML(p, start, end)).join("") ||
        "<div>No results.</div>";
    }

    document.querySelectorAll('#amenities input[type="checkbox"]').forEach(cb => {
      cb.addEventListener('change', () => {
        if (!window.__catalogProps) { run(); } else { filterAndRenderByAmenities(); }
      });
    });

    const sortSelect = document.getElementById('sort-order');
    if (sortSelect) {
      sortSelect.addEventListener('change', () => {
        if (!window.__catalogProps) {
          run();
        } else {
          filterAndRenderByAmenities();
        }
      });
    }

    run();
  </script>
  <!-- ANCHOR: CATALOG_FILTERS_TOGGLE -->
    <script>
    (() => {
      const btn   = document.getElementById('filtersBtn');
      const panel = document.getElementById('amenities');
      if (!btn || !panel) return;

      btn.setAttribute('aria-controls', 'amenities');
      btn.setAttribute('aria-expanded', panel.open ? 'true' : 'false');

      btn.addEventListener('click', () => {
        const willOpen = !panel.open;
        panel.open = willOpen;
        btn.setAttribute('aria-expanded', willOpen ? 'true' : 'false');

        if (willOpen) {
          panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });
    })();

  /* === ANCHOR: CUSTOM_SELECT_INIT (match landing, hardened) ============= */

  function initCustomSelect(wrapper){
    const button = wrapper.querySelector(".custom-select-toggle");
    const labelEl = wrapper.querySelector(".custom-select-label");
    const menu = wrapper.querySelector(".custom-select-menu");
    const options = menu.querySelectorAll("li[data-value]");
    const hidden = document.getElementById(wrapper.dataset.target);

    if (!button || !labelEl || !menu || !hidden) return;

    function openMenu(){
      menu.classList.add("is-open");
      button.setAttribute("aria-expanded","true");
    }

    function closeMenu(){
      menu.classList.remove("is-open");
      button.setAttribute("aria-expanded","false");
    }

    function selectOption(li){
      const value = li.getAttribute("data-value") || "";
      const text  = (li.textContent || "").trim();

      hidden.value = value;
      labelEl.textContent = text;

      options.forEach(o => o.removeAttribute("aria-selected"));
      if (value !== "") {
        li.setAttribute("aria-selected","true");
      }

      closeMenu();
    }

    // Toggle open/close on button click
    button.addEventListener("click", function(evt){
      evt.preventDefault();
      evt.stopPropagation();

      if(menu.classList.contains("is-open")){
        closeMenu();
      } else {
        openMenu();
      }
    });

    // Select + close on option click
    options.forEach(li => {
      li.addEventListener("click", function(evt){
        evt.preventDefault();
        evt.stopPropagation();
        selectOption(li);
      });
    });

    // Close when clicking anywhere outside the wrapper
    document.addEventListener("click", function(evt){
      if(!wrapper.contains(evt.target)){
        closeMenu();
      }
    });

    // Initial sync from hidden value or aria-selected
    (function syncInitial(){
      const currentVal = (hidden.value || "").trim();
      if (!currentVal) {
        const preSel = menu.querySelector("li[aria-selected='true']");
        if (preSel) {
          labelEl.textContent = (preSel.textContent || "").trim();
        }
        return;
      }

      let matched = false;
      options.forEach(li => {
        const val = (li.getAttribute("data-value") || "").trim();
        if (val === currentVal) {
          labelEl.textContent = (li.textContent || "").trim();
          options.forEach(o => o.removeAttribute("aria-selected"));
          li.setAttribute("aria-selected","true");
          matched = true;
        }
      });

      if (!matched) {
        const preSel = menu.querySelector("li[aria-selected='true']");
        if (preSel) {
          labelEl.textContent = (preSel.textContent || "").trim();
        }
      }
    })();
  }

  // Initialize ALL custom-select instances on this page
  document.querySelectorAll(".custom-select").forEach(initCustomSelect);

  /* === ANCHOR: CUSTOM_SELECT_SYNC (match landing) ========================= */
  // On page load, sync dropdown label to query param (?city=...)
  (function syncDestination(){
    const url = new URL(location.href);
    const cityParam =
      url.searchParams.get("city") ||
      url.searchParams.get("q") ||
      url.searchParams.get("destination") ||
      "";

    if (!cityParam) return;

    const destHidden = document.getElementById("dest");
    if (!destHidden) return;

    const wrapper = destHidden.closest(".custom-select");
    if (!wrapper) return;

    const labelEl = wrapper.querySelector(".custom-select-label");
    const options = wrapper.querySelectorAll(".custom-select-menu li[data-value]");

    // Normalize for comparison
    const normalized = cityParam.trim().toUpperCase();

    options.forEach(li => {
      const val = (li.getAttribute("data-value") || "").trim().toUpperCase();
      if (val === normalized) {
        destHidden.value = li.getAttribute("data-value");
        labelEl.textContent = li.textContent.trim();

        // update aria-selected
        options.forEach(o => o.removeAttribute("aria-selected"));
        li.setAttribute("aria-selected", "true");
      }
    });
  })();

  /* === ANCHOR: CATALOG_MAP_MODAL_WIRING (details-backed pins) =============== */
  (function wireCatalogMapModal(){
    const openBtn  = document.getElementById("catalog-map-open");
    const backdrop = document.getElementById("catalog-map-modal");
    const closeBtn = document.getElementById("catalog-map-close");
    const canvas   = document.getElementById("catalog-map-canvas");
    if (!openBtn || !backdrop || !closeBtn || !canvas) return;

    let map = null;
    let markers = [];
    let infoWindow = null;
    let lastZoomForMarkers = null;

    // cache: propertyId -> { lat, lng, label }
    const coordCache = Object.create(null);

    function getProps(){
      return Array.isArray(window.__catalogProps) ? window.__catalogProps : [];
    }

    function getDestLabel(){
      const destLabelEl = document.getElementById("dest-label");
      return (destLabelEl && destLabelEl.textContent || "").trim();
    }

    function getPresetCenter(label){
      const PRESETS = {
        "Siargao":      { lat: 9.8443, lng: 126.0450 },
        "General Luna": { lat: 9.7892, lng: 126.1654 },
        "Cloud 9":      { lat: 9.8088, lng: 126.1713 },
        "El Nido":      { lat: 11.2027, lng: 119.4150 },
        "Coron":        { lat: 12.0,    lng: 120.2    },
        "Boracay":      { lat: 11.9622, lng: 121.9246 },
        "Manila":       { lat: 14.5995, lng: 120.9842 },
        "Cebu":         { lat: 10.3157, lng: 123.8854 }
      };
      if (PRESETS[label]) return PRESETS[label];
      return { lat: 12.8797, lng: 121.7740 }; // PH center fallback
    }

    function computeCenter(entries, destLabel){
      if (entries.length){
        let sumLat = 0, sumLng = 0;
        for (const e of entries){
          sumLat += e.pos.lat;
          sumLng += e.pos.lng;
        }
        return { lat: sumLat / entries.length, lng: sumLng / entries.length };
      }
      return getPresetCenter(destLabel || getDestLabel());
    }

    function escapeHtml(str){
      return String(str || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;");
    }

    function buildDetailsLink(p){
      // Read current search box values so they flow into details page
      const startInp  = document.getElementById("start");
      const endInp    = document.getElementById("end");
      const guestsInp = document.getElementById("cat-guests");

      const startVal  = (startInp  && startInp.value)  || "";
      const endVal    = (endInp    && endInp.value)    || "";
      const guestsVal = (guestsInp && guestsInp.value) || "";

      const params = new URLSearchParams();
      params.set("propertyId", String(p.propertyId));

      if (startVal)  params.set("start", startVal);
      if (endVal)    params.set("end",   endVal);
      if (guestsVal) params.set("guests", guestsVal);

      if (window.ratePlanId) {
        params.set("ratePlanId", String(window.ratePlanId));
      }

      return "/catalog_details.html?" + params.toString();
    }

    function groupEntries(entries, zoom){
      const z = typeof zoom === "number" ? zoom : 10;
      let precision;
      if (z <= 7) precision = 0;
      else if (z <= 9) precision = 1;
      else if (z <= 11) precision = 2;
      else if (z <= 13) precision = 3;
      else precision = 4;

      const buckets = new Map();
      for (const e of entries){
        const key = e.pos.lat.toFixed(precision) + "|" + e.pos.lng.toFixed(precision);
        const arr = buckets.get(key);
        if (arr) arr.push(e); else buckets.set(key, [e]);
      }

      return Array.from(buckets.values()).map(group => ({
        pos: group[0].pos,
        items: group
      }));
    }

    function buildEntries(props){
      const out = [];
      for (const p of props){
        const id = p.propertyId;
        if (!id) continue;

        let lat = (p.latitude ?? null);
        let lng = (p.longitude ?? null);
        let label = p.mapLabel || p.location || [p.city, p.country].filter(Boolean).join(", ");

        const cached = coordCache[id];
        if (cached){
          lat   = cached.lat;
          lng   = cached.lng;
          label = cached.label || label;
        }

        if (typeof lat === "string") lat = parseFloat(lat);
        if (typeof lng === "string") lng = parseFloat(lng);
        if (!Number.isFinite(lat) || !Number.isFinite(lng)) continue;

        out.push({ p, pos: { lat, lng }, label });
      }
      return out;
    }

    async function loadMissingCoords(props){
      const tasks = [];

      // Read current dates from the search box so /catalog/details does not 400
      const startInp = document.getElementById("start");
      const endInp   = document.getElementById("end");
      const startVal = (startInp && startInp.value) || "";
      const endVal   = (endInp && endInp.value) || "";

      for (const p of props){
        const id = p.propertyId;
        if (!id) continue;

        const hasLat =
          coordCache[id] ||
          (Number.isFinite(parseFloat(String(p.latitude ?? ""))) &&
           Number.isFinite(parseFloat(String(p.longitude ?? ""))));

        if (hasLat) continue;

        const params = new URLSearchParams();
        params.set("propertyId", String(id));
        if (startVal) params.set("start", startVal);
        if (endVal)   params.set("end", endVal);

        const url = `/catalog/details?${params.toString()}`;

        tasks.push(
          fetch(url)
            .then(r => (r.ok ? r.json() : null))
            .then(j => {
              if (!j || !j.meta || !j.meta.property) return;
              const mp = j.meta.property;

              let lat = mp.latitude ?? mp.lat ?? mp.geoLat ?? null;
              let lng = mp.longitude ?? mp.lng ?? mp.geoLng ?? null;
              if (typeof lat === "string") lat = parseFloat(lat);
              if (typeof lng === "string") lng = parseFloat(lng);
              if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;

              const label =
                mp.mapLabel ||
                p.mapLabel ||
                p.location ||
                [p.city, p.country].filter(Boolean).join(", ");

              coordCache[id] = { lat, lng, label };
              p.latitude  = lat;
              p.longitude = lng;
              if (!p.mapLabel && label) p.mapLabel = label;
            })
            .catch(err => {
              console.warn("[catalog.map] details fetch failed for", id, err);
            })
        );
      }

      if (tasks.length) {
        await Promise.all(tasks);
      }
    }

    function refreshMarkers(destLabel){
      if (!map) return;

      const props   = getProps();
      const entries = buildEntries(props);
      const groups  = groupEntries(entries, map.getZoom());

      // Clear existing markers
      for (const m of markers){
        m.setMap(null);
      }
      markers = [];

      if (!infoWindow){
        infoWindow = new google.maps.InfoWindow();
      }

      for (const group of groups){
        const propsInGroup = group.items;
        const single = propsInGroup.length === 1;
        const firstP = propsInGroup[0].p;

        const markerTitle = single
          ? (firstP.name || "Stay")
          : `${propsInGroup.length} stays here`;

        const marker = new google.maps.Marker({
          map,
          position: group.pos,
          title: markerTitle
        });

        marker.addListener("click", function(){
          let html;
          if (single){
            const p = firstP;
            const label =
              coordCache[p.propertyId]?.label ||
              p.mapLabel ||
              p.location ||
              [p.city, p.country].filter(Boolean).join(", ");
            const link = buildDetailsLink(p);

            html =
              '<div style="font-size:13px;max-width:240px;">' +
              `<strong>${escapeHtml(p.name || "Property")}</strong><br>` +
              (label ? `${escapeHtml(label)}<br>` : "") +
              `<a href="${link}" style="color:#ff6a3d;font-weight:600;text-decoration:none;">View details</a>` +
              "</div>";
          } else {
            const items = propsInGroup.slice(0, 4);
            let listHtml = "";
            for (const e of items){
              const p = e.p;
              const link = buildDetailsLink(p);
              listHtml +=
                `<li><a href="${link}" style="color:#ff6a3d;text-decoration:none;">${escapeHtml(p.name || "Property")}</a></li>`;
            }
            if (propsInGroup.length > 4){
              listHtml += "<li>‚Ä¶and more</li>";
            }

            html =
              '<div style="font-size:13px;max-width:260px;">' +
              `<strong>${propsInGroup.length} stays in this area</strong>` +
              `<ul style="margin:6px 0;padding-left:18px;">${listHtml}</ul>` +
              "</div>";
          }

          infoWindow.setContent(html);
          infoWindow.open(map, marker);
        });

        markers.push(marker);
      }

      // If we had no entries, at least keep map centered on destination
      if (!groups.length){
        const center = computeCenter([], destLabel);
        map.setCenter(center);
      }
    }

    async function ensureMap(){
      const props      = getProps();
      const destLabel  = getDestLabel();
      const startCenter = getPresetCenter(destLabel);

      if (!(window.google && google.maps && google.maps.Map)){
        console.warn("[catalog.map] Google Maps JS not ready");
        return;
      }

      if (!map){
        map = new google.maps.Map(canvas, {
          center: startCenter,
          zoom: props.length === 1 ? 11 : 9,
          mapTypeControl: false,
          streetViewControl: false,
          fullscreenControl: false,
          zoomControl: true,
          gestureHandling: "greedy"
        });

        map.addListener("zoom_changed", function(){
          const z = map.getZoom();
          if (z === lastZoomForMarkers) return;
          lastZoomForMarkers = z;
          refreshMarkers(destLabel);
        });
      } else {
        map.setCenter(startCenter);
      }

      // Load coords from /catalog/details for each property if needed
      await loadMissingCoords(props);

      const entries = buildEntries(props);
      const center  = computeCenter(entries, destLabel);
      const zoom    = entries.length === 1 ? 13 : (props.length ? 10 : map.getZoom());

      map.setCenter(center);
      map.setZoom(zoom);

      lastZoomForMarkers = map.getZoom();
      refreshMarkers(destLabel);
    }

    function openModal(){
      backdrop.style.display = "flex";
      backdrop.setAttribute("aria-hidden", "false");
      document.documentElement.style.overflow = "hidden";
      document.body.style.overflow = "hidden";

      // fire and forget
      void ensureMap();
    }

    function closeModal(){
      backdrop.style.display = "none";
      backdrop.setAttribute("aria-hidden", "true");
      document.documentElement.style.overflow = "";
      document.body.style.overflow = "";
    }

    openBtn.addEventListener("click", openModal);
    closeBtn.addEventListener("click", closeModal);

    backdrop.addEventListener("click", function(evt){
      if (evt.target === backdrop) {
        closeModal();
      }
    });

    document.addEventListener("keydown", function(evt){
      if (evt.key === "Escape" && backdrop.style.display === "flex") {
        closeModal();
      }
    });
  })();

</script>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB3S03x_g_worh7dj4dk-lHYPFJ3RMknVc"></script>

</body>
</html>