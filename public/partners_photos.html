<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Photos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <!-- Inline favicon -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><circle cx="32" cy="32" r="28" fill="%23ff6a3d"/></svg>' />

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/extranet.css">
  
  <style>
  :root{
    --bg:#0b1320; --card:#111a2b; --fg:#e8eefc; --muted:#9bb0d3; --line:rgba(255,255,255,.08);
    --brand-orange:#ff6a3d; --brand-blue:#2e7bff;
  }
  *{ box-sizing:border-box }
  body{
    margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif; color:var(--fg);
    background: radial-gradient(1000px 600px at 20% -10%, #1a2b4a 0%, #0b1320 60%, #0b1320 100%);
    min-height:100vh;
  }
  .page{ max-width:1100px; margin:32px auto; padding:0 16px; }
  .card{ background:var(--card); border:1px solid var(--line); border-radius:16px; padding:18px; box-shadow:0 8px 40px rgba(0,0,0,.45); }

  .row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  .row.between{ justify-content:space-between; align-items:center; }
  .spacer{ height:16px; }
  .muted{ color:var(--muted); font-size:12px; }

    .input{
        border:1px solid var(--line); border-radius:10px; padding:10px 12px;
        background:#0e1830; color:var(--fg);
    }
  /* Fix: keep the native "Choose File" button from touching the bottom border */
    input[type="file"].input{
    height:44px;          /* make the whole control taller */
    padding:0 12px;       /* vertical space is controlled by the button's margins */
    line-height:44px;     /* vertically centers the filename text */
    }

    /* Style & center the inner button with equal top/bottom margin */
    input[type="file"].input::file-selector-button,
    input[type="file"].input::-webkit-file-upload-button{ /* Safari/WebKit fallback */
    margin:4px 8px 4px 0; /* 4px top/bottom â†’ symmetric spacing */
    padding:6px 12px;
    line-height:normal;
    border-radius:999px;
    border:1px solid var(--brand-blue);
    background:transparent;
    color:#d7e5ff;        /* matches your blue-outline "Save/Back" buttons */
    }

  .input:focus{ outline:none; border-color:var(--brand-blue); box-shadow:0 0 0 3px rgba(46,123,255,.20); }

/* Make the native "Choose File" button match our blue-outline Save button */
input[type="file"].input {            /* keep field height tidy */
padding: 0 12px;
}

/* Modern browsers */
input[type="file"].input::file-selector-button {
font: inherit;
padding: 9px 14px;
border-radius: 999px;
border: 1px solid var(--brand-blue);
background: transparent;
color: #d7e5ff;
cursor: pointer;
margin-right: 10px;                 /* space before filename */
transition: box-shadow .12s ease, transform .12s ease;
}
input[type="file"].input::file-selector-button:hover {
box-shadow: 0 0 0 3px rgba(46,123,255,.20) inset;
transform: translateY(-1px);
}

/* WebKit fallback (older Safari/Chromium) */
input[type="file"].input::-webkit-file-upload-button {
font: inherit;
padding: 9px 14px;
border-radius: 999px;
border: 1px solid var(--brand-blue);
background: transparent;
color: #d7e5ff;
cursor: pointer;
margin-right: 10px;
transition: box-shadow .12s ease, transform .12s ease;
}
input[type="file"].input::-webkit-file-upload-button:hover {
box-shadow: 0 0 0 3px rgba(46,123,255,.20) inset;
transform: translateY(-1px);
}

  /* File input: slightly shorter than the Upload button and with comfy vertical padding */
  input[type="file"].input{
    padding: 6px 10px;        /* less tall than .btn (which is 9px top/bottom) */
    height: 34px;             /* explicit for consistent cross-browser look */
    line-height: 1.1;
  }

  /* Style the inner "Choose file" button to match our secondary/outline buttons */
  input[type="file"].input::file-selector-button{
    padding: 6px 12px;
    border-radius: 999px;
    border: 1px solid var(--brand-blue);
    background: transparent;
    color: #d7e5ff;
    font-weight: 700;
    margin-right: 10px;
    cursor: pointer;
  }
  /* Safari/old Chromium variant */
  input[type="file"].input::-webkit-file-upload-button{
    padding: 6px 12px;
    border-radius: 999px;
    border: 1px solid var(--brand-blue);
    background: transparent;
    color: #d7e5ff;
    font-weight: 700;
    margin-right: 10px;
    cursor: pointer;
  }

  /* Grid */
  .grid{ display:grid; grid-template-columns: repeat(3, 1fr); gap:14px; }
  @media (max-width: 960px){ .grid{ grid-template-columns: repeat(2, 1fr);} }
  @media (max-width: 640px){ .grid{ grid-template-columns: 1fr;} }

  .ph-card{
    border:1px solid var(--line); border-radius:12px; overflow:hidden; background:#0f1a30;
  }
  .ph-img{
    width:100%; height:220px; object-fit:cover; background:#0c1426;
    display:block;
  }
  .ph-body{ padding:10px; display:flex; flex-direction:column; gap:8px; }
  .badge{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--line); background:#1f2937; }
  .badge.cover{ background:#065f46; }

  .actions{ display:flex; gap:8px; flex-wrap:wrap; }
  textarea.alt{ width:100%; min-height:40px; resize:vertical; }
  </style>
</head>
<body>
  <div class="page">
    <div class="card">
      <div class="row between">
        <h1 style="margin:0;">Photos</h1>
        <button id="backBtn" class="btn secondary">Back to menu</button>
      </div>
      <div class="muted">
        Upload JPEG/PNG/WebP. Max size is enforced by server policy.
      </div>

      <div class="spacer"></div>

      <!-- Upload row -->
      <div id="photos-toolbar" class="row">
        <input id="file" type="file" accept="image/jpeg,image/png,image/webp" class="input" />
        <button id="uploadBtn" class="btn">Upload Photo</button>
        <span class="muted">Your current session is used for auth.</span>
      </div>

      <div class="spacer"></div>

      <!-- Room filter -->
      <div id="room-filter" class="row">
        <label for="roomSelect" class="muted">Assign to:</label>
        <select id="roomSelect" class="input">
          <option value="">Property (no room)</option>
        </select>
        <span class="muted">New uploads will be assigned here.</span>
      </div>

      <div class="spacer"></div>

      <!-- Grid list -->
      <div id="grid" class="grid" aria-live="polite"></div>
    </div>
  </div>

<script>
const BASE = 'https://lolaelo-api.onrender.com';
const ALLOWED_CT = new Set(['image/jpeg','image/png','image/webp']);

function token(){ return localStorage.getItem('lolaelo_session') || ''; }
function headers(json=true){
  const t = token();
  const h = { 'Authorization': 'Bearer ' + t, 'x-partner-token': t };
  if (json) h['Content-Type'] = 'application/json';
  return h;
}
function fmtDate(iso){ if(!iso) return ''; return new Date(iso).toLocaleString(); }

async function listPhotos(){
  const grid = document.getElementById('grid');
  grid.innerHTML = '<div class="muted">Loadingâ€¦</div>';
  const ridRaw = window.currentRoomTypeIdForPhotos;
  const rid = (typeof ridRaw === 'number' && Number.isFinite(ridRaw)) ? ridRaw : NaN;
  let url = BASE + '/extranet/property/photos';
  const qs = new URLSearchParams();
  if (Number.isFinite(rid)) qs.set('roomTypeId', String(rid));
  qs.set('cb', String(Date.now()));
  url += '?' + qs.toString();

  const r = await fetch(url, { method: 'GET', headers: headers(false), cache: 'no-store' });
  if (!r.ok){ grid.innerHTML = '<div>Failed to load ('+r.status+')</div>'; return; }
  const raw = await r.json(); const rows = Array.isArray(raw.value) ? raw.value : raw;

  console.log('[photos][list] sample row:', rows[0]);

  grid.innerHTML = '';
  if (!rows.length){ grid.innerHTML = '<div class="muted">No photos yet.</div>'; return; }

  for (const row of rows){
    console.log('[photos][render-row]', {
      id: row.id,
      alt: row.alt,
      roomTypeId: row.roomTypeId
    });

    const card = document.createElement('div'); card.className='ph-card';

    const img = document.createElement('img');
    img.className = 'ph-img';
    img.src = row.url;
    img.alt = row.alt || 'Photo';
    card.appendChild(img);

    const body = document.createElement('div'); body.className='ph-body';

    const top = document.createElement('div');
    const badge = document.createElement('span');
    badge.className = 'badge' + (row.isCover ? ' cover' : '');
    badge.textContent = row.isCover ? 'COVER' : 'PHOTO';
    top.appendChild(badge);
    const meta = document.createElement('span'); meta.className='muted'; meta.style.marginLeft='8px';
    meta.textContent = fmtDate(row.createdAt);
    top.appendChild(meta);
    body.appendChild(top);

    const ta = document.createElement('textarea'); ta.className='alt input'; ta.placeholder='Alt/descriptionâ€¦'; ta.value=row.alt||'';
    body.appendChild(ta);

    // --- Assign-to-room row (dropdown + apply) ---
    const assignRow = document.createElement('div');
    assignRow.className = 'row';

    const assignLabel = document.createElement('label');
    assignLabel.className = 'muted';
    assignLabel.textContent = 'Assign to:';
    assignRow.appendChild(assignLabel);

    const assignSel = document.createElement('select');
    assignSel.className = 'input';
    assignSel.style.minWidth = '220px';

    // Build options from cached room list
    const roomsList = Array.isArray(window.__roomsListForPhotos) ? window.__roomsListForPhotos : [];
    // Default: property-level (no room)
    const optNone = document.createElement('option');
    optNone.value = '';
    optNone.textContent = 'Property (no room)';
    assignSel.appendChild(optNone);

    // Room options
    roomsList.forEach(rm => {
      const id = Number(rm.roomTypeId ?? rm.id);
      const name = String(rm.name ?? rm.title ?? `Room ${id}`);
      if (!Number.isFinite(id)) return;
      const opt = document.createElement('option');
      opt.value = String(id);
      opt.textContent = name;
      assignSel.appendChild(opt);
    });

    // Preselect current assignment if present
    if (Number.isFinite(Number(row.roomTypeId))) {
      assignSel.value = String(Number(row.roomTypeId));
    } else {
      assignSel.value = '';
    }

    assignRow.appendChild(assignSel);

    const assignBtn = document.createElement('button');
    assignBtn.className = 'btn secondary';
    assignBtn.textContent = 'Apply';
    assignBtn.onclick = async () => {
    assignBtn.disabled = true;
    try {
    const raw = (assignSel.value || '').trim();
    const payload = {
      // blank = property-level (no room), anything else = numeric roomTypeId
      roomTypeId: raw === '' ? null :
        (Number.isFinite(Number(raw)) ? Number(raw) : null),
    };
    const url = BASE + '/extranet/property/photos/' + row.id;

      console.log('[photos][assign] PUT', url, payload);

      // Try PUT first
      let rr = await fetch(url, {
        method: 'PUT',
        headers: headers(),
        body: JSON.stringify(payload)
      });

      // If backend prefers PATCH (or PUT not allowed), retry once with PATCH
      if (!rr.ok && (rr.status === 405 || rr.status === 404)) {
        console.log('[photos][assign] PUT not allowed (', rr.status, ') â†’ retry PATCH');
        rr = await fetch(url, {
          method: 'PATCH',
          headers: headers(),
          body: JSON.stringify(payload)
        });
      }

      const txt = await rr.text().catch(() => '');
      console.log('[photos][assign] status:', rr.status, 'body:', txt);

      if (!rr.ok) {
        alert('Assign failed: ' + rr.status + '\n' + txt);
        return;
      }

      // âœ… Make it stick immediately in the UI without relying on list() response
      row.roomTypeId = payload.roomTypeId;               // persist in current card model
      assignSel.value = payload.roomTypeId ? String(payload.roomTypeId) : '';

      alert('Assigned successfully.');

    // Optional: if the header filter is set to a specific room, refresh list to re-filter
    await listPhotos();

    } catch (e) {
      console.warn('[photos][assign] exception', e);
      alert('Assign error: ' + (e && e.message ? e.message : e));
    } finally {
      assignBtn.disabled = false;
    }
  };

    assignRow.appendChild(assignBtn);

    body.appendChild(assignRow);
    // --- end assign-to-room row ---

    const actions = document.createElement('div'); actions.className='actions';

    const saveBtn = document.createElement('button');
    saveBtn.className='btn secondary';
    saveBtn.textContent='Save';
    saveBtn.onclick = async () => {
      saveBtn.disabled = true;
      try{
        const rr = await fetch(BASE + '/extranet/property/photos/' + row.id, {
          method:'PUT', headers: headers(), body: JSON.stringify({ alt: ta.value })
        });
        if(!rr.ok){ const err = await rr.text(); alert('Save failed: ' + rr.status + '\n' + err); }
      } finally { saveBtn.disabled = false; }
    };
    actions.appendChild(saveBtn);

    // new: match blue-outline like Save / Back to menu
    const coverBtn = document.createElement('button');
    coverBtn.className = 'btn secondary';
    coverBtn.textContent = row.isCover ? 'Cover' : 'Make Cover';
    coverBtn.disabled = !!row.isCover;
    coverBtn.onclick = async () => {
      coverBtn.disabled = true;
      try{
        const rr = await fetch(BASE + '/extranet/property/photos/' + row.id, {
          method:'PUT', headers: headers(), body: JSON.stringify({ isCover: true })
        });
        if(!rr.ok){ const err = await rr.text(); alert('Cover failed: ' + rr.status + '\n' + err); }
        else { await listPhotos(); }
      } finally { coverBtn.disabled = false; }
    };
    actions.appendChild(coverBtn);

    const delBtn = document.createElement('button');
    delBtn.className='btn danger';
    delBtn.textContent='Delete';
    delBtn.onclick = async () => {
      if (!confirm('Delete this photo?')) return;
      delBtn.disabled = true;
      try{
        const rr = await fetch(BASE + '/extranet/property/photos/' + row.id, {
          method:'DELETE', headers: headers(false)
        });
        if(!rr.ok && rr.status !== 204){ const err = await rr.text(); alert('Delete failed: ' + rr.status + '\n' + err); }
        else { await listPhotos(); }
      } finally { delBtn.disabled = false; }
    };
    actions.appendChild(delBtn);

    body.appendChild(actions);
    card.appendChild(body);
    grid.appendChild(card);
  }
}

async function upload(){
  const f = document.getElementById('file').files[0];
  if (!f) return alert('Pick a file first.');
  if (!ALLOWED_CT.has(f.type)) return alert('Unsupported type: ' + f.type);

  // 1) presign
  const r1 = await fetch(BASE + '/extranet/property/photos/upload-url', {
    method:'POST', headers: headers(), body: JSON.stringify({ fileName: f.name, contentType: f.type, size: f.size })
  });
  if (!r1.ok){ const e = await r1.text(); return alert('upload-url failed: ' + r1.status + '\n' + e); }
  const up = await r1.json();

  // 2) PUT to S3
  const r2 = await fetch(up.uploadUrl, { method:'PUT', headers: up.headers, body: f });
  if (!r2.ok) return alert('S3 PUT failed: ' + r2.status);

  // 3) create DB row; we can try to read dimensions client-side
  let width = null, height = null;
  try {
    const img = new Image();
    img.src = URL.createObjectURL(f);
    await new Promise((resolve, reject) => { img.onload = resolve; img.onerror = reject; });
    width = img.naturalWidth || null; height = img.naturalHeight || null;
  } catch {}

  const roomTypeId = Number(window.currentRoomTypeIdForPhotos);
  const payload = { key: up.key, url: up.url, alt: f.name, width, height, isCover: false };
  if (Number.isFinite(roomTypeId)) payload.roomTypeId = roomTypeId;

  const r3 = await fetch(BASE + '/extranet/property/photos', {
    method:'POST', headers: headers(),
    body: JSON.stringify(payload)
  });

  if (!r3.ok){ const err = await r3.text(); return alert('Create failed: ' + r3.status + '\n' + err); }

  await listPhotos(); alert('Uploaded.');
}

document.getElementById('uploadBtn').addEventListener('click', upload);
document.getElementById('backBtn').addEventListener('click', () => { window.location.href = '/partners_app.html'; });

// Ensure refresh on bfcache restore or after login redirects
window.addEventListener('pageshow', () => { if (typeof listPhotos === 'function') listPhotos(); });

// Initial load
listPhotos();

// === Room filter wiring (populate + preselect) ===
(function(){
  const sel = document.getElementById('roomSelect');
  if (!sel) return;

  // Read ?room=<id> from URL (if present)
  const qs = new URLSearchParams(window.location.search || "");
  const preselectRoomId = Number(qs.get('room'));
  let currentRoomTypeId = Number.isFinite(preselectRoomId) ? preselectRoomId : null;

  async function populateRoomOptions(){
    try {
      // Expecting: [{ roomTypeId, id?, name, active? }, ...]
      const res = await fetch(BASE + '/extranet/property/rooms', {
        method: 'GET',
        headers: headers(false),
        cache: 'no-store'
      });
      if (!res.ok) throw new Error('rooms fetch failed');
      const data = await res.json().catch(() => ([]));
      const arr = Array.isArray(data) ? data : (Array.isArray(data.rooms) ? data.rooms : []);

      // Cache rooms for per-photo assignment
      window.__roomsListForPhotos = arr;

      // Keep the "Property (no room)" default; clear prior room options
      for (let i = sel.options.length - 1; i >= 1; i--) sel.remove(i);

      arr.forEach(r => {
        const id = Number(r.roomTypeId ?? r.id);
        const name = String(r.name ?? r.title ?? `Room ${id}`);
        if (!Number.isFinite(id)) return;

        const opt = document.createElement('option');
        opt.value = String(id);
        opt.textContent = name;
        sel.appendChild(opt);
      });

      // Preselect if URL had ?room=
      if (Number.isFinite(preselectRoomId)) {
        sel.value = String(preselectRoomId);
        currentRoomTypeId = preselectRoomId;
        window.currentRoomTypeIdForPhotos = currentRoomTypeId;
      } else {
        sel.value = ""; // Property (no room)
        currentRoomTypeId = null;
        window.currentRoomTypeIdForPhotos = currentRoomTypeId;
      }

      // ðŸ”„ Refresh grid once options/selection are ready
      await listPhotos();

    } catch (e){
      console.warn('[photos] populateRoomOptions failed', e);
      // fall back to property-level (no room)
      sel.value = "";
      currentRoomTypeId = null;
      window.currentRoomTypeIdForPhotos = currentRoomTypeId;
      try { await listPhotos(); } catch(_){}
    }
  }

  // Track changes
  sel.addEventListener('change', async () => {
    const v = Number(sel.value);
    currentRoomTypeId = Number.isFinite(v) ? v : null;
    window.currentRoomTypeIdForPhotos = currentRoomTypeId; // expose globally
    console.log('[photos] currentRoomTypeId =', currentRoomTypeId ?? '(property)');
    try {
      await listPhotos(); // refresh grid whenever the user switches room
    } catch (e) {
      console.warn('[photos] listPhotos refresh failed after room change', e);
    }
  });

  // Init
  populateRoomOptions();
})();

</script>
</body>
</html>
