<!DOCTYPE html>
<html lang="en">
<head>
	<link
		rel="icon"
		type="image/png"
		sizes="32x32"
		href="https://www.lolaelo.com/logo2.png?cb=favicon-32"
	/>
	<link
		rel="icon"
		type="image/png"
		sizes="16x16"
		href="https://www.lolaelo.com/logo2.png?cb=favicon-16"
	/>
	<link
		rel="shortcut icon"
		href="https://www.lolaelo.com/logo2.png?cb=favicon"
	/>
  <meta charset="UTF-8" />
  <title>Lolaelo - Checkout</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  />
  <!-- Flatpickr (calendar) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>


<style>
  :root {
    --bg: #f9fafb;
    --card-bg: #ffffff;
    --border: #e5e7eb;
    --text: #0f172a;
    --muted: #6b7280;
    --accent: #ff6a3d;
    --accent-soft: rgba(255, 106, 61, 0.08);
    --teal: #0f766e;
    --radius-lg: 16px;
    --shadow-soft: 0 12px 30px rgba(15, 23, 42, 0.08);
  }

  * { box-sizing: border-box; }

  body {
    margin: 0;
    padding: 0;
    font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: var(--bg);
    color: var(--text);
  }

  /* ANCHOR: LAYOUT_SHELL */
  .page {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  header {
    padding: 16px 24px;
    border-bottom: 1px solid var(--border);
    background: #ffffff;
    position: sticky;
    top: 0;
    z-index: 20;
  }

  .header-inner {
    max-width: 1040px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
  }

  .logo {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    font-weight: 700;
    letter-spacing: 0.06em;
    font-size: 18px;
  }

  .logo img {
    height: 24px; /* smaller header logo */
    display: block;
  }

  .logo-text {
    color: var(--accent);
    font-size: 14px;
    font-weight: 600;
    letter-spacing: 0.12em;
  }

  .step-indicator {
    font-size: 13px;
    color: var(--muted);
  }

  main {
    flex: 1;
    padding: 24px 16px 32px;
  }

  .layout {
    max-width: 1040px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: minmax(0, 2.2fr) minmax(0, 1.1fr);
    gap: 24px;
    align-items: flex-start;
  }

  @media (max-width: 900px) {
    .layout {
      grid-template-columns: minmax(0, 1fr);
    }
  }

  /* ANCHOR: CARD_FRAME */
  .card {
    background: var(--card-bg);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-soft);
    padding: 20px 20px 18px;
    border: 1px solid rgba(15, 23, 42, 0.02);
  }

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
  }

  .card-header-right {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 4px;
  }

  .card-header-actions {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 2px;
  }

  .card-header-link {
    border: none;
    background: none;
    padding: 0;
    font-size: 12px;
    font-weight: 500;
    color: var(--accent);
    cursor: pointer;
    text-decoration: none;
  }

  .card-header-link:hover {
    text-decoration: underline;
  }

  .card-title {
    font-size: 15px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .card-step {
    width: 22px;
    height: 22px;
    border-radius: 999px;
    border: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 500;
    color: var(--muted);
  }

  .card-step.active {
    border-color: var(--accent);
    background: var(--accent-soft);
    color: var(--accent);
  }

  .card-step.completed {
    border-color: var(--teal);
    background: rgba(16, 185, 129, 0.08);
    color: var(--teal);
  }

  .card-status {
    font-size: 12px;
    color: var(--muted);
  }

  .card-status.completed {
    color: var(--teal);
    font-weight: 500;
  }

  .section-body {
    margin-top: 6px;
    font-size: 14px;
    color: var(--muted);
  }

  .section-body.hidden {
    display: none;
  }

  .addons-footer-row {
    margin-top: 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    flex-wrap: wrap;
  }

  /* Keep the pill tight and aligned in Section 3 */
  .addons-section-total-pill {
    margin: 0;
    white-space: nowrap;
  }

  .addons-section-total-pill span {
    font-weight: 600;
  }

  /* ANCHOR: FIELDS_AND_FORM */
  .field-row {
    margin-top: 12px;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .field-label {
    font-size: 13px;
    color: var(--muted);
  }

  .field-value {
    font-size: 14px;
    color: var(--text);
  }

  /* Room -> Plan x Rooms (Section 1) */
  .room-plan-row{
    margin-top: 12px;
    display: flex;
    align-items: flex-end;
    gap: 10px;
  }
  .rp-col{
    display:flex;
    flex-direction:column;
    gap:4px;
    min-width: 0;
  }
  .rp-col-grow{ flex: 1; }

  .rp-label{
    font-size: 12px;
    color: var(--muted);
  }
  .rp-value{
    font-size: 14px;
    color: var(--text);
    display:flex;
    align-items: baseline;
    gap: 8px;
    flex-wrap: wrap;
  }

  /* Center value for # of Rooms column only */
  .rp-col:last-child .rp-value{
    justify-content: center;
  }
  .rp-arrow{
    font-size: 16px;
    color: var(--muted);
    padding: 0 2px 2px;
  }
  .rp-mult{
    color: var(--muted);
  }
  .rp-unit{
    color: var(--muted);
  }

  .addons-block {
    margin-top: 16px;
    padding-top: 12px;
    border-top: 1px dashed var(--border-soft);
  }

  .checkout-dates-card-wrapper{
    margin-top: 6px;
    display: block;         /* visible unless hidden */
  }

  .checkout-dates-card-wrapper.hidden{
    display: none;
  }

  .detail-date-bar {
    display: grid;
    grid-template-columns: 1fr;
    row-gap: 8px;

    margin-top: 2px;
    font-size: 12px;

    width: 50%;
    max-width: 260px;
    padding: 12px 14px;
    border-radius: 18px;
    background: var(--surface);
    box-shadow: 0 8px 30px rgba(15, 23, 42, 0.08);
    border: 1px solid var(--border-soft);
  }

  .detail-date-bar label {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .detail-date-bar label span {
    font-size: 11px;
    color: var(--muted);
  }

  .detail-date-bar input[type="date"] {
    font-size: 12px;
    padding: 4px 6px;
    border-radius: 8px;
    border: 1px solid var(--border-subtle);
    background: var(--surface-subtle);
    color: var(--fg);
  }

  .detail-date-bar button {
    padding: 6px 12px;
    border-radius: 999px;
    border: 1px solid var(--accent);
    background: transparent;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    white-space: nowrap;
    justify-self: flex-end;   /* third row, right aligned */
  }

  .addons-header {
    margin-bottom: 6px;
  }

  .addons-title {
    font-size: 14px;
    font-weight: 500;
  }

  .addons-subtitle {
    font-size: 12px;
    color: var(--muted);
  }

  .addons-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 4px;
  }

  .addon-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    font-size: 13px;
  }

  .addon-main {
    display: flex;
    flex-direction: column;
  }

  .addon-title {
    font-weight: 500;
  }

  .addon-meta {
    font-size: 12px;
    color: var(--muted);
  }

  .addon-qty {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .addon-qty label {
    font-size: 12px;
    color: var(--muted);
  }

  .addon-qty input {
    width: 64px;
    padding: 4px 6px;
    border-radius: 6px;
    border: 1px solid var(--border-soft);
    text-align: right;
    font-size: 13px;
  }

  button {
    font-family: inherit;
    border: none;
    cursor: pointer;
  }

  .btn-primary {
    margin-top: 14px;
    padding: 9px 16px;
    border-radius: 999px;
    background: var(--accent);
    color: #ffffff;
    font-size: 14px;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .btn-primary[disabled] {
    opacity: 0.6;
    cursor: default;
  }

  .btn-link {
    background: none;
    border: none;
    color: var(--teal);
    font-size: 13px;
    padding: 0;
  }

  .guest-form-grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 10px 12px;
    margin-top: 8px;
  }

  @media (max-width: 600px) {
    .guest-form-grid {
      grid-template-columns: minmax(0, 1fr);
    }
  }

  label {
    display: block;
    font-size: 13px;
    color: var(--muted);
    margin-bottom: 4px;
  }

  input,
  textarea {
    width: 100%;
    border-radius: 10px;
    border: 1px solid var(--border);
    padding: 8px 10px;
    font-size: 14px;
    font-family: inherit;
    outline: none;
    background: #ffffff;
  }

  input:focus,
  textarea:focus {
    border-color: var(--teal);
    box-shadow: 0 0 0 1px rgba(15, 118, 110, 0.12);
  }

  .phone-row {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .phone-country {
    min-width: 170px;
    border-radius: 10px;
    border: 1px solid var(--border);
    padding: 8px 8px;
    font-size: 13px;
    background: #ffffff;
  }

  .phone-country:focus {
    border-color: var(--teal);
    box-shadow: 0 0 0 1px rgba(15, 118, 110, 0.12);
    outline: none;
  }

  .phone-input {
    flex: 1;
  }

  textarea {
    min-height: 70px;
    resize: vertical;
  }

  .error-text {
    color: #b91c1c;
    font-size: 13px;
    margin-top: 6px;
  }

  /* ANCHOR: SUMMARY_CARD */
  /* ANCHOR: PRICE_SUMMARY */
  .price-summary-row {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    gap: 16px; /* a bit more deliberate spacing */
    margin-top: 2px;
  }

  .price-main-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .price-per-night {
    font-size: 14px;      /* closer to dates / nights */
    font-weight: 400;
    color: var(--text);
  }
  .price-per-night-caption {
    font-size: 12px;
    color: var(--muted);
  }

  .price-total-pill {
    padding: 10px 18px;       /* bigger pill overall */
    border-radius: 999px;
    border: 1px solid var(--border);
    background: #f9fafb;
    font-size: 17px;          /* bigger font */
    font-weight: 500;         /* slight emphasis but not bold */
    white-space: nowrap;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    transform: translateY(2px); /* minor vertical centering polish */
  }

  .price-total-pill span {
    font-weight: 600;
    font-size: 17px; /* match pill font size */
    color: var(--text);
   }

  .summary-card-title {
    font-size: 15px;
    font-weight: 600;
    margin-bottom: 6px;
  }

  .summary-line {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    font-size: 13px;
    margin-top: 4px;
    color: var(--muted);
  }

  .summary-line strong {
    font-size: 14px;
    color: var(--text);
  }

  .summary-total {
    margin-top: 10px;
    padding-top: 8px;
    border-top: 1px dashed var(--border);
    display: flex;
    justify-content: space-between;
    align-items: baseline;
  }

  .summary-total-label {
    font-size: 13px;
    color: var(--muted);
  }

  .summary-total-amount {
    font-size: 18px;
    font-weight: 600;
    color: var(--text);
  }

  .breakdown-toggle {
    margin-top: 8px;
    font-size: 13px;
    color: var(--teal);
    cursor: pointer;
  }

  .breakdown {
    margin-top: 6px;
    padding: 8px 0 4px;
    border-top: 1px dashed var(--border);
    display: none;
    font-size: 12px;
    color: var(--muted);
  }

  .breakdown.visible {
    display: block;
  }

  .breakdown-line{
    display: grid;
    grid-template-columns: auto 1fr auto;
    column-gap: 10px;
    align-items: baseline;
    margin-bottom: 2px;
  }
  .breakdown-line .bd-rooms{
    color: var(--muted);
    white-space: nowrap;
  }

  /* ANCHOR: STICKY_FOOTER */
  .sticky-footer {
    position: sticky;
    bottom: 0;
    margin-top: 16px;
    background: linear-gradient(
      to top,
      rgba(249, 250, 251, 0.96),
      rgba(249, 250, 251, 0.9)
    );
    padding-top: 8px;
  }

  .sticky-inner {
    max-width: 1040px;
    margin: 0 auto;
    padding: 10px 0 6px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
  }

  .sticky-label {
    font-size: 13px;
    color: var(--muted);
  }

  .sticky-amount {
    font-size: 16px;
    font-weight: 600;
    color: var(--text);
  }

  .sticky-button {
    padding: 11px 24px;
    border-radius: 999px;
    background: var(--accent);
    color: #ffffff;
    font-size: 14px;
    font-weight: 600;
    border: none;
    white-space: nowrap;
    margin-left: -65px; /* shift button ~10 characters to the left */
  }

  .sticky-button[disabled] {
    opacity: 0.6;
    cursor: default;
  }

  /* Hide global sticky footer â€“ Section 5 button now drives payment */
  .sticky-footer {
    display: none;
  }

  /* ANCHOR: PAYMENT_PILLS */
  .card-logos {
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

	/* BIGGER logos â€“ ~5x original */
	.card-logos img,
	.pill img,
	.card-logo-ticker {
		height: 60px;
		display: block;
		object-fit: contain;
	}

  .payment-options-row {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    align-items: stretch;
  }

  .pill-wrap {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    min-width: 190px;
  }

  .pill-caption {
    font-size: 11px;
    color: var(--muted);
    text-align: center;
    line-height: 1.3;
    margin-bottom: 2px; /* caption ABOVE the pill */
  }

  .pill {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 16px 22px;
    border-radius: 999px;
    font-size: 11px;
    font-weight: 500;
    border: 1px solid var(--border);
    color: var(--muted);
    background: #f9fafb;
    gap: 10px;
    transition:
      border-color 0.16s ease-out,
      box-shadow 0.16s ease-out,
      background 0.16s ease-out,
      transform 0.12s ease-out;
  }

  .pill-main {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  /* Invisible radio that sits over the pill */
  .payment-pill-input {
    position: absolute;
    inset: 20px 0 0 0; /* start roughly at top of pill */
    opacity: 0;
    cursor: pointer;
  }

  /* Selected pill: orange outline + soft gradient */
  .payment-pill-input:checked + .pill {
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(255, 106, 61, 0.35);
    background: linear-gradient(135deg, rgba(255, 247, 237, 1), #ffffff);
    transform: translateY(-1px);
  }

  /* Remove old colored dot entirely */
  .pill-dot {
    display: none;
  }

  /* ANCHOR: SECURITY_HELPER */
  .payment-security {
    margin-top: 10px;
    display: flex;
    justify-content: flex-end;
    position: relative;
  }

  /* circular icon version â€“ used with the badge-style helper */
  .security-badge {
    width: 32px;
    height: 32px;
    border-radius: 999px;
    background: #dbeafe;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #0f766e;
    font-size: 16px;
    box-shadow: 0 8px 20px rgba(15, 23, 42, 0.15);
    cursor: default;
  }

  .security-icon-btn {
    width: 32px;
    height: 32px;
    border-radius: 999px;
    border: none;
    background: #e0f2fe;
    color: #0f766e;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 6px 16px rgba(15, 23, 42, 0.18);
    font-size: 16px;
    cursor: pointer;
  }

  .security-icon-btn:focus-visible {
    outline: 2px solid #0f766e;
    outline-offset: 2px;
  }

  .security-bubble {
    position: absolute;
    top: 130%;                     /* push BELOW the icon */
    left: 50%;                     /* center horizontally */
    transform: translate(-50%, 4px); /* center + slight slide on show */
    background: #e0fdf4;
    color: #0f172a;
    padding: 10px 12px;
    border-radius: 12px;
    width: 260px;
    box-shadow: 0 16px 35px rgba(15, 23, 42, 0.2);
    font-size: 12px;
    line-height: 1.4;
    opacity: 0;
    pointer-events: none;
    transition:
      opacity 0.18s ease-out,
      transform 0.18s ease-out;
    z-index: 30;
  }

  .security-bubble strong {
    color: #0f172a;   /* match bubble body text */
    font-weight: 700;
    display: block;
    margin-bottom: 6px;
  }

  .payment-security:hover .security-bubble,
  .payment-security:focus-within .security-bubble {
    opacity: 1;
    pointer-events: auto;
    transform: translateY(0);
  }

  /* Agreement line next to payment button */
  .payment-agreement {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 4px;
    font-size: 12px;
    color: var(--muted);
    margin-left: 8px;
    margin-top: 10px;   /* <<< drops entire block one line down */
    max-width: 420px;
  }

  .payment-agreement-label {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    margin-top: 0;     /* reset */
    border-radius: 10px;
    border: 1px solid transparent;
    background: #ffffff;
    cursor: pointer;
    transition:
      border-color 0.15s ease-out,
      box-shadow 0.15s ease-out,
      background 0.15s ease-out;
  }

  .payment-agreement-checkbox {
    width: 14px;
    height: 14px;
    margin-top: 0;
  }

  .payment-agreement-text {
    line-height: 1.3;
    white-space: nowrap;
    margin-top: 0;
  }

  @media (max-width: 640px) {
    .payment-agreement-text {
      white-space: normal; /* allow wrapping on small screens */
    }
  }

  .payment-agreement.error .payment-agreement-label {
    border-color: #ef4444;
    box-shadow: 0 0 0 1px rgba(239, 68, 68, 0.45);
    background: linear-gradient(#fff5f5, #ffffff);
  }

  .terms-error {
    font-size: 11px;
    color: #b91c1c;
  }

  /* === CHECKOUT SECTION 2 GRID LAYOUT ================================== */

  .dates-grid{
    display:grid;
    grid-template-columns: 1fr 1fr;  /* split evenly */
    gap: 32px;
    align-items: start;
  }

  /* === SECTION 1: LINE ITEM CARD OUTLINE (subtle separation) === */
  .section-body[data-section-body="1"] .dates-grid{
    border: 1px solid rgba(15, 28, 46, 0.10);
    border-radius: 16px;
    padding: 14px;
    margin-bottom: 14px;
    background: linear-gradient(180deg, rgba(255, 106, 61, 0.03), rgba(255, 255, 255, 0));
  }

  .dates-right{
    display:flex;
    flex-direction:column;
    align-items:flex-end;     /* pin to right edge */
  }

  .dates-right .top-info-right{
    text-align:right;
  }

  .dates-right .top-info-right .card-header-link{
    color:#ff6a3d;            /* edit dates orange */
  }

  .dates-left .field-row {
    margin-bottom: 12px;
  }

  /* === CHECKOUT SECTION 1 (Room & Price) ROW LAYOUT ===================== */

  .room-plan-row{
    display:flex;
    align-items:flex-end;
    gap:12px;
    margin: 10px 0 14px 0;
  }

  .rp-col{ min-width: 0; }
  .rp-label{ font-size: 12px; color: var(--muted); margin-bottom: 4px; }
  .rp-value{ font-size: 13px; color: var(--text); }

  .rp-arrow, .rp-op{
    flex: 0 0 auto;
    color: var(--muted);
    font-weight: 600;
    line-height: 1;
    padding-bottom: 2px;
  }

  .room-price-row{
    display:flex;
    align-items:flex-end;
    gap:12px;
    margin: 6px 0 14px 0;
  }

  /* Row 2: center only the VALUES under the labels */
  .room-price-row .rp-value{
    text-align:center;
    width:100%;
  }

  .room-price-row .rp-col{
    display:flex;
    flex-direction:column;
    align-items: center;
  }
  .room-price-row .rp-label{
    align-self: flex-start;
  }
  .pill-outline{
    flex: 0 0 auto;
    padding: 8px 14px;
    border-radius: 9999px;
    border: 2px solid var(--bubble);
    background: #ffffff;
    color: var(--text);
    font-weight: 700;
    cursor: default;
  }

  .stay-confirm-row{
    margin-top: 14px;
    display:flex;
    align-items:center;
    justify-content:flex-end;
    gap:12px;
    width:100%;
  }

  .dates-right .stay-confirm-row{
    margin-top:auto;            /* push to bottom */
    width:100%;
    display:flex;
    justify-content:flex-end;   /* push button to right */
  }

  .stay-remove-row{
    margin-top: 10px;
    display:flex;
    justify-content:flex-start; /* bottom-left */
  }

  .stay-confirm-row .btn-primary{
    margin-left:auto;
  }

  #stayDatesInline{
    display:inline-block;
    white-space: nowrap;
  }

  /* Keep the confirm button from overlapping the dates */
  #confirmRoomPriceBtn{
    flex: 0 0 auto;
  }

  /* Top row: Property name (left) + Stay dates (right) */
  .top-info-row{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:16px;
    margin-bottom: 10px; /* controls space before the divider */
  }
  .top-info-left{ flex: 1 1 auto; min-width: 0; }

  /* Top-right stay dates + edit link: right aligned, but allow wrapping (no border bleed) */
  .top-info-right{
    display:flex;
    flex-direction:column;
    align-items:flex-end;
    text-align:right;
    max-width: 48%;
  }

  .top-info-right .field-label{
    text-align:right;
  }

  .top-info-right .field-value{
    text-align:right;
    color:#111;           /* darker value */
    font-weight:400;      /* not bold */
    max-width: 240px;     /* prevents pushing into the gutter */
    white-space: nowrap;  /* keep in one row */
    overflow-wrap: normal;
    word-break: normal;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* Dividers + padding between consolidated rows */
  .rp-stack{
    margin-top: 12px; /* space after top info row */
    padding-top: 5px;
    border-top: 1px solid rgba(255,106,61,0.22);
  }

  .rp-stack .room-plan-row{
    padding-top: 5px;
    padding-bottom: 18px; /* breathing room before the divider */
    border-bottom: 1px solid rgba(255,106,61,0.22);
  }

  .rp-stack .room-price-row{
    padding-top: 10px;
  }
  #confirmRoomPriceBtn{
    margin-top: 8px;
  }

  .dates-right .card-header-link {
    border: 0;
    background: transparent;
    color: var(--bubble);
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
  }

  #editDatesLink{
    color:#ff6a3d;
  }

  .checkout-dates-card-wrapper .detail-date-bar{
    width: 100%;
    padding: 12px 14px;
    border-radius: 18px;
    border: 1px solid var(--border);
    background: #ffffff;
    box-shadow: 0 4px 12px rgba(15,23,42,0.06);

    display: flex;
    flex-direction: column;   /* stack */
    align-items: stretch;     /* full width */
    gap: 10px;
  }

  /* hide old native date fields (keep them in DOM for your existing apply logic) */
  #checkout-date-bar .detail-date-field{
    display: none;
  }

  /* flatpickr driver stays invisible */
  .checkout-dates-driver{
    position: absolute;
    left: -9999px;
    width: 1px;
    height: 1px;
    opacity: 0;
    pointer-events: none;
  }

  /* the new â€œrange pillâ€ */
  .checkout-dates-display{
    flex: 1 1 auto;
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 10px 14px;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: #ffffff;
    cursor: pointer;
    font-size: 14px;
    color: var(--text);
    text-align: left;
    white-space: nowrap;
  }

  .checkout-dates-display:focus-visible{
    outline: 2px solid rgba(15,118,110,0.35);
    outline-offset: 2px;
  }

  .checkout-dates-display-icon{
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 22px;
  }

  /* keep the Update button aligned to the same row */
  #checkout-dates-apply{
    margin: 0;
    align-self: center;
    white-space: nowrap;
  }

  /* small screens: allow wrapping gracefully */
  @media (max-width: 760px){
    .checkout-dates-card-wrapper .detail-date-bar{
      flex-wrap: wrap;
    }
    #checkout-dates-apply{
      width: 100%;
    }
    .checkout-dates-display{
      width: 100%;
      justify-content: flex-start;
    }
  }

  #checkout-dates-driver{
    position:absolute;
    opacity:0;
    pointer-events:none;
    height:0;
    width:0;
  }

  /* === CHECKOUT DATE CARD (stacked) === */
  .checkout-dates-shell{
    display:flex;
    flex-direction:column;      /* stack vertically */
    align-items:flex-end;       /* align to right */
    gap:10px;
    width:100%;
    position:relative;
  }

  /* Ensure the pill and button are block-level and stack cleanly */
  #checkout-dates-display,
  #checkout-dates-apply{
    display:block;
  }

  /* Pill sizing stays consistent */
  .checkout-dates-display{
    width:100%;
    max-width:260px;
  }

  /* If anything inside the card was intercepting clicks, keep clicks enabled */
  .checkout-dates-shell *{
    pointer-events:auto;
  }

  /* One source of truth for Update button */
  #checkout-dates-apply{
    margin:0 !important;
    transform:none !important;
    align-self:flex-end;
    padding:6px 12px;
    border-radius:999px;
    border:1px solid var(--bubble);
    background:transparent;
    font-size:12px;
    font-weight:500;
    cursor:pointer;
    white-space:nowrap;
  }

  /* Driver input: hide without display:none so flatpickr can position properly */
  #checkout-dates-driver{
    position:absolute;
    opacity:0;
    pointer-events:none;
    height:0;
    width:0;
  }

  /* Keep the calendar anchored near the pill (not top-left) */
  .checkout-dates-shell .flatpickr-calendar{
    z-index: 9999;
  }

  /* collapse into 1 column on small screens */
  @media (max-width: 760px) {
    .dates-grid {
      grid-template-columns: 1fr;
    }

    .dates-right {
      align-items: flex-start;
    }
  }

</style>

</head>
<body>
  <div class="page">
		<header>
			<div class="checkout-header-wrapper" style="
				display:flex;
				align-items:center;
				justify-content:space-between;
				padding:16px 24px;
				border-bottom:1px solid var(--border);
				background:#ffffff;
			">
				
				<!-- LEFT: LOGO -->
				<div style="display:flex;align-items:center;gap:10px;">
					<a href="https://www.lolaelo.com/">
						<img
							src="https://www.lolaelo.com/logo.png?cb=logo-5x"
							alt="Lolaelo"
							decoding="async"
							loading="eager"
							style="display:block;height:24px;width:auto;"
						>
					</a>
				</div>

				<!-- CENTER: CHECKOUT TITLE -->
				<div style="
					flex:1;
					display:flex;
					justify-content:center;
					pointer-events:none;
					margin-left:-48px; /* counter logo width for true center */
				">
					<span style="
						font-size:20px;
						font-weight:600;
						color:#ff6a3d;
						letter-spacing:0.4px;
					">
						CHECKOUT
					</span>
				</div>

				<!-- RIGHT: STEP INDICATOR -->
				<div class="step-indicator" style="font-size:13px;color:var(--muted);white-space:nowrap;">
					Step 1 of 2 Â· Review and details
				</div>

			</div>
		</header>
    <main>
      <div class="layout">
        <!-- Left side: progressive sections -->
        <div>
          <!-- Section 1 - Room and Prices -->
          <div class="card" data-section="1">
            <div class="card-header">
              <div class="card-title">
                <div class="card-step active" data-step-indicator="1">1</div>
                Room & Price
              </div>
              <div class="card-status" data-step-status="1">
                Waiting for confirmation
              </div>
            </div>

            <div class="section-body" data-section-body="1">

              <!-- CONSOLIDATED TWO-COLUMN GRID (Left = Room/Price rows, Right = Dates editor card) -->
              <!-- ANCHOR: ROOM_PRICE_CARDS_ROOT -->
              <div id="roomPriceCardsRoot">
                <div class="dates-grid" id="roomPriceCardTemplate">

                <!-- LEFT COLUMN -->
                <div class="dates-left">

                  <div class="top-info-row">
                    <div class="top-info-left">
                      <div class="field-label">Property name</div>
                      <div class="field-value">
                        <div id="propertyName"></div>
                        <div class="muted" id="propertyMeta"></div>
                        <span id="propertyIdValue" style="display:none;"></span>
                      </div>
                    </div>
                  </div>

                  <!-- Row 1 (existing): Room -> Rate plan -> # of Rooms -->
                <div class="rp-stack">
                  <div class="room-plan-row">
                    <div class="rp-col">
                      <div class="rp-label">Room</div>
                      <div class="rp-value">
                        <span id="roomName"></span>
                        <span id="roomIdValue" style="display:none;"></span>
                      </div>
                    </div>

                    <div class="rp-arrow">â†’</div>

                    <div class="rp-col">
                      <div class="rp-label">Rate Plan</div>
                      <div class="rp-value">
                        <span id="ratePlanName"></span>
                        <span id="ratePlanIdValue" style="display:none;"></span>
                      </div>
                    </div>

                    <div class="rp-col">
                      <div class="rp-label"># of Rooms</div>
                      <div class="rp-value">
                        <span id="roomQty">1</span>
                      </div>
                    </div>
                  </div>

                  <!-- Row 2: nights x avg price = total -->
                  <div class="room-price-row">
                    <div class="rp-col">
                      <div class="rp-label">Nights</div>
                      <div class="rp-value">
                        <span id="stayNights">0</span>
                      </div>
                    </div>

                    <div class="rp-op">Ã—</div>

                    <div class="rp-col">
                      <div class="rp-label"># of Rooms</div>
                      <div class="rp-value">
                        <span id="roomQty">1</span>
                      </div>
                    </div>

                    <div class="rp-op">Ã—</div>

                    <div class="rp-col">
                      <div class="rp-label">Avg. Price/Night</div>
                      <div class="rp-value">
                        <span id="avgNightPrice">$0</span>
                      </div>
                    </div>

                    <div class="rp-op">=</div>

                    <button
                      type="button"
                      class="pill-outline"
                      id="totalPill"
                      aria-label="Total room price"
                    >
                      $0
                    </button>
                  </div>
                </div>

                <!-- Row 3: remove (confirm moved to right column) -->
                <div class="stay-remove-row">
                  <button
                    type="button"
                    class="card-header-link"
                    id="removeLineItemBtn"
                    data-remove-lineitem="1"
                  >
                    Remove line item
                  </button>
                </div>

                </div>
                <!-- END LEFT COLUMN -->

                <!-- RIGHT COLUMN: DATE CARD (preserved) -->
                <div class="dates-right">

                  <div class="top-info-right">
                    <div class="field-label">Stay dates</div>
                    <div class="field-value">
                      <span id="stayDatesInline"></span>
                    </div>

                    <!-- Edit dates link (shows the preserved date card on the right) -->
                    <button class="card-header-link" id="editDatesLink" type="button">
                      Edit dates
                    </button>
                  </div>

                  <div id="checkoutDatesCardWrapper" class="checkout-dates-card-wrapper hidden">

                    <div id="checkout-date-bar" class="detail-date-bar">
                      <input
                        type="text"
                        id="checkout-dates-driver"
                        class="checkout-dates-driver"
                        aria-hidden="true"
                      />

                      <button
                        type="button"
                        id="checkout-dates-display"
                        class="checkout-dates-display"
                        aria-label="Edit stay dates"
                      >
                        <span class="checkout-dates-display-icon">ðŸ“…</span>
                        <span id="checkout-dates-display-label">Select dates</span>
                      </button>

                      <label class="detail-date-field">
                        <span>Check in</span>
                        <input type="date" id="checkout-checkin" />
                      </label>

                      <label class="detail-date-field">
                        <span>Check out</span>
                        <input type="date" id="checkout-checkout" />
                      </label>

                      <button
                        id="checkout-dates-apply"
                        class="btn-outline"
                        style="
                          border: 2px solid #ff6a3d;
                          color: #ff6a3d;
                          padding: 6px 18px;
                          border-radius: 9999px;
                          background: #ffffff;
                          font-weight: 600;
                          font-size: 13px;
                          cursor: pointer;
                        "
                      >
                        Update dates
                      </button>

                    </div>
                  </div>
                </div>
                <!-- Row 3: confirm (moved to right column) -->
                  <div class="stay-confirm-row">
                    <button
                      type="button"
                      class="btn-primary"
                      id="confirmRoomPriceBtn"
                      data-confirm="1"
                    >
                      Confirm Room & Price
                    </button>
                  </div>
                <!-- END RIGHT COLUMN -->

              </div>
            </div>
           <!-- END GRID -->

            </div>
          </div>

          <!-- Section 2 - Add-ons -->
          <div class="card" data-section="2">
            <div class="card-header">
              <div class="card-title">
                <div class="card-step" data-step-indicator="2">2</div>
                ADD-ONs
              </div>
              <div class="card-status" data-step-status="2">
                Locked until previous step
              </div>
            </div>

            <div class="section-body hidden" data-section-body="2">
              <p class="section-intro">
                Optional activities and extras selected by your hotel.
              </p>

              <div
                class="addons-explore-row"
                style="text-align:center; margin-bottom:12px;"
              >
                <button
                  type="button"
                  class="addons-explore-pill"
                  data-open-addons-modal
                  style="
                    padding: 8px 24px;
                    border-radius: 9999px;
                    border: 2px solid #0a8a85;
                    background: #ffffff;
                    color: #0a8a85;
                    font-weight: 600;
                    font-size: 14px;
                    cursor: pointer;
                    display: inline-block;
                  "
                >
                  Explore ADD-ONs
                </button>
              </div>

              <!-- Inline summary list (populated from selected add-ons) -->
              <div
                id="addonsList"
                class="addons-inline-summary"
                style="display:none; margin-top:12px;"
              ></div>

              <!-- Default empty message if property has no activities configured -->
              <p id="addonsEmptyMessage" class="muted" style="margin-top:12px;">
                No add-ons are available for this stay.
              </p>

              <div
                class="addons-confirm-row"
                style="
                  margin-top:12px;
                  display:flex;
                  align-items:center;
                  justify-content:space-between;
                  gap:12px;
                "
              >
                <!-- Left: primary action -->
                <button class="btn-primary" type="button" data-confirm="2">
                  Confirm add-ons
                </button>

                <!-- Right: pill-style total -->
                <div
                  id="addonsInlineTotalWrapper"
                  class="addons-inline-total"
                  style="display:none; font-size:13px; color:#374151;"
                >
                  <span class="addons-inline-total-pill">
                    <span class="addons-inline-total-label">
                      Add-ons total:
                    </span>
                    <span
                      id="addonsInlineTotal"
                      class="addons-inline-total-amount"
                    >
                      --
                    </span>
                  </span>
                </div>
              </div>
            </div> <!-- end section-body 2 -->
          </div>   <!-- end card (Section 2) -->

          <!-- Section 3 - Guest details -->
          <div class="card" data-section="3">
            <div class="card-header">
              <div class="card-title">
                <div class="card-step" data-step-indicator="3">3</div>
                Guest details
              </div>
              <div class="card-status" data-step-status="3">
                Locked until previous step
              </div>
            </div>
            <div class="section-body hidden" data-section-body="3">
              <div class="guest-form-grid">
                <div>
                  <label for="firstName">First name</label>
                  <input id="firstName" autocomplete="given-name" />
                </div>
                <div>
                  <label for="lastName">Last name</label>
                  <input id="lastName" autocomplete="family-name" />
                </div>
                <div>
                  <label for="email">Email</label>
                  <input id="email" type="email" autocomplete="email" />
                </div>
                <div>
                  <label for="phone">Mobile number</label>
                  <div class="phone-row">
                    <select id="phoneCountry" class="phone-country">
                      <option value="+1">ðŸ‡ºðŸ‡¸ +1 (United States)</option>
                      <option value="+63">ðŸ‡µðŸ‡­ +63 (Philippines)</option>
                      <option value="+44">+44 (United Kingdom)</option>
                      <option value="+61">+61 (Australia)</option>
                      <option value="+65">+65 (Singapore)</option>
                      <option value="+81">+81 (Japan)</option>
                      <option value="+82">+82 (South Korea)</option>
                      <option value="+49">+49 (Germany)</option>
                      <option value="+33">+33 (France)</option>
                      <option value="+34">+34 (Spain)</option>
                      <option value="+39">+39 (Italy)</option>
                      <option value="+31">+31 (Netherlands)</option>
                      <option value="+63-other">Other</option>
                    </select>
                    <input
                      id="phone"
                      type="tel"
                      autocomplete="tel"
                      placeholder="9-digit mobile"
                      class="phone-input"
                    />
                  </div>
                </div>
              </div>

              <div style="margin-top: 10px;">
                <label for="specialRequests">
                  Special request to hotel management (optional)
                </label>
                <textarea id="specialRequests"></textarea>
              </div>

              <div class="error-text" id="guestError" style="display: none;">
                Please fill in all guest details and contact information.
              </div>

              <button class="btn-primary" type="button" data-confirm="3">
                Confirm guest details
              </button>
            </div>
          </div>

          <!-- Section 4 - Payment method -->
          <div class="card" data-section="4">
            <div class="card-header">
              <div class="card-title">
                <div class="card-step" data-step-indicator="4">4</div>
                Payment method
              </div>
              <div class="card-status" data-step-status="4">
                Locked until previous step
              </div>
            </div>

            <div class="section-body hidden" data-section-body="4">
              <div class="field-row">
                
                <!-- TOP ROW: PAYMENT PILLS -->
                <div class="field-inline payment-options-row">
                  <!-- CARD / STRIPE -->
                  <div class="pill-wrap">
                    <div class="pill-caption">
                      Stripe â€“ Major CCs
                    </div>
                    <label class="pill-wrap-label">
                      <input
                        type="radio"
                        name="paymentMethod"
                        value="card"
                        class="payment-pill-input"
                        checked
                      />
                      <div class="pill">
                        <div class="pill-main">
                          <div class="card-logos">
														<img
															src="https://www.lolaelo.com/assets/card_visa.png"
															alt="Visa, Mastercard, Apple Pay, Discover, Amex"
															class="card-logo-ticker"
														/>
                          </div>
                        </div>
                      </div>
                    </label>
                  </div>

                  <!-- PAYPAL -->
                  <div class="pill-wrap">
                    <div class="pill-caption">
                      (coming soon)
                    </div>
                    <label class="pill-wrap-label">
                      <input
                        type="radio"
                        name="paymentMethod"
                        value="paypal"
                        class="payment-pill-input"
                        disabled
                      />
                      <div class="pill">
                        <div class="pill-main">
                          <img
                            src="https://www.lolaelo.com/assets/paypal.png"
                            alt="PayPal"
                          >
                        </div>
                      </div>
                    </label>
                  </div>

                  <!-- GCASH -->
                  <div class="pill-wrap">
                    <div class="pill-caption">
                      (coming soon)
                    </div>
                    <label class="pill-wrap-label">
                      <input
                        type="radio"
                        name="paymentMethod"
                        value="gcash"
                        class="payment-pill-input"
                        disabled
                      />
                      <div class="pill">
                        <div class="pill-main">
                          <img
                            src="https://www.lolaelo.com/assets/gcash.png"
                            alt="GCash"
                          >
                        </div>
                      </div>
                    </label>
                  </div>
                </div>

                <!-- BOTTOM ROW: TEXT CAPTIONS UNDER PILLS -->
                <div class="field-inline payment-options-row" style="margin-top: 6px;">
                  <div style="min-width:190px;text-align:center;font-size:12px;color:#6b7280;">
                    <div>Visa â€“ MasterCard â€“ AMEX</div>
                    <div>ApplePay â€“ Discover</div>
                  </div>
                  <div style="min-width:190px;text-align:center;font-size:12px;color:#6b7280;">
                    PayPal
                  </div>
                  <div style="min-width:190px;text-align:center;font-size:12px;color:#6b7280;">
                    GCash
                  </div>
                </div>
              </div>

              <!-- SECURITY ICON + CONFIRM BUTTON + AGREEMENT -->
              <div style="display:flex; align-items:center; justify-content:flex-start; gap:14px; margin-top:16px; position:relative;">

                <!-- Confirm button -->
                <button class="btn-primary" type="button" data-confirm="4">
                  Proceed to secure payment
                </button>

                <!-- Security icon + bubble -->
                <div class="payment-security" style="position:relative;">
                  <button
                    class="security-icon-btn"
                    type="button"
                    aria-label="Security and payments"
                  >
                    ðŸ”’
                  </button>

                  <div class="security-bubble">
                    <strong>Secure checkout</strong>
                    Your payment is encrypted and processed by Stripe, the same
                    provider trusted by companies like Lyft and Airbnb.
                    Future options like PayPal and GCash will follow the same
                    security standards so your card details never touch our servers.
                  </div>
                </div>

                <!-- Terms / Privacy agreement -->
                <div class="payment-agreement">
                  <label class="payment-agreement-label" for="termsCheckbox">
                    <input
                      id="termsCheckbox"
                      type="checkbox"
                      class="payment-agreement-checkbox"
                    />
                    <span class="payment-agreement-text">
                      I agree to Lolaeloâ€™s
                      <a href="/public/terms.html" target="_blank" style="color:#0f766e; text-decoration:none;">
                        Terms of Use</a>
                       and
                      <a href="/public/privacy.html" target="_blank" style="color:#0f766e; text-decoration:none;">
                        Privacy Policy</a>.
                  </span>
                  </label>
                  <div id="termsError" class="terms-error" style="display:none;">
                    Agreement to the Terms of Use and Privacy Policy is required to continue.
                  </div>
                </div>
              </div>
						</div>
					</div>
				</div>

				<!-- Right side: booking summary -->
        <aside>

          <div class="card">
            <div class="summary-card-title">Your stay</div>

            <div class="summary-line" style="margin-bottom:12px;">
              <span>Property Name</span>
              <strong id="summaryProperty">Property</strong>
            </div>

            <!-- Room type hidden but intact for JS -->
            <div class="summary-line" style="display:none;">
              <span>Room type</span>
              <strong id="summaryRoom">Room</strong>
            </div>

            <!-- Rate plan hidden but intact for JS -->
            <div class="summary-line" style="display:none;">
              <span>Rate plan</span>
              <strong id="summaryPlan">Rate plan</strong>
            </div>

            <div class="summary-line" style="margin-bottom:12px;">
              <span>Dates</span>
              <strong id="summaryDates">Dates</strong>
            </div>

            <div class="summary-line" style="margin-bottom:6px;">
              <span># of Rooms</span>
              <strong id="summaryRooms">--</strong>
            </div>

            <div class="summary-line" style="margin-bottom:14px;">
              <span># of Nights</span>
              <strong id="summaryNightsVisible">--</strong>
            </div>

            <div class="summary-line" style="margin-bottom:14px;">
              <span>ADD-ONs</span>
              <strong id="summaryAddons">None selected</strong>
            </div>

            <hr style="border:0;border-top:1px solid #e5e5e5;margin:10px 0;">

            <div class="summary-total">
              <div>
                <div class="summary-total-label">Total</div>
              </div>
              <div class="summary-total-amount" id="summaryTotal">
                --
              </div>
            </div>

            <div class="breakdown-toggle" id="breakdownToggle">
              View detailed breakdown
            </div>
            <div class="breakdown" id="breakdownDetails">
            </div>

          </div>

        </aside>

      <div class="sticky-footer">
        <div class="sticky-inner">
          <div>

          </div>
            <button class="sticky-button" id="confirmAndPayButton" disabled>
              Proceed to secure payment
            </button>
        </div>
      </div>
    </main>
  </div>

  <script>
    function parseQuery() {
      const params = new URLSearchParams(window.location.search);

      // Raw value from URL
      const fromUrl = params.get("propertyId") || "";

      // Fallback from localStorage if URL is missing it
      let fromStorage = "";
      try {
        fromStorage = localStorage.getItem("checkout.lastPropertyId") || "";
      } catch (_) {
        fromStorage = "";
      }

      const propertyId = fromUrl || fromStorage;

      // --- qty: URL first, then durable fallback (checkout.selection.v1) ---
      const roomIdStr = params.get("roomId") || "";
      const planIdStr = params.get("ratePlanId") || params.get("plan") || "";
      let qtyStr = params.get("qty") || "";

      if (!qtyStr) {
        try {
          const raw = localStorage.getItem("checkout.selection.v1") || "";
          const sel = raw ? JSON.parse(raw) : null;

          const items = sel && Array.isArray(sel.items) ? sel.items : [];
          const roomIdNum = Number(roomIdStr);
          const planIdNum = Number(planIdStr);

          const hit = items.find(it => {
            const r = Number(it && (it.roomTypeId != null ? it.roomTypeId : it.roomId));
            const p = Number(it && (it.ratePlanId != null ? it.ratePlanId : it.planId));
            return Number.isFinite(r) && Number.isFinite(p) && r === roomIdNum && p === planIdNum;
          });

          if (hit && hit.qty != null) qtyStr = String(hit.qty);
        } catch (_) {}
      }

      return {
        propertyId,
        roomId: roomIdStr,
        start: params.get("start") || "",
        end: params.get("end") || "",

        // IDs
        ratePlanId: planIdStr,

        // Optional name fields (can be populated from catalog_details)
        propertyName: params.get("propertyName") || "",
        propertyLocation: params.get("propertyLocation") || "",
        roomName: params.get("roomName") || "",

        // NEW: qty
        qty: qtyStr || "1",

        // Rate plan display name â€“ prefer explicit name, fall back to planLabel
        ratePlanName:
          params.get("ratePlanName") ||
          params.get("planLabel") ||
          ""
      };
    }

    // =========================
    // CART v1 (Secondary Sprint)
    // =========================
    const CART_KEY = "checkout.cart.v1";
    const SELECTION_KEY = "checkout.selection.v1";

    function safeJsonParse(raw) {
      try { return raw ? JSON.parse(raw) : null; } catch (_) { return null; }
    }

    function loadCartV1() {
      try {
        return safeJsonParse(localStorage.getItem(CART_KEY) || "");
      } catch (_) {
        return null;
      }
    }

    function coalesceQueryFromCart(q) {
      const qq = Object.assign({}, q || {});
      const cart = loadCartV1();
      const items = cart && Array.isArray(cart.items) ? cart.items : [];
      if (!items.length) return { q: qq, cart: null, active: null };

      // Active item = try match the URL selection first; otherwise fall back to first item
      let active = null;

      const wantPid   = qq.propertyId ? String(qq.propertyId) : "";
      const wantRoom  = qq.roomId ? String(qq.roomId) : "";
      const wantPlan  = qq.ratePlanId ? String(qq.ratePlanId) : "";
      const wantStart = qq.start ? String(qq.start) : "";
      const wantEnd   = qq.end ? String(qq.end) : "";

      active =
        items.find(it => {
          if (!it) return false;
          const pid  = it.propertyId != null ? String(it.propertyId) : "";
          const rid  = it.roomTypeId != null ? String(it.roomTypeId) : "";
          const plan = it.ratePlanId != null ? String(it.ratePlanId) : "";
          const s    = it.start != null ? String(it.start) : "";
          const e    = it.end != null ? String(it.end) : "";

          // Match the strongest signals first (pid + room + plan). Dates help when provided.
          if (wantPid && pid !== wantPid) return false;
          if (wantRoom && rid !== wantRoom) return false;
          if (wantPlan && plan !== wantPlan) return false;

          // If the URL includes dates, enforce them too.
          if (wantStart && s !== wantStart) return false;
          if (wantEnd && e !== wantEnd) return false;

          return true;
        }) || null;

      // If no exact match, prefer the most recently added item (cart-like behavior)
      if (!active) active = items[items.length - 1];

      // Fill missing query fields from cart (do not override URL when present)
      if (!qq.propertyId && active.propertyId != null) qq.propertyId = String(active.propertyId);
      if (!qq.roomId     && active.roomTypeId != null) qq.roomId = String(active.roomTypeId);
      if (!qq.ratePlanId && active.ratePlanId != null) qq.ratePlanId = String(active.ratePlanId);
      if ((!qq.qty || Number(qq.qty) <= 0) && active.qty != null) qq.qty = String(active.qty);

      if (!qq.start && active.start) qq.start = String(active.start);
      if (!qq.end   && active.end)   qq.end   = String(active.end);

      if (!qq.propertyName && active.propertyName) qq.propertyName = String(active.propertyName);
      if (!qq.propertyLocation && active.propertyLocation) qq.propertyLocation = String(active.propertyLocation);
      if (!qq.roomName && active.roomName) qq.roomName = String(active.roomName);
      if (!qq.ratePlanName && active.planLabel) qq.ratePlanName = String(active.planLabel);

      return { q: qq, cart, active };
    }

    function saveCartV1(cart) {
      try {
        localStorage.setItem(CART_KEY, JSON.stringify(cart));
        return true;
      } catch (_) {
        return false;
      }
    }

    function buildCartFromCurrentQuery(q) {
      const nowIso = new Date().toISOString();
      const lineId =
        "ln_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2, 8);

      return {
        version: 1,
        createdAt: nowIso,
        itinerary: {
          policy: "continuous_or_adjacent",
          currency: "PHP"
        },
        items: [
          {
            lineId,
            propertyId: q.propertyId || "",
            propertyName: q.propertyName || "",
            propertyLocation: q.propertyLocation || "",
            roomTypeId: q.roomId || "",
            roomName: q.roomName || "",
            ratePlanId: q.ratePlanId || "",
            planLabel: q.ratePlanName || "",
            qty: Number(q.qty || 1) || 1,
            start: q.start || "",
            end: q.end || ""
          }
        ]
      };
    }

    function migrateSelectionToCartIfNeeded(q) {
      // If cart already exists, do nothing.
      const existingCart = loadCartV1();
      if (existingCart && existingCart.version === 1 && Array.isArray(existingCart.items)) {
        return existingCart;
      }

      // If selection exists, create a cart (do not delete selection yet).
      let sel = null;
      try {
        sel = safeJsonParse(localStorage.getItem(SELECTION_KEY) || "");
      } catch (_) {
        sel = null;
      }
      if (!sel) return null;

      // Minimal migration: create cart from current query fields (stable + already in use today).
      const cart = buildCartFromCurrentQuery(q);
      saveCartV1(cart);
      return cart;
    }

    // Treat YYYY-MM-DD as a plain calendar date (no timezone)
    function parseLocalYMD(dateStr) {
      if (!dateStr) return null;
      const parts = dateStr.split("-");
      if (parts.length !== 3) return null;

      const year  = Number(parts[0]);
      const month = Number(parts[1]); // 1â€“12
      const day   = Number(parts[2]);

      if (!year || !month || !day) return null;
      const d = new Date(year, month - 1, day); // local midnight
      if (Number.isNaN(d.getTime())) return null;
      return d;
    }

    function formatDate(dateStr) {
      const d = parseLocalYMD(dateStr);
      if (!d) return "";
      return d.toLocaleDateString(undefined, {
        year: "numeric",
        month: "short",
        day: "numeric"
      });
    }

    function diffNights(startStr, endStr) {
      const s = parseLocalYMD(startStr);
      const e = parseLocalYMD(endStr);
      if (!s || !e) return "";

      const ms = e.getTime() - s.getTime();
      const nights = Math.round(ms / (1000 * 60 * 60 * 24));
      return nights > 0 ? nights : "";
    }

    function formatCurrency(amount, currency) {
      const num = Number(amount);
      if (!Number.isFinite(num)) return "";

      const cur = currency || "USD";
      try {
        return new Intl.NumberFormat("en-US", {
          style: "currency",
          currency: cur,
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        }).format(num);
      } catch (_) {
        return "$" + num.toFixed(2);
      }
    }

    function renderNightlyBreakdown(nightsArr, currency) {
      const container = document.getElementById("breakdownDetails");
      if (!container) return;

      const s = (typeof state === "object" && state) ? state : {};
      const cur = currency || s.pricingCurrency || "USD";

      const parts = [];

      // 1) Nightly rows (existing behavior)
      if (Array.isArray(nightsArr) && nightsArr.length > 0) {
        nightsArr.forEach(function (n) {
          const dateStr = n.date || n.dt || n.day || "";
          const label = formatDate(dateStr) || dateStr;

          const amtNum = Number(
            n.amount !== undefined ? n.amount :
            n.price  !== undefined ? n.price  :
            n.value  !== undefined ? n.value  : 0
          );
          const amtText = formatCurrency(amtNum, cur);

          const qn = Math.max(1, Number.parseInt(String(s.qty || state.qty || 1), 10) || 1);

          parts.push(
            '<div class="breakdown-line">' +
              '<span>' + label + '</span>' +
              (qn > 1 ? ('<span class="bd-rooms">x ' + qn + ' rooms</span>') : '') +
              '<span>' + amtText + '</span>' +
            '</div>'
          );
        });
      }

      // 2) Add-ons section (if any)
      const addons = Array.isArray(s.selectedAddons) ? s.selectedAddons : [];
      const addonsSubtotalNum = Number(s.addonsSubtotal || 0);

      if (addons.length && Number.isFinite(addonsSubtotalNum) && addonsSubtotalNum > 0) {
      // Header row for add-ons
      // Insert Stay Total (sum of nightly base room amounts)
      const stayTotalNum = Array.isArray(nightsArr)
        ? nightsArr.reduce((sum, n) => {
            const amt = Number(
              n.amount !== undefined ? n.amount :
              n.price  !== undefined ? n.price  :
              n.value  !== undefined ? n.value  : 0
            );
            return sum + (Number.isFinite(amt) ? amt : 0);
          }, 0)
        : 0;

        parts.push(
          '<div class="breakdown-line" style="margin-top:6px;font-weight:700;font-size:1.05rem;">' +
            '<span style="font-size:1.05rem;">Stay total</span>' +
            '<span style="font-size:1.05rem;">' + formatCurrency(stayTotalNum, cur) + '</span>' +
          '</div>'
        );

        // Spacer between Stay total and first add-on line
        parts.push('<div class="breakdown-line" style="height:6px;"></div>');

        addons.forEach(function (item) {
          if (!item) return;

          const qty = Number(item.quantity || item.qty || 0);
          const lineTotalNum = Number(item.lineTotal || item.total || 0);
          if (!qty || !Number.isFinite(lineTotalNum)) return;

          const name = (item.activity || item.name || "Add-on").toString();
          const label = name + " Â· Qty " + qty;
          const amtText = formatCurrency(lineTotalNum, cur);

          const left = label;

          parts.push(
            '<div class="breakdown-line">' +
              '<span>' + left + '</span>' +
              '<span>' + amtText + '</span>' +
            '</div>'
          );
        });

        // Add-ons total row
        parts.push(
          '<div class="breakdown-line" style="font-weight:700;font-size:1.05rem;margin-top:4px;">' +
            '<span style="font-size:1.05rem;">Add-ons total</span>' +
            '<span style="font-size:1.05rem;">' + formatCurrency(addonsSubtotalNum, cur) + '</span>' +
          '</div>'
        );
      }

      if (!parts.length) {
        container.innerHTML = "";
        return;
      }

      container.innerHTML = parts.join("");
    }

    function renderAddons(addons) {
      const listEl =
        document.getElementById("addonsModalList") ||
        document.getElementById("addonsList");
      const modalBody = document.getElementById("addonsModalBody");
      const emptyEl = document.getElementById("addonsEmptyMessage");

      // Prefer the modal body as the primary container; fall back to the inline list
      const root = modalBody || listEl;
      if (!root) return;

      // Clear all possible containers so we donâ€™t have stale rows
      root.innerHTML = "";
      if (modalBody && modalBody !== root) modalBody.innerHTML = "";
      if (listEl && listEl !== root) listEl.innerHTML = "";

      const rows = Array.isArray(addons) ? addons : [];
      if (!rows.length) {
        if (emptyEl) {
          emptyEl.textContent = "No add-ons are available for this stay.";
          emptyEl.classList.remove("hidden");
        }
        return;
      }

      if (emptyEl) {
        emptyEl.classList.add("hidden");
      }

      // header row
      const header = document.createElement("div");
      header.className = "addon-row";
      header.style.fontWeight = "600";

      const hMain = document.createElement("div");
      hMain.className = "addon-main";
      const hTitle = document.createElement("div");
      hTitle.className = "addon-title";
      hTitle.textContent = "Activity";
      const hMeta = document.createElement("div");
      hMeta.className = "addon-meta";
      hMeta.textContent = "Price Â· Unit Â· Hotel notes";
      hMain.appendChild(hTitle);
      hMain.appendChild(hMeta);

      const hSide = document.createElement("div");
      hSide.className = "addon-side";
      const hQty = document.createElement("div");
      hQty.textContent = "Qty";
      const hLine = document.createElement("div");
      hLine.textContent = "Line total";
      hSide.appendChild(hQty);
      hSide.appendChild(hLine);

      header.appendChild(hMain);
      header.appendChild(hSide);
      root.appendChild(header);

      // Ensure we have a selections map on state
      if (!state.addonsSelections) state.addonsSelections = {};

      rows.forEach(function (addon, idx) {
        const activity = (addon.activity || "").toString().trim();
        const uom = (addon.uom || "").toString().trim();
        const price =
          addon.price === null || addon.price === undefined
            ? null
            : Number(addon.price);
        const notes = (addon.notes || "").toString().trim();

        const row = document.createElement("div");
        row.className = "addon-row";

        const main = document.createElement("div");
        main.className = "addon-main";

        const title = document.createElement("div");
        title.className = "addon-title";
        title.textContent = activity || "Activity";

        const meta = document.createElement("div");
        meta.className = "addon-meta";

        const priceStr =
          price !== null && Number.isFinite(price)
            ? new Intl.NumberFormat("en-US", {
                style: "currency",
                currency: "USD",
              }).format(price)
            : "Price on request";

        const bits = [];
        bits.push(priceStr);
        if (uom) bits.push(uom);
        if (notes) bits.push(notes);
        meta.textContent = bits.join(" Â· ");

        main.appendChild(title);
        main.appendChild(meta);

        const side = document.createElement("div");
        side.className = "addon-side";

        const key = String(idx);
        const currentQty = state.addonsSelections[key] || 0;

        const qtyWrap = document.createElement("div");
        qtyWrap.style.display = "flex";
        qtyWrap.style.flexDirection = "column";
        qtyWrap.style.gap = "4px";

        const qtyLabel = document.createElement("label");
        qtyLabel.textContent = "Qty";

        const qtyInput = document.createElement("input");
        qtyInput.type = "number";
        qtyInput.min = "0";
        qtyInput.step = "1";
        qtyInput.value =
          typeof currentQty === "number" && currentQty > 0
            ? String(currentQty)
            : "0";
        qtyInput.setAttribute("data-addon-index", String(idx));
        qtyInput.className = "addon-qty-input";

        const lineTotal = document.createElement("div");
        lineTotal.className = "addon-line-total";

        function updateLineTotal() {
          const qtyVal = parseInt(qtyInput.value, 10);
          if (isNaN(qtyVal) || qtyVal <= 0 || price === null || !Number.isFinite(price)) {
            lineTotal.textContent = "";
            return;
          }
          const total = qtyVal * price;
          lineTotal.textContent = new Intl.NumberFormat("en-US", {
            style: "currency",
            currency: "USD",
          }).format(total);
        }

        qtyInput.addEventListener("input", function () {
          const val = parseInt(qtyInput.value, 10);
          if (isNaN(val) || val <= 0) {
            delete state.addonsSelections[key];
          } else {
            state.addonsSelections[key] = val;
          }
          updateLineTotal();
          updateAddonsSummary();
        });

        updateLineTotal();

        qtyWrap.appendChild(qtyLabel);
        qtyWrap.appendChild(qtyInput);

        side.appendChild(qtyWrap);
        side.appendChild(lineTotal);

        row.appendChild(main);
        row.appendChild(side);

        const comment = document.createElement("textarea");
        comment.rows = 2;
        comment.placeholder = "Comments for hotel (optional)";
        comment.className = "addon-comment";
        comment.setAttribute("data-addon-index", String(idx));

        const wrapper = document.createElement("div");
        wrapper.style.display = "flex";
        wrapper.style.flexDirection = "column";
        wrapper.style.gap = "4px";

        wrapper.appendChild(row);
        wrapper.appendChild(comment);

        root.appendChild(wrapper);
      });
    }

    function renderAddonsInlineSummary(subtotalOverride) {
      const listEl       = document.getElementById("addonsList");
      const totalWrapper = document.getElementById("addonsInlineTotalWrapper");
      const totalSpan    = document.getElementById("addonsInlineTotal");

      if (!listEl) return;

      const selections = Array.isArray(state.selectedAddons)
        ? state.selectedAddons.filter(function (s) {
            const q = Number(s.quantity || 0);
            return q > 0;
          })
        : [];

      const cur = state.pricingCurrency || "USD";

      listEl.innerHTML = "";

      if (!selections.length) {
        listEl.style.display = "none";
        if (totalWrapper) totalWrapper.style.display = "none";
        if (totalSpan) totalSpan.textContent = "--";
        return;
      }

      listEl.style.display = "block";

      const ul = document.createElement("ul");
      ul.style.listStyle = "none";
      ul.style.padding = "0";
      ul.style.margin = "0";

      let subtotal = 0;

      selections.forEach(function (sel) {
        const li = document.createElement("li");
        li.style.display = "flex";
        li.style.justifyContent = "space-between";
        li.style.alignItems = "baseline";
        li.style.fontSize = "13px";
        li.style.marginBottom = "4px";

        const left = document.createElement("span");
        left.textContent =
          (sel.activity || "Add-on") +
          " Â· Qty " +
          (sel.quantity != null ? sel.quantity : 0);

        const right = document.createElement("span");
        const lt = Number(sel.lineTotal);
        if (Number.isFinite(lt) && lt > 0) {
          right.textContent = formatCurrency(lt, cur);
          subtotal += lt;
        } else {
          right.textContent = "--";
        }

        li.appendChild(left);
        li.appendChild(right);
        ul.appendChild(li);
      });

      listEl.appendChild(ul);

      const finalSubtotal =
        typeof subtotalOverride === "number" && subtotalOverride > 0
          ? subtotalOverride
          : subtotal;

      if (totalSpan) {
        totalSpan.textContent =
          finalSubtotal > 0 ? formatCurrency(finalSubtotal, cur) : "--";
      }
      if (totalWrapper) {
        totalWrapper.style.display = finalSubtotal > 0 ? "block" : "none";
      }
    }

    function recomputeSelectedAddons() {
      const modalBody = document.getElementById("addonsModalBody");
      const listEl    = document.getElementById("addonsList");

      // Use the same root container as renderAddons:
      // prefer modal body, fall back to inline list.
      const root = modalBody || listEl;
      if (!root) return;

      const qtyInputs = root.querySelectorAll(
        'input[type="number"][data-addon-index]'
      );
      const commentAreas = root.querySelectorAll(
        'textarea.addon-comment[data-addon-index]'
      );

      const commentsByIndex = {};
      commentAreas.forEach(function (ta) {
        const idxAttr = ta.getAttribute("data-addon-index");
        const idx = Number(idxAttr);
        if (!Number.isFinite(idx) || idx < 0) return;
        commentsByIndex[idx] = ta.value || "";
      });

      const selections    = [];
      const selectionsMap = {};
      let subtotal        = 0;

      qtyInputs.forEach(function (input) {
        const idxAttr = input.getAttribute("data-addon-index");
        const idx = Number(idxAttr);
        if (!Number.isFinite(idx) || idx < 0) return;

        const qty = Number(input.value || "0");
        if (!Number.isFinite(qty) || qty <= 0) {
          return;
        }

        const cfg = Array.isArray(state.addonsConfig)
          ? state.addonsConfig[idx]
          : null;
        if (!cfg) return;

        const rawPrice = cfg.price;
        const price =
          typeof rawPrice === "number"
            ? rawPrice
            : (rawPrice != null ? Number(rawPrice) : NaN);

        const lineTotal =
          !Number.isNaN(price) && Number.isFinite(price)
            ? price * qty
            : null;

        selections.push({
          index: idx,
          quantity: qty,
          activity: (cfg.activity || "").toString().trim(),
          uom: (cfg.uom || "").toString().trim(),
          price: !Number.isNaN(price) && Number.isFinite(price) ? price : null,
          lineTotal,
          travelerComment: commentsByIndex[idx] || ""
        });

        selectionsMap[idx] = qty;
        if (lineTotal != null && Number.isFinite(lineTotal)) {
          subtotal += lineTotal;
        }
      });

      state.selectedAddons   = selections;
      state.addonsSelections = selectionsMap;
      state.addonsSubtotal   = subtotal;          // <-- store add-ons subtotal

      const subtotalEl = document.getElementById("addonsModalSubtotal");
      if (subtotalEl) {
        if (subtotal > 0) {
          const cur = state.pricingCurrency || "USD";
          subtotalEl.textContent = formatCurrency(subtotal, cur);
        } else {
          subtotalEl.textContent = "--";
        }
      }

      // Inline summary under Section 3 (between Explore and Confirm)
      renderAddonsInlineSummary(subtotal);

      // Update final grand total (base + add-ons)
      updateGrandTotal();

      // Also refresh main summaries (Your stay)
      updateSummaries();
      updateAddonsSummary();

      // Refresh right-hand breakdown so it includes add-ons
      if (Array.isArray(state.pricingNights) && state.pricingNights.length) {
        renderNightlyBreakdown(
          state.pricingNights,
          state.pricingCurrency || "USD"
        );
      }
    }

    function updateGrandTotal() {
      const totalEl = document.getElementById("summaryTotal");
      if (!totalEl) return;

      const currency = state.pricingCurrency || "USD";

      // Prefer the rate-planâ€“adjusted total from applyCheckoutQuote,
      // fall back to baseRoomTotal only if needed.
      let base = 0;

      if (typeof state.pricingTotal === "number" &&
          Number.isFinite(state.pricingTotal) &&
          state.pricingTotal > 0) {
        base = state.pricingTotal;
      } else if (typeof state.baseRoomTotal === "number" &&
                Number.isFinite(state.baseRoomTotal) &&
                state.baseRoomTotal > 0) {
        // baseRoomTotal was captured before qty scaling; apply qty here for safety
        const qn = Math.max(1, Number.parseInt(String(state.qty || 1), 10) || 1);
        base = state.baseRoomTotal * qn;
      }

      const addons = Number(state.addonsSubtotal || 0);

      // If we don't yet have a meaningful base, don't overwrite placeholder
      if (!Number.isFinite(base) || base <= 0) return;

      const grand = base + (Number.isFinite(addons) ? addons : 0);
      totalEl.textContent = formatCurrency(grand, currency);
    }

    const state = {
      propertyId: "",
      roomId: "",
      qty: 1,
      start: "",
      end: "",
      ratePlanId: "",
      propertyName: "",
      propertyLocation: "",
      roomName: "",
      ratePlanName: "",
      sectionConfirmed: { 1: false, 2: false, 3: false, 4: false },
      addonsConfig: [],
      addonsSelections: {},

      // Pricing / quote from /catalog/details
      pricingTotal: 0,
      pricingCurrency: "USD",
      pricingNights: [] // [{ date, amount }, ...]
    };

    function updateSummaries() {
      const propertyText =
        state.propertyName || state.propertyId || "Property";
      const propertyMeta = state.propertyLocation || "";
      const roomText =
        state.roomName || state.roomId || "Room";
      const planText =
        state.ratePlanName || state.ratePlanId || "Rate plan";

      // Compute dates/nights FIRST (prevents ReferenceError)
      const startFormatted = formatDate(state.start);
      const endFormatted   = formatDate(state.end);
      const nights         = diffNights(state.start, state.end);

      const datesText =
        startFormatted && endFormatted
          ? startFormatted + " to " + endFormatted
          : "";

      // Hidden IDs
      const propIdEl = document.getElementById("propertyIdValue");
      if (propIdEl) propIdEl.textContent = state.propertyId;
      const roomIdEl = document.getElementById("roomIdValue");
      if (roomIdEl) roomIdEl.textContent = state.roomId;
      const planIdEl = document.getElementById("ratePlanIdValue");
      if (planIdEl) planIdEl.textContent = state.ratePlanId;

      // Visible labels in Section 1
      const propNameEl = document.getElementById("propertyName");
      if (propNameEl) propNameEl.textContent = propertyText;
      const propMetaEl = document.getElementById("propertyMeta");
      if (propMetaEl) propMetaEl.textContent = propertyMeta;

      const qn = Math.max(1, Number.parseInt(String(state.qty || 1), 10) || 1);

      const roomNameEl = document.getElementById("roomName");
      if (roomNameEl) roomNameEl.textContent = roomText;

      const planNameEl = document.getElementById("ratePlanName");
      if (planNameEl) planNameEl.textContent = planText;

      const qtyEl = document.getElementById("roomQty");
      if (qtyEl) qtyEl.textContent = String(qn);

      // Row 2 + stay dates
      const nightsEl = document.getElementById("stayNights");
      if (nightsEl) nightsEl.textContent = String(nights || 0);

      const stayInline = document.getElementById("stayDatesInline");
      if (stayInline) stayInline.textContent = datesText;

      // Avg price + total pill (use formatCurrency, NOT money())
      const cur = state.pricingCurrency || "USD";
      const total = Number(state.pricingTotal || 0); // qty-adjusted total

      const avgEl = document.getElementById("avgNightPrice");
      if (avgEl) {
        const nn = Math.max(1, Number(nights || 0));
        const qq = Math.max(1, Number(qn || 1));
        const avg = total > 0 ? (total / qq / nn) : 0;
        avgEl.textContent = formatCurrency(avg, cur);
      }

      const totalPill = document.getElementById("totalPill");
      if (totalPill) totalPill.textContent = formatCurrency(total, cur);

      // Summary card on the right
      const sp = document.getElementById("summaryProperty");
      if (sp) sp.textContent = propertyText;
      const sr = document.getElementById("summaryRoom");
      if (sr) sr.textContent = qn === 1 ? roomText : `${roomText} Â· ${qn} rooms`;
      const spl = document.getElementById("summaryPlan");
      if (spl) spl.textContent = planText;

      const sd = document.getElementById("summaryDates");
      if (sd) sd.textContent = datesText || "Dates";

      const nightsText =
        nights ? nights + " night" + (nights > 1 ? "s" : "") : "";
      const srooms = document.getElementById("summaryRooms");
      if (srooms) srooms.textContent = (qn === 1) ? "1 room" : `${qn} rooms`;

      const sn = document.getElementById("summaryNights");
      if (sn) sn.textContent = nightsText || "--";

      // Avg. price per night in Section 2 + total pill
      const nightlyEl = document.getElementById("nightlyPriceText");
      const nightlyCaptionEl = document.getElementById("nightlyPriceCaption");
      const totalPillSpan = document.getElementById("priceTotalText");

      // Read current Total text from summary card
      const summaryTotalEl = document.getElementById("summaryTotal");
      const rawSummaryText = summaryTotalEl
        ? (summaryTotalEl.textContent || "")
        : "";
      const parsedFromSummary = Number(
        String(rawSummaryText).replace(/[^0-9.]/g, "")
      );

      // Prefer total from quote, fall back to parsed summary total
      let effectiveTotal = 0;
      if (typeof state.pricingTotal === "number" && state.pricingTotal > 0) {
        effectiveTotal = state.pricingTotal;
      } else if (!Number.isNaN(parsedFromSummary) && parsedFromSummary > 0) {
        effectiveTotal = parsedFromSummary;
      }

      // Keep pill text in sync with summary total display
      if (totalPillSpan && rawSummaryText.trim()) {
        totalPillSpan.textContent = rawSummaryText.trim();
      }

      // Compute and show *average* price per night
      if (nightlyEl) {
        if (effectiveTotal > 0 && nightsNum > 0) {
          const perNight = effectiveTotal / nightsNum;
          nightlyEl.textContent = "$" + perNight.toFixed(2);
        } else {
          nightlyEl.textContent = "-";
        }
      }

      // Caption: "for X night(s)"
      if (nightlyCaptionEl) {
        nightlyCaptionEl.textContent =
          nightsNum > 0
            ? "for " + nightsNum + " night" + (nightsNum > 1 ? "s" : "")
            : "";
      }

      // Add-ons summary
      var addonsLabel = "None selected";
      if (Array.isArray(state.selectedAddons) && state.selectedAddons.length) {
        var totalQty = state.selectedAddons.reduce(function (sum, item) {
          var q = Number(item.quantity || 0);
          return sum + (Number.isFinite(q) && q > 0 ? q : 0);
        }, 0);
        if (totalQty > 0) {
          addonsLabel =
            totalQty +
            " add-on" +
            (totalQty === 1 ? "" : "s");
        }
      }
      var addonsEl = document.getElementById("summaryAddons");
      if (addonsEl) addonsEl.textContent = addonsLabel;
    }

        function updateAddonsSummary() {
      // Count how many distinct add-ons have qty > 0
      const selections = state.addonsSelections || {};
      const selectedCount = Object.values(selections).reduce((acc, qty) => {
        const n = typeof qty === "number" ? qty : parseInt(qty, 10);
        return acc + (n > 0 ? 1 : 0);
      }, 0);

      const summaryEl = document.getElementById("summaryAddons");
      if (summaryEl) {
        summaryEl.textContent =
          selectedCount > 0
            ? selectedCount + " add-on" + (selectedCount > 1 ? "s" : "") + " selected"
            : "None selected";
      }
    }

    function renderAddons(addons) {
      const listEl    = document.getElementById("addonsList");
      const modalBody = document.getElementById("addonsModalBody");
      const emptyEl   = document.getElementById("addonsEmptyMessage");

      const rows = Array.isArray(addons) ? addons : [];
      state.addonsConfig = rows;

      // If neither container exists, nothing to do
      if (!listEl && !modalBody) return;

      // Clear both containers (we primarily use the modal body)
      if (listEl) listEl.innerHTML = "";
      if (modalBody) modalBody.innerHTML = "";

      if (!rows.length) {
        if (emptyEl) {
          emptyEl.textContent = "No add-ons are available for this stay.";
          emptyEl.style.display = "block";
        }
        return;
      }

      if (emptyEl) {
        emptyEl.style.display = "none";
      }

      // Prefer modal body; fall back to inline list if modal not present
      const target = modalBody || listEl;

      // ---------- Header row: 5 columns ----------
      const header = document.createElement("div");
      header.className = "addon-row addon-row-header";

      function makeHeaderCell(className, text) {
        const el = document.createElement("div");
        el.className = "addon-col " + className;
        el.textContent = text;
        return el;
      }

      header.appendChild(makeHeaderCell("addon-col-activity", "Activity"));
      header.appendChild(makeHeaderCell("addon-col-uom", "Unit"));
      header.appendChild(makeHeaderCell("addon-col-price", "Price per unit"));
      header.appendChild(makeHeaderCell("addon-col-qty", "Qty"));
      header.appendChild(makeHeaderCell("addon-col-total", "Total"));

      target.appendChild(header);

      // ---------- Data rows: 5 columns ----------
      rows.forEach(function (addon, idx) {
        const activity = (addon.activity || "").toString().trim() || "Add-on";
        const uom      = (addon.uom || "").toString().trim();
        const notes    = (addon.notes || "").toString().trim();
        const rawPrice = addon.price;

        const price =
          typeof rawPrice === "number"
            ? rawPrice
            : rawPrice != null
            ? Number(rawPrice)
            : NaN;

        const hasNumericPrice = !Number.isNaN(price) && Number.isFinite(price);
        const priceText = hasNumericPrice
          ? formatCurrency(price, state.pricingCurrency || "USD")
          : "Price TBD";

        const row = document.createElement("div");
        row.className = "addon-row";

        // Column 1: Activity (and optional notes)
        const colActivity = document.createElement("div");
        colActivity.className = "addon-col addon-col-activity";

        const titleEl = document.createElement("div");
        titleEl.className = "addon-title";
        titleEl.textContent = activity;
        colActivity.appendChild(titleEl);

        if (notes) {
          const notesEl = document.createElement("div");
          notesEl.className = "addon-notes";
          notesEl.textContent = notes;
          colActivity.appendChild(notesEl);
        }

        // Column 2: UoM
        const colUom = document.createElement("div");
        colUom.className = "addon-col addon-col-uom";
        colUom.textContent = uom || "â€”";

        // Column 3: Price per UoM
        const colPrice = document.createElement("div");
        colPrice.className = "addon-col addon-col-price";
        colPrice.textContent = priceText;

        // Column 4: Qty (with input)
        const colQty = document.createElement("div");
        colQty.className = "addon-col addon-col-qty";

        const key = String(idx);
        const currentQty =
          state.addonsSelections && typeof state.addonsSelections[key] === "number"
            ? state.addonsSelections[key]
            : 0;

        const qtyInput = document.createElement("input");
        qtyInput.type = "number";
        qtyInput.min = "0";
        qtyInput.step = "1";
        qtyInput.value = currentQty > 0 ? String(currentQty) : "0";
        qtyInput.setAttribute("data-addon-index", String(idx));

        colQty.appendChild(qtyInput);

        // Column 5: Subtotal for this row
        const colTotal = document.createElement("div");
        colTotal.className = "addon-col addon-col-total addon-line-total";

        function refreshLineTotal() {
          const q = parseInt(qtyInput.value, 10);
          if (!hasNumericPrice || isNaN(q) || q <= 0) {
            colTotal.textContent = "";
            return;
          }
          const total = q * price;
          colTotal.textContent = formatCurrency(
            total,
            state.pricingCurrency || "USD"
          );
        }

        qtyInput.addEventListener("input", function () {
          const val = parseInt(qtyInput.value, 10);
          if (isNaN(val) || val <= 0) {
            if (state.addonsSelections) {
              delete state.addonsSelections[key];
            }
          } else {
            if (!state.addonsSelections) state.addonsSelections = {};
            state.addonsSelections[key] = val;
          }
          refreshLineTotal();
          recomputeSelectedAddons();
        });

        // Prevent mouse-wheel from changing the value while scrolling the page
        qtyInput.addEventListener(
          "wheel",
          function (e) {
            e.preventDefault();
          },
          { passive: false }
        );

        // Initial subtotal render
        refreshLineTotal();

        row.appendChild(colActivity);
        row.appendChild(colUom);
        row.appendChild(colPrice);
        row.appendChild(colQty);
        row.appendChild(colTotal);

        target.appendChild(row);
      });

      // After initial render, compute subtotal + summary once
      recomputeSelectedAddons();
    }

    function openAddonsModal() {
      const backdrop = document.getElementById("addonsModalBackdrop");
      if (!backdrop) {
        console.warn("[addonsModal] backdrop not found");
        return;
      }

      // Make sure it is visible even if CSS is missing
      backdrop.style.display = "flex";
      backdrop.classList.add("is-open");
      backdrop.setAttribute("aria-hidden", "false");

      console.log("[addonsModal] open");
    }

    function closeAddonsModal() {
      const backdrop = document.getElementById("addonsModalBackdrop");
      if (!backdrop) return;

      backdrop.classList.remove("is-open");
      backdrop.setAttribute("aria-hidden", "true");
      backdrop.style.display = "none";

      console.log("[addonsModal] close");
    }

    // Delegate clicks for add-ons modal (open / close / apply)
    document.addEventListener("click", function (evt) {
      const target = evt.target;
      if (!(target instanceof HTMLElement)) return;

      // Open trigger (pill in section 3)
      if (target.closest("[data-open-addons-modal]")) {
        evt.preventDefault();
        openAddonsModal();
        return;
      }

      // Close triggers: explicit close buttons or clicking backdrop
      if (
        target.closest("[data-close-addons-modal]") ||
        target.id === "addonsModalBackdrop"
      ) {
        evt.preventDefault();
        closeAddonsModal();
        return;
      }

      // Apply: recompute selections + subtotal, then close
      if (target.closest("[data-apply-addons-modal]")) {
        evt.preventDefault();
        if (typeof recomputeSelectedAddons === "function") {
          recomputeSelectedAddons();
        }
        closeAddonsModal();
      }
    });

    // Helper: read IDs/dates from the URL so add-ons do not depend on state wiring
    function getCheckoutIdsFromQuery() {
      const qs = new URLSearchParams(location.search);
      const propertyId = qs.get("propertyId") || "";
      const start      = qs.get("start") || "";
      const end        = qs.get("end") || "";
      const ratePlanId = qs.get("ratePlanId");

      return {
        propertyId,
        start,
        end,
        ratePlanId: ratePlanId ? Number(ratePlanId) : null
      };
    }

    async function loadAddonsForProperty() {
      const q = parseQuery();

      // Prefer state.propertyId if weâ€™ve already set it, otherwise fall back
      // to whatever parseQuery resolved (query string + localStorage bridge).
      const propertyId = Number(
        (state.propertyId && String(state.propertyId)) ||
        (q.propertyId && String(q.propertyId)) ||
        "0"
      );

      // Dates: prefer the current state, fall back to query
      const start = state.start || q.start || "";
      const end   = state.end   || q.end   || "";

      if (!Number.isFinite(propertyId) || propertyId <= 0 || !start || !end) {
        console.log("[checkout] loadAddonsForProperty missing params", {
          propertyId,
          start,
          end
        });
        return;
      }

      // Keep state in sync once we have a solid id
      state.propertyId = String(propertyId);

      try {
        const params = new URLSearchParams();
        params.set("propertyId", String(propertyId));
        params.set("start", start);
        params.set("end", end);

        // IMPORTANT: do not filter by ratePlanId here.
        // The DB uses its own internal rate plan IDs (8,11,12,...) which
        // don't match the front-end ids (1,2,3). Filtering here was
        // stripping out all room/price data.
        // if (q.ratePlanId) params.set("ratePlanId", q.ratePlanId);

        const url = "/catalog/details?" + params.toString();
        console.log("[checkout] details URL", url);

        const resp = await fetch(url, {
          method: "GET",
          headers: { Accept: "application/json" }
        });

        if (!resp.ok) {
          console.warn(
            "[checkout] /catalog/details for addons failed",
            resp.status
          );
          state.addonsConfig = [];
          renderAddons([]);
          return;
        }

        const data = await resp.json();

        // Debug: full /catalog/details payload used by checkout
        console.log("[checkout] details raw", data);
        window.__checkoutDetailsPayload = data;

        const addons = Array.isArray(data.addons) ? data.addons : [];
        state.addonsConfig = addons;
        console.log("[checkout] addons from details", {
          propertyId,
          start,
          end,
          count: addons.length,
          addons
        });
        renderAddons(addons);

        // Apply backend pricing quote if present, otherwise derive from rooms[].daily
        if (data && typeof data === "object" && data.checkoutQuote) {
          const quote = data.checkoutQuote;
          console.log("[checkout] applying checkoutQuote", quote);

          // Remember the base room total (no add-ons yet)
          const baseTotal = Number(quote && quote.total);
          if (Number.isFinite(baseTotal)) {
            state.baseRoomTotal = baseTotal;
          }

          applyCheckoutQuote(quote);
        } else {
          try {
            const roomsArr = Array.isArray(data.rooms) ? data.rooms : [];
            if (!roomsArr.length) return;

            // Prefer the room the user actually selected, fall back to first room
            const qRoomId = q.roomId ? Number(q.roomId) : NaN;
            let chosen = null;

            if (Number.isFinite(qRoomId)) {
              chosen =
                roomsArr.find(r => {
                  const rtId = Number(
                    (r && (r.roomTypeId != null ? r.roomTypeId : r.id))
                  );
                  return Number.isFinite(rtId) && rtId === qRoomId;
                }) || null;
            }
            if (!chosen) chosen = roomsArr[0];

            const daily = Array.isArray(chosen.daily) ? chosen.daily : [];
            const msPerDay = 24 * 60 * 60 * 1000;
            const startDate = new Date(start + "T00:00:00Z");
            const endDate   = new Date(end   + "T00:00:00Z");
            const nights = [];

            for (let t = startDate.getTime(); t < endDate.getTime(); t += msPerDay) {
              const iso = new Date(t).toISOString().slice(0, 10);
              const rec = daily.find(d => d && d.date === iso);
              if (!rec) continue;

              const val = rec.price != null ? Number(rec.price) : NaN;
              if (!Number.isFinite(val) || val <= 0) continue;

              nights.push({ date: iso, amount: val });
            }

            const total = nights.reduce((sum, n) => sum + n.amount, 0);
            if (!nights.length || !Number.isFinite(total) || total <= 0) return;

            const curRow = daily.find(d => d && d.currency) || null;
            const curCode = curRow && curRow.currency ? String(curRow.currency) : "USD";

            const quote = { currency: curCode, total, nights };
            console.log("[checkout] applying derived checkoutQuote", quote);
            applyCheckoutQuote(quote);
          } catch (e) {
            console.warn("[checkout] failed to derive checkoutQuote from rooms", e);
          }
        }
      } catch (err) {
        console.error("[checkout] loadAddonsForProperty error", err);
        state.addonsConfig = [];
        renderAddons([]);
      }
    }

    function applyQuoteToCard(cardEl, quote) {
      if (!cardEl || !quote) return;

      const total = Number(quote.total || 0);
      const nightsArr = Array.isArray(quote.nights) ? quote.nights : [];
      const nights = nightsArr.length || 0;

      // avg price/night
      const avg = nights > 0 ? (total / nights) : 0;

      // Find elements inside this card (prefer id-suffixed by dataset orig id, else fallback to query by id suffix)
      const avgEl =
        cardEl.querySelector('[data-orig-id="avgNightPrice"]') ||
        cardEl.querySelector('[id^="avgNightPrice__li"]') ||
        cardEl.querySelector("#avgNightPrice");

      const totalBtn =
        cardEl.querySelector('[data-orig-id="totalPill"]') ||
        cardEl.querySelector('[id^="totalPill__li"]') ||
        cardEl.querySelector("#totalPill");

      const nightsEl =
        cardEl.querySelector('[data-orig-id="stayNights"]') ||
        cardEl.querySelector('[id^="stayNights__li"]') ||
        cardEl.querySelector("#stayNights");

      if (nightsEl) nightsEl.textContent = String(nights);

      // Use existing currency formatting style from top card (simple $ fallback)
      const cur = quote.currency || "";
      const fmtMoney = (v) => {
        const n = Number(v || 0);
        const s = n.toFixed(0);
        if (cur === "USD") return "$" + s;
        if (cur) return cur + " " + s;
        return "$" + s;
      };

      if (avgEl) avgEl.textContent = fmtMoney(avg);
      if (totalBtn) totalBtn.textContent = fmtMoney(total);
    }

    function applyCheckoutQuote(quote) {
      if (!quote || typeof quote !== "object") return;

      // Start from backend quote
      var nightsArr = Array.isArray(quote.nights)
        ? quote.nights.map(function (n) { return Object.assign({}, n); })
        : [];

      // 1) Base total from backend (before plan adjustments)
      var baseTotal = 0;
      if (typeof quote.total === "number" && Number.isFinite(quote.total)) {
        baseTotal = quote.total;
      } else if (nightsArr.length) {
        baseTotal = nightsArr.reduce(function (sum, n) {
          var v = Number(
            n.amount !== undefined ? n.amount :
            n.price  !== undefined ? n.price  :
            n.value  !== undefined ? n.value  : 0
          );
          return sum + (Number.isFinite(v) ? v : 0);
        }, 0);
      }

      if (!Number.isFinite(baseTotal) || baseTotal <= 0) {
        // No valid total â€“ keep existing placeholder
        return;
      }

      // 2) Adjust for selected rate plan (mirror catalog_details helper)
      var adjustedNights = nightsArr;
      var totalNumeric = baseTotal;

      try {
        var q = parseQuery();
        var rpId = q && q.ratePlanId ? Number(q.ratePlanId) : NaN;

        function adjustNightAmount(amount, planId) {
          var base = Number(amount);
          if (!Number.isFinite(base)) return amount;

          // Keep these rules in sync with getPlanPriceForRoom in catalog_details.html
          if (planId === 1) {
            // Standard
            return base;
          }
          if (planId === 2) {
            // Non-refundable: -10%
            return Math.round(base * 0.9 * 100) / 100;
          }
          if (planId === 3) {
            // With Breakfast: +10
            return base + 10;
          }
          return base;
        }

        if (Number.isFinite(rpId) && nightsArr.length) {
          adjustedNights = nightsArr.map(function (n) {
            var raw = n.amount !== undefined ? n.amount :
                      n.price  !== undefined ? n.price  :
                      n.value  !== undefined ? n.value  : 0;
            var adj = adjustNightAmount(raw, rpId);
            var clone = Object.assign({}, n);
            clone.amount = adj;
            return clone;
          });

          totalNumeric = adjustedNights.reduce(function (sum, n) {
            var v = Number(n.amount);
            return sum + (Number.isFinite(v) ? v : 0);
          }, 0);
        }
      } catch (e) {
        console.warn("[checkout] ratePlan adjustment failed", e);
        adjustedNights = nightsArr;
        totalNumeric = baseTotal;
      }

      // 3) Apply room quantity (multiplies room-only totals and nightly amounts)
      var qtyNum = 1;
      try {
        qtyNum = Number.parseInt(String(state.qty || 1), 10);
        if (!Number.isFinite(qtyNum) || qtyNum < 1) qtyNum = 1;
      } catch (_) {
        qtyNum = 1;
      }

      if (qtyNum > 1 && Array.isArray(adjustedNights) && adjustedNights.length) {
        adjustedNights = adjustedNights.map(function (n) {
          var clone = Object.assign({}, n);
          var raw = Number(
            clone.amount !== undefined ? clone.amount :
            clone.price  !== undefined ? clone.price  :
            clone.value  !== undefined ? clone.value  : 0
          );
          var scaled = Number.isFinite(raw) ? (raw * qtyNum) : 0;
          clone.amount = Math.round(scaled * 100) / 100;
          return clone;
        });
        totalNumeric = Math.round((Number(totalNumeric) * qtyNum) * 100) / 100;
      }

      var currency = quote.currency || "USD";

      state.pricingTotal = totalNumeric;
      state.pricingCurrency = currency;
      state.pricingNights = adjustedNights;

      // Update summary total amount
      var totalEl = document.getElementById("summaryTotal");
      if (totalEl) {
        totalEl.textContent = formatCurrency(totalNumeric, currency);
      }

      // Update nightly breakdown using adjusted nights
      renderNightlyBreakdown(adjustedNights, currency);

      // Recompute per-night average and caption based on new total
      updateSummaries();
    }

    async function loadAddonsConfig() {
      const ids = getCheckoutIdsFromQuery();
      const propertyId = ids.propertyId;
      const start = ids.start;
      const end = ids.end;
      const ratePlanId = ids.ratePlanId;

      if (!propertyId || !start || !end) {
        console.log("[checkout] loadAddonsConfig skipped (missing ids/dates)", ids);
        return;
      }

      try {
        const params = new URLSearchParams();
        params.set("propertyId", propertyId);
        params.set("start", start);
        params.set("end", end);
        if (Number.isFinite(ratePlanId)) {
          params.set("ratePlanId", String(ratePlanId));
        }

        const resp = await fetch("/catalog/details?" + params.toString(), {
          headers: { Accept: "application/json" }
        });

        if (!resp.ok) {
          console.warn("[checkout] /catalog/details for config failed", resp.status);
          return;
        }

        const data = await resp.json();

        // Debug tap: inspect the full details payload in checkout
        console.log("[checkout] details raw", data);
        window.__checkoutDetailsPayload = data;

        const addons = Array.isArray(data.addons) ? data.addons : [];
        console.log("[checkout] loadAddonsConfig got addons", addons);

        if (typeof state === "object") {
          state.addonsConfig = addons;
        }

        // Optional pricing quote from /catalog/details
        if (data && typeof data === "object" && data.checkoutQuote) {
          applyCheckoutQuote(data.checkoutQuote);
        }
      } catch (err) {
        console.error("[checkout] loadAddonsConfig error", err);
      }
    }

    function setSectionState(section, status) {
      const stepCircle = document.querySelector('[data-step-indicator="' + section + '"]');
      const statusLabel = document.querySelector('[data-step-status="' + section + '"]');
      const body = document.querySelector('[data-section-body="' + section + '"]');
      if (!stepCircle || !statusLabel || !body) return;

      if (status === "active") {
        stepCircle.classList.add("active");
        stepCircle.classList.remove("completed");
        statusLabel.textContent = "Waiting for confirmation";
        statusLabel.classList.remove("completed");
        body.classList.remove("hidden");
      } else if (status === "completed") {
        stepCircle.classList.remove("active");
        stepCircle.classList.add("completed");
        statusLabel.textContent = "Confirmed";
        statusLabel.classList.add("completed");
        body.classList.add("hidden");
      } else {
        stepCircle.classList.remove("active");
        stepCircle.classList.remove("completed");
        statusLabel.textContent = "Locked until previous step";
        statusLabel.classList.remove("completed");
        body.classList.add("hidden");
      }
    }

    function refreshSections() {
      for (let i = 1; i <= 4; i++) {
        const isConfirmed = state.sectionConfirmed[i];
        if (i === 1) {
          setSectionState(1, isConfirmed ? "completed" : "active");
        } else {
          const prevDone = state.sectionConfirmed[i - 1];
          if (!prevDone) {
            setSectionState(i, "locked");
          } else {
            setSectionState(i, isConfirmed ? "completed" : "active");
          }
        }
      }
      const allConfirmed =
        state.sectionConfirmed[1] &&
        state.sectionConfirmed[2] &&
        state.sectionConfirmed[3] &&
        state.sectionConfirmed[4];
      document.getElementById("confirmAndPayButton").disabled = !allConfirmed;
    }

    function normalizeRoomPriceCardsUI() {
      const cards = Array.from(
        document.querySelectorAll('.section-body[data-section-body="1"] .dates-grid')
      );
      if (!cards.length) return;

      const many = cards.length > 1;

      // Always control Remove visibility first (Remove must show on every card when 2+)
      cards.forEach((card) => {
        const removeBtn = card.querySelector('button[data-remove-lineitem="1"]');
        if (!removeBtn) return;

        // If Remove is inside a hidden confirm row on non-last cards, move it out.
        const row = removeBtn.closest(".stay-confirm-row");
        if (row) {
          removeBtn.remove();
          // Place it under the pricing row, before the confirm row area (keeps minimal layout)
          card.appendChild(removeBtn);
        }

        removeBtn.style.display = many ? "" : "none";
      });

      // Singleton Confirm (SAFE): do NOT move/remove DOM nodes.
      // Just show confirm on the last card only.
      try {
        const lastIdx = cards.length - 1;

        cards.forEach((card, i) => {
          const row = card.querySelector(".stay-confirm-row");
          if (!row) return;

          row.style.display = (i === lastIdx) ? "flex" : "none";

          const confirmBtn = row.querySelector('button[data-confirm="1"]');
          if (confirmBtn) confirmBtn.style.display = "";
        });
      } catch (_) {}
    }

    function confirmRemoveLineItemUI(onYes) {
      // Remove existing modal if any
      const old = document.getElementById("removeLineItemConfirm");
      if (old) old.remove();

      const backdrop = document.createElement("div");
      backdrop.id = "removeLineItemConfirm";
      backdrop.style.position = "fixed";
      backdrop.style.left = "0";
      backdrop.style.top = "0";
      backdrop.style.right = "0";
      backdrop.style.bottom = "0";
      backdrop.style.background = "rgba(15, 28, 46, 0.35)";
      backdrop.style.display = "flex";
      backdrop.style.alignItems = "center";
      backdrop.style.justifyContent = "center";
      backdrop.style.zIndex = "9999";
      backdrop.style.padding = "18px";

      const card = document.createElement("div");
      card.style.background = "#fff";
      card.style.border = "1px solid rgba(15, 28, 46, 0.12)";
      card.style.borderRadius = "16px";
      card.style.maxWidth = "420px";
      card.style.width = "100%";
      card.style.boxShadow = "0 12px 30px rgba(15, 28, 46, 0.18)";
      card.style.padding = "16px 16px 14px 16px";
      card.style.fontFamily = "Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif";

      const title = document.createElement("div");
      title.textContent = "Remove this line item?";
      title.style.fontWeight = "700";
      title.style.fontSize = "14px";
      title.style.color = "#0F1C2E";

      const body = document.createElement("div");
      body.textContent = "This will remove the room and rate plan from your checkout.";
      body.style.marginTop = "6px";
      body.style.fontSize = "13px";
      body.style.color = "rgba(15, 28, 46, 0.8)";
      body.style.lineHeight = "1.35";

      const actions = document.createElement("div");
      actions.style.display = "flex";
      actions.style.gap = "10px";
      actions.style.justifyContent = "flex-end";
      actions.style.marginTop = "12px";

      const noBtn = document.createElement("button");
      noBtn.type = "button";
      noBtn.textContent = "No";
      noBtn.className = "pill-outline"; // uses your existing aesthetic

      const yesBtn = document.createElement("button");
      yesBtn.type = "button";
      yesBtn.textContent = "Yes, remove";
      yesBtn.className = "btn-primary"; // uses your existing aesthetic

      function close() {
        backdrop.remove();
      }

      backdrop.addEventListener("click", (e) => {
        if (e.target === backdrop) close();
      });

      noBtn.addEventListener("click", () => close());
      yesBtn.addEventListener("click", () => {
        close();
        try { onYes && onYes(); } catch(_) {}
      });

      actions.appendChild(noBtn);
      actions.appendChild(yesBtn);

      card.appendChild(title);
      card.appendChild(body);
      card.appendChild(actions);

      backdrop.appendChild(card);
      document.body.appendChild(backdrop);
    }

    // Delegated remove handler
    document.addEventListener("click", (e) => {
      const btn = e.target.closest('button[data-remove-lineitem="1"]');
      if (!btn) return;

      const card = btn.closest(".dates-grid");
      if (!card) return;

      // We expect your render loop to set a line id on the card wrapper.
      const lineId =
        card.getAttribute("data-lineid") ||
        card.getAttribute("data-lineId") ||
        (card.dataset ? (card.dataset.lineid || card.dataset.lineId || card.dataset.lineId) : null);

      if (!lineId) {
        alert("Remove failed: missing lineId on this card wrapper (data-lineid).");
        return;
      }

      let cart = null;
      try { cart = JSON.parse(localStorage.getItem("checkout.cart.v1") || "null"); } catch (_) { cart = null; }
      if (!cart || !Array.isArray(cart.items)) return;

      cart.items = cart.items.filter(it => String(it.lineId) !== String(lineId));
      localStorage.setItem("checkout.cart.v1", JSON.stringify(cart));

      confirmRemoveLineItemUI(() => {
        try {
          const cart = loadCartV1();
          const items = cart && Array.isArray(cart.items) ? cart.items : [];

          const keep = items.filter(it => String(it && it.lineId) !== String(lineId));
          cart.items = keep;
          saveCartV1(cart);

          console.log("[checkout] removed lineId", lineId, "remaining", keep.length);
        } catch (e) {
          console.warn("[checkout] remove failed in confirm", e);
        }

        // IMPORTANT: avoid re-adding the removed line via URL->cart guard on reload.
        // Navigate to a URL that points to an existing remaining line (or clears selection).
        try {
          const cartAfter = loadCartV1();
          const remaining = cartAfter && Array.isArray(cartAfter.items) ? cartAfter.items : [];

          const qsNext = new URLSearchParams(location.search);

          if (remaining.length) {
            const it0 = remaining[0];

            qsNext.set("propertyId", String(it0.propertyId || ""));
            qsNext.set("roomId",     String(it0.roomTypeId || ""));
            qsNext.set("ratePlanId", String(it0.ratePlanId || ""));
            qsNext.set("qty",        String(it0.qty || 1));
            qsNext.set("start",      String(it0.start || ""));
            qsNext.set("end",        String(it0.end || ""));

            // Optional labels (safe)
            if (it0.propertyName) qsNext.set("propertyName", String(it0.propertyName));
            if (it0.propertyLocation) qsNext.set("propertyLocation", String(it0.propertyLocation));
            if (it0.roomName) qsNext.set("roomName", String(it0.roomName));
            if (it0.planLabel) qsNext.set("planLabel", String(it0.planLabel));
          } else {
            // No items left: clear selection params so nothing can be re-added
            ["propertyId","roomId","ratePlanId","qty","start","end","propertyName","propertyLocation","roomName","planLabel","plans"].forEach(k => qsNext.delete(k));
          }

          location.replace(`${location.pathname}?${qsNext.toString()}`);
          return;
        } catch (_) {}

        // Fallback
        location.reload();

      });
    });

    function suffixIdsInClone(rootEl, idx) {
      rootEl.querySelectorAll("[id]").forEach(function (el) {
        var orig = el.id;
        el.dataset.origId = orig;
        el.id = orig + "__li" + idx;
      });
    }

    function setCloneTextByOrigId(rootEl, origId, text) {
      var el = rootEl.querySelector('[data-orig-id="' + origId + '"]');
      if (el) el.textContent = text == null ? "" : String(text);
    }

    // Helper: render "Dec 16, 2025 to Dec 19, 2025" from YYYY-MM-DD
    function prettyStayRange(start, end) {
      try {
        if (!start || !end) return "";
        const s = String(start);
        const e = String(end);

        // Parse as local date (avoid timezone shift)
        const ps = s.split("-").map(n => parseInt(n, 10));
        const pe = e.split("-").map(n => parseInt(n, 10));
        if (ps.length !== 3 || pe.length !== 3) return `${s} to ${e}`;

        const ds = new Date(ps[0], ps[1] - 1, ps[2]);
        const de = new Date(pe[0], pe[1] - 1, pe[2]);

        const fmt = (d) =>
          d.toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" });

        return `${fmt(ds)} to ${fmt(de)}`;
      } catch (_) {
        return `${start || ""} to ${end || ""}`;
      }
    }

    function renderRoomPriceCardsFromCart() {
      var cart = loadCartV1();
        // Sort items by start date (earliest first), then end date
        function dayNum(ymd) {
          if (!ymd || typeof ymd !== "string") return Number.MAX_SAFE_INTEGER;
          const p = ymd.split("-");
          if (p.length !== 3) return Number.MAX_SAFE_INTEGER;
          return (Number(p[0]) * 10000) + (Number(p[1]) * 100) + Number(p[2]);
        }

        const itemsSorted = Array.isArray(cart && cart.items)
          ? cart.items.slice().sort((a, b) => {
              const as = dayNum(a.start);
              const bs = dayNum(b.start);
              if (as !== bs) return as - bs;
              const ae = dayNum(a.end);
              const be = dayNum(b.end);
              return ae - be;
            })
          : [];

      if (!cart || !Array.isArray(itemsSorted) || itemsSorted.length <= 1) return;

      var root = document.getElementById("roomPriceCardsRoot");
      var tpl  = document.getElementById("roomPriceCardTemplate");
      if (!root || !tpl) return;

      // Keep the first card as-is (it uses the original IDs and existing logic).
      // Tag the first (template) card with its lineId so remove works on it too
      if (itemsSorted[0] && itemsSorted[0].lineId) {
        tpl.dataset.lineId = itemsSorted[0].lineId;
        tpl.setAttribute("data-lineid", String(cart.items[0].lineId));
        // Ensure the first card gets its quote applied via the same scoped method
        (function(card, itemRef) {
          if (!itemRef) return;
          const pid = Number(itemRef.propertyId || 0);
          if (!pid) return;

          const qs = new URLSearchParams();
          qs.set("propertyId", String(pid));
          if (itemRef.start) qs.set("start", String(itemRef.start));
          if (itemRef.end)   qs.set("end",   String(itemRef.end));
          if (itemRef.roomTypeId) qs.set("roomId", String(itemRef.roomTypeId));
          if (itemRef.ratePlanId) qs.set("ratePlanId", String(itemRef.ratePlanId));
          qs.set("qty", String(itemRef.qty || 1));

          fetch("/catalog/details?" + qs.toString(), { credentials: "include" })
            .then(r => r.json())
            .then(data => {
              const quote = data && data.checkoutQuote ? data.checkoutQuote : null;
              if (quote) applyQuoteToCard(card, quote);
            })
            .catch(err => console.warn("[checkout] card quote failed", err));
        })(tpl, itemsSorted[0]);

      }

      // Remove any previously cloned cards.
      root.querySelectorAll(".dates-grid.__li").forEach(function (n) { n.remove(); });

      // Create clones for items[1..]
      for (var i = 1; i < itemsSorted.length; i++) {
        var item = itemsSorted[i];

        var clone = tpl.cloneNode(true);
        clone.classList.add("__li");
      const lid = item.lineId || ("line_" + i);
        clone.dataset.lineId = lid;
        clone.setAttribute("data-lineid", String(lid));

        // Suffix IDs inside clone to avoid duplicates
        suffixIdsInClone(clone, i);

        // Populate visible fields in the clone (display only for now)
        setCloneTextByOrigId(clone, "propertyName", item.propertyName || "");
        setCloneTextByOrigId(clone, "propertyMeta", item.propertyLocation || "");
        setCloneTextByOrigId(clone, "propertyIdValue", item.propertyId || "");
        setCloneTextByOrigId(clone, "roomName", item.roomName || "");
        setCloneTextByOrigId(clone, "roomIdValue", item.roomTypeId || "");
        setCloneTextByOrigId(clone, "ratePlanName", item.planLabel || "");
        setCloneTextByOrigId(clone, "ratePlanIdValue", item.ratePlanId || "");
        setCloneTextByOrigId(clone, "roomQty", item.qty != null ? item.qty : "");

      const datesEl = clone.querySelector('[data-orig-id="stayDatesInline"]');
        if (datesEl) datesEl.textContent = prettyStayRange(item.start, item.end);

        // For now: hide the date editor inside clone to avoid flatpickr duplication in this step.
        // We will wire per-card edit dates next step.
        var wrap = clone.querySelector('[data-orig-id="checkoutDatesCardWrapper"]');
        if (wrap) wrap.classList.add("hidden");

        root.appendChild(clone);
        // Fetch quote for this line item and apply to this card (scoped)
        (function(card, itemRef) {
          const pid = Number(itemRef.propertyId || 0);
          if (!pid) return;

          const qs = new URLSearchParams();
          qs.set("propertyId", String(pid));
          if (itemRef.start) qs.set("start", String(itemRef.start));
          if (itemRef.end)   qs.set("end",   String(itemRef.end));
          if (itemRef.roomTypeId) qs.set("roomId", String(itemRef.roomTypeId));
          if (itemRef.ratePlanId) qs.set("ratePlanId", String(itemRef.ratePlanId));
          qs.set("qty", String(itemRef.qty || 1));

          fetch("/catalog/details?" + qs.toString(), { credentials: "include" })
            .then(r => r.json())
            .then(data => {
              const quote = data && data.checkoutQuote ? data.checkoutQuote : null;
              if (quote) applyQuoteToCard(card, quote);
            })
            .catch(err => console.warn("[checkout] card quote failed", err));
        })(clone, item);
      }

      // IMPORTANT: normalize AFTER cards are rendered (so remove/confirm visibility wins)
      try { normalizeRoomPriceCardsUI(); } catch (_) {}
    }

    // === CONFIRM DELEGATE WIRE (prevents dead Confirm when cards are cloned) ===
    if (!window.__checkoutConfirmDelegated) {
      window.__checkoutConfirmDelegated = true;

      document.addEventListener("click", function (e) {
        const btn = e.target && e.target.closest
          ? e.target.closest('button[data-confirm="1"]')
          : null;

        if (!btn) return;

        // Prevent any default behavior and make Confirm always work
        e.preventDefault();

        // Section 1 confirm
        try { handleConfirmClick(1); } catch (err) {
          console.warn("[checkout] confirm delegate failed", err);
        }
      }, true);
    }

    function handleConfirmClick(section) {

      // Guest details validation lives on section 4
      if (section === 3) {
        const firstName = document.getElementById("firstName").value.trim();
        const lastName = document.getElementById("lastName").value.trim();
        const email = document.getElementById("email").value.trim();
        const phone = document.getElementById("phone").value.trim();
        const errorEl = document.getElementById("guestError");

        if (!firstName || !lastName || !email || !phone) {
          if (errorEl) errorEl.style.display = "block";
          return;
        } else if (errorEl) {
          errorEl.style.display = "none";
        }
      } else if (section === 4) {
        // Terms / Privacy agreement is required before payment
        const checkbox = document.getElementById("termsCheckbox");
        const errorEl  = document.getElementById("termsError");
        const wrap     = document.querySelector(".payment-agreement");

        const isChecked = checkbox && checkbox.checked;

        if (!isChecked) {
          if (errorEl) errorEl.style.display = "block";
          if (wrap) wrap.classList.add("error");
          return; // do not mark section 5 as confirmed
        }

        // Clear error state when user has agreed
        if (errorEl) errorEl.style.display = "none";
        if (wrap) wrap.classList.remove("error");
      }

      state.sectionConfirmed[section] = true;
      refreshSections();

      // If user just confirmed Payment Method, immediately start Stripe Checkout.
      if (section === 4) {
        const btn = document.getElementById("confirmAndPayButton");
        if (btn && !btn.disabled) {
          setTimeout(() => btn.click(), 0);
        }
      }
    }

    // ANCHOR: ADDONS_MODAL_HANDLERS
    // Modal open / close / apply is handled via the global click
    // delegation above using:
    //   [data-open-addons-modal]
    //   [data-close-addons-modal]
    //   [data-apply-addons-modal]

    function initCheckout() {
      const q0 = parseQuery();
      migrateSelectionToCartIfNeeded(q0);

      // NEW: If user arrived with an explicit selection in the URL (from catalog_details),
      // ensure it exists as a cart line (append vs overwrite).
      (function ensureQueryLineIsInCart() {
        const hasAll =
          q0 &&
          Number(q0.propertyId) &&
          Number(q0.roomId) &&
          Number(q0.ratePlanId) &&
          q0.start &&
          q0.end;

        if (!hasAll) return;

        const cart = loadCartV1();
        if (!cart || !Array.isArray(cart.items)) return;

        const propId = String(q0.propertyId);
        const roomId = String(q0.roomId);
        const planId = String(q0.ratePlanId);
        const start  = String(q0.start);
        const end    = String(q0.end);
        const qty    = Math.max(1, Number.parseInt(String(q0.qty || "1"), 10) || 1);

        // Consider it the â€œsame lineâ€ only if property+room+plan+dates match
        const existing = cart.items.find(it =>
          String(it.propertyId) === propId &&
          String(it.roomTypeId) === roomId &&
          String(it.ratePlanId) === planId &&
          String(it.start) === start &&
          String(it.end) === end
        );

        if (existing) {
          // If user re-clicked Book Now on same exact line, just sync qty + labels
          existing.qty = qty;
          if (q0.propertyName) existing.propertyName = String(q0.propertyName);
          if (q0.propertyLocation) existing.propertyLocation = String(q0.propertyLocation);
          if (q0.roomName) existing.roomName = String(q0.roomName);
          if (q0.ratePlanName) existing.planLabel = String(q0.ratePlanName);
          saveCartV1(cart);
          return;
        }

        // Append as a new line
        const lineId =
          "ln_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2, 8);

        cart.items.push({
          lineId,
          propertyId: propId,
          propertyName: String(q0.propertyName || ""),
          propertyLocation: String(q0.propertyLocation || ""),
          roomTypeId: roomId,
          roomName: String(q0.roomName || ""),
          ratePlanId: planId,
          planLabel: String(q0.ratePlanName || ""),
          qty,
          start,
          end
        });

        saveCartV1(cart);
      })();

      const picked = coalesceQueryFromCart(q0);
      const q = picked.q;

      // optional state hooks for later steps (no UI impact now)
      state.cart = picked.cart;
      state.activeLine = picked.active;
      state.propertyId = q.propertyId;
      state.roomId = q.roomId;
      state.qty = Math.max(1, Number.parseInt(q.qty, 10) || 1);
      state.start = q.start;
      state.end = q.end;
      state.ratePlanId = q.ratePlanId;
      state.propertyName = q.propertyName;
      state.propertyLocation = q.propertyLocation;
      state.roomName = q.roomName;
      state.ratePlanName = q.ratePlanName;

      updateSummaries();
      refreshSections();
      renderRoomPriceCardsFromCart();
      loadAddonsForProperty();
      normalizeRoomPriceCardsUI();
      
      // Allow clicking headers to reopen a section, but keep only one open

      // Allow clicking headers to reopen a section, but keep only one open
      document.querySelectorAll(".card-header").forEach(function (header) {
        header.addEventListener("click", function () {
          var card = header.closest(".card");
          if (!card) return;
          var section = Number(card.getAttribute("data-section"));
          if (!section) return;

          // Donâ€™t let user jump ahead if previous sections arenâ€™t confirmed
          for (var i = 1; i < section; i++) {
            if (!state.sectionConfirmed[i]) {
              return;
            }
          }

          // Open this section, close all others
          document.querySelectorAll("[data-section-body]").forEach(function (bodyEl) {
            var bodySection = Number(bodyEl.getAttribute("data-section-body"));
            if (bodySection === section) {
              bodyEl.classList.remove("hidden");
            } else {
              bodyEl.classList.add("hidden");
            }
          });
        });
      });

      (function wireEditDatesLinksAllCards() {
        const wrap = document.getElementById("checkoutDatesCardWrapper");
        if (!wrap) return;

        // Active line item for date edits
        state.activeLineIdForDates = state.activeLineIdForDates || null;

        document.addEventListener("click", function (e) {
          const link = e.target.closest(".dates-grid .top-info-right .card-header-link");
          if (!link) return;

          // Only handle the "Edit dates" links, not other links/buttons
          const isEdit =
            link.id === "editDatesLink" ||
            (link.dataset && link.dataset.origId === "editDatesLink") ||
            (typeof link.id === "string" && link.id.indexOf("editDatesLink__li") === 0);

          if (!isEdit) return;

          e.preventDefault();

          const card = link.closest(".dates-grid");
          if (!card) return;

          const lineId = card.getAttribute("data-lineid") || (card.dataset ? card.dataset.lineId : null);
          if (!lineId) {
            alert("Edit dates failed: missing data-lineid on this card.");
            return;
          }

          state.activeLineIdForDates = String(lineId);

          // Move the single real date editor into this card's right column
          const rightCol = card.querySelector(".dates-right");
          if (rightCol) rightCol.appendChild(wrap);

          wrap.classList.remove("hidden");
          wrap.scrollIntoView({ behavior: "smooth", block: "nearest" });

          // Load that line's dates into the editor (inputs + flatpickr)
          const cart = loadCartV1();
          const items = cart && Array.isArray(cart.items) ? cart.items : [];
          const it = items.find(x => String(x && x.lineId) === String(lineId));
          if (!it) return;

          state.start = String(it.start || "");
          state.end   = String(it.end || "");

          const inEl  = document.getElementById("checkout-checkin");
          const outEl = document.getElementById("checkout-checkout");
          if (inEl)  inEl.value = state.start;
          if (outEl) outEl.value = state.end;

          const rangeDriver = document.getElementById("checkout-dates-driver");
          const fp = rangeDriver && rangeDriver._checkoutFp ? rangeDriver._checkoutFp : null;
          if (fp && state.start && state.end) {
            fp.setDate([state.start, state.end], true);
          }

          const btn = document.getElementById("checkout-dates-display");
          if (btn) btn.focus();
        });
      })();

      document.querySelectorAll("[data-confirm]").forEach(function (btn) {
        btn.addEventListener("click", function () {
          const section = Number(btn.getAttribute("data-confirm"));
          handleConfirmClick(section);
        });
      });

      const breakdownToggle = document.getElementById("breakdownToggle");
      const breakdownDetails = document.getElementById("breakdownDetails");
      if (breakdownToggle && breakdownDetails) {
        breakdownToggle.addEventListener("click", function () {
          breakdownDetails.classList.toggle("visible");
        });
      }

      const confirmAndPayButton = document.getElementById("confirmAndPayButton");
      if (confirmAndPayButton) {
        // Original Stripe Checkout handler (kept as-is)
        confirmAndPayButton.addEventListener("click", async function () {
          if (confirmAndPayButton.disabled) return;

          confirmAndPayButton.disabled = true;
          confirmAndPayButton.textContent = "Redirecting to secure payment.";

          try {
            const response = await fetch("/api/payments/create-checkout-session", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                propertyId: state.propertyId,
                roomId: state.roomId,
                start: state.start,
                end: state.end,
                ratePlanId: state.ratePlanId,
                addons: Array.isArray(state.selectedAddons)
                  ? state.selectedAddons
                  : []
              })
            });

            if (!response.ok) throw new Error("Failed to start payment");
            const data = await response.json();
            if (data && data.url) {
              window.location.href = data.url;
            } else {
              throw new Error("Missing redirect URL");
            }
          } catch (err) {
            console.error("Error starting Stripe Checkout", err);
            confirmAndPayButton.disabled = false;
            confirmAndPayButton.textContent = "Proceed to secure payment";
            alert("Could not start payment. Please try again.");
          }
        });

        // NEW: Reuse the same Stripe handler when clicking the Section 5 button
        const sectionFiveButton = document.querySelector('button[data-confirm="5"]');
        if (sectionFiveButton) {
          sectionFiveButton.addEventListener("click", function () {
            // Let the generic [data-confirm] handler run first
            // (it marks section 5 as confirmed and refreshes the UI),
            // then trigger the Stripe button once everything is unlocked.
            setTimeout(function () {
              if (!confirmAndPayButton.disabled) {
                confirmAndPayButton.click();
              }
            }, 0);
          });
        }
      }

      const changePlanLink = document.getElementById("changePlanLink");
      if (changePlanLink) {
        changePlanLink.addEventListener("click", function (e) {
          e.preventDefault();

          // Deterministic navigation (no browser back stack dependency)
          // Prefer the most recent catalog_details url if present; otherwise fall back to catalog.
          const lastDetails = localStorage.getItem("checkout.lastDetailsUrl");
          if (lastDetails && typeof lastDetails === "string") {
            window.location.href = lastDetails;
            return;
          }

          window.location.href = "/catalog.html";
        });
      }

      // Date card wiring for Section 2 (flatpickr range + anchored to pill)
      const datesCardWrapper = document.getElementById("checkoutDatesCardWrapper");

      // NEW ids (match catalog_details pattern)
      const rangeDriver  = document.getElementById("checkout-dates-driver");          // hidden text input
      const displayBtn   = document.getElementById("checkout-dates-display");         // the date pill button
      const displayLabel = document.getElementById("checkout-dates-display-label");   // text inside pill

      // Keep these for apply/URL update
      const applyBtn     = document.getElementById("checkout-dates-apply");

      // ANCHOR: CHECKOUT_DATES_APPLY_WIRE
      if (applyBtn && !applyBtn.dataset.wiredDates) {
        applyBtn.dataset.wiredDates = "1";

        applyBtn.addEventListener("click", function () {
          // Prefer flatpickr selection if present
          const fp = rangeDriver && rangeDriver._checkoutFp ? rangeDriver._checkoutFp : null;
          const sel = fp && fp.selectedDates ? fp.selectedDates : [];

          const s = sel[0] || parseLocalYMD(state.start) || null;
          let   e = sel[1] || parseLocalYMD(state.end)   || null;

          if (!s) return;

          if (!e || e <= s) {
            e = new Date(s.getTime());
            e.setDate(s.getDate() + 1);
          }

          const finalStart = formatLocalYmd(s);
          const finalEnd   = formatLocalYmd(e);

          const qsNext = new URLSearchParams(location.search);
          qsNext.set("start", finalStart);
          qsNext.set("end", finalEnd);

          location.assign(`${location.pathname}?${qsNext.toString()}`);
        });
      }

      // Helper: format a Date as local YYYY-MM-DD (no timezone shift)
      function formatLocalYmd(d) {
        const y  = d.getFullYear();
        const m  = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        return `${y}-${m}-${dd}`;
      }

      function formatMmddyyyy(d) {
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        const y = d.getFullYear();
        return `${m}/${dd}/${y}`;
      }

      function setDisplayText(startDate, endDate) {
        if (!displayLabel) return;
        if (startDate && endDate) {
          displayLabel.textContent = `${formatMmddyyyy(startDate)} to ${formatMmddyyyy(endDate)}`;
        } else if (startDate) {
          displayLabel.textContent = `${formatMmddyyyy(startDate)} to`;
        } else {
          displayLabel.textContent = "Select dates";
        }
      }
    
      // --- Edit dates: single authoritative click handler (prevents double-wiring) ---
      const editDatesLink = document.getElementById("editDatesLink");
      if (editDatesLink && datesCardWrapper) {
        // Kill any previous listeners by cloning the node (prevents "click cancels itself")
        const fresh = editDatesLink.cloneNode(true);
        editDatesLink.parentNode.replaceChild(fresh, editDatesLink);

        fresh.addEventListener("click", function (e) {
          e.preventDefault();

          // Show the date card reliably
          datesCardWrapper.classList.remove("hidden");
          datesCardWrapper.style.display = "flex";

          // Optional: scroll into view so it feels responsive
          try { datesCardWrapper.scrollIntoView({ behavior: "smooth", block: "nearest" }); } catch (_) {}
        });
      }

      // Bail if required elements arenâ€™t present
      if (rangeDriver && displayBtn && applyBtn && window.flatpickr) {
        // Prevent double-init
        if (!rangeDriver._checkoutFp) {

          // Seed initial dates from state (YYYY-MM-DD)
          const seedStart = parseLocalYMD(state.start);
          const seedEnd   = parseLocalYMD(state.end);

          setDisplayText(seedStart || null, seedEnd || null);

          const keepScroll = () => {
            const y = window.scrollY;
            requestAnimationFrame(() => window.scrollTo(0, y));
          };

          const fp = flatpickr(rangeDriver, {
            mode: "range",
            dateFormat: "Y-m-d",
            allowInput: false,
            clickOpens: false,                 // we open via the pill
            closeOnSelect: false,              // keep open after start; close after end
            enableTime: false,
            positionElement: displayBtn,       // anchor to the pill (fixes top-left)
            appendTo: datesCardWrapper || document.body,

            defaultDate: (seedStart && seedEnd) ? [formatLocalYmd(seedStart), formatLocalYmd(seedEnd)]
                      : (seedStart) ? [formatLocalYmd(seedStart)]
                      : null,

            onOpen: function () {
              keepScroll(); // guard against jump scroll
            },

            onChange: function (selectedDates, dateStr, instance) {
              const s = (selectedDates && selectedDates[0]) ? selectedDates[0] : null;
              const e = (selectedDates && selectedDates[1]) ? selectedDates[1] : null;

              setDisplayText(s, e);
              keepScroll();

              // Auto-close once end date is selected (match catalog behavior)
              if (s && e && instance && typeof instance.close === "function") {
                instance.close();
                keepScroll();
              }
            }
          });

          rangeDriver._checkoutFp = fp;

          // Open calendar when clicking the pill
          // Defensive: if fp isn't valid (or wiring got disrupted), build a fallback fp on demand.
          displayBtn.addEventListener("click", function (e) {
            e.preventDefault();
            e.stopPropagation();

            console.log("[checkout][dates] pill click");

            // Prefer the primary instance created above
            if (fp && typeof fp.open === "function") {
              fp.open();
              keepScroll();
              return;
            }

            // Fallback: if something prevented fp from being usable, create one now
            if (rangeDriver && typeof window.flatpickr === "function") {
              try {
                if (!rangeDriver._checkoutFp) {
                  rangeDriver._checkoutFp = flatpickr(rangeDriver, {
                    mode: "range",
                    dateFormat: "Y-m-d",
                    allowInput: false,
                    clickOpens: false,
                    closeOnSelect: false,
                    positionElement: displayBtn,
                    appendTo: datesCardWrapper || document.body,
                    onOpen: function () {
                      keepScroll();
                    },
                    onChange: function (selectedDates) {
                      const s = (selectedDates && selectedDates[0]) ? selectedDates[0] : null;
                      const ee = (selectedDates && selectedDates[1]) ? selectedDates[1] : null;
                      setDisplayText(s, ee);
                      keepScroll();
                    }
                  });
                }

                rangeDriver._checkoutFp.open();
                keepScroll();
                return;
              } catch (err) {
                console.warn("[checkout][dates] fallback flatpickr init failed", err);
              }
            }

            console.warn("[checkout][dates] flatpickr not available / driver missing");
          });

          // Apply button: read from flatpickr selection, normalize, then reload URL
          applyBtn.addEventListener("click", function (e) {
            e.preventDefault();

            console.log("[checkout][dates] apply click");

            // Prefer primary fp, fall back to any on-demand instance
            const activeFp =
              (fp && typeof fp === "object") ? fp :
              (rangeDriver && rangeDriver._checkoutFp) ? rangeDriver._checkoutFp :
              null;

            const sel = (activeFp && Array.isArray(activeFp.selectedDates))
              ? activeFp.selectedDates
              : [];

            const s = sel[0] || parseLocalYMD(state.start) || null;
            let endDate = sel[1] || parseLocalYMD(state.end) || null;

            if (!s) return;

            // Ensure end exists and is after start
            if (!endDate || endDate <= s) {
              endDate = new Date(s.getTime());
              endDate.setDate(s.getDate() + 1);
            }

            const finalStart = formatLocalYmd(s);
            const finalEnd   = formatLocalYmd(endDate);

            // Apply ONLY to the active line item in the cart
            const lineId = state.activeLineIdForDates ? String(state.activeLineIdForDates) : null;
            if (!lineId) return;

            const cartNow = loadCartV1();
            if (!cartNow || !Array.isArray(cartNow.items)) return;

            const idx = cartNow.items.findIndex(it => String(it && it.lineId) === lineId);
            if (idx < 0) return;

            // Propose update
            const proposed = cartNow.items.map(x => Object.assign({}, x));
            proposed[idx].start = finalStart;
            proposed[idx].end   = finalEnd;

            // Validate: continuous/back-to-back only (no gaps). Allow overlaps.
            function dayNum(ymd) {
              if (!ymd || typeof ymd !== "string") return Number.MAX_SAFE_INTEGER;
              const p = ymd.split("-");
              if (p.length !== 3) return Number.MAX_SAFE_INTEGER;
              return (Number(p[0]) * 10000) + (Number(p[1]) * 100) + Number(p[2]);
            }

            const sorted = proposed.slice().sort((a,b) => dayNum(a.start) - dayNum(b.start) || dayNum(a.end) - dayNum(b.end));
            for (let i = 1; i < sorted.length; i++) {
              const prevEnd = dayNum(sorted[i - 1].end);
              const curStart = dayNum(sorted[i].start);
              if (curStart > prevEnd) {
                alert("This checkout supports one trip at a time. Dates must be continuous or back-to-back (no gaps).");
                return;
              }
            }

            // Commit update
            cartNow.items = proposed;
            saveCartV1(cartNow);

            // Keep the URL focused on this updated line (so the â€œactiveâ€ card matches)
            const active = cartNow.items[idx];
            if (active) {
              qsNext.set("propertyId", String(active.propertyId || ""));
              qsNext.set("roomId",     String(active.roomTypeId || ""));
              qsNext.set("ratePlanId", String(active.ratePlanId || ""));
              qsNext.set("qty",        String(active.qty || 1));
            }

            // After apply, hide the date card
            const wrap = document.getElementById("checkoutDatesCardWrapper");
            if (wrap) wrap.classList.add("hidden");

            const qsNext = new URLSearchParams(location.search);
            qsNext.set("start", finalStart);
            qsNext.set("end", finalEnd);

            location.assign(`${location.pathname}?${qsNext.toString()}`);
          });
        } // end init guard
      } // end flatpickr guard

      const addonsList = document.getElementById("addonsList");
      if (addonsList) {
        addonsList.addEventListener("input", function (ev) {
          const target = ev.target;
          if (!target) return;

          const isQty =
            target.tagName === "INPUT" &&
            target.getAttribute("type") === "number" &&
            target.getAttribute("data-addon-index") != null;

          const isComment =
            target.tagName === "TEXTAREA" &&
            target.classList.contains("addon-comment") &&
            target.getAttribute("data-addon-index") != null;

          if (!isQty && !isComment) return;

          recomputeSelectedAddons();
        });
      }
    } // END initCheckout

    // Run init once when DOM is ready (THIS MUST BE OUTSIDE initCheckout)
    document.addEventListener("DOMContentLoaded", initCheckout);
    // If the browser restores this page from bfcache, force a fresh render from cart
    window.addEventListener("pageshow", function () {
      try {
        // Re-run only the cart render to avoid double-wiring everything
        if (typeof renderRoomPriceCardsFromCart === "function") {
          renderRoomPriceCardsFromCart();
        }
      } catch (_) {}
    });

  </script>

	  <script>
    (function () {
      const tickerImg = document.querySelector(".card-logo-ticker");
      if (!tickerImg) return;

      // TODO: make sure these 5 files exist in /assets on lolaelo.com
      const logos = [
        "https://www.lolaelo.com/assets/card_visa.png",
        "https://www.lolaelo.com/assets/card_mastercard.png",
        "https://www.lolaelo.com/assets/card_applepay.png",
        "https://www.lolaelo.com/assets/card_discover.png",
        "https://www.lolaelo.com/assets/card_amex.png",
      ];

      let index = 0;
      setInterval(() => {
        index = (index + 1) % logos.length;
        tickerImg.src = logos[index];
      }, 1500);
    })();
  </script>

  <!-- ANCHOR: ADDONS_MODAL -->
  <div id="addonsModalBackdrop" class="addons-modal-backdrop" style="display:none;">
    <div class="addons-modal">
      <div class="addons-modal-header">
        <h2 class="addons-modal-title">Explore add-ons</h2>
        <button
          type="button"
          class="addons-modal-close"
          id="addonsModalCloseBtn"
          data-close-addons-modal
        >
          Ã—
        </button>
      </div>

      <div class="addons-modal-body" id="addonsModalBody">
        <!-- Rows will be injected here -->
      </div>

      <div class="addons-modal-footer">
        <div class="addons-modal-subtotal">
          Add-ons total: <span id="addonsModalSubtotal">--</span>
        </div>
        <div class="addons-modal-actions">
          <button
            type="button"
            class="btn-secondary"
            id="addonsModalCancelBtn"
            data-close-addons-modal
          >
            Cancel
          </button>
          <button
            type="button"
            class="btn-primary"
            id="addonsModalApplyBtn"
            data-apply-addons-modal
          >
            Apply add-ons
          </button>
        </div>
      </div>
    </div>
  </div>

  <style>
    .section-intro {
      margin: 0 0 12px;
      font-size: 0.9rem;
      color: #4b5563; /* darker, readable */
    }

    .addons-explore-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 22px;
      border-radius: 999px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      border: 2px solid transparent;
      background:
        linear-gradient(#ffffff, #ffffff) padding-box,
        linear-gradient(135deg, #0f766e, #14b8a6) border-box;
      color: #0f766e;
      transition:
        box-shadow 0.15s ease,
        transform 0.05s ease;
      margin-bottom: 16px;
    }

    .addons-explore-pill:hover {
      box-shadow: 0 4px 10px rgba(15, 118, 110, 0.18);
      transform: translateY(-1px);
    }

    .addons-explore-pill:active {
      transform: translateY(0);
      box-shadow: 0 2px 5px rgba(15, 118, 110, 0.2);
    }

    /* Modal backdrop */
    .addons-modal-backdrop {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(15, 23, 42, 0.35);
      z-index: 50;
    }

    .addons-modal-backdrop.is-open {
      display: flex;
    }

    /* Wider modal: ~1.5x previous width */
    .addons-modal {
      width: 100%;
      max-width: 1080px;
      max-height: 80vh;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.25);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .addons-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      border-bottom: 1px solid #e5e7eb;
    }

    .addons-modal-title {
      margin: 0;
      font-size: 1rem;
      font-weight: 600;
    }

    .addons-modal-close {
      border: none;
      background: transparent;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      color: #6b7280;
    }

    .addons-modal-close:hover {
      color: #111827;
    }

    #addonsModalBackdrop .addons-modal-body {
      padding: 16px 80px;        /* wider left/right indent */
      overflow-y: auto;          /* scroll only vertically */
      overflow-x: hidden;        /* prevent sideways scrolling */
      font-size: 14px;           /* modal text slightly larger */
      box-sizing: border-box;    /* padding stays consistent */
    }

    /* Inline add-ons total pill under Section 3 */
    #addonsInlineTotalWrapper .addons-inline-total-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 14px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      font-size: 13px;
    }

    #addonsInlineTotalWrapper .addons-inline-total-amount {
      font-weight: 600;
      color: #111827;
    }

    .addons-modal-intro {
      margin: 0 0 12px;
      font-size: 0.9rem;
      color: #4b5563;
    }

    .addons-modal-footer {
      padding: 12px 24px 16px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 8px; /* subtotal above buttons */
    }

    .addons-modal-subtotal {
      font-weight: 600;
      font-size: 14px;
    }

    .addons-modal-actions {
      display: flex;
      gap: 10px;
    }

    /* Buttons inside modal only */
    #addonsModalBackdrop .btn-primary {
      padding: 7px 22px;
      min-height: 40px;
      border-radius: 999px;
      background: linear-gradient(135deg, #ff6a3d, #ff7a4c);
      color: #ffffff;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
    }

    #addonsModalBackdrop .btn-secondary {
      padding: 10px 24px;
      min-height: 40px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      cursor: pointer;
      font-size: 14px;
    }

    /* Column layout inside modal body â€“ 5 columns:
       Activity Â· Unit Â· Price per unit Â· Qty Â· Total
       (use fr units so everything contracts inside the modal width) */
    #addonsModalBackdrop .addon-row,
    #addonsModalBackdrop .addon-row-header {
      display: grid;
      grid-template-columns: 3fr 1.1fr 1.3fr 1fr 1.3fr; /* tighter Unit/Total */
      column-gap: 6px;                                 /* smaller gaps */
      align-items: center;
      padding: 8px 0;
      font-size: 14px;
      box-sizing: border-box;
      width: 100%;
    }

    #addonsModalBackdrop .addon-row-header {
      border-bottom: 1px solid #e5e7eb;
      margin-bottom: 4px;
      padding-bottom: 4px;
      font-weight: 600;
    }

    #addonsModalBackdrop .addon-col-activity {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    #addonsModalBackdrop .addon-col-activity .addon-title {
      font-weight: 500;
    }

    #addonsModalBackdrop .addon-col-activity .addon-meta {
      font-size: 12px;
      color: #6b7280;
    }

    #addonsModalBackdrop .addon-col-uom,
    #addonsModalBackdrop .addon-col-price,
    #addonsModalBackdrop .addon-col-qty,
    #addonsModalBackdrop .addon-col-total {
      font-size: 13px;
      color: #111827;
      white-space: nowrap;
    }

    #addonsModalBackdrop .addon-col-price {
      white-space: nowrap;
    }

    #addonsModalBackdrop .addon-col-qty {
      display: flex;
      flex-direction: column;
      align-items: center; /* center Qty under header */
      gap: 4px;
    }

    #addonsModalBackdrop .addon-col-qty label {
      font-size: 12px;
      color: #6b7280;
    }

    #addonsModalBackdrop .addon-col-qty input {
      width: 72px;
      padding: 4px 6px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      text-align: center;
      font-size: 13px;
      -moz-appearance: textfield;
      appearance: textfield;
    }

    #addonsModalBackdrop .addon-col-total {
      text-align: right;
      font-size: 13px;
      font-weight: 500;
    }

  </style>

  <!-- END ANCHOR: ADDONS_MODAL -->

</body>
</html>
