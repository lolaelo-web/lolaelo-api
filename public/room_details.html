<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lolaelo · Room</title>
  <link rel="icon" href="https://www.lolaelo.com/logo.png?cb=fav-v1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#fff; --fg:#111; --muted:#6b7280; --line:#eaeaea; --bubble:#ff6633; --paper:#fff; --radius:16px; --shadow:0 12px 40px rgba(0,0,0,.08); --maxw:860px; }
    *{ box-sizing:border-box; } html,body{ margin:0; min-height:100%; }
    body{
      font: 15px/1.5 Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--fg);
      background:
        linear-gradient(to bottom, rgba(255,255,255,.10), rgba(255,255,255,.10)),
        url("https://images.pexels.com/photos/1005417/pexels-photo-1005417.jpeg?auto=compress&cs=tinysrgb&dpr=2&h=1600&w=2400")
        center/cover no-repeat fixed;
      display:flex; flex-direction:column; align-items:center;
    }
    .paper{ width:100%; max-width:var(--maxw); margin:18px 20px; background:var(--paper); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px 16px 22px; }
    header{ display:grid; grid-template-columns:auto 1fr; align-items:center; gap:12px; }
    header h1{ margin:0; font-size:22px; font-weight:700; text-align:right; }
    .hero{ position:relative; border-radius:var(--radius); overflow:hidden; background:#fff; aspect-ratio:16/9; width:100%; min-height:260px; box-shadow:var(--shadow); }
    .hero img{ width:100%; height:100%; object-fit:contain; background:#fff; display:block; transition:opacity .25s ease; }
    .hero.is-loading::after{ content:""; position:absolute; inset:0; background-image:linear-gradient(90deg, rgba(0,0,0,.02) 0%, rgba(0,0,0,.06) 20%, rgba(0,0,0,.02) 40%); background-size:400px 100%; animation:shimmer 1.1s infinite linear; }
    @keyframes shimmer{ 0%{background-position:-400px 0;} 100%{background-position:400px 0;} }
    .thumbs.property-strip{
      margin-top:0;
      opacity:.95;
    }
    .thumbs.property-strip img{
      width:90px;
      height:60px;
      object-fit:cover;
      border-radius:12px;
      background:#fff;
      box-shadow:0 6px 16px rgba(0,0,0,.10);
      display:block;
    }
    .grid{ display:grid; grid-template-columns:minmax(0,3fr) minmax(320px,1fr); gap:16px; align-items:start; }
    @media (max-width:860px){ .grid{ grid-template-columns:1fr; } }
    .panel{ border:1px solid var(--line); border-radius:14px; padding:14px; display:flex; flex-direction:column; gap:12px; }
    .muted{ color:var(--muted); font-size:12px; }
    .price{ font-weight:800; font-size:26px; }
    .cta{ border:1px solid var(--bubble); background:var(--bubble); color:#fff; font-weight:700; border-radius:12px; padding:14px; width:100%; cursor:pointer; }
    .chips{ display:flex; gap:6px; flex-wrap:wrap; margin:6px 0; }
    .chip{ font-size:11px; padding:4px 8px; border:1px solid var(--line); border-radius:999px; background:#fafafa; color:#444; }
    .note{ font-size:12px; color:var(--muted); }
    .row{ display:flex; gap:10px; align-items:center; }
    .plan-summary{
      margin-top:10px;
      padding-top:10px;
      border-top:1px solid var(--line);
      display:grid;
      gap:6px;
      font-size:14px;
      color:#333;
    }
    .plan-summary .ps-row{
      display:flex;
      justify-content:space-between;
      cursor:pointer;
    }
    .plan-summary .ps-label{
      opacity:.8;
    }
    .plan-summary .ps-price{
      font-weight:500;
    }
  </style>
</head>
<body>
  <div class="paper">
    <header>
      <a class="logo" href="/catalog.html">
        <img src="https://www.lolaelo.com/logo.png?cb=logo-5x" alt="Lolaelo" decoding="async" loading="eager" style="height:95px;width:auto;display:block;">
      </a>
      <h1><span id="prop-name">Loading…</span></h1>
    </header>

    <section>
      <div id="hero" class="hero" aria-live="polite">
        <img id="hero-img" src="" alt="">
      </div>
      <div id="thumbs" class="thumbs" aria-label="More photos"></div>
      <div id="prop-strip" class="thumbs property-strip" aria-label="Property photos" hidden></div>
    </section>

    <div class="grid" style="margin-top:10px;">
      <section>
        <h2 id="room-name" style="margin:8px 0 6px;">Room</h2>
        <div id="room-meta" class="note"></div>
        <div id="amenities" class="chips"></div>
        <div id="desc" class="note" style="margin-top:8px;"></div>
      </section>

      <aside class="panel">
        <div id="stay-range" class="muted"></div>
        <div id="plan-label" class="muted"></div>
        <div id="plan-desc" class="note"></div>
        <div class="row"><div class="muted">From</div><div id="from" class="price">—</div></div>
        <div id="nights" class="muted"></div>
        <div id="total" class="muted"></div>

        <!-- New plan summary block -->
        <div id="plan-summary" class="plan-summary" hidden></div>

        <button id="continue" class="cta" type="button">Continue (mock)</button>
      </aside>
    </div>
  </div>

  <script>
  // --- Query params
  const qs = new URLSearchParams(location.search);

  const propertyId = qs.get('propertyId') || qs.get('id');
  const roomId     = qs.get('roomId');

  // Accept ratePlanId or plan
  const ratePlanId = qs.get('ratePlanId') || qs.get('plan') || null;

  // Derive a human-readable plan label if not explicitly provided
  let rawPlanLabel = qs.get('planLabel') || '';
  if (!rawPlanLabel && ratePlanId) {
    const rpId = String(ratePlanId);
    if (rpId === '1') rawPlanLabel = 'Non-refundable';
    else if (rpId === '2') rawPlanLabel = 'Standard';
    else if (rpId === '3') rawPlanLabel = 'With Breakfast';
  }

  const start = qs.get('start') || new Date().toISOString().slice(0,10);
  const end   = qs.get('end')   || start;

  // --- DOM
  const heroWrap = document.getElementById('hero');
  const heroImg  = document.getElementById('hero-img');
  const thumbs   = document.getElementById('thumbs');
  const propName = document.getElementById('prop-name');
  const roomName = document.getElementById('room-name');
  const roomMeta = document.getElementById('room-meta');
  const chipsEl  = document.getElementById('amenities');
  const descEl       = document.getElementById('desc');
  const fromEl       = document.getElementById('from');
  const rangeEl      = document.getElementById('stay-range');
  const nightsEl     = document.getElementById('nights');
  const planLabelEl  = document.getElementById('plan-label');
  const planDescEl   = document.getElementById('plan-desc');
  const totalEl      = document.getElementById('total');

  let images = [];
  let heroIndex = 0;

  function getPlaceholderSVG(label='Photo not available'){
    return 'data:image/svg+xml;utf8,' + encodeURIComponent(
      `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 450">
        <rect width="800" height="450" fill="white"/>
        <rect x="20" y="20" width="760" height="410" fill="#f3f4f6" stroke="#e5e7eb"/>
        <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle"
              font-family="Inter, Arial, sans-serif" font-size="20" fill="#9ca3af">${label}</text>
      </svg>`
    );
  }

  function thumbHTML(src, idx, total, name){
    return `<button class="thumb" type="button" data-idx="${idx}" aria-current="${idx===0?'true':'false'}">
      <img src="${src}" alt="${name} — photo ${idx+1} of ${total}" loading="lazy" decoding="async" width="110" height="72" draggable="false">
    </button>`;
  }

  function setHero(i){
    if (!images.length) return;
    i = Math.max(0, Math.min(images.length-1, i));
    heroIndex = i;
    const src = images[i];

    const img = new Image();
    heroWrap.classList.add('is-loading');
    img.onload = () => {
      heroImg.src = src;
      heroImg.alt = (roomName.textContent || 'Room') + ' — hero image';
      heroWrap.classList.remove('is-loading');
      thumbs.querySelectorAll('button.thumb').forEach((b, k)=>b.setAttribute('aria-current', k===i?'true':'false'));
    };
    img.onerror = () => {
      const ph = getPlaceholderSVG();
      heroImg.src = ph;
      heroImg.alt = 'Photo not available';
      heroWrap.classList.remove('is-loading');
    };
    img.src = src;
  }

  function money(n){ const x=Number(n); return Number.isFinite(x) ? `$${x.toFixed(2)}` : '—'; }
  function daysBetween(a,b){ return Math.round((new Date(b)-new Date(a))/86400000); }

  // === PER-PLAN PRICE HELPER (matches catalog_details) ===
  function getPlanPriceForRoom(roomTypeId, ratePlanId) {
    const rid = Number(roomTypeId);
    const pid = Number(ratePlanId);

    try {
      const payload = window.__detailsPayload || {};
      const rooms = Array.isArray(payload.rooms) ? payload.rooms : [];
      const room = rooms.find(rm => {
        const rtId = rm.roomTypeId != null ? Number(rm.roomTypeId) : null;
        const id   = rm.id != null ? Number(rm.id) : null;
        return rtId === rid || id === rid;
      });
      if (!room) return null;

      // 1) If backend gives per-plan summary, trust that first
      if (Array.isArray(room.ratePlanSummaries)) {
        const rp = room.ratePlanSummaries.find(x => Number(x.ratePlanId) === pid);
        if (rp) {
          const v = Number(rp.priceFrom);
          if (Number.isFinite(v)) return v;
        }
      }

      // 2) Derive a base STANDARD nightly price from room.daily or priceFrom
      let baseStd = null;

      if (Array.isArray(room.daily) && room.daily.length) {
        const nums = room.daily
          .map(d => {
            if (d == null) return NaN;
            if ("price" in d)      return Number(d.price);
            if ("amount" in d)     return Number(d.amount);
            if ("basePrice" in d)  return Number(d.basePrice);
            return NaN;
          })
          .filter(Number.isFinite);

        if (nums.length) {
          // use the minimum as "from" price
          baseStd = Math.min.apply(null, nums);
        }
      }

      if (baseStd == null && room.priceFrom != null) {
        const v = Number(room.priceFrom);
        if (Number.isFinite(v)) baseStd = v;
      }

      if (baseStd == null) return null;

      // 3) Apply rate plan rules on top of the base STANDARD price
      if (pid === 1) {
        // Non-refundable: -10 percent
        return Math.round(baseStd * 0.9 * 100) / 100;
      }
      if (pid === 2) {
        // Standard: base
        return baseStd;
      }
      if (pid === 3) {
        // With Breakfast: +10
        return baseStd + 10;
      }

      // Fallback for any other plan ids
      return baseStd;
    } catch (e) {
      console.warn("[getPlanPriceForRoom] failed", e);
      return null;
    }
  }

  // === PLAN LABEL HELPERS ===
  function normalizePlanLabel(raw){
    const s = String(raw || '').trim();
    if (!s) return '';
    if (/non[-\s]?ref/i.test(s)) return 'Non-refundable';
    if (/breakfast/i.test(s))   return 'With Breakfast';
    if (/standard/i.test(s))    return 'Standard';
    return s;
  }

  function describePlanFromLabel(label){
    if (/non[-\s]?ref/i.test(label)) {
      return 'Lower price, no refunds or changes.';
    }
    if (/with breakfast/i.test(label)) {
      return 'This rate includes breakfast for 2.';
    }
    if (/standard/i.test(label)) {
      return 'Flexible standard rate with free cancellation.';
    }
    return '';
  }
  // === END PLAN LABEL HELPERS ===

  async function load(){
    rangeEl.textContent = `${start} — ${end}`;
    heroWrap.classList.add('is-loading');

    // Load property + rooms once ( scoped to this rate plan if provided )
    let url = `/catalog/details?propertyId=${encodeURIComponent(propertyId)}&start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`;
    if (ratePlanId) {
      url += `&ratePlanId=${encodeURIComponent(ratePlanId)}`;
    }
    const r = await fetch(url, { cache:'no-store' });
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    const j = await r.json();
    window.__detailsPayload = j; // allow shared helpers to inspect details

    propName.textContent = j?.name || 'Stay';

    const rooms = Array.isArray(j?.rooms) ? j.rooms : [];
    // Resolve room by roomTypeId (matches roomId from catalog_details links), with fallbacks
    const room = rooms.find(rr =>
      String(rr.roomTypeId ?? rr.id ?? rr.roomId ?? rr.code ?? '') === String(roomId)
    ) || rooms[0];

    roomName.textContent = room?.name || 'Room';

    const normPlan = normalizePlanLabel(rawPlanLabel);
    const planDesc = describePlanFromLabel(normPlan);

    if (planLabelEl && normPlan) {
      planLabelEl.textContent = `Plan: ${normPlan}`;
    }
    if (planDescEl && planDesc) {
      planDescEl.textContent = planDesc;
    }

    // Meta line (size/occupancy if available)
    const m2  = room?.areaM2 ?? room?.areaSqm ?? null;
    const ft2 = room?.areaFt2 ?? (m2 ? Math.round(m2 * 10.7639) : null);
    const occ = room?.occupancy ?? room?.maxGuests ?? null;
    const bits = [];
    if (occ) bits.push(`${occ} guests`);
    if (m2)  bits.push(`${m2} m²`);
    if (ft2) bits.push(`${ft2} ft²`);
    roomMeta.textContent = bits.join(' · ');

    // Amenities & description (best effort)
    const am = Array.isArray(room?.amenities) ? room.amenities
             : Array.isArray(j?.amenities)    ? j.amenities
             : [];
    chipsEl.innerHTML = am.slice(0,8).map(a=>`<span class="chip">${String(a)}</span>`).join('');
    descEl.textContent = String(room?.description || j?.description || '');

    // Price roll-up from room.daily (no per-plan IDs in daily yet)
    const daily = (Array.isArray(room?.daily) ? room.daily : [])
      .filter(d =>
        !d.closed &&
        Number(d.inventory ?? d.open ?? 0) > 0 &&
        d.price != null &&
        !isNaN(Number(d.price))
      );

    // From price: minimum nightly price across open nights
    let minP = daily.length
      ? Math.min(...daily.map(d => Number(d.price)))
      : null;

    // Fallback: if daily is somehow empty, try details payload helper
    if (minP == null) {
      const rid = room?.roomTypeId ?? room?.id ?? roomId;
      if (rid) {
        const fallbackPrice = getPlanPriceForRoom(rid, ratePlanId || 2);
        if (fallbackPrice != null) minP = fallbackPrice;
      }
    }

    fromEl.textContent = minP != null ? money(minP) : '—';

    const nights = daysBetween(start,end);
    nightsEl.textContent = nights > 0 ? `${nights} night${nights === 1 ? '' : 's'}` : '';

    // Estimated total for stay
    let total = daily.length
      ? daily.reduce((sum, d) => sum + Number(d.price), 0)
      : null;

    if ((total == null || !isFinite(total)) && minP != null && nights > 0) {
      total = minP * nights;
    }

    if (totalEl) {
      totalEl.textContent = total != null && isFinite(total)
        ? `Estimated total for stay: ${money(total)}`
        : '';
    }

    // === PLAN SUMMARY (dynamic, from backend) ===
    const box = document.getElementById('plan-summary');
    if (box) {
      const rid = room?.roomTypeId ?? room?.id ?? roomId;
      if (rid) {
        try {
          const rpUrl = `/catalog/rateplans?propertyId=${propertyId}&roomTypeId=${rid}`;
          const rpRes = await fetch(rpUrl, { cache: 'no-store' });
          const rpList = rpRes.ok ? await rpRes.json() : [];

          if (Array.isArray(rpList) && rpList.length) {
            const currentPlan = ratePlanId ? String(ratePlanId) : null;
            let html = '';

            for (const rp of rpList) {
              const id = rp.ratePlanId;
              const label = rp.name || `Plan ${id}`;
              const p = getPlanPriceForRoom(rid, id);
              if (p == null) continue;

              const isActive = currentPlan === String(id);
              html += `
                <div class="ps-row" data-plan="${id}" style="${isActive ? 'font-weight:600;' : ''}">
                  <span class="ps-label">${label}</span>
                  <span class="ps-price">${money(p)}</span>
                </div>`;
            }

            if (html) {
              box.hidden = false;
              box.innerHTML = html;

              box.addEventListener('click', e => {
                const row = e.target.closest('.ps-row');
                if (!row) return;

                const newPlan = row.dataset.plan;
                if (!newPlan) return;

                const url = new URL(location.href);
                url.searchParams.set('ratePlanId', newPlan);

                const rp = rpList.find(x => String(x.ratePlanId) === newPlan);
                if (rp && rp.name) {
                  url.searchParams.set('planLabel', rp.name);
                }

                location.href = url.toString();
              });
            }
          }
        } catch (e) {
          console.warn("RatePlan summary failed", e);
        }
      }
    }

    // Images: prefer room.images (matching this roomTypeId when tagged)
    // → property-level images → catalog.search(by partnerId) fallback
    const pick = (arr, opts = {}) => {
      const { onlyRoomId = null, onlyPropertyLevel = false } = opts || {};
      const list = Array.isArray(arr) ? arr : [];
      const out  = [];

      for (const it of list) {
        const obj = (it && typeof it === 'object') ? it : null;

        // Try to read roomType metadata if present
        let rid = null;
        if (obj && ('roomTypeId' in obj || 'roomTypeID' in obj || 'roomId' in obj)) {
          rid = Number(obj.roomTypeId ?? obj.roomTypeID ?? obj.roomId);
          if (!Number.isFinite(rid)) rid = null;
        }

        // If we are filtering for a specific room id, skip others
        if (onlyRoomId != null) {
          if (rid == null || String(rid) !== String(onlyRoomId)) {
            continue;
          }
        }

        // If we only want property-level photos, skip anything tagged to a room
        if (onlyPropertyLevel && rid != null) {
          continue;
        }

        const src =
          typeof it === 'string'
            ? it
            : (obj?.url || obj?.photoUrl || obj?.imageUrl || obj?.src || obj?.href || "");
        if (src) out.push(src);
      }

      return out;
    };

    // Try to derive a numeric room id for filtering
    const roomNumericId = Number(room?.roomTypeId ?? room?.id ?? roomId);
    const hasRoomId = Number.isFinite(roomNumericId);

    // 1) Room-only photos when metadata is present
    images = pick(
      room?.images,
      hasRoomId ? { onlyRoomId: roomNumericId } : {}
    );

    // 2) If none found, prefer property-level images from details payload
    if (!images.length) {
      // First try images explicitly *not* tied to any roomTypeId
      let propImages = pick(j?.images, { onlyPropertyLevel: true });

      // If we did not find any property-only photos, fall back to all images
      if (!propImages.length) {
        propImages = pick(j?.images);
      }
      images = propImages;
    }

    // 3) Final safety net: /catalog/search fallback (unchanged behavior)
    if (!images.length) {
      try {
        const q  = `start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}&propertyId=${encodeURIComponent(j?.partnerId || propertyId)}&limit=1`;
        const sr = await fetch(`/catalog/search?${q}`, { cache:'no-store' });
        if (sr.ok) {
          const sj    = await sr.json();
          const props = Array.isArray(sj?.properties) ? sj.properties : (Array.isArray(sj) ? sj : []);
          const item  = props.find(it =>
            String(it?.partnerId ?? it?.propertyId ?? it?.id) === String(j?.partnerId || propertyId)
          ) || props[0];
          if (item) images = pick(item.images || item.photos || []);
        }
      } catch {}
    }

    // Render gallery
    if (!images.length){
      heroImg.src = getPlaceholderSVG();
      heroImg.alt = 'Photo not available';
      thumbs.innerHTML = '';
    } else {
      thumbs.innerHTML = images
        .map((s,i)=>thumbHTML(s,i,images.length, roomName.textContent))
        .join('');
      setHero(0);
    }

    // Optional property-level photo strip (non-interactive, no duplicates)
    const propStrip = document.getElementById('prop-strip');
    if (propStrip) {
      let propImages = pick(j?.images, { onlyPropertyLevel: true });

      // Remove any URLs already used in the main room gallery
      if (Array.isArray(images) && images.length && Array.isArray(propImages)) {
        const roomSet = new Set(images);
        propImages = propImages.filter(src => !roomSet.has(src));
      }

      if (propImages && propImages.length) {
        propStrip.hidden = false;
        propStrip.innerHTML = propImages
          .map((src, idx) => {
            const alt = `Property photo ${idx + 1}`;
            return `<img src="${src}" alt="${alt}">`;
          })
          .join('');
      } else {
        propStrip.hidden = true;
        propStrip.innerHTML = '';
      }
    }

    thumbs.addEventListener('click', e=>{
      const b = e.target.closest('button.thumb'); if(!b) return;
      setHero(Number(b.dataset.idx||0));
    });

    // Also change hero on hover for mouse users
    thumbs.addEventListener('mouseover', e => {
      const b = e.target.closest('button.thumb'); if (!b) return;
      setHero(Number(b.dataset.idx || 0));
    });
  }

  load().catch(e=>{
    console.error(e);
    heroWrap.classList.remove('is-loading');
    heroImg.src = getPlaceholderSVG('Failed to load');
  });

  // Mock continue
  document.getElementById('continue').addEventListener('click', ()=>{
    alert('Checkout flow coming soon');
  });
  </script>
</body>
</html>
