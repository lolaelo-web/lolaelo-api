<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Payments | Lolaelo Extranet</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="/css/extranet.css" />

  <style>
    /* ANCHOR: LOCAL_CSS */
    :root{ --bg:#0b1320; --card:#111a2b; --fg:#e8eefc; --muted:#9bb0d3; --accent:#ff6a3d; --line:rgba(255,255,255,.08); }
    body{
      margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;
      background: radial-gradient(1000px 600px at 20% -10%, #1a2b4a 0%, #0b1320 60%, #0b1320 100%);
      color:var(--fg); min-height:100vh;
    }
    .wrap{ max-width:1100px; margin:0 auto; padding:18px 14px 28px; }

    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:14px; }
    .brand{ display:flex; align-items:center; gap:10px; min-width:0; }
    .title{ font-weight:700; letter-spacing:.2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .actions{ display:flex; gap:10px; align-items:center; }
    .actions a.btn{ text-decoration:none; }

    .crumb{ color:var(--muted); font-size:13px; margin:6px 0 10px; }

    .hero{
      display:flex; align-items:flex-end; justify-content:space-between; gap:12px;
      padding:14px 14px; border:1px solid var(--line); background:var(--panel);
      border-radius:14px;
    }
    .hero h1{ margin:0; font-size:20px; }
    .hero p{ margin:6px 0 0; color:var(--muted); font-size:13px; }

    .grid{ display:grid; grid-template-columns: 1.1fr .9fr; gap:12px; margin-top:12px; }
    @media (max-width: 900px){ .grid{ grid-template-columns:1fr; } }

    .stack{ display:flex; flex-direction:column; gap:12px; }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:16px;
      padding:18px;
      box-shadow:0 8px 40px rgba(0,0,0,.45);
    }
    .card h2{ margin:0 0 10px; font-size:14px; letter-spacing:.2px; }

    .muted{ color:var(--muted); }
    .right{ text-align:right; }

    table{ width:100%; border-collapse:collapse; }
    th,td{ border-bottom:1px solid var(--line); padding:10px 8px; font-size:13px; text-align:left; vertical-align:top; }
    th{ text-align:left; color:#bcd3ff; font-weight:700; }
    tr:last-child td{ border-bottom:none; }

    .empty{
      padding:12px; color:var(--muted); font-size:13px;
      border:1px dashed var(--line); border-radius:12px; background:#0c1730;
    }

    .status{ display:inline-flex; align-items:center; gap:8px; font-size:13px; color:var(--muted); }
    .dot{ width:8px; height:8px; border-radius:999px; background:#6aa0ff; display:inline-block; }

    .brand .dot{
      width:10px; height:10px; border-radius:999px;
      background:#2bbb6f; box-shadow:0 0 0 3px rgba(43,187,111,.25);
    }

    .kpis{ display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; }
    @media (max-width: 600px){ .kpis{ grid-template-columns:1fr; } }
    .kpi{ border:1px solid var(--line); border-radius:12px; padding:12px; background:#0c1730; }
    .kpi .label{ font-size:12px; color:var(--muted); }
    .kpi .value{ margin-top:6px; font-size:18px; font-weight:700; }

    .pill{
      display:inline-block;
      padding:3px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid var(--line);
      background:#0e1830;
      color:#cfe0ff;
    }

    #readyTable button.btn{ position:relative; z-index:2; pointer-events:auto; }
    #readyTable td{ position:relative; }

  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <span class="dot" aria-hidden="true"></span>
        <div class="title">Lolaelo Extranet</div>
      </div>

      <div class="actions">
        <a class="btn ghost" href="partners_app.html" title="Back to menu" style="text-decoration:none;">Back to menu</a>
        <a class="btn ghost" href="mailto:support@lolaelo.com" title="Support" style="text-decoration:none;">Support</a>
        <button id="btnLogout" class="btn ghost" title="Sign out">Sign out</button>
      </div>
    </div>

    <div class="crumb">Extranet / Payments</div>

    <div class="hero">
      <div>
        <h1>Payments</h1>
        <p>View completed bookings ready for payout and your payment history.</p>
      </div>
      <div class="status" id="status">
        <span class="dot"></span>
        <span id="statusText">Loading...</span>
      </div>
    </div>

    <div class="grid">
      <div class="stack">
        <div class="card">
          <h2>Ready for payout</h2>
          <div class="muted" style="font-size:13px; margin:-4px 0 10px;">
            These are completed stays not yet included in a payout.
          </div>

          <div id="readyEmpty" class="empty" style="display:none;">No completed bookings waiting for payout.</div>

          <div style="overflow:auto;">
            <table id="readyTable" style="display:none;">
              <thead>
                <tr>
                  <th>Booking Ref #</th>
                  <th>Stay dates</th>
                  <th class="right">Total</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="readyBody"></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <h2>Payment history</h2>

          <div id="historyEmpty" class="empty" style="display:none;">No payments found yet.</div>

          <div style="overflow:auto;">
            <table id="historyTable" style="display:none;">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Confirmation</th>
                  <th class="right">Amount</th>
                  <th>Bookings</th>
                  <th>Details</th>
                </tr>
              </thead>
              <tbody id="historyBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>Totals</h2>
        <div class="kpis">
          <div class="kpi">
            <div class="label">Total Received</div>
            <div class="value" id="kpiTotalReceived">-</div>
          </div>
          <div class="kpi">
            <div class="label">Pending Payout</div>
            <div class="value" id="kpiTotalPending">-</div>
          </div>
          <div class="kpi">
            <div class="label">No. of Payouts Sent</div>
            <div class="value" id="kpiCount">-</div>
          </div>
        </div>

        <div style="margin-top:12px;">
          <button id="btnRefresh" class="btn">Refresh</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ANCHOR: PAYOUT_MODAL -->
  <div id="payoutModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:9999; padding:18px; overflow:auto;">
    <div style="max-width:980px; margin:0 auto; border:1px solid var(--line); background:var(--panel); border-radius:14px;">
      <div style="display:flex; justify-content:space-between; gap:12px; align-items:center; padding:14px 16px; border-bottom:1px solid var(--line);">
        <div>
          <div style="font-weight:800; font-size:14px;" id="pmTitle">Payment details</div>
          <div class="muted" style="font-size:12px;" id="pmSub">Loading...</div>
        </div>
        <button class="btn ghost" type="button" onclick="closePayoutModal()">Close</button>
      </div>

      <div style="padding:14px 16px;">
        <div id="pmEmpty" class="empty" style="display:none;">No bookings found for this payment.</div>

        <div style="overflow:auto;">
          <table id="pmTable" style="display:none; width:100%; border-collapse:collapse;">
            <thead>
              <tr>
                <th>Booking</th>
                <th>Stay dates</th>
                <th class="right">Total</th>
              </tr>
            </thead>
            <tbody id="pmBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- ANCHOR: BOOKING_DETAIL_MODAL -->
  <div id="bookingModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:9999; padding:18px; overflow:auto;">
    <div style="max-width:900px; margin:0 auto; background:var(--card); border:1px solid var(--line); border-radius:16px; box-shadow:0 10px 60px rgba(0,0,0,.6);">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; padding:14px 16px; border-bottom:1px solid #203150;">
        <div>
          <div style="font-weight:800; font-size:15px;" id="bmTitle">Booking</div>
          <div class="muted" style="font-size:12px;" id="bmSubtitle"></div>
        </div>
        <button class="btn ghost" type="button" onclick="closeBookingModal()">Close</button>
      </div>

      <div style="padding:14px 16px;">
        <div id="bmSummary" class="note" style="margin-top:0;"></div>

        <h3 style="margin:14px 0 8px; font-size:14px;">Rooms booked</h3>
        <table style="width:100%; border-collapse:collapse;">
          <thead>
            <tr>
              <th style="text-align:left; padding:8px; border-bottom:1px solid #203150;">Room</th>
              <th style="text-align:left; padding:8px; border-bottom:1px solid #203150;">Rate plan</th>
              <th style="text-align:left; padding:8px; border-bottom:1px solid #203150;">Dates</th>
              <th style="text-align:right; padding:8px; border-bottom:1px solid #203150;">Room Qty</th>
              <th style="text-align:right; padding:8px; border-bottom:1px solid #203150;">No. of Guests</th>
              <th style="text-align:right; padding:8px; border-bottom:1px solid #203150;">Line total</th>
            </tr>
          </thead>
          <tbody id="bmItems"></tbody>
          <tfoot>
            <tr>
              <td colspan="5" style="padding:10px 8px; text-align:right; font-weight:800;">Total</td>
              <td style="padding:10px 8px; text-align:right; font-weight:800;" id="bmTotal"></td>
            </tr>
          </tfoot>
        </table>

        <!-- ANCHOR: BOOKING_MODAL_ADDONS -->
        <h3 style="margin:14px 0 8px; font-size:14px; display:none;" id="bmAddonsTitle">Add-ons</h3>
        <table style="width:100%; border-collapse:collapse; display:none;" id="bmAddonsTable">
          <thead>
            <tr>
              <th style="text-align:left; padding:8px; border-bottom:1px solid #203150;">Activity</th>
              <th style="text-align:left; padding:8px; border-bottom:1px solid #203150;">UOM</th>
              <th style="text-align:right; padding:8px; border-bottom:1px solid #203150;">Qty</th>
              <th style="text-align:right; padding:8px; border-bottom:1px solid #203150;">Unit</th>
              <th style="text-align:right; padding:8px; border-bottom:1px solid #203150;">Line total</th>
            </tr>
          </thead>
          <tbody id="bmAddons"></tbody>
        </table>
        <!-- ANCHOR: BOOKING_MODAL_ADDONS END -->
      </div>
    </div>
  </div>
  <!-- ANCHOR: BOOKING_DETAIL_MODAL END -->

  <script>
    (function () {
      // --- Config --------------------------------------------------------------
      const API_BASE = (window.API_BASE || "").trim() || (location.origin.includes("localhost") ? "http://localhost:3000" : location.origin);
      const LOGIN_PAGE = "partners_login.html";

      // --- Helpers -------------------------------------------------------------
      const $ = (id) => document.getElementById(id);

      function esc(s){
        return String(s == null ? "" : s)
          .replace(/&/g,"&amp;")
          .replace(/</g,"&lt;")
          .replace(/>/g,"&gt;")
          .replace(/"/g,"&quot;")
          .replace(/'/g,"&#39;");
      }

      function getToken() {
        try { return localStorage.getItem("lolaelo_session") || ""; } catch { return ""; }
      }

      function setStatus(text) {
        $("statusText").textContent = text;
      }

      async function authFetch(path, opts) {
        const t = getToken();
        if (!t) throw new Error("NO_TOKEN");

        const headers = Object.assign({}, (opts && opts.headers) || {});
        headers["Authorization"] = `Bearer ${t}`;

        // Match the header contract your other partner pages use
        try {
          const partnerToken = localStorage.getItem("partnerToken");
          if (partnerToken) headers["x-partner-token"] = partnerToken;
        } catch {}

        // Temporary until partnerId is derived server-side from session
        headers["x-partner-id"] = String(2);

        const res = await fetch(`${API_BASE}${path}`, Object.assign({}, opts || {}, { headers }));
        return res;
      }

      function money(n, currency) {
        const val = Number(n || 0);
        const cur = (currency || "USD").toUpperCase();
        try {
          return new Intl.NumberFormat(undefined, { style: "currency", currency: cur }).format(val);
        } catch {
          return `${cur} ${val.toFixed(2)}`;
        }
      }

      function fmtYmd(d){
        if (!d) return "";
        const s = String(d);
        return s.length >= 10 ? s.slice(0,10) : s;
      }

      // --- UI wiring -----------------------------------------------------------
      $("btnLogout").onclick = async () => {
        try {
          const t = getToken();
          await fetch(`${API_BASE}/extranet/logout`, { method: "POST", headers: { Authorization: `Bearer ${t}` } });
        } catch {}
        try {
          localStorage.removeItem("partnerToken");
          localStorage.removeItem("lolaelo_session");
        } catch {}
        location.replace(LOGIN_PAGE);
      };

      $("btnRefresh").onclick = () => load();

      window.closePayoutModal = function(){
        const m = $("payoutModal");
        if (m) m.style.display = "none";
      };

      window.openPayout = async function(payoutId){
        const m = $("payoutModal");
        if (!m) return;

        $("pmTitle").textContent = "Payment details";
        $("pmSub").textContent = "Loading...";
        $("pmEmpty").style.display = "none";
        $("pmTable").style.display = "none";
        $("pmBody").innerHTML = "";

        m.style.display = "block";

        const r = await authFetch(`/api/extranet/me/payouts/${payoutId}/bookings`, { method:"GET" });
        if (!r.ok) {
          $("pmSub").textContent = `Failed to load (${r.status})`;
          $("pmEmpty").style.display = "";
          return;
        }

        const j = await r.json();
        const payout = j.payout || {};
        const bookings = Array.isArray(j.bookings) ? j.bookings : [];

        const conf = payout.confirmationNumber ? String(payout.confirmationNumber) : "-";
        const paidAt = payout.paidAt ? fmtYmd(payout.paidAt) : "-";
        $("pmSub").textContent = `Paid: ${paidAt} | Confirmation: ${conf}`;

        if (!bookings.length) {
          $("pmEmpty").style.display = "";
          return;
        }

        $("pmBody").innerHTML = bookings.map(b => {
          const ref = String(b.bookingRef || "");
          const inD = fmtYmd(b.checkInDate);
          const outD = fmtYmd(b.checkOutDate);
          const stay = (inD && outD) ? `${inD} to ${outD}` : "-";
          const total = money(b.amountPaid || 0, b.currency || (payout.currency || "USD"));
          return `
            <tr>
              <td>
                <button class="btn ghost" type="button" onclick="openBooking('${esc(ref)}')" style="padding:6px 10px;">
                    ${esc(ref)}
                  </button>
                </td>
              <td>${esc(stay)}</td>
              <td class="right">${esc(total)}</td>
            </tr>
          `;
        }).join("");

        $("pmTable").style.display = "";
      };

      // ANCHOR: BOOKING_DETAIL_MODAL_JS
      function formatMoney(val, cur){
        const n = Number(val || 0);
        const c = String(cur || "USD").toUpperCase();
        return `${c} ${n.toFixed(2)}`;
      }

      function fmtPrettyRange(a, b){
        try{
          const da = new Date(a);
          const db = new Date(b);
          const fa = da.toLocaleDateString(undefined, { month:"short", day:"numeric", year:"numeric" });
          const fb = db.toLocaleDateString(undefined, { month:"short", day:"numeric", year:"numeric" });
          return `${fa} - ${fb}`;
        } catch {
          const aa = fmtYmd(a), bb = fmtYmd(b);
          return (aa && bb) ? `${aa} - ${bb}` : "-";
        }
      }

      window.closeBookingModal = function(){
        const modal = $("bookingModal");
        if (modal) modal.style.display = "none";
      };

      window.openBooking = async function(bookingRef){
        const modal = $("bookingModal");
        const title = $("bmTitle");
        const sub = $("bmSubtitle");
        const summary = $("bmSummary");
        const itemsEl = $("bmItems");
        const totalEl = $("bmTotal");

        if (!modal || !itemsEl) return;

        modal.style.display = "block";
        itemsEl.innerHTML = `<tr><td colspan="6" class="muted" style="padding:10px;">Loading...</td></tr>`;
        if (totalEl) totalEl.textContent = "";

        // Reset add-ons section (same behavior as manage bookings)
        const addonsTitle = $("bmAddonsTitle");
        const addonsTable = $("bmAddonsTable");
        const addonsBody  = $("bmAddons");
        if (addonsTitle && addonsTable && addonsBody) {
          addonsTitle.style.display = "none";
          addonsTable.style.display = "none";
          addonsBody.innerHTML = "";
        }

        const res = await authFetch(`/api/extranet/me/bookings/${encodeURIComponent(bookingRef)}`, { method:"GET" });
        const data = await res.json().catch(() => null);

        if (!data || !data.ok) {
          itemsEl.innerHTML = `<tr><td colspan="6" class="muted" style="padding:10px;">Failed loading booking.</td></tr>`;
          return;
        }

        const b = data.booking || {};
        const items = Array.isArray(data.items) ? data.items : [];
        const addons = Array.isArray(data.addons) ? data.addons : [];

        // Derive stay info from items (authoritative)
        let minIn = null;
        let maxOut = null;
        let sameWindow = true;

        if (items.length) {
          const firstIn = fmtYmd(items[0].checkInDate);
          const firstOut = fmtYmd(items[0].checkOutDate);

          items.forEach(it => {
            const ci = new Date(it.checkInDate);
            const co = new Date(it.checkOutDate);
            if (!Number.isNaN(ci.getTime())) minIn = (minIn && minIn < ci) ? minIn : ci;
            if (!Number.isNaN(co.getTime())) maxOut = (maxOut && maxOut > co) ? maxOut : co;

            if (fmtYmd(it.checkInDate) !== firstIn || fmtYmd(it.checkOutDate) !== firstOut) {
              sameWindow = false;
            }
          });
        }

        const modalStay =
          (!items.length)
            ? ((b.checkInDate && b.checkOutDate) ? `${fmtPrettyRange(b.checkInDate, b.checkOutDate)}` : "-")
            : (sameWindow ? `${fmtPrettyRange(minIn, maxOut)}` : "Multiple varying dates");

        const currency = (items[0]?.currency || b.currency || "USD");

        if (title) title.textContent = `Booking ${b.bookingRef || bookingRef}`;
        if (sub) sub.textContent = `${b.propertyName || ""}`.trim();

        const guest = [b.travelerFirstName, b.travelerLastName].filter(Boolean).join(" ").trim() || "Traveler";
        if (summary) {
          summary.innerHTML = `
            <div><b>Guest:</b> ${esc(guest)}</div>
            <div><b>Stay:</b> ${esc(modalStay)}</div>
            <div><b>Status:</b> ${esc(String(b.status || "-").replaceAll("_"," "))}</div>
            <div><b>Guests:</b> ${esc(b.guests ?? "-")}</div>
          `;
        }

        // Rooms booked table (same as manage bookings)
        let total = 0;
        itemsEl.innerHTML = items.map(it => {
          const dates = fmtPrettyRange(it.checkInDate, it.checkOutDate);
          const lt = Number(it.lineTotal || 0);
          total += (Number.isFinite(lt) ? lt : 0);

          return `
            <tr>
              <td style="padding:8px; border-bottom:1px solid #203150;">${esc(it.roomTypeName || it.roomTypeId || "-")}</td>
              <td style="padding:8px; border-bottom:1px solid #203150;">${esc(it.ratePlanName || it.ratePlanId || "-")}</td>
              <td style="padding:8px; border-bottom:1px solid #203150;" class="muted">${esc(dates)}</td>
              <td style="padding:8px; border-bottom:1px solid #203150; text-align:right;">${esc(it.qty)}</td>
              <td style="padding:8px; border-bottom:1px solid #203150; text-align:right;">${esc((b.guests ?? "-"))}</td>
              <td style="padding:8px; border-bottom:1px solid #203150; text-align:right;">${esc(formatMoney(it.lineTotal, it.currency || currency))}</td>
            </tr>
          `;
        }).join("");

        // Add-ons (same as manage bookings)
        if (addonsTitle && addonsTable && addonsBody && addons.length) {
          addonsTitle.style.display = "";
          addonsTable.style.display = "";

          addonsBody.innerHTML = addons.map(a => {
            const qty = Number(a.qty || 0) || 0;
            const unit = Number(a.unitPrice || 0) || 0;
            const line = Number(a.lineTotal || 0) || 0;
            const cur = String(a.currency || currency || "USD").toUpperCase();

            return `
              <tr>
                <td style="padding:8px; border-bottom:1px solid #203150;">${esc(a.activity || "")}</td>
                <td style="padding:8px; border-bottom:1px solid #203150;">${esc(a.uom || "")}</td>
                <td style="padding:8px; border-bottom:1px solid #203150; text-align:right;">${esc(qty)}</td>
                <td style="padding:8px; border-bottom:1px solid #203150; text-align:right;">${esc(formatMoney(unit, cur))}</td>
                <td style="padding:8px; border-bottom:1px solid #203150; text-align:right;">${esc(formatMoney(line, cur))}</td>
              </tr>
            `;
          }).join("");
        }

        if (totalEl) totalEl.textContent = formatMoney(total, currency);
      };
      // ANCHOR: BOOKING_DETAIL_MODAL_JS END

      // --- Data load -----------------------------------------------------------
      async function load() {
        setStatus("Loading...");

        const t = getToken();
        if (!t) {
          setStatus("Sign in required");
          location.replace(LOGIN_PAGE);
          return;
        }

        // Reset
        $("readyTable").style.display = "none";
        $("readyEmpty").style.display = "none";
        $("historyTable").style.display = "none";
        $("historyEmpty").style.display = "none";

        $("kpiTotalReceived").textContent = "-";
        $("kpiTotalPending").textContent = "-";
        $("kpiCount").textContent = "-";

        // 1) Ready for payout (completed bookings not linked to payout)
        const r1 = await authFetch("/api/extranet/me/payout-ready", { method: "GET" });
        if (!r1.ok) throw new Error(`ready_failed_${r1.status}`);
        const readyJson = await r1.json();
        const readyRows = Array.isArray(readyJson.rows) ? readyJson.rows : [];

        if (!readyRows.length) {
          $("readyEmpty").style.display = "";
        } else {
          $("readyBody").innerHTML = readyRows.map(b => {
            const ref = String(b.bookingRef || "");
            const inD = fmtYmd(b.checkInDate);
            const outD = fmtYmd(b.checkOutDate);
            const stay = (inD && outD) ? `${inD} to ${outD}` : "-";
            const total = money(b.amountPaid || 0, b.currency || "USD");
            return `
              <tr>
                <td>
                  <button class="btn ghost" type="button" onclick="openBooking('${esc(ref)}')" style="padding:6px 10px;">
                    ${esc(ref)}
                  </button>
                </td>
                <td>${esc(stay)}</td>
                <td class="right">${esc(total)}</td>
                <td><span class="pill">Payment Ready</span></td>
              </tr>
            `;
          }).join("");
          $("readyTable").style.display = "";
        }

        // 2) Payment history (payouts)
        const r2 = await authFetch("/api/extranet/me/payouts", { method: "GET" });
        if (!r2.ok) throw new Error(`payouts_failed_${r2.status}`);
        const payJson = await r2.json();
        const payouts = Array.isArray(payJson.rows) ? payJson.rows : [];

        if (!payouts.length) {
          $("historyEmpty").style.display = "";
        } else {
          $("historyBody").innerHTML = payouts.map(p => {
            const id = Number(p.id || 0);
            const paidAt = p.paidAt ? fmtYmd(p.paidAt) : (p.createdAt ? fmtYmd(p.createdAt) : "-");
            const conf = p.confirmationNumber ? String(p.confirmationNumber) : "-";
            const amt = (p.amountNet == null) ? "-" : money(p.amountNet, p.currency || "USD");
            const cnt = Number(p.bookingCount || 0) || 0;
            return `
              <tr>
                <td>${esc(paidAt)}</td>
                <td><span class="muted">${esc(conf)}</span></td>
                <td class="right">${esc(amt)}</td>
                <td>${cnt}</td>
                <td>
                  <button class="btn ghost" type="button" onclick="openPayout(${id})">View</button>
                </td>
              </tr>
            `;
          }).join("");
          $("historyTable").style.display = "";
        }

        // KPIs
        const totalReceived = payouts
          .filter(p => String(p.status || "").toUpperCase() === "PAID" && p.amountNet != null)
          .reduce((s, p) => s + Number(p.amountNet || 0), 0);

        const currency = payouts[0]?.currency || "USD";
        $("kpiTotalReceived").textContent = payouts.length ? money(totalReceived, currency) : "-";
        $("kpiTotalPending").textContent = readyRows.length ? `${readyRows.length} booking${readyRows.length === 1 ? "" : "s"}` : "-";
        $("kpiCount").textContent = payouts.length ? String(payouts.length) : "-";

        setStatus("Ready");
      }

      // Boot
      load().catch((e) => {
        console.error("[payments] load error", e);
        if (String(e && e.message) === "NO_TOKEN") location.replace(LOGIN_PAGE);
        setStatus("Failed to load");
      });
    })();
  </script>
</body>
</html>
