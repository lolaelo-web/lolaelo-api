<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lolaelo â€¢ Rooms & Availability</title>
  <style>
    :root{
      --bg: #0b1220;
      --panel: #0f172a;
      --muted: #94a3b8;
      --text: #e2e8f0;
      --brand: #ff6a3d;
      --ok: #16a34a;
      --warn: #eab308;
      --err: #ef4444;
      --chip: #111827;
      --chip-border: #1f2937;
      --sep: rgba(148,163,184,.25);
      --focus: #3b82f6;
      --shadow: 0 10px 25px rgba(0,0,0,.35);
      --radius: 14px;
    }
    html,body{height:100%;}
    body{
      margin:0; background:var(--bg); color:var(--text); font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
    }
    /* Layout */
    .wrap{display:grid; grid-template-columns: 280px 1fr; height:100%;}
    aside{background:var(--panel); border-right:1px solid #0b1220; padding:16px 12px;}
    main{padding:16px; overflow:auto;}
    header{display:flex; align-items:center; justify-content:space-between; padding:8px 16px; border-bottom:1px solid #0b1220; background:linear-gradient(to bottom, rgba(255,255,255,.02), rgba(255,255,255,0)); position:sticky; top:0; z-index:5}
    .brand{display:flex; gap:10px; align-items:center; font-weight:600}
    .brand .dot{width:10px; height:10px; background:var(--brand); border-radius:999px; box-shadow:0 0 0 3px rgba(255,106,61,.15)}
    .actions{display:flex; gap:8px}
    .btn{background:#111827; color:var(--text); border:1px solid #1f2937; padding:8px 12px; border-radius:10px; cursor:pointer}
    .btn.primary{background:var(--brand); border-color:transparent; color:black; font-weight:600}
    .btn:focus-visible{outline:2px solid var(--focus); outline-offset:2px}

    /* Sidebar rooms list */
    .rooms-hdr{font-size:12px; color:var(--muted); letter-spacing:.06em; text-transform:uppercase; margin:6px 8px}
    .room-list{list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:6px}
    .room-item{display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-radius:10px; background:#0b1220; border:1px solid #101827; cursor:pointer}
    .room-item:hover{border-color:#243244}
    .room-item.is-selected{outline:2px solid var(--brand); outline-offset:0}
    .room-item .name{font-weight:600}
    .room-item .meta{color:var(--muted); font-size:12px}

    /* Calendar grid */
    .cal-wrap{display:grid; grid-template-rows:auto 1fr; gap:12px}
    .days{display:grid; grid-auto-flow:column; grid-auto-columns:minmax(120px,1fr); gap:0; border:1px solid #0e1625; border-radius:var(--radius); overflow:hidden; box-shadow:var(--shadow)}
    .day{background:#0d1424; padding:10px; min-height:160px; position:relative}
    .day + .day{border-left:1px solid var(--sep)} /* vertical day separators */
    .day .date{display:flex; align-items:baseline; gap:6px; margin-bottom:8px}
    .date .dow{color:var(--muted); font-size:12px}
    .date .dom{font-weight:700; letter-spacing:.02em}

    /* Chips row */
    .chips{display:grid; gap:8px}
    .chip{display:grid; grid-template-columns: 1fr; gap:4px; background:var(--chip); border:1px solid var(--chip-border); border-radius:12px; padding:8px}
    .chip .label{font-size:11px; letter-spacing:.04em; text-transform:uppercase; color:var(--muted)}

    /* Editable input inside chip */
    .chip input[type="number"],
    .chip input[type="text"]{
      width:100%;
      box-sizing:border-box;
      background:#0a0f1a;
      color:var(--text);
      border:1px solid #223047; /* tighter alignment stays inside */
      border-radius:10px;
      padding:10px 10px;
      font-size:14px;
      line-height:1.2;
      outline: none;
      transition: border .15s ease, box-shadow .15s ease, background .15s ease;
    }
    .chip input::placeholder{color:#52607a}
    .chip input:hover{border-color:#3a4e6c}
    .chip input:focus{border-color:var(--focus); box-shadow:0 0 0 3px rgba(59,130,246,.15); background:#0b1220}

    /* Remove number spinners for consistent layout */
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button{ -webkit-appearance:none; margin:0 }
    input[type=number]{ -moz-appearance:textfield }

    /* Inline status + toasts */
    .status{margin-top:8px; color:var(--muted); font-size:12px}
    .toast{position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#0b1220; border:1px solid #20314a; padding:12px 16px; border-radius:12px; box-shadow:var(--shadow); z-index:9999; opacity:0; pointer-events:none; transition:opacity .2s ease, transform .2s ease}
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-2px); pointer-events:auto}
    .toast.ok{border-color:rgba(22,163,74,.35)}
    .toast.err{border-color:rgba(239,68,68,.35)}

    /* Selected room outline around calendar */
    .calendar-selected{box-shadow:0 0 0 2px var(--brand) inset}

    /* Responsive safety: keep inputs inside chips at small widths */
    @media (max-width: 900px){
      .wrap{grid-template-columns: 1fr}
      aside{position:sticky; top:0; z-index:4}
    }
  </style>
</head>
<body>
  <header>
    <div class="brand"><span class="dot"></span> Rooms & Availability</div>
    <div class="actions">
      <button class="btn" id="refreshBtn" title="Reload data">Reload</button>
      <button class="btn primary" id="bulkSaveBtn" title="Save visible changes">Save Changes</button>
    </div>
  </header>
  <div class="wrap">
    <aside>
      <div class="rooms-hdr">Room Types</div>
      <ul class="room-list" id="roomList">
        <!-- Populated by JS -->
      </ul>
    </aside>
    <main>
      <div class="cal-wrap">
        <div class="status" id="status">Select a room type to edit inventory & prices.</div>
        <div class="days" id="days">
          <!-- Populated by JS with .day columns; each has .chips and inputs -->
        </div>
      </div>
    </main>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // --- Helpers ---
    const API_BASE = "/extranet/property/rooms"; // relies on same-origin proxy; change to absolute if needed
    const token = localStorage.getItem("partnerToken") || "";
    const authHeaders = () => ({
      "Content-Type": "application/json",
      ...(token ? { Authorization: `Bearer ${token}` } : {})
    });

    const $ = (q, el=document) => el.querySelector(q);
    const $$ = (q, el=document) => Array.from(el.querySelectorAll(q));

    function showToast(msg, kind="ok"){
      const t = $("#toast");
      t.className = `toast show ${kind}`;
      t.textContent = msg;
      setTimeout(()=>{ t.classList.remove("show") }, 2200);
    }

    function fmtCurrency(v){
      if (v === "" || v === null || v === undefined) return "";
      const num = Number(String(v).replace(/[^0-9.-]/g, ""));
      if (Number.isNaN(num)) return "";
      return new Intl.NumberFormat(undefined, { style: "currency", currency: "USD", minimumFractionDigits: 2 }).format(num);
    }

    function parseCurrency(text){
      if (text === "") return "";
      const num = Number(String(text).replace(/[^0-9.-]/g, ""));
      return Number.isNaN(num) ? "" : String(num.toFixed(2));
    }

    // On-focus: show raw numeric; on-blur: format as $X.XX
    function attachCurrencyHandlers(input){
      input.addEventListener("focus", () => {
        const raw = parseCurrency(input.value);
        input.value = raw;
        input.setSelectionRange(input.value.length, input.value.length);
      });
      input.addEventListener("blur", () => {
        input.value = fmtCurrency(input.value);
      });
      // Initial formatting if value looks numeric
      if (input.value && /^[$\d]/.test(input.value)) input.value = fmtCurrency(input.value);
    }

    // Keep inputs visually inside chips at every zoom/DP setting
    function tightenInputs(scope=document){
      $$('.chip input', scope).forEach(inp => {
        inp.style.maxWidth = '100%';
      });
    }

    // --- Data & Render ---
    let state = {
      rooms: [],
      selectedRoomId: null,
      start: new Date(),
      days: 14,
      inventoryByDate: {},
      pricesByDate: {}
    };

    function iso(d){ return d.toISOString().slice(0,10); }
    function addDays(d, n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
    function dow(d){ return d.toLocaleDateString(undefined, { weekday: 'short' }); }

    async function fetchRooms(){
      const r = await fetch(API_BASE + '/', { headers: authHeaders() });
      if(!r.ok){ throw new Error('Rooms list failed'); }
      state.rooms = await r.json();
      renderRooms();
    }

    function renderRooms(){
      const ul = $("#roomList");
      ul.innerHTML = '';
      state.rooms.forEach(rt => {
        const li = document.createElement('li');
        li.className = 'room-item' + (rt.id === state.selectedRoomId ? ' is-selected' : '');
        li.dataset.id = rt.id;
        li.innerHTML = `<div class="name">${rt.name}</div><div class="meta">ID ${rt.id}</div>`;
        li.addEventListener('click', async ()=>{
          state.selectedRoomId = rt.id;
          $$('.room-item').forEach(n=>n.classList.toggle('is-selected', Number(n.dataset.id)===rt.id));
          $("#days").classList.add("calendar-selected");
          await loadCalendar(rt.id);
        });
        ul.appendChild(li);
      });
      if (!state.selectedRoomId && state.rooms[0]){
        state.selectedRoomId = state.rooms[0].id;
        renderRooms();
      }
    }

    async function loadCalendar(roomTypeId){
      const startISO = iso(state.start);
      const endISO = iso(addDays(state.start, state.days-1));
      const invUrl = `${API_BASE}/${roomTypeId}/inventory?start=${startISO}&end=${endISO}`;
      const priceUrl = `${API_BASE}/${roomTypeId}/prices?start=${startISO}&end=${endISO}`;
      const [ri, rp] = await Promise.all([
        fetch(invUrl, { headers: authHeaders() }).then(r=>r.json()),
        fetch(priceUrl, { headers: authHeaders() }).then(r=>r.json()),
      ]);
      state.inventoryByDate = Object.fromEntries(ri.map(x=>[x.date, x]));
      state.pricesByDate = Object.fromEntries(rp.map(x=>[x.date + '|' + (x.ratePlanId||'base'), x]));
      renderCalendar();
      showToast(`Loaded ${state.days} days`, 'ok');
    }

    function renderCalendar(){
      const daysEl = $("#days");
      daysEl.innerHTML = '';
      for(let i=0;i<state.days;i++){
        const d = addDays(state.start, i);
        const dISO = iso(d);
        const inv = state.inventoryByDate[dISO] || { roomsOpen: '', minStay: '', isClosed: false };
        const price = state.pricesByDate[dISO+'|base'] || { price: '' };

        const col = document.createElement('div');
        col.className = 'day';
        col.innerHTML = `
          <div class="date"><span class="dow">${dow(d)}</span><span class="dom">${d.getDate()}</span></div>
          <div class="chips">
            <div class="chip">
              <div class="label">Open</div>
              <input type="number" inputmode="numeric" placeholder="0" class="open-input" data-date="${dISO}" value="${inv.roomsOpen ?? ''}">
            </div>
            <div class="chip">
              <div class="label">Min Stay</div>
              <input type="number" inputmode="numeric" placeholder="0" class="minstay-input" data-date="${dISO}" value="${inv.minStay ?? ''}">
            </div>
            <div class="chip">
              <div class="label">Price</div>
              <input type="text" placeholder="$0.00" class="price-input" data-date="${dISO}" value="${price.price!=='' && price.price!=null ? String(price.price) : ''}">
            </div>
          </div>
        `;
        daysEl.appendChild(col);
      }

      // Attach handlers
      $$('.price-input', daysEl).forEach(attachCurrencyHandlers);
      tightenInputs(daysEl);
    }

    // --- Save flow (minimal) ---
    async function saveVisible(){
      if (!state.selectedRoomId) return;
      const roomTypeId = state.selectedRoomId;
      const startISO = iso(state.start);
      const endISO = iso(addDays(state.start, state.days-1));

      // Gather bulk payloads
      const invBulk = [];
      const priceBulk = [];

      $$('.day').forEach(col => {
        const date = $('[data-date]', col)?.dataset.date;
        if (!date) return;
        const open = $('.open-input', col)?.value ?? '';
        const minStay = $('.minstay-input', col)?.value ?? '';
        const priceEl = $('.price-input', col);
        let price = parseCurrency(priceEl?.value || '');

        if (open !== '' || minStay !== ''){
          invBulk.push({ date, roomsOpen: open===''?null:Number(open), minStay: minStay===''?null:Number(minStay), isClosed: false });
        }
        if (price !== ''){
          priceBulk.push({ date, price: Number(price), ratePlanId: null });
        }
      });

      const status = $('#status');
      const t0 = performance.now();

      try{
        let invRes = { upserted: 0 }, priceRes = { upserted: 0 };
        if (invBulk.length){
          const r = await fetch(`${API_BASE}/${roomTypeId}/inventory/bulk`, { method:'POST', headers: authHeaders(), body: JSON.stringify({ start: startISO, end: endISO, items: invBulk }) });
          if(!r.ok) throw new Error('Inventory save failed');
          invRes = await r.json();
        }
        if (priceBulk.length){
          const r = await fetch(`${API_BASE}/${roomTypeId}/prices/bulk`, { method:'POST', headers: authHeaders(), body: JSON.stringify({ start: startISO, end: endISO, items: priceBulk }) });
          if(!r.ok) throw new Error('Prices save failed');
          priceRes = await r.json();
        }
        const dt = Math.max(0, 250 - (performance.now() - t0));
        await new Promise(res => setTimeout(res, dt)); // ensure UI feels snappy but not flickery
        await loadCalendar(roomTypeId);
        status.textContent = `Saved: ${invBulk.length} inventory edits, ${priceBulk.length} price edits.`;
        showToast('Changes saved', 'ok');
      }catch(err){
        console.error(err);
        showToast('Save failed', 'err');
      }
    }

    // --- Boot ---
    $('#bulkSaveBtn').addEventListener('click', saveVisible);
    $('#refreshBtn').addEventListener('click', ()=> state.selectedRoomId ? loadCalendar(state.selectedRoomId) : fetchRooms());

    (async function init(){
      if (!token){
        $('#status').textContent = 'Not signed in. Use OTP: /login/request-code â†’ /login/verify-code';
      }
      try{
        await fetchRooms();
        if (state.selectedRoomId){ await loadCalendar(state.selectedRoomId); }
      }catch(e){
        console.error(e);
        $('#status').textContent = 'Failed to load data.';
      }
    })();
  </script>
</body>
</html>
