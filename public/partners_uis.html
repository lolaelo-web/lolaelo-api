<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Partners · Unified Inventory Search (UIS)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><rect width='16' height='16' fill='%234f8cff'/></svg>" type="image/svg+xml">

  <!-- Style system copied from partners_rooms.html for pixel-consistent UI -->
  <style>
    :root{
      --bg:#0b0d12; --panel:#121621; --panel-2:#161b28; --text:#e7ecf3; --muted:#98a3b3;
      --brand:#4f8cff; --accent:#ffb86b; --ok:#2ecc71; --warn:#f39c12; --err:#e74c3c;
      --border:#222a3a; --chip:#1e2536; --header-h:56px;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; background:var(--bg); color:var(--text);
      font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial; }

    /* Header bar (same as rooms page) */
    header{ display:flex; gap:12px; align-items:center; padding:14px 18px; height:var(--header-h);
      border-bottom:1px solid var(--border); background:var(--panel); position:sticky; top:0; z-index:5; }
    header h1{ font-size:16px; margin:0; letter-spacing:.2px; }
    .spacer{ flex:1; }
    .header-actions{ display:flex; gap:8px; align-items:center; }
    .header-actions .note{ white-space:nowrap; }

    /* Controls + layout */
    .wrap{ display:flex; flex-direction:column; min-height:calc(100vh - var(--header-h)); }
    .controls{ display:flex; flex-wrap:wrap; gap:8px; padding:10px;
      border-bottom:1px solid var(--border); background:var(--panel); align-items:center; }
    .controls .group{ display:flex; gap:6px; align-items:center; }
    .controls .group label{ color:var(--muted); font-size:12px; }
    .controls input,.controls select{ background:var(--chip); border:1px solid var(--border);
      color:var(--text); padding:8px 10px; border-radius:8px; }
    .controls button.secondary{ background:transparent; border:1px solid var(--border); color:var(--text); }

    /* Table */
    .content{ padding:12px; background:var(--panel-2); }
    table{ width:100%; border-collapse:separate; border-spacing:0; }
    thead th{ text-align:left; font-size:12px; color:var(--muted); padding:10px; border-bottom:1px solid var(--border); position:sticky; top:calc(var(--header-h) + 49px); background:var(--panel-2); }
    tbody td{ padding:10px; border-bottom:1px solid var(--border); font-variant-numeric:tabular-nums; }
    .badge{ display:inline-block; padding:2px 6px; border-radius:8px; font-size:11px; border:1px solid var(--border); background:var(--chip); color:var(--muted); }
    .badge.direct{ color:#84d6a2; }
    .badge.pms{ color:#86b5ff; }

    /* Buttons (identical to rooms page) */
    button{ background:var(--brand); color:#fff; border:0; border-radius:8px; padding:8px 12px; cursor:pointer; }
    button.secondary{ background:transparent; border:1px solid var(--border); color:var(--text); }
    .btn-accent{ background:var(--accent); color:#0b0d12; }
    .btn-accent:hover{ filter:brightness(1.05); }
    #save{ background:var(--accent); color:#0b0d12; }
    #save:disabled{ opacity:.6; cursor:not-allowed; }

    .note{ color:var(--muted); font-size:12px; }
    .ok{ color:var(--ok); } .warn{ color:var(--warn); } .error{ color:var(--err); }

    /* Source chip inside table cell */
    .src-cell{ display:flex; align-items:center; gap:8px; }
  </style>
</head>
<body>
  <header>
    <h1>Unified Inventory Search (UIS)</h1>
    <div class="spacer"></div>
    <div class="header-actions">
      <span id="status" class="note">Ready.</span>
      <span id="dirty-count" class="note">No changes</span>
      <button id="save" disabled>Save changes</button>
      <button id="back" class="secondary" onclick="location.href='/partners_app.html'">Back to menu</button>
    </div>
  </header>

  <!-- Controls strip (dates, guests, Search) -->
  <div class="controls">
    <div class="group">
      <label>Check-in</label>
      <input type="date" id="start" />
    </div>
    <div class="group">
      <label>Check-out</label>
      <input type="date" id="end" />
    </div>
    <div class="group">
      <label>Guests</label>
      <input type="number" min="1" id="guests" value="2" />
    </div>
    <div class="group">
      <button id="search" class="secondary" type="button">Search</button>
    </div>
  </div>

  <div class="content">
    <table aria-label="UIS results">
      <thead>
        <tr>
          <th style="width:120px;">Date</th>
          <th style="width:100px;">Source</th>
          <th>Room</th>
          <th style="width:80px;">Max</th>
          <th style="width:120px;">Price</th>
          <th style="width:100px;">RatePlan</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>

<script>
(() => {
  // Copy of rooms page status helpers for consistency
  const statusEl = document.getElementById('status');
  const dirtyEl  = document.getElementById('dirty-count');
  const saveBtn  = document.getElementById('save');

  function setStatus(msg, cls=""){ statusEl.className="note "+cls; statusEl.textContent=msg; }
  function setSaved(){ dirtyEl.textContent = "No changes"; saveBtn.disabled = true; }
  setSaved(); // UIS has nothing to persist

  // Token: accept #token=... once, store as localStorage.partnerToken
  (function ensureToken(){
    const hash = new URLSearchParams(location.hash.slice(1));
    const t = hash.get('token');
    if (t) localStorage.setItem('partnerToken', t);
  })();

  const token =
    localStorage.getItem("partnerToken") ||
    localStorage.getItem("lolaelo_session") || "";

  const H = token
    ? { "Authorization":"Bearer "+token, "x-partner-token":token }
    : {};

  // Defaults similar to partners_uis prior behavior
  const startInp = document.getElementById('start');
  const endInp   = document.getElementById('end');
  const guestsInp= document.getElementById('guests');
  const rowsBody = document.getElementById('rows');

  const todayISO = ()=>new Date().toISOString().slice(0,10);
  function addDaysISO(iso, n){ const d=new Date(iso+"T00:00:00Z"); d.setUTCDate(d.getUTCDate()+n); return d.toISOString().slice(0,10); }

  // Initialize date inputs (3 nights window)
  const s0 = todayISO();
  const e0 = addDaysISO(s0, 3);
  startInp.value = startInp.value || s0;
  endInp.value   = endInp.value   || e0;

  function money(v){ const n=Number(v); return Number.isFinite(n) ? "$"+n.toFixed(2) : ""; }

  // INSERT — ANCHOR: MOCK_UIS_DATA
  function enumerateDates(startISO, endISO){
    const out = [];
    const ONE = 86400000;
    const s = new Date(startISO + "T00:00:00Z");
    const e = new Date(endISO   + "T00:00:00Z");
    for (let d = new Date(s); d < e; d = new Date(d.getTime() + ONE)){
      out.push(d.toISOString().slice(0,10));
    }
    return out;
  }

  // 6 mock hotels (Siargao, Philippines) for QA — treated as "direct/extranet" source
  const UIS_MOCK_HOTELS = [
    { id: 101, name: "Cloud 9 Surf House",     area: "General Luna", maxGuests: 2, base: 120 },
    { id: 102, name: "Naked Island Bungalows", area: "Dapa",         maxGuests: 3, base:  95 },
    { id: 103, name: "Daku Beach Resort",      area: "General Luna", maxGuests: 4, base: 150 },
    { id: 104, name: "Sohoton Cove Lodge",     area: "Socorro",      maxGuests: 2, base: 110 },
    { id: 105, name: "Pacifico Tides Villas",  area: "San Isidro",   maxGuests: 2, base: 175 },
    { id: 106, name: "Magpupungko Beach Huts", area: "Pilar",        maxGuests: 2, base:  80 },
  ];

  // Generate mock UIS results for a given date window and guest count
  function getMockResults(startISO, endISO, guests){
    const dates = enumerateDates(startISO, endISO); // nightly results
    const extranet = [];

    for (const h of UIS_MOCK_HOTELS){
      if (guests > (h.maxGuests || 2)) continue; // simple capacity filter

      for (const d of dates){
        const dow = new Date(d + "T00:00:00Z").getUTCDay();
        // Weekend bumps: Fri/Sat +15%, Sun +10%
        const weekendBump = (dow === 5 || dow === 6) ? 1.15 : (dow === 0 ? 1.10 : 1.00);
        const price = h.base * weekendBump;

        extranet.push({
          date: d,
          source: "direct",              // shown as "Direct" badge in table
          hotelId: h.id,
          name: `${h.name} · ${h.area}`, // displays in "Room" column for now
          maxGuests: h.maxGuests,
          price: Number(price.toFixed(2)),
          ratePlanId: "STD"
        });
      }
    }

    return { extranet, pms: [] };
  }

  function rowHtml(r){
    const src = (r.source||"").toLowerCase();
    const badgeCls = src === "pms" ? "badge pms" : "badge direct";
    const max = Number.isFinite(Number(r.maxGuests)) ? Number(r.maxGuests) : "-";
    const price = money(r.price);
    const rp = r.ratePlanId || r.ratePlanName || "-";
    return `<tr>
      <td>${r.date}</td>
      <td><div class="src-cell"><span class="${badgeCls}">${src === "pms" ? "PMS" : "Direct"}</span></div></td>
      <td>${r.name ?? ""}</td>
      <td>${max}</td>
      <td>${price}</td>
      <td>${rp}</td>
    </tr>`;
  }

  async function runSearch(){
    const start = startInp.value;
    const end   = endInp.value;
    const guests= Math.max(1, parseInt(guestsInp.value||"2",10));

    if (!start || !end || end <= start){
      setStatus("Enter a valid date window (end must be after start).", "warn");
      return;
    }
    setStatus("Searching…");

    try{
      // PMS mock should mirror Direct inventory when mappings exist
      const url = `/extranet/pms/uis/search?start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}&guests=${guests}`;
      const r = await fetch(url, { headers: H });
      if (!r.ok){
        setStatus(`Search failed (${r.status})`, "error");
        return;
      }
      const x = await r.json();
      const rows = []
        .concat(Array.isArray(x.extranet) ? x.extranet : [])
        .concat(Array.isArray(x.pms) ? x.pms : []);
      rowsBody.innerHTML = rows.map(rowHtml).join("") || `<tr><td colspan="6" class="note">No results.</td></tr>`;
      setStatus(`Found ${rows.length} result${rows.length===1?"":"s"}.`, "ok");
    }catch(e){
      console.error(e);
      setStatus("Search error", "error");
    }
  }

  document.getElementById('search').addEventListener('click', runSearch);

  // Auto-run once
  runSearch();
})();
</script>
</body>
</html>
