<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PMS Admin — Connections & Mappings</title>
  <script>
    // --- tiny helper: el() ---
    const el = (sel, root=document) => root.querySelector(sel);
    const els = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    // --- state ---
    const state = {
      token: localStorage.partnerToken || "",
      whoami: null,
      orgName: null,
      connections: [],
      mappings: [],
    };

    // --- HTTP helpers ---
    function headers(json=true){
      const h = { 'Authorization': 'Bearer ' + (state.token||''), 'x-partner-token': (state.token||'') };
      if (json) h['Content-Type'] = 'application/json';
      return h;
    }
    async function apiGet(path){
      const r = await fetch(path, { headers: headers(false) });
      if (!r.ok) throw new Error(await r.text());
      return r.json();
    }
    async function apiJson(method, path, body){
      const r = await fetch(path, { method, headers: headers(true), body: JSON.stringify(body||{}) });
      if (!r.ok){
        let msg = '';
        try { msg = JSON.stringify(await r.json()); } catch { msg = await r.text(); }
        throw new Error(msg || (r.status+':'+r.statusText));
      }
      try { return await r.json(); } catch { return {}; }
    }

    // --- UI helpers ---
    function setStatus(text, kind='info'){
      const box = el('#status');
      box.textContent = text;
      box.className = 'status ' + kind;
    }
    function fmtIso(dt){
      if (!dt) return '';
      try { return new Date(dt).toISOString().slice(0,19).replace('T',' '); } catch { return dt; }
    }

    // --- token & org controls ---
    function loadTokenFromHash(){
      const m = location.hash.match(/[#&]token=([^&]+)/);
      if (m && m[1]){
        state.token = decodeURIComponent(m[1]);
        localStorage.partnerToken = state.token;
      }
      el('#partnerToken').value = state.token;
    }
    function saveToken(){
      state.token = el('#partnerToken').value.trim();
      if (!state.token){ setStatus('Token cleared. Set a valid token.', 'warn'); return; }
      localStorage.partnerToken = state.token;
      setStatus('Token saved to localStorage.','ok');
      bootstrap();
    }

    async function loadWhoAmI(){
      state.whoami = await apiGet('/extranet/pms/whoami');
      el('#whoami').textContent = `partnerId=${state.whoami?.partnerId ?? '—'}`;
    }

    // Try to show company/property name instead of partnerId (best-effort)
    async function loadOrgName(){
      const candidates = [
        '/extranet/property/profile',
        '/extranet/property/__profile',
        '/extranet/property/__debug',
      ];
      for (const path of candidates){
        try {
          const j = await apiGet(path);
          const name = j?.companyName || j?.name || j?.propertyName || j?.property?.name || null;
          if (name){ state.orgName = String(name); break; }
        } catch(_){}
      }
      const label = state.orgName ? state.orgName : (state.whoami ? `partnerId=${state.whoami.partnerId}` : '—');
      el('#orgLabel').textContent = label;
      el('#orgLabel').title = state.orgName ? `Partner ${state.whoami?.partnerId}` : '';
    }

    async function loadConnections(){
      state.connections = await apiGet('/extranet/pms/connections');
      renderConnections();
    }
    async function loadMappings(){
      state.mappings = await apiGet('/extranet/pms/mappings');
      renderMappings();
    }

    // --- actions: connections ---
    async function upsertConnection(ev){
      ev?.preventDefault();
      const f = ev.target.closest('form');
      const payload = {
        provider: el('[name=provider]', f).value.trim() || 'CLOUDBEDS',
        mode: el('[name=mode]', f).value.trim() || 'mock',
        status: el('[name=status]', f).value.trim() || 'TESTING',
        scope: el('[name=scope]', f).value.trim() || null,
      };
      const row = await apiJson('POST','/extranet/pms/connections', payload);
      setStatus(`Connection upserted (id=${row.id}, status=${row.status}).`, 'ok');
      await loadConnections();
    }
    async function updateConnection(id){
      const rowEl = el(`[data-conn-id="${id}"]`);
      const payload = {
        mode: el('[data-f=mode]', rowEl).value.trim() || undefined,
        status: el('[data-f=status]', rowEl).value.trim() || undefined,
        scope: el('[data-f=scope]', rowEl).value.trim() || undefined,
        accessToken: el('[data-f=accessToken]', rowEl).value || undefined,
        refreshToken: el('[data-f=refreshToken]', rowEl).value || undefined,
        tokenExpiresAt: el('[data-f=tokenExpiresAt]', rowEl).value || undefined,
      };
      const row = await apiJson('PATCH',`/extranet/pms/connections/${id}`, payload);
      setStatus(`Connection ${id} updated (status=${row.status}).`, 'ok');
      await loadConnections();
    }
    async function testConnection(id){
      const r = await apiJson('POST',`/extranet/pms/connections/${id}/test`,{});
      setStatus(`Test ${r.ok?'ok':'fail'} for connection ${id}.`, r.ok?'ok':'error');
      await loadConnections();
    }
    async function deleteConnection(id){
      if (!confirm(`Delete connection ${id}? This also removes mappings.`)) return;
      await apiJson('DELETE',`/extranet/pms/connections/${id}`);
      setStatus(`Connection ${id} deleted.`, 'ok');
      await Promise.all([loadConnections(), loadMappings()]);
    }

    // --- actions: mappings ---
    async function createMapping(ev){
      ev?.preventDefault();
      const f = ev.target.closest('form');
      const payload = {
        pmsConnectionId: Number(el('[name=pmsConnectionId]', f).value),
        remoteRoomId: el('[name=remoteRoomId]', f).value.trim(),
        remoteRatePlanId: el('[name=remoteRatePlanId]', f).value.trim() || null,
        localRoomTypeId: Number(el('[name=localRoomTypeId]', f).value) || null,
        localRatePlanId: Number(el('[name=localRatePlanId]', f).value) || null,
        currency: el('[name=currency]', f).value.trim() || 'USD',
        active: el('[name=active]', f).checked,
      };
      const row = await apiJson('POST','/extranet/pms/mappings', payload);
      setStatus(`Mapping created (id=${row.id}).`, 'ok');
      await loadMappings();
    }
    async function updateMapping(id){
      const rowEl = el(`[data-map-id="${id}"]`);
      const payload = {
        localRoomTypeId: Number(el('[data-f=localRoomTypeId]', rowEl).value)||null,
        localRatePlanId: Number(el('[data-f=localRatePlanId]', rowEl).value)||null,
        currency: el('[data-f=currency]', rowEl).value.trim()||null,
        active: el('[data-f=active]', rowEl).checked,
      };
      const row = await apiJson('PATCH',`/extranet/pms/mappings/${id}`, payload);
      setStatus(`Mapping ${id} updated.`, 'ok');
      await loadMappings();
    }
    async function deleteMapping(id){
      if (!confirm(`Delete mapping ${id}?`)) return;
      await apiJson('DELETE',`/extranet/pms/mappings/${id}`);
      setStatus(`Mapping ${id} deleted.`, 'ok');
      await loadMappings();
    }

    // --- renderers ---
    function renderConnections(){
      const tbody = el('#connRows');
      tbody.innerHTML = '';
      for (const c of state.connections){
        const tr = document.createElement('tr');
        tr.dataset.connId = String(c.id);
        tr.innerHTML = `
          <td class="mono">${c.id}</td>
          <td>${c.provider}</td>
          <td><input data-f="mode" value="${c.mode||''}"/></td>
          <td><input data-f="status" value="${c.status||''}"/></td>
          <td><input data-f="scope" value="${c.scope||''}"/></td>
          <td>
            <div class="token-col">
              <input data-f="accessToken" type="password" placeholder="accessToken" />
              <input data-f="refreshToken" type="password" placeholder="refreshToken" />
              <input data-f="tokenExpiresAt" type="datetime-local" />
            </div>
          </td>
          <td class="actions-col">
            <button class="btn btn-primary" onclick="updateConnection(${c.id})">Save</button>
            <button class="btn btn-secondary" onclick="testConnection(${c.id})">Test</button>
            <button class="btn btn-danger" onclick="deleteConnection(${c.id})">Delete</button>
          </td>`;
        tbody.appendChild(tr);
      }
    }
    function renderMappings(){
      const tbody = el('#mapRows');
      tbody.innerHTML = '';
      for (const m of state.mappings){
        const tr = document.createElement('tr');
        tr.dataset.mapId = String(m.id);
        tr.innerHTML = `
          <td class="mono">${m.id}</td>
          <td class="mono">${m.pmsConnectionId}</td>
          <td class="mono">${m.remoteRoomId}</td>
          <td><input data-f="localRoomTypeId" value="${m.localRoomTypeId??''}"/></td>
          <td><input data-f="localRatePlanId" value="${m.localRatePlanId??''}"/></td>
          <td><input data-f="currency" value="${m.currency||'USD'}"/></td>
          <td><input data-f="active" type="checkbox" ${m.active?'checked':''}/></td>
          <td class="actions-col">
            <button class="btn btn-primary" onclick="updateMapping(${m.id})">Save</button>
            <button class="btn btn-danger" onclick="deleteMapping(${m.id})">Delete</button>
          </td>`;
        tbody.appendChild(tr);
      }
    }

    // --- bootstrap ---
    async function bootstrap(){
      try{
        loadTokenFromHash();
        if (!state.token){ setStatus('Set a partner token to begin.', 'warn'); return; }
        await loadWhoAmI();
        await loadOrgName();
        await Promise.all([loadConnections(), loadMappings()]);
        setStatus('Ready', 'ok');
      }catch(e){ setStatus(String(e.message||e), 'error'); }
    }

    window.addEventListener('DOMContentLoaded', bootstrap);
    window.saveToken = saveToken;
    window.upsertConnection = upsertConnection;
    window.updateConnection = updateConnection;
    window.testConnection = testConnection;
    window.deleteConnection = deleteConnection;
    window.createMapping = createMapping;
    window.updateMapping = updateMapping;
    window.deleteMapping = deleteMapping;
  </script>
  <style>
    :root{
      --bg: #0f172a;          /* slate-900 like UIS */
      --card: #111827;        /* gray-900 */
      --text: #e5e7eb;        /* gray-200 */
      --muted: #94a3b8;       /* slate-400 */
      --border: #1f2937;      /* gray-800 */
      --primary: #3b82f6;     /* blue-500 */
      --primary-600: #2563eb; /* blue-600 */
      --danger: #ef4444;      /* red-500 */
      --ok: #22c55e;          /* green-500 */
      --warn: #f59e0b;        /* amber-500 */
      --input: #0b1222;       /* near bg */
    }
    *{ box-sizing:border-box }
    body { background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 20px; }
    h1 { font-size: 18px; margin:0 0 10px; }
    h2 { font-size: 15px; margin:14px 0 10px; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    input, button, select { padding:8px 10px; border:1px solid var(--border); border-radius:8px; font-size:14px; color:var(--text); background:var(--input); }
    input::placeholder{ color:var(--muted) }
    table { width:100%; border-collapse:collapse; table-layout: fixed; }
    th, td { border-bottom:1px solid var(--border); padding:8px; vertical-align:top; }
    th { text-align:left; color:var(--muted); font-weight:600; }
    .card { border:1px solid var(--border); background:var(--card); border-radius:12px; padding:12px; }
    .grid { display:grid; grid-template-columns: 1fr; gap:14px; }
    @media (min-width: 960px){ .grid { grid-template-columns: 1fr 1fr; } }
    .muted { color:var(--muted); font-size:12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .status { margin-top:12px; padding:8px 10px; border-radius:8px; display:inline-block; background:var(--border); }
    .status.ok { background: rgba(34,197,94,0.15); color:#bbf7d0; }
    .status.warn { background: rgba(245,158,11,0.15); color:#fde68a; }
    .status.error { background: rgba(239,68,68,0.15); color:#fecaca; }

    .btn{ cursor:pointer; border:none; border-radius:8px; padding:8px 10px; font-weight:600; }
    .btn-primary{ background:var(--primary); color:white; }
    .btn-primary:hover{ background:var(--primary-600); }
    .btn-secondary{ background:#475569; color:white; }
    .btn-danger{ background:var(--danger); color:white; }

    .token-col{ display:flex; flex-direction:column; gap:6px; }
    .token-col input{ width:100%; }

    .actions-col{ display:flex; flex-direction:column; gap:6px; min-width: 140px; }
    .actions-col .btn{ width:100%; }
    @media (min-width: 1100px){ .actions-col{ flex-direction:row; } }

    #header { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    #orgLabel { font-weight:600; }
  </style>
</head>
<body>
  <div id="header" class="row">
    <h1>PMS Admin — Connections & Mappings</h1>
    <div class="row">
      <span id="orgLabel" class="muted mono">—</span>
    </div>
  </div>

  <div class="row" style="margin-top:6px;">
    <input id="partnerToken" type="password" placeholder="partner session token" style="width:360px"/>
    <button class="btn btn-primary" onclick="saveToken()">Set token</button>
    <span id="whoami" class="muted mono">partnerId=—</span>
  </div>
  <div id="status" class="status">Loading…</div>

  <div class="grid" style="margin-top:16px;">
    <div class="card">
      <h2>Create / Upsert Connection</h2>
      <form onsubmit="upsertConnection(event)">
        <div class="row" style="margin-bottom:8px;">
          <input name="provider" placeholder="provider (e.g. CLOUDBEDS)" style="width:200px"/>
          <input name="mode" placeholder="mode (mock|live)" style="width:120px"/>
          <input name="status" placeholder="status (TESTING|CONNECTED|ERROR)" style="width:220px"/>
          <input name="scope" placeholder="scope (optional)" style="width:240px"/>
          <button class="btn btn-primary" type="submit">Upsert</button>
        </div>
        <div class="muted">Use the table below to set access/refresh tokens and expiry, then Save + Test.</div>
      </form>
    </div>

    <div class="card">
      <h2>Create Mapping</h2>
      <form onsubmit="createMapping(event)">
        <div class="row" style="margin-bottom:8px;">
          <input name="pmsConnectionId" placeholder="pmsConnectionId" style="width:140px"/>
          <input name="remoteRoomId" placeholder="remoteRoomId (e.g. R101)" style="width:180px"/>
          <input name="remoteRatePlanId" placeholder="remoteRatePlanId (e.g. BAR)" style="width:180px"/>
          <input name="localRoomTypeId" placeholder="localRoomTypeId" style="width:140px"/>
          <input name="localRatePlanId" placeholder="localRatePlanId (optional)" style="width:170px"/>
          <input name="currency" placeholder="currency (USD)" style="width:120px"/>
          <label class="row" style="gap:6px"><input name="active" type="checkbox" checked/> active</label>
          <button class="btn btn-primary" type="submit">Create</button>
        </div>
      </form>
    </div>
  </div>

  <div class="card" style="margin-top:16px;">
    <h2>Connections</h2>
    <table>
      <thead>
        <tr>
          <th style="width:60px">id</th>
          <th style="width:150px">provider</th>
          <th style="width:120px">mode</th>
          <th style="width:150px">status</th>
          <th>scope</th>
          <th style="width:420px">tokens</th>
          <th style="width:160px">actions</th>
        </tr>
      </thead>
      <tbody id="connRows"></tbody>
    </table>
  </div>

  <div class="card" style="margin-top:16px;">
    <h2>Mappings</h2>
    <table>
      <thead>
        <tr>
          <th style="width:60px">id</th>
          <th style="width:80px">conn</th>
          <th style="width:140px">remote</th>
          <th style="width:140px">local RT</th>
          <th style="width:140px">local RP</th>
          <th style="width:120px">currency</th>
          <th style="width:90px">active</th>
          <th style="width:160px">actions</th>
        </tr>
      </thead>
      <tbody id="mapRows"></tbody>
    </table>
  </div>

  <p class="muted" style="margin-top:14px;">Secrets aren’t logged. Token is read from <span class="mono">#token</span> once and stored in <span class="mono">localStorage.partnerToken</span>.</p>
</body>
</html>
