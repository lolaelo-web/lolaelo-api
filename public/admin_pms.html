<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Partners ¬∑ PMS Connections & Mappings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><rect width='16' height='16' fill='%234f8cff'/></svg>" type="image/svg+xml">

  <style>
    :root{
      --bg:#0b0d12; --panel:#121621; --panel-2:#161b28; --text:#e7ecf3; --muted:#98a3b3;
      --brand:#4f8cff; --accent:#ffb86b; --ok:#2ecc71; --warn:#f39c12; --err:#e74c3c;
      --border:#222a3a; --chip:#1e2536; --header-h:56px;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; background:var(--bg); color:var(--text);
      font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial; }

    header{ display:flex; gap:12px; align-items:center; padding:14px 18px; height:var(--header-h);
      border-bottom:1px solid var(--border); background:var(--panel); position:sticky; top:0; z-index:5; }
    header h1{ font-size:16px; margin:0; letter-spacing:.2px; }
    .spacer{ flex:1; }
    .header-actions{ display:flex; gap:8px; align-items:center; }
    .header-actions .note{ white-space:nowrap; }
    button{ background:var(--brand); color:#fff; border:0; border-radius:8px; padding:8px 12px; cursor:pointer; }
    button.secondary{ background:transparent; border:1px solid var(--border); color:var(--text); }
    .btn-accent{ background:var(--accent); color:#0b0d12; }
    .btn-accent:hover{ filter:brightness(1.05); }
    #save{ background:var(--accent); color:#0b0d12; }
    #save:disabled{ opacity:.6; cursor:not-allowed; }

    .note{ color:var(--muted); font-size:12px; }
    .ok{ color:var(--ok); } .warn{ color:var(--warn); } .error{ color:var(--err); }

    .wrap{ padding:12px; display:grid; gap:12px; background:var(--panel-2); }

    .card{ border:1px solid var(--border); border-radius:10px; background:var(--panel); }
    .card header{ background:transparent; border-bottom:1px solid var(--border); height:auto; padding:10px 12px; position:static; }
    .card h3{ font-size:14px; margin:0; }
    .card .body{ padding:12px; display:grid; gap:10px; }
    .card .footer{ display:flex; gap:8px; padding:10px 12px; border-top:1px solid var(--border); }
    .left-actions{ justify-content:flex-start; }

    .row{ display:flex; gap:8px; flex-wrap:wrap; }
    .row input,.row select{ background:var(--chip); border:1px solid var(--border); color:var(--text); padding:8px 10px; border-radius:8px; }
    .row label{ color:var(--muted); font-size:12px; }

    table{ width:100%; border-collapse:separate; border-spacing:0; }
    thead th{ text-align:left; font-size:12px; color:var(--muted); padding:10px; border-bottom:1px solid var(--border); }
    tbody td{ padding:10px; border-bottom:1px solid var(--border); vertical-align:middle; }
    td.actions{ white-space:nowrap; }

    .token-wrap{ display:flex; align-items:center; gap:8px; }
    .eye{ cursor:pointer; user-select:none; border:1px solid var(--border); background:var(--chip);
      padding:6px 8px; border-radius:8px; font-size:12px; }
    .pill{ display:inline-block; padding:2px 8px; border-radius:999px; background:var(--chip); border:1px solid var(--border); color:var(--muted); font-size:12px; }
  </style>
</head>
<body>
  <header>
    <h1>PMS Admin ‚Äî Connections & Mappings</h1>
    <div class="spacer"></div>
    <div class="header-actions">
      <span id="status" class="note">Ready.</span>
      <span id="dirty" class="note">No changes</span>
      <button id="save" disabled>Save changes</button>
      <button class="secondary" onclick="location.href='/partners_app.html'">Back to menu</button>
    </div>
  </header>

  <div class="wrap">
    <!-- Token + partner label -->
    <div class="card">
      <header><h3>Partner session</h3></header>
      <div class="body">
        <div class="row">
          <div class="token-wrap">
            <input id="token" placeholder="partner session token" style="min-width:320px" />
            <button class="eye" id="eye" type="button">üëÅ</button>
            <button class="btn-accent" id="set-token" type="button">Set token</button>
            <span id="partner-label" class="pill">partnerId=?</span>
          </div>
        </div>
      </div>
      <div class="footer left-actions">
        <span class="note">Tip: pass once via <code style="background:var(--chip); padding:2px 6px; border-radius:6px;">#token=&lt;value&gt;</code>. Stored as <code style="background:var(--chip); padding:2px 6px; border-radius:6px;">localStorage.partnerToken</code>.</span>
      </div>
    </div>

    <!-- Create / Upsert Connection -->
    <div class="card">
      <header><h3>Create / Upsert Connection</h3></header>
      <div class="body">
        <div class="row">
          <input id="provider" placeholder="provider (e.g. CLOUDBEDS)" />
          <input id="mode" placeholder="mode (mock|live)" />
          <input id="status-in" placeholder="status (TESTING|CONNECTED)" />
          <input id="scope" placeholder="scope (optional)" />
        </div>
      </div>
      <div class="footer left-actions">
        <button id="upsert" class="btn-accent" type="button">Upsert</button>
      </div>
    </div>

    <!-- Create Mapping -->
    <div class="card">
      <header><h3>Create Mapping</h3></header>
      <div class="body">
        <div class="row">
          <input id="map-conn" placeholder="pmsConnectionId" style="width:160px" />
          <input id="map-remote-room" placeholder="remoteRoomId (e.g. R101)" />
          <input id="map-remote-rp" placeholder="remoteRatePlanId (e.g. BAR)" />
          <input id="map-local-rt" placeholder="localRoomTypeId" style="width:160px" />
          <input id="map-local-rp" placeholder="localRatePlanId (optional)" />
          <input id="map-currency" placeholder="currency (USD)" style="width:140px" />
          <label><input type="checkbox" id="map-active" checked /> active</label>
        </div>
      </div>
      <div class="footer left-actions">
        <button id="create-map" class="btn-accent" type="button">Create</button>
      </div>
    </div>

    <!-- Connections table -->
    <div class="card">
      <header><h3>Connections</h3></header>
      <div class="body">
        <table id="conn-table">
          <thead>
            <tr>
              <th style="width:60px;">id</th>
              <th>provider</th>
              <th>mode</th>
              <th>status</th>
              <th>scope</th>
              <th style="width:220px;">accessToken</th>
              <th style="width:220px;">refreshToken</th>
              <th style="width:180px;">expiresAt</th>
              <th class="actions" style="width:220px;">actions</th>
            </tr>
          </thead>
          <tbody id="conn-rows"></tbody>
        </table>
      </div>
      <div class="footer left-actions">
        <span class="note">Use Save to persist tokens, then Test to validate connectivity.</span>
      </div>
    </div>

    <!-- Mappings table -->
    <div class="card">
      <header><h3>Mappings</h3></header>
      <div class="body">
        <table id="map-table">
          <thead>
            <tr>
              <th style="width:60px;">id</th>
              <th style="width:80px;">conn</th>
              <th style="width:140px;">remote</th>
              <th style="width:120px;">local RT</th>
              <th style="width:120px;">local RP</th>
              <th style="width:120px;">currency</th>
              <th style="width:80px;">active</th>
              <th class="actions" style="width:160px;">actions</th>
            </tr>
          </thead>
          <tbody id="map-rows"></tbody>
        </table>
      </div>
      <div class="footer left-actions">
        <span class="note">PMS mock mirrors Direct inventory for mapped local room types inside the query window.</span>
      </div>
    </div>
  </div>

<script>
(() => {
  // Status/dirty
  const statusEl = document.getElementById('status');
  const dirtyEl  = document.getElementById('dirty');
  const saveBtn  = document.getElementById('save');
  function setStatus(msg, cls=""){ statusEl.className="note "+cls; statusEl.textContent=msg; }
  function setSaved(){ dirtyEl.textContent="No changes"; saveBtn.disabled=true; }
  function setDirty(){ dirtyEl.textContent="Unsaved changes"; saveBtn.disabled=false; }
  setSaved();

  // Token handling + whoami + profile label
  (function ensureToken(){
    const hash = new URLSearchParams(location.hash.slice(1));
    const t = hash.get('token');
    if (t) localStorage.setItem('partnerToken', t);
  })();
  const tokenInput = document.getElementById('token');
  const eyeBtn     = document.getElementById('eye');
  const setTokenBtn= document.getElementById('set-token');
  const partnerLbl = document.getElementById('partner-label');

  // Initialize token field with masked value length
  const storedToken = localStorage.getItem('partnerToken') || '';
  tokenInput.value = storedToken ? '‚Ä¢'.repeat(Math.min(storedToken.length, 24)) : '';
  tokenInput.dataset.masked = '1';

  eyeBtn.addEventListener('click', () => {
    if (!storedToken) return;
    const masked = tokenInput.dataset.masked === '1';
    tokenInput.value = masked ? storedToken : '‚Ä¢'.repeat(Math.min(storedToken.length, 24));
    tokenInput.dataset.masked = masked ? '0' : '1';
  });

  setTokenBtn.addEventListener('click', ()=>{
    const raw = prompt("Paste your partner session token:") || "";
    if (!raw.trim()) return;
    localStorage.setItem('partnerToken', raw.trim());
    tokenInput.value = '‚Ä¢'.repeat(Math.min(raw.length, 24));
    tokenInput.dataset.masked = '1';
    initAuth().then(()=>refreshAll());
  });

  function authHeaders(){
    const t =
      localStorage.getItem("partnerToken") ||
      localStorage.getItem("lolaelo_session") || "";
    return t ? { "Authorization":"Bearer "+t, "x-partner-token":t } : {};
  }

  async function initAuth(){
    try{
      const w = await fetch('/extranet/pms/whoami', { headers: authHeaders() });
      if (w.ok){
        const js = await w.json();
        const pid = js.partnerId ?? '?';
        partnerLbl.textContent = `partnerId=${pid}`;
        // Try to fetch company name
        try{
          const prof = await fetch('/extranet/property/profile', { headers: authHeaders() });
          if (prof.ok){
            const pjs = await prof.json();
            if (pjs?.name) partnerLbl.textContent = `${pjs.name} ¬∑ partnerId=${pid}`;
          }
        }catch{}
      }else{
        partnerLbl.textContent = 'partnerId=?';
      }
    }catch{
      partnerLbl.textContent = 'partnerId=?';
    }
  }

  // Upsert connection
  document.getElementById('upsert').addEventListener('click', async ()=>{
    const body = {
      provider: (document.getElementById('provider').value||'CLOUDBEDS').trim(),
      mode: (document.getElementById('mode').value||'mock').trim(),
      status: (document.getElementById('status-in').value||'TESTING').trim(),
      scope: (document.getElementById('scope').value||null)
    };
    setStatus('Upserting‚Ä¶');
    const r = await fetch('/extranet/pms/connections', {
      method:'POST',
      headers: { 'Content-Type':'application/json', ...authHeaders() },
      body: JSON.stringify(body)
    });
    if (!r.ok){ setStatus(`Upsert failed (${r.status})`,'error'); return; }
    setStatus('Connection upserted.','ok'); await loadConnections();
  });

  // Create mapping
  document.getElementById('create-map').addEventListener('click', async ()=>{
    const body = {
      pmsConnectionId: Number(document.getElementById('map-conn').value||0),
      remoteRoomId: (document.getElementById('map-remote-room').value||'').trim(),
      remoteRatePlanId: (document.getElementById('map-remote-rp').value||'').trim() || null,
      localRoomTypeId: Number(document.getElementById('map-local-rt').value||0) || null,
      localRatePlanId: Number(document.getElementById('map-local-rp').value||0) || null,
      currency: (document.getElementById('map-currency').value||'USD').trim(),
      active: !!document.getElementById('map-active').checked
    };
    if (!body.pmsConnectionId || !body.remoteRoomId){ setStatus('Provide connection id and remoteRoomId','warn'); return; }
    setStatus('Creating mapping‚Ä¶');
    const r = await fetch('/extranet/pms/mappings', {
      method:'POST',
      headers: { 'Content-Type':'application/json', ...authHeaders() },
      body: JSON.stringify(body)
    });
    if (!r.ok){ setStatus(`Create mapping failed (${r.status})`,'error'); return; }
    setStatus('Mapping created.','ok'); await loadMappings();
  });

  // Tables render
  const connRows = document.getElementById('conn-rows');
  const mapRows  = document.getElementById('map-rows');

  async function loadConnections(){
    const r = await fetch('/extranet/pms/connections', { headers: authHeaders() });
    if (!r.ok){ setStatus(`Load connections failed (${r.status})`,'error'); return; }
    const rows = await r.json();
    connRows.innerHTML = rows.map(c => `
      <tr data-id="${c.id}">
        <td>${c.id}</td>
        <td>${c.provider}</td>
        <td><input value="${c.mode??''}" data-k="mode" /></td>
        <td><input value="${c.status??''}" data-k="status" /></td>
        <td><input value="${c.scope??''}" data-k="scope" /></td>
        <td><input value="${c.accessToken??''}" data-k="accessToken" /></td>
        <td><input value="${c.refreshToken??''}" data-k="refreshToken" /></td>
        <td><input type="datetime-local" value="${toLocalDT(c.tokenExpiresAt)}" data-k="tokenExpiresAt" /></td>
        <td class="actions">
          <button class="btn-accent" data-act="save">Save</button>
          <button class="secondary" data-act="test">Test</button>
          <button class="secondary" data-act="del">Delete</button>
        </td>
      </tr>
    `).join('') || `<tr><td colspan="9" class="note">No connections.</td></tr>`;
  }

  async function loadMappings(){
    const r = await fetch('/extranet/pms/mappings', { headers: authHeaders() });
    if (!r.ok){ setStatus(`Load mappings failed (${r.status})`,'error'); return; }
    const rows = await r.json();
    mapRows.innerHTML = rows.map(m => `
      <tr data-id="${m.id}">
        <td>${m.id}</td>
        <td>${m.pmsConnectionId}</td>
        <td>${esc(m.remoteRoomId)}${m.remoteRatePlanId?` ¬∑ ${esc(m.remoteRatePlanId)}`:''}</td>
        <td><input value="${m.localRoomTypeId??''}" data-k="localRoomTypeId" /></td>
        <td><input value="${m.localRatePlanId??''}" data-k="localRatePlanId" /></td>
        <td><input value="${m.currency??'USD'}" data-k="currency" /></td>
        <td><input type="checkbox" ${m.active?'checked':''} data-k="active" /></td>
        <td class="actions">
          <button class="btn-accent" data-act="save">Save</button>
          <button class="secondary" data-act="del">Delete</button>
        </td>
      </tr>
    `).join('') || `<tr><td colspan="8" class="note">No mappings.</td></tr>`;
  }

  // Helpers
  function esc(s){ return String(s??'').replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); }
  function toLocalDT(v){
    if (!v) return '';
    const d = new Date(v);
    if (isNaN(d)) return '';
    const pad = n=>String(n).padStart(2,'0');
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  // Connections row actions
  connRows.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button'); if (!btn) return;
    const tr = btn.closest('tr'); const id = Number(tr.dataset.id);
    if (btn.dataset.act === 'save'){
      const payload = pickInputs(tr, ['mode','status','scope','accessToken','refreshToken','tokenExpiresAt']);
      setStatus('Saving connection‚Ä¶');
      const r = await fetch(`/extranet/pms/connections/${id}`, {
        method:'PATCH',
        headers: { 'Content-Type':'application/json', ...authHeaders() },
        body: JSON.stringify(payload)
      });
      if (!r.ok){ setStatus(`Save failed (${r.status})`,'error'); return; }
      setStatus('Saved.','ok'); setSaved(); await loadConnections();
    } else if (btn.dataset.act === 'test'){
      setStatus('Testing‚Ä¶');
      const r = await fetch(`/extranet/pms/connections/${id}/test`, { method:'POST', headers: authHeaders() });
      if (!r.ok){ setStatus(`Test failed (${r.status})`,'error'); return; }
      setStatus('Test success.','ok'); await loadConnections();
    } else if (btn.dataset.act === 'del'){
      if (!confirm('Delete this connection (and its mappings)?')) return;
      setStatus('Deleting‚Ä¶');
      const r = await fetch(`/extranet/pms/connections/${id}`, { method:'DELETE', headers: authHeaders() });
      if (!r.ok){ setStatus(`Delete failed (${r.status})`,'error'); return; }
      setStatus('Deleted.','ok'); await refreshAll();
    }
  });

  // Mappings row actions
  mapRows.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button'); if (!btn) return;
    const tr = btn.closest('tr'); const id = Number(tr.dataset.id);
    if (btn.dataset.act === 'save'){
      const payload = pickInputs(tr, ['localRoomTypeId','localRatePlanId','currency','active']);
      setStatus('Saving mapping‚Ä¶');
      const r = await fetch(`/extranet/pms/mappings/${id}`, {
        method:'PATCH',
        headers: { 'Content-Type':'application/json', ...authHeaders() },
        body: JSON.stringify(payload)
      });
      if (!r.ok){ setStatus(`Save failed (${r.status})`,'error'); return; }
      setStatus('Saved.','ok'); setSaved(); await loadMappings();
    } else if (btn.dataset.act === 'del'){
      if (!confirm('Delete this mapping?')) return;
      setStatus('Deleting‚Ä¶');
      const r = await fetch(`/extranet/pms/mappings/${id}`, { method:'DELETE', headers: authHeaders() });
      if (!r.ok){ setStatus(`Delete failed (${r.status})`,'error'); return; }
      setStatus('Deleted.','ok'); await loadMappings();
    }
  });

  function pickInputs(tr, keys){
    const obj = {};
    keys.forEach(k=>{
      const el = tr.querySelector(`[data-k="${k}"]`);
      if (!el) return;
      if (el.type === 'checkbox') obj[k] = !!el.checked;
      else obj[k] = el.value || null;
    });
    return obj;
  }

  saveBtn.addEventListener('click', ()=>{}); // present for consistency; row-level saves handle changes
  ['input','change'].forEach(evt=>{
    document.body.addEventListener(evt, (e)=>{
      if (e.target.closest('#conn-table') || e.target.closest('#map-table')) setDirty();
    }, true);
  });

  async function refreshAll(){ await Promise.all([loadConnections(), loadMappings(), initAuth()]); }
  initAuth().then(()=>refreshAll());
})();
</script>
</body>
</html>
